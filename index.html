<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Odontoiatrico Basile Ciccarone - Magazzino Materiali</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f8fb;color:#2c3e50;line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    h1{color:#003d7a;margin-bottom:8px;font-size:28px;font-weight:600}
    .subtitle{color:#7f8c8d;margin-bottom:24px;font-size:14px}
    #alerts{margin-bottom:20px}
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:8px;font-size:14px;border-left:4px solid}
    .alert.info{background:#e6f0ff;border-color:#0066cc;color:#003d7a}
    .alert.warn{background:#fff3e6;border-color:#ff9800;color:#e65100}
    
    form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-size:12px;font-weight:600;color:#003d7a;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
    input,select{padding:10px 12px;font-size:14px;border:1px solid #d0dce6;border-radius:6px;background:#fff;color:#2c3e50;transition:border-color 0.2s}
    input:focus,select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s}
    form button{background:#0066cc;color:#fff}
    form button:hover{background:#0052a3}
    
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    thead{background:#003d7a;color:#fff}
    th{padding:14px 12px;text-align:left;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-bottom:1px solid #e8ecf1;font-size:14px;vertical-align:middle}
    tbody tr:hover{background:#f9fbfd}
    
    .badge{display:inline-block;padding:6px 10px;border-radius:6px;color:#fff;font-weight:600;font-size:12px}
    .expired{background:#d32f2f}
    .soon{background:#f57c00}
    .ok{background:#388e3c}
    .low{background:#d32f2f}
    
    .btn-action{width:32px;height:32px;padding:0;font-size:18px;font-weight:bold;border:2px solid;border-radius:6px;cursor:pointer;transition:all 0.15s;margin:0 2px;display:inline-flex;align-items:center;justify-content:center;}
    .btn-inc{background:#e8f5e9;color:#2e7d32;border-color:#2e7d32;}
    .btn-inc:hover{background:#2e7d32;color:#fff;}
    .btn-dec{background:#fff3e0;color:#ef6c00;border-color:#ef6c00;}
    .btn-dec:hover{background:#ef6c00;color:#fff;}
    .btn-del{background:#ffebee;color:#c62828;border-color:#c62828;}
    .btn-del:hover{background:#c62828;color:#fff;}
    
    .action-buttons{display:flex;gap:10px;margin-bottom:20px;justify-content:flex-end}
    .action-buttons button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff}
    .action-buttons button:hover{background:#0052a3}
    .action-buttons button.export{background:#388e3c}
    .action-buttons button.export:hover{background:#2e7d32}
    
    .action-menu-btn{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff}
    .action-menu-btn:hover{background:#0052a3}
    .action-menu{position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;min-width:250px}
    .action-menu button.menu-item{width:100%;padding:12px 16px;border:none;background:none;color:#2c3e50;text-align:left;cursor:pointer;font-size:14px;transition:background 0.2s;display:flex;align-items:center;gap:8px;font-family:inherit}
    .action-menu button.menu-item:hover{background:#f5f5f5}
    
    #loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    #loginScreen.hidden{display:none}
    .login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);text-align:center;max-width:320px}
    .login-box h2{color:#003d7a;margin-bottom:24px;font-size:24px}
    .login-box input{width:100%;padding:12px;margin-bottom:16px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .login-box input:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    .login-box button{width:100%;padding:12px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s}
    .login-box button:hover{background:#0052a3}
    .login-error{color:#d32f2f;font-size:13px;margin-bottom:12px}
    
    .category-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .category-btn{padding:12px 16px;border:2px solid #d0dce6;border-radius:8px;background:#fff;color:#2c3e50;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s;text-align:center}
    .category-btn:hover{border-color:#0066cc;color:#0066cc}
    .category-btn.active{background:#0066cc;color:#fff;border-color:#0066cc}
    
    .header-wrapper{display:flex;align-items:center;gap:16px;margin-bottom:24px}
    .logo-circle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,61,122,0.25)}
    .header-content h1{margin:0;padding:0;font-size:32px}
    .header-content .studio-name{font-size:14px;color:#7f8c8d;font-weight:400}
    .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .filters-row{margin-bottom:20px;display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;background:linear-gradient(135deg,#f0f4f8 0%,#fff 100%);padding:18px 20px;border-radius:10px;border:1px solid #e0e8f0;box-shadow:0 2px 6px rgba(0,61,122,0.05)}
    .filter-label{font-weight:700;color:#003d7a;font-size:12px;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.6px;display:flex;align-items:center;gap:6px}
    .filter-label::before{display:inline-block;width:6px;height:6px;border-radius:50%;background:#0066cc}
    .filter-select{padding:9px 14px;font-size:14px;border-radius:8px;border:1.5px solid #d0dce6;min-width:190px;background:#fff;color:#2c3e50;font-weight:500;transition:all 0.2s;box-shadow:0 1px 2px rgba(0,0,0,0.04);cursor:pointer}
    .filter-select:hover{border-color:#0066cc;box-shadow:0 2px 8px rgba(0,102,204,0.12)}
    .filter-select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.15)}
    
    .filters-reset-btn{padding:9px 18px;font-size:13px;font-weight:600;background:#fff;color:#d32f2f;border:1.5px solid #d32f2f;border-radius:8px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
    .filters-reset-btn:hover{background:#d32f2f;color:#fff}
    .filters-reset-btn.hidden{display:none}

    /* Report Modal Styles */
    #reportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #reportModal.active{display:flex;align-items:flex-start;justify-content:center}
    #implantsReportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #implantsReportModal.active{display:flex;align-items:flex-start;justify-content:center}
    .report-modal-content{background:#fff;border-radius:12px;max-width:1400px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .report-header{background:linear-gradient(135deg,#0066cc 0%,#003d7a 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .report-header h2{margin:0;font-size:22px}
    .report-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .report-close:hover{background:#fff;color:#0066cc}
    .report-body{padding:24px}
    .report-filters{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;padding:16px;background:#f0f4f8;border-radius:8px}
    .report-filter-group{display:flex;flex-direction:column;gap:6px}
    .report-filter-group label{font-weight:600;color:#003d7a;font-size:12px}
    .report-filter-group select{padding:8px 12px;border-radius:6px;border:1px solid #d0dce6;font-size:14px}
    .report-content{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:20px}
    .report-chart-container{background:#f9fbfd;padding:16px;border-radius:8px;position:relative;height:400px}
    .report-table-container{overflow-x:auto;margin-top:20px}
    .report-table{width:100%;border-collapse:collapse;background:#fff}
    .report-table thead{background:#003d7a;color:#fff}
    .report-table th{padding:12px;text-align:left;font-weight:600;font-size:13px}
    .report-table td{padding:12px;border-bottom:1px solid #e8ecf1;font-size:14px}
    .report-table tbody tr:hover{background:#f9fbfd}
    .report-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
    .report-stat{background:linear-gradient(135deg,#e3f2fd 0%,#f3f8ff 100%);padding:16px;border-radius:8px;border-left:4px solid #0066cc}
    .report-stat-label{font-size:12px;color:#003d7a;font-weight:600}
    .report-stat-value{font-size:24px;font-weight:700;color:#0066cc;margin-top:8px}

    @media (max-width:1200px){
      .report-content{grid-template-columns:1fr}
      .report-chart-container{height:350px}
    }

    /* Consumption Modal Styles */
    #consumptionModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #consumptionModal.active{display:flex;align-items:flex-start;justify-content:center}
    .consumption-modal-content{background:#fff;border-radius:12px;max-width:700px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .consumption-header{background:linear-gradient(135deg,#f57c00 0%,#e65100 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .consumption-header h2{margin:0;font-size:22px}
    .consumption-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .consumption-close:hover{background:#fff;color:#f57c00}
    .consumption-body{padding:24px}
    .consumption-form{display:flex;flex-direction:column;gap:16px}
    .consumption-group{display:flex;flex-direction:column;gap:8px}
    .consumption-group label{font-weight:600;color:#003d7a;font-size:13px;text-transform:uppercase}
    .consumption-group select,.consumption-group input{padding:10px 12px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .consumption-preview{background:#f0f4f8;padding:16px;border-radius:8px;border-left:4px solid #f57c00;margin-top:12px}
    .consumption-preview-title{font-weight:600;color:#003d7a;margin-bottom:8px}
    .consumption-preview-line{display:flex;justify-content:space-between;padding:6px 0;font-size:14px}
    .consumption-preview-line strong{color:#f57c00}
    .consumption-buttons{display:flex;gap:12px;margin-top:20px}
    .consumption-btn{flex:1;padding:12px;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .consumption-btn.cancel{background:#e0e0e0;color:#333}
    .consumption-btn.cancel:hover{background:#bdbdbd}
    .consumption-btn.confirm{background:#f57c00;color:#fff}
    .consumption-btn.confirm:hover{background:#e65100}
    .batch-info{background:#fff3e0;padding:12px;border-radius:6px;margin-top:12px;border-left:3px solid #f57c00}

    /* Add Selection Modal Styles */
    #addSelectionModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;overflow-y:auto;padding:20px}
    #addSelectionModal.active{display:flex;align-items:center;justify-content:center}
    .selection-modal-content{background:#fff;border-radius:12px;max-width:600px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:slideDown 0.3s ease}
    .selection-header{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:28px;border-radius:12px 12px 0 0;text-align:center}
    .selection-header h2{margin:0;font-size:26px;font-weight:700}
    .selection-header p{margin:8px 0 0 0;font-size:15px;opacity:0.95}
    .selection-body{padding:40px;display:flex;flex-direction:column;gap:20px;align-items:center}
    .selection-btn{width:100%;max-width:320px;padding:18px 24px;font-size:16px;font-weight:600;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .selection-btn.order{background:linear-gradient(135deg,#388e3c 0%,#1b5e20 100%);color:#fff}
    .selection-btn.order:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(56,142,60,0.3)}
    .selection-btn.material{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff}
    .selection-btn.material:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(25,118,210,0.3)}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}

    /* Material Modal Styles */
    #materialModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #materialModal.active{display:flex;align-items:flex-start;justify-content:center}
    .material-modal-content{background:#fff;border-radius:12px;max-width:700px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .material-header{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:24px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .material-header h2{margin:0;font-size:22px;font-weight:700}
    .material-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .material-close:hover{background:#fff;color:#1976d2}
    .material-body{padding:32px}
    .material-form{display:grid;grid-template-columns:1fr 1fr;gap:20px;grid-auto-flow:dense}
    .material-form-group{display:flex;flex-direction:column;gap:8px}
    .material-form-group.full{grid-column:1/-1}
    .material-form-group label{font-weight:600;color:#003d7a;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
    .material-form-group input,.material-form-group select{padding:12px;border:1.5px solid #d0dce6;border-radius:8px;font-size:14px;transition:all 0.2s;background:#fff}
    .material-form-group input:focus,.material-form-group select:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1);background:#f8f9fa}
    .material-buttons{display:flex;gap:12px;margin-top:32px}
    .material-btn{flex:1;padding:12px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;font-size:15px;text-transform:uppercase;letter-spacing:0.5px}
    .material-btn.cancel{background:#e0e0e0;color:#333}
    .material-btn.cancel:hover{background:#bdbdbd;transform:translateY(-1px)}
    .material-btn.submit{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;box-shadow:0 4px 12px rgba(25,118,210,0.25)}
    .material-btn.submit:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(25,118,210,0.35)}

    /* Order Modal Styles */
    #orderModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px;margin:0}
    #orderModal.active{display:flex;align-items:flex-start;justify-content:center;padding:40px 20px}
    .order-modal-content{background:#fff;border-radius:12px;max-width:1000px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .order-header{background:linear-gradient(135deg,#388e3c 0%,#1b5e20 100%);color:#fff;padding:24px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .order-header h2{margin:0;font-size:22px}
    .order-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .order-close:hover{background:#fff;color:#388e3c}
    .order-body{padding:40px}
    .order-info{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:40px;padding:24px;background:#f0f4f8;border-radius:10px;border-left:4px solid #388e3c}
    .order-info-group{display:flex;flex-direction:column;gap:10px}
    .order-info-group label{font-weight:700;color:#003d7a;font-size:11px;text-transform:uppercase;letter-spacing:0.6px}
    .order-info-group input,.order-info-group select{padding:13px 14px;border:1.5px solid #d0dce6;border-radius:8px;font-size:14px;transition:all 0.3s;background:#fff}
    .order-info-group input:focus,.order-info-group select:focus{outline:none;border-color:#388e3c;box-shadow:0 0 0 3px rgba(56,142,60,0.12);background:#fafbfc}
    .articles-container{margin:40px 0;border:none;border-radius:0;padding:0;background:transparent}
    .articles-title{font-weight:700;color:#003d7a;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;font-size:15px;padding-bottom:14px;border-bottom:2px solid #e0e0e0;gap:12px;flex-wrap:wrap}
    .article-row{display:grid;grid-template-columns:1.2fr 1.2fr 1fr 1fr 90px;gap:14px;margin-bottom:16px;padding:18px;background:#fafbfc;border-radius:10px;border:1.5px solid #e8ecf1;align-items:flex-end;transition:all 0.3s;border-left:4px solid #388e3c}
    .article-row:hover{box-shadow:0 6px 16px rgba(0,0,0,0.1);background:#fff;border-color:#388e3c}
    .article-field{display:flex;flex-direction:column;gap:7px}
    .article-field label{font-weight:700;color:#003d7a;font-size:11px;text-transform:uppercase;letter-spacing:0.4px}
    .article-field input,.article-field select{padding:11px 13px;border:1.5px solid #d0dce6;border-radius:7px;font-size:13px;transition:all 0.2s;width:100%;background:#fff}
    .article-field input:focus,.article-field select:focus{outline:none;border-color:#388e3c;box-shadow:0 0 0 3px rgba(56,142,60,0.12);background:#fafbfc}
    .article-remove{background:#c62828;color:#fff;border:none;border-radius:7px;padding:10px 12px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:13px;display:flex;align-items:center;justify-content:center;gap:4px;height:44px}
    .article-remove:hover{background:#b71c1c;transform:translateY(-2px);box-shadow:0 4px 10px rgba(198,40,40,0.35)}
    .add-article-btn{padding:12px 20px;background:linear-gradient(135deg,#388e3c 0%,#2e7d32 100%);color:#fff;border:none;border-radius:7px;cursor:pointer;font-weight:600;transition:all 0.3s;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 3px 10px rgba(56,142,60,0.3);text-transform:uppercase;letter-spacing:0.4px}
    .add-article-btn:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(56,142,60,0.4)}
    .order-buttons{display:flex;gap:14px;margin-top:40px;padding-top:24px;border-top:1px solid #e0e0e0}
    .order-btn{flex:1;padding:14px 20px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:all 0.3s;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    .order-btn.cancel{background:#e0e0e0;color:#333}
    .order-btn.cancel:hover{background:#bdbdbd;transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15)}
    .order-btn.submit{background:linear-gradient(135deg,#388e3c 0%,#2e7d32 100%);color:#fff;box-shadow:0 3px 10px rgba(56,142,60,0.3)}
    .order-btn.submit:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(56,142,60,0.4)}

    /* Batch Expansion Styles */
    .batch-expand-row{background:#f9fbfd;cursor:pointer;user-select:none}
    .batch-expand-btn{background:none;border:none;color:#0066cc;cursor:pointer;font-weight:600;font-size:14px;padding:0}
    .batch-expand-btn:hover{color:#0052a3}
    .batch-details{display:none;background:#f0f4f8;padding:12px 24px;border-top:1px solid #e0e0e0}
    .batch-details.show{display:block}
    .batches-list{display:flex;flex-direction:column;gap:8px}
    .batch-card{background:#fff;padding:12px;border-radius:6px;border-left:4px solid #0066cc}
    .batch-card-header{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;font-size:13px}
    .batch-card-header strong{color:#003d7a}
    .batch-card-header .expiry-status{font-weight:600;padding:2px 6px;border-radius:3px}
    .expiry-ok{background:#c8e6c9;color:#2e7d32}
    .expiry-warn{background:#ffe0b2;color:#e65100}
    .expiry-critical{background:#ffcdd2;color:#c62828}
    .consumption-history{margin-top:8px;padding:8px;background:#fafafa;border-radius:4px;font-size:12px;color:#666}
    .header-content{min-width:0}
    
    .implants-btn{background:#ff6b35;margin-left:10px}
    .implants-btn:hover{background:#e55a2b}
    #implantsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto}
    #implantsModal.active{display:flex;align-items:flex-start;justify-content:center;padding:20px}
    .modal-content{background:#fff;border-radius:12px;max-width:900px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .modal-header{background:#003d7a;color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:22px}
    .modal-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .modal-close:hover{background:#fff;color:#003d7a}
    .modal-body{padding:24px}

    @media (max-width:900px){
      .container{padding:16px}
      .header-content h1{font-size:24px;line-height:1.2}
      .action-buttons{justify-content:stretch}
      .action-buttons button{width:100%}
      .filters-row{gap:12px;padding:14px 16px}
      .filters-row > div{flex:1 1 180px}
      .filter-select{min-width:160px}
    }

    @media (max-width:700px){
      body{font-size:14px}
      .container{padding:12px}
      .header-wrapper{align-items:flex-start;gap:12px}
      .logo-circle{width:48px;height:48px;font-size:18px}
      .header-content h1{font-size:20px}
      .header-content .studio-name{font-size:13px}
      .subtitle{font-size:13px}
      form{grid-template-columns:1fr;padding:14px;gap:10px}
      .category-filters{grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
      .category-btn{padding:10px 8px;font-size:13px}
      .action-buttons{margin-bottom:14px}
      .action-buttons button{font-size:13px;padding:10px 12px}
      .filters-row{flex-direction:column;gap:10px;padding:12px 14px}
      .filters-row > div{width:100%}
      .filter-label{display:flex;align-items:center;margin-right:0;margin-bottom:6px;font-size:12px}
      .filter-label::before{width:5px;height:5px}
      .filter-select{display:block;width:100%;min-width:0;font-size:13px;padding:9px 10px;border-radius:6px}
      .filters-reset-btn{width:100%;padding:10px 14px;font-size:12px}

      table{border:none;box-shadow:none;background:transparent}
      thead{display:none}
      tbody{display:block}
      tbody tr{display:block;background:#fff;border:1px solid #e8ecf1;border-radius:8px;margin-bottom:10px;padding:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
      td{display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:1px solid #eef2f6;padding:9px 8px;font-size:13px;text-align:right}
      td::before{content:attr(data-label);font-weight:600;color:#003d7a;text-align:left}
      td:last-child{border-bottom:none}
      td[data-label="Azioni"]{justify-content:flex-end}
      td[data-label="Azioni"]::before{margin-right:auto}
      .btn-action{width:34px;height:34px}
    }

    @media (max-width:420px){
      .category-filters{grid-template-columns:1fr}
    }

    @media (max-width:360px){
      .container{padding:10px}
      .header-wrapper{gap:10px}
      .logo-circle{width:42px;height:42px;font-size:16px}
      .header-content h1{font-size:18px}
      .header-content .studio-name{font-size:12px}
      form{padding:12px}
      .category-btn{font-size:12px;padding:9px 8px}
      .filter-label{font-size:12px}
      .filter-select{font-size:12px;padding:8px 9px}
      .alert{padding:10px 12px;font-size:13px}
    }
  </style>
</head>
<body>
  <!-- Login disabilitato temporaneamente -->
  <div style="display:none"></div>

  <div class="container" id="mainContent" style="display:block">
    <div class="header-wrapper">
      <div class="logo-circle">BC</div>
      <div class="header-content">
        <h1>Studio Odontoiatrico Basile Ciccarone</h1>
        <p class="studio-name">Gestione Magazzino Materiali di Consumo</p>
      </div>
    </div>
    <div id="alerts"></div>
    <div class="alert info" style="margin-bottom:18px;">
      <strong>Nota sulle notifiche:</strong> Riceverai un avviso automatico quando:
      <ul style="margin:8px 0 0 18px; font-size:13px; color:#003d7a;">
        <li>Un materiale Ã¨ scaduto o sta per scadere tra 30 giorni</li>
        <li>La quantitÃ  del materiale raggiunge il valore soglia impostato</li>
      </ul>
      Le notifiche compaiono in alto nella pagina ogni volta che si verifica una di queste condizioni.
    </div>

    <form id="addForm">
      <div class="form-group"><label>Nome materiale</label><input id="name" placeholder="Es. Cemento composito" required /></div>
      <div class="form-group"><label>ğŸ“… Data Ordine</label><input id="orderDate" type="date" required /></div>
      <div class="form-group"><label>â° Data Scadenza</label><input id="expiry" type="date" required /></div>
      <div class="form-group"><label>Prezzo (â‚¬)</label><input id="price" type="number" step="0.01" placeholder="0.00" /></div>
      <div class="form-group"><label>QuantitÃ </label><input id="quantity" type="number" min="0" value="1" required /></div>
      <div class="form-group"><label>ğŸ—‚ï¸ Categoria</label><select id="category" required><option value="">-- Seleziona --</option><option value="Strumentario">Strumentario</option><option value="Consumabili Generici">Consumabili Generici</option><option value="Monouso">Monouso</option><option value="Disinfezione e Sterilizzazione">Disinfezione e Sterilizzazione</option><option value="Chirurgia">Chirurgia</option><option value="Endodonzia">Endodonzia</option><option value="Conservativa e Protesi">Conservativa e Protesi</option><option value="Frese e Lucidatura">Frese e Lucidatura</option><option value="Anestesia e Farmaci">Anestesia e Farmaci</option><option value="Impronte e Laboratorio">Impronte e Laboratorio</option><option value="Radiografia e Fotografia">Radiografia e Fotografia</option><option value="Profilassi e Igiene Orale">Profilassi e Igiene Orale</option><option value="Ortodonzia">Ortodonzia</option></select></div>

      <div class="form-group"><label>ğŸšš Distributore</label>
        <select id="distributorSelect" required>
          <option value="">-- Seleziona --</option>
          <option value="Dental Leader">Dental Leader</option>
          <option value="GherÃ²">GherÃ²</option>
          <option value="Revello">Revello</option>
          <option value="Dentitalia">Dentitalia</option>
          <option value="Dental Trey">Dental Trey</option>
          <option value="Umbra">Umbra</option>
          <option value="Eli Dent">Eli Dent</option>
          <option value="Non disponibile">Non disponibile</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="distributor" placeholder="Distributore personalizzato" style="display:none;margin-top:6px" />
      </div>
      <div class="form-group"><label>ğŸ¢ Azienda</label>
        <select id="companySelect">
          <option value="">-- Seleziona --</option>
          <option value="3M">3M</option>
          <option value="Ivoclar">Ivoclar</option>
          <option value="GC">GC</option>
          <option value="Dentsply Sirona">Dentsply Sirona</option>
          <option value="Coltene">Coltene</option>
          <option value="Kerr">Kerr</option>
          <option value="Voco">Voco</option>
          <option value="Septodont">Septodont</option>
          <option value="Zhermack">Zhermack</option>
          <option value="DMG">DMG</option>
          <option value="VOCO">VOCO</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="company" placeholder="Azienda personalizzata" style="display:none;margin-top:6px" />
      </div>
      <div class="form-group"><label>Soglia quantitÃ  bassa</label>
        <select id="lowStockThreshold">
          <option value="1">1</option>
          <option value="2">2 (default)</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="lowStockThresholdCustom" type="number" min="1" step="1" placeholder="Personalizzato" style="display:none;margin-top:6px" />
      </div>
      <button type="submit" style="grid-column:span 1;align-self:flex-end">Aggiungi materiale</button>
    </form>
    
    <div id="categoryFilters" class="category-filters"></div>

    <!-- Pulsanti Principali -->
    <div class="action-dropdown-container" style="margin:20px 0;display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:space-between">
      <!-- Pulsante Magazzino Implantare con grafica distintiva -->
      <button id="implantsBtn" class="implants-btn-main" onclick="openImplantsModal()" style="background:linear-gradient(135deg,#2E7D32 0%,#1B5E20 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(27,94,32,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
        ğŸ”© Magazzino Implantare
      </button>

      <button onclick="openAddSelectionModal()" style="background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(25,118,210,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
        â• Aggiungi
      </button>

      <button onclick="openReportModal()" style="background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(13,71,161,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
        ğŸ“Š Analisi Spese
      </button>

      <button onclick="openConsumptionModal()" style="background:linear-gradient(135deg,#f57c00 0%,#e65100 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(230,81,0,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
        ğŸ“‰ Registra Consumo
      </button>

      <div style="display:flex;gap:12px;align-items:center;margin-left:auto;flex-wrap:wrap">
        <!-- Pulsante Scarica Dati Materiali -->
        <div style="position:relative">
          <button class="action-menu-btn" onclick="toggleActionMenu('downloadMenu')">ğŸ“¥ Scarica Dati â–¼</button>
          <div id="downloadMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;left:0">
            <button class="menu-item" onclick="downloadMaterialsPDF()">ğŸ“„ PDF Materiali</button>
            <button class="menu-item" onclick="exportMaterialsCSV()">ğŸ“Š CSV Materiali</button>
          </div>
        </div>

        <!-- Pulsante Backup -->
        <div style="position:relative">
          <button class="action-menu-btn" onclick="toggleActionMenu('backupMenu')">ğŸ’¾ Backup â–¼</button>
          <div id="backupMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;right:0;left:auto">
            <button class="menu-item" onclick="exportBackup()">ğŸ“¥ Esporta Backup Completo</button>
            <button class="menu-item" onclick="document.getElementById('importFile').click()">ğŸ“¤ Importa Backup</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)" />
          </div>
        </div>
      </div>
    </div>

    <div class="filters-row">
      <div>
        <label for="expiryFilterSelect" class="filter-label">ğŸ“… Scadenza</label>
        <select id="expiryFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
          <option value="Rosso">ğŸ”´ Entro 3 mesi</option>
          <option value="Giallo">ğŸŸ¡ Entro 6 mesi</option>
          <option value="Verde">ğŸŸ¢ Oltre 6 mesi</option>
        </select>
      </div>
      <div>
        <label for="quantityFilterSelect" class="filter-label">ğŸ“¦ QuantitÃ </label>
        <select id="quantityFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
          <option value="Rosso">ğŸ”´ Sotto soglia</option>
          <option value="Giallo">ğŸŸ¡ Uguale soglia</option>
          <option value="Verde">ğŸŸ¢ Sopra soglia</option>
        </select>
      </div>
      <div>
        <label for="companyFilterSelect" class="filter-label">ğŸ¢ Azienda</label>
        <select id="companyFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
        </select>
      </div>
      <div>
        <label for="distributorFilterSelect" class="filter-label">ğŸšš Distributore</label>
        <select id="distributorFilterSelect" class="filter-select">
          <option value="Tutti">Tutti</option>
        </select>
      </div>
      <button id="resetFiltersBtn" class="filters-reset-btn hidden">âŸ² Azzera Filtri</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nome</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th>Prezzo</th><th>Distributore</th><th>Azienda</th><th style="text-align:center;">QuantitÃ </th><th>Azioni</th></tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

  </div>

  <!-- Modal Magazzino Implantare -->
  <div id="implantsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ”© Magazzino Implantare</h2>
        <button class="modal-close" onclick="closeImplantsModal()">Ã—</button>
      </div>
      <div class="modal-body">
      
      <form id="implantForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:24px;background:#f5f5f5;border-radius:8px;margin-bottom:24px">
        <div class="form-group">
          <label>Tipo</label>
          <select id="implantType" required>
            <option value="">-- Seleziona --</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Azienda</label>
          <select id="implantCompany" required>
            <option value="">-- Seleziona --</option>
            <option value="Straumann">Straumann</option>
            <option value="Nobel Biocare">Nobel Biocare</option>
            <option value="Zimmer Biomet">Zimmer Biomet</option>
            <option value="Dentsply Sirona">Dentsply Sirona</option>
            <option value="Osstem">Osstem</option>
            <option value="Biomet 3i">Biomet 3i</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantCompanyCustom" placeholder="Azienda personalizzata" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantModelGroup">
          <label>Modello / Nomenclatura</label>
          <select id="implantModel">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantModelCustom" placeholder="Scrivi modello/nomenclatura (es. BLX, NC, RC)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantKitComponentsGroup" style="display:none">
          <label>Componenti Kit</label>
          <select id="implantKitComponents">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantKitComponentsCustom" placeholder="Scrivi componente (es. Frese chirurgiche, Maschiatore, ecc.)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantDiameterGroup">
          <label>Diametro (mm)</label>
          <select id="implantDiameter">
            <option value="">-- Seleziona --</option>
            <option value="2.9">2.9 mm</option>
            <option value="3.3">3.3 mm</option>
            <option value="3.5">3.5 mm</option>
            <option value="4.0">4.0 mm</option>
            <option value="4.1">4.1 mm</option>
            <option value="4.5">4.5 mm</option>
            <option value="4.8">4.8 mm</option>
            <option value="5.0">5.0 mm</option>
            <option value="6.0">6.0 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantDiameterCustom" type="number" step="0.1" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantLengthGroup">
          <label>Lunghezza (mm)</label>
          <select id="implantLength">
            <option value="">-- Seleziona --</option>
            <option value="6">6 mm</option>
            <option value="8">8 mm</option>
            <option value="10">10 mm</option>
            <option value="12">12 mm</option>
            <option value="14">14 mm</option>
            <option value="16">16 mm</option>
            <option value="18">18 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantLengthCustom" type="number" step="0.5" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group">
          <label>ğŸ“… Data Ordine</label>
          <input id="implantOrderDate" type="date" required />
        </div>
        <div class="form-group">
          <label>â° Data Scadenza</label>
          <input id="implantExpiry" type="date" />
        </div>
        <div class="form-group">
          <label>Prezzo (â‚¬)</label>
          <input id="implantPrice" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div class="form-group">
          <label>QuantitÃ </label>
          <input id="implantQuantity" type="number" min="0" value="1" required />
        </div>
        <button type="submit" style="grid-column:span 1;align-self:flex-end">Aggiungi impianto</button>
      </form>

      <h3 style="margin:24px 0 12px;color:#003d7a;font-size:18px">ğŸ“‹ Inventario Impianti</h3>
      
      <!-- Dropdown Scarica Dati Impianti -->
      <div style="margin:16px 0;display:flex;gap:10px;align-items:center;position:relative">
        <button class="action-menu-btn" onclick="toggleActionMenu('implantsMenu')">ğŸ“¥ Scarica Dati â–¼</button>
        <button class="action-menu-btn" onclick="openImplantsReportModal()" style="background-color:#1976d2">ğŸ“Š Analisi Spese Impianti</button>
        <div id="implantsMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;left:0">
          <button class="menu-item" onclick="downloadImplantsPDF()">ğŸ“„ Scarica PDF Impianti</button>
          <button class="menu-item" onclick="exportImplantsCSV()">ğŸ“Š Scarica CSV Impianti</button>
        </div>
      </div>
      
      <!-- Filtri Impianti -->
      <div class="filters-row" style="margin-bottom:16px;display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <label for="implantTypeFilter" class="filter-label">Filtra per tipo:</label>
          <select id="implantTypeFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div>
          <label for="implantCompanyFilter" class="filter-label">Filtra per azienda:</label>
          <select id="implantCompanyFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
          </select>
        </div>
        <div>
          <label for="implantModelFilter" id="implantModelFilterLabel" class="filter-label">Filtra per modello:</label>
          <select id="implantModelFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
          </select>
        </div>
        <div>
          <label for="implantExpiryFilter" class="filter-label">Filtra per scadenza:</label>
          <select id="implantExpiryFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
            <option value="Scaduti">Scaduti</option>
            <option value="< 3 mesi">< 3 mesi</option>
            <option value="< 6 mesi">< 6 mesi</option>
            <option value="> 6 mesi">> 6 mesi</option>
          </select>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Tipo</th><th>Azienda</th><th>Modello</th><th>Ã˜</th><th>L</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th>Prezzo</th><th style="text-align:center;">QuantitÃ </th><th>Azioni</th></tr>
          </thead>
          <tbody id="implantsList"></tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <!-- Analisi Spese Modal -->
  <div id="reportModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“Š Analisi Spese Materiali</h2>
        <button class="report-close" onclick="closeReportModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri Report -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Categoria / Macroarea</label>
            <select id="reportCategoryFilter" onchange="updateReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Azienda</label>
            <select id="reportCompanyFilter" onchange="updateReportData()">
              <option value="Tutte">Tutte</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Distributore</label>
            <select id="reportDistributorFilter" onchange="updateReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetReportFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche Riassuntive -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Spesa Totale</div>
            <div class="report-stat-value" id="reportTotalExpense">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Numero Ordini</div>
            <div class="report-stat-value" id="reportOrderCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Prezzo Medio</div>
            <div class="report-stat-value" id="reportAveragePrice">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Top Categoria</div>
            <div class="report-stat-value" id="reportTopCategory" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Grafici -->
        <div class="report-content">
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“ˆ Trend Spese (Mese)</h3>
            <div class="report-chart-container">
              <canvas id="reportTrendChart"></canvas>
            </div>
          </div>
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“Š Distribuzione Spese</h3>
            <div class="report-chart-container">
              <canvas id="reportDistributionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tabella Analitica -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Analisi Dettagliata</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Categoria</th>
                <th>Nome Materiale</th>
                <th>Azienda</th>
                <th>Distributore</th>
                <th>Prezzo (â‚¬)</th>
                <th>QuantitÃ </th>
                <th>Totale (â‚¬)</th>
              </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Selection Modal -->
  <div id="addSelectionModal">
    <div class="selection-modal-content">
      <div class="selection-header">
        <h2>Cosa vuoi aggiungere?</h2>
        <p>Scegli un'opzione per iniziare</p>
      </div>
      <div class="selection-body">
        <button type="button" class="selection-btn order" onclick="continueWithOrder()">
          <span>ğŸ“¦</span>
          <span>Nuovo Ordine</span>
        </button>
        <button type="button" class="selection-btn material" onclick="continueWithMaterial()">
          <span>ğŸ“</span>
          <span>Nuovo Materiale</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Nuovo Materiale Modal -->
  <div id="materialModal">
    <div class="material-modal-content">
      <div class="material-header">
        <h2>ğŸ“ Nuovo Materiale</h2>
        <button class="material-close" onclick="closeMaterialModal()">Ã—</button>
      </div>
      <div class="material-body">
        <form id="materialForm" class="material-form">
          <div class="material-form-group"><label for="matName">Nome materiale</label><input id="matName" placeholder="Es. Cemento composito" required /></div>
          <div class="material-form-group"><label for="matOrderDate">Data Ordine</label><input id="matOrderDate" type="date" required /></div>
          <div class="material-form-group"><label for="matExpiry">Data Scadenza</label><input id="matExpiry" type="date" required /></div>
          <div class="material-form-group"><label for="matPrice">Prezzo (â‚¬)</label><input id="matPrice" type="number" step="0.01" placeholder="0.00" /></div>
          <div class="material-form-group"><label for="matQuantity">QuantitÃ </label><input id="matQuantity" type="number" min="0" value="1" required /></div>
          <div class="material-form-group"><label for="matCategory">Categoria</label><select id="matCategory" required><option value="">-- Seleziona --</option><option value="Strumentario">Strumentario</option><option value="Consumabili Generici">Consumabili Generici</option><option value="Monouso">Monouso</option><option value="Disinfezione e Sterilizzazione">Disinfezione e Sterilizzazione</option><option value="Chirurgia">Chirurgia</option><option value="Endodonzia">Endodonzia</option><option value="Conservativa e Protesi">Conservativa e Protesi</option><option value="Frese e Lucidatura">Frese e Lucidatura</option><option value="Anestesia e Farmaci">Anestesia e Farmaci</option><option value="Impronte e Laboratorio">Impronte e Laboratorio</option><option value="Radiografia e Fotografia">Radiografia e Fotografia</option><option value="Profilassi e Igiene Orale">Profilassi e Igiene Orale</option><option value="Ortodonzia">Ortodonzia</option></select></div>
          <div class="material-form-group"><label for="matDistributor">Distributore</label><select id="matDistributor" required><option value="">-- Seleziona --</option><option value="Dental Leader">Dental Leader</option><option value="GherÃ²">GherÃ²</option><option value="Revello">Revello</option><option value="Dentitalia">Dentitalia</option><option value="Dental Trey">Dental Trey</option><option value="Umbra">Umbra</option><option value="Eli Dent">Eli Dent</option><option value="Non disponibile">Non disponibile</option><option value="Other">Altro...</option></select></div>
          <div class="material-form-group"><label for="matCompany">Azienda</label><select id="matCompany"><option value="">-- Seleziona --</option><option value="3M">3M</option><option value="Ivoclar">Ivoclar</option><option value="GC">GC</option><option value="Dentsply Sirona">Dentsply Sirona</option><option value="Coltene">Coltene</option><option value="Kerr">Kerr</option><option value="Voco">Voco</option><option value="Septodont">Septodont</option><option value="Zhermack">Zhermack</option><option value="DMG">DMG</option><option value="VOCO">VOCO</option><option value="Other">Altro...</option></select></div>
          <div class="material-form-group"><label for="matLowStock">Soglia quantitÃ  bassa</label><select id="matLowStock"><option value="1">1</option><option value="2" selected>2 (default)</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="Other">Altro...</option></select></div>
          <div class="material-buttons"><button type="button" class="material-btn cancel" onclick="closeMaterialModal()">Annulla</button><button type="submit" class="material-btn submit">âœ“ Aggiungi</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Nuovo Ordine Modal -->
  <div id="orderModal">
    <div class="order-modal-content">
      <div class="order-header">
        <h2>ğŸ“¦ Nuovo Ordine</h2>
        <button class="order-close" onclick="closeOrderModal()">Ã—</button>
      </div>
      <div class="order-body">
        <form id="orderForm">
          <!-- Info Ordine -->
          <div class="order-info">
            <div class="order-info-group">
              <label for="orderDate">Data Ordine</label>
              <input id="orderDate" type="date" required />
            </div>
            <div class="order-info-group">
              <label for="orderDistributor">Distributore</label>
              <select id="orderDistributor" required>
                <option value="">-- Seleziona --</option>
              </select>
            </div>
          </div>

          <!-- Articoli -->
          <div class="articles-container">
            <div class="articles-title">
              ğŸ“‹ Articoli dell'Ordine
              <button type="button" class="add-article-btn" onclick="addArticleRow()">â• Aggiungi Articolo</button>
            </div>
            <div id="articlesContainer"></div>
          </div>

          <!-- Pulsanti -->
          <div class="order-buttons">
            <button type="button" class="order-btn cancel" onclick="closeOrderModal()">â† Annulla</button>
            <button type="submit" class="order-btn submit">âœ“ Salva Ordine</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Consumo Materiale Modal -->
  <div id="consumptionModal">
    <div class="consumption-modal-content">
      <div class="consumption-header">
        <h2>ğŸ“‰ Registra Consumo Materiale</h2>
        <button class="consumption-close" onclick="closeConsumptionModal()">Ã—</button>
      </div>
      <div class="consumption-body">
        <form class="consumption-form" id="consumptionForm">
          <div class="consumption-group">
            <label for="consumptionMaterial">Materiale</label>
            <select id="consumptionMaterial" required onchange="updateConsumptionPreview()">
              <option value="">-- Seleziona materiale --</option>
            </select>
          </div>

          <div class="consumption-group">
            <label for="consumptionQuantity">QuantitÃ  da consumare (pz)</label>
            <input id="consumptionQuantity" type="number" min="1" step="1" required onchange="updateConsumptionPreview()" />
          </div>

          <div class="consumption-group">
            <label for="consumptionDate">Data consumo</label>
            <input id="consumptionDate" type="date" required onchange="updateConsumptionPreview()" />
          </div>

          <!-- Preview FIFO -->
          <div class="consumption-preview">
            <div class="consumption-preview-title">ğŸ“‹ Preview Riduzione FIFO</div>
            <div id="consumptionPreviewContent" style="color:#666;font-size:13px;padding:8px">
              Seleziona un materiale per visualizzare anteprima...
            </div>
          </div>

          <div class="consumption-buttons">
            <button type="button" class="consumption-btn cancel" onclick="closeConsumptionModal()">Annulla</button>
            <button type="submit" class="consumption-btn confirm">âœ“ Conferma Consumo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Implants Report Modal -->
  <div id="implantsReportModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“Š Analisi Spese Impianti</h2>
        <button class="report-close" onclick="closeImplantsReportModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri Report -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Tipo Impianto</label>
            <select id="implantsReportTypeFilter" onchange="updateImplantsReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Azienda</label>
            <select id="implantsReportCompanyFilter" onchange="updateImplantsReportData()">
              <option value="Tutte">Tutte</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetImplantsReportFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche Riassuntive -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Spesa Totale</div>
            <div class="report-stat-value" id="implantsReportTotalExpense">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Numero Ordini</div>
            <div class="report-stat-value" id="implantsReportOrderCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Prezzo Medio</div>
            <div class="report-stat-value" id="implantsReportAveragePrice">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Top Tipo</div>
            <div class="report-stat-value" id="implantsReportTopType" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Grafici -->
        <div class="report-content">
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“ˆ Trend Spese (Mese)</h3>
            <div class="report-chart-container">
              <canvas id="implantsReportTrendChart"></canvas>
            </div>
          </div>
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“Š Distribuzione per Tipo</h3>
            <div class="report-chart-container">
              <canvas id="implantsReportDistributionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tabella Analitica -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Analisi Dettagliata</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Tipo</th>
                <th>Azienda</th>
                <th>Modello</th>
                <th>Prezzo (â‚¬)</th>
                <th>QuantitÃ </th>
                <th>Totale (â‚¬)</th>
              </tr>
            </thead>
            <tbody id="implantsReportTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZeB8P2osUIN2YHa5qg4eAZdRH8js2cW0",
      authDomain: "gestione-materiali-di-consumo.firebaseapp.com",
      projectId: "gestione-materiali-di-consumo",
      storageBucket: "gestione-materiali-di-consumo.firebasestorage.app",
      messagingSenderId: "831456435798",
      appId: "1:831456435798:web:af967c6986c06dde8d65f7",
      measurementId: "G-CEGE8B5LGZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const APP_VERSION = '2026-02-20-fix-local-first-3';
    console.log('App version:', APP_VERSION);
    let firebaseReady = true;
    let realtimeListenersStarted = false;
    if (db && typeof db.enablePersistence === 'function') {
      db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        console.warn('Persistenza offline Firebase non attiva:', err && err.message ? err.message : err);
      });
    }

    // Login anonimo automatico
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously().catch(err => {
          console.warn('Errore login anonimo:', err.message);
        });
      } else {
        console.log('Login anonimo riuscito:', user.uid);
        startRealtimeListeners();
      }
    });

    const addForm = document.getElementById('addForm');
    const listEl = document.getElementById('list');
    const alertsEl = document.getElementById('alerts');
    const categoryFiltersEl = document.getElementById('categoryFilters');
    const companyFilterSelect = document.getElementById('companyFilterSelect');
    const distributorFilterSelect = document.getElementById('distributorFilterSelect');

    const CATEGORIES = ['Tutti', 'Strumentario', 'Consumabili Generici', 'Monouso', 'Disinfezione e Sterilizzazione', 'Chirurgia', 'Endodonzia', 'Conservativa e Protesi', 'Frese e Lucidatura', 'Anestesia e Farmaci', 'Impronte e Laboratorio', 'Radiografia e Fotografia', 'Profilassi e Igiene Orale', 'Ortodonzia'];
    const COMPANY_OPTIONS = ['3M', 'Ivoclar', 'GC', 'Dentsply Sirona', 'Coltene', 'Kerr', 'Voco', 'Septodont', 'Zhermack', 'DMG', 'VOCO', 'Other'];
    const DISTRIBUTOR_OPTIONS = ['Dental Leader', 'GherÃ²', 'Revello', 'Dentitalia', 'Dental Trey', 'Umbra', 'Eli Dent', 'Non disponibile', 'Other'];
    let currentFilter = 'Tutti';
    let currentCompanyFilter = 'Tutte';
    let currentDistributorFilter = 'Tutti';
    let currentExpiryFilter = 'Tutte';
    let currentQuantityFilter = 'Tutte';
    let allDocs = []; // store all docs for filtering

    let notified = new Map(); // track notifications per doc

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveToLocalStorage(docs){
      // Se docs non Ã¨ un array o vuoto, niente da salvare
      if (!Array.isArray(docs) || docs.length === 0) return;
      // Estrai dati dai doc Firestore
      const fbData = docs[0] && typeof docs[0].data === 'function'
        ? docs.map(doc=>{
            const d = doc.data();
            const order = d.orderDate && d.orderDate.toDate ? d.orderDate.toDate().toISOString() : (d.orderDate ? new Date(d.orderDate).toISOString() : null);
            const exp = d.expiry && d.expiry.toDate ? d.expiry.toDate().toISOString() : (d.expiry ? new Date(d.expiry).toISOString() : null);
            const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt ? new Date(d.createdAt).toISOString() : null);
            return {id: doc.id, ...d, orderDate: order, expiry: exp, createdAt: created};
          })
        : docs;
      // Carica materiali esistenti in localStorage e unisci (Firebase ha prioritÃ , localStorage Ã¨ solo backup offline)
      try {
        const existing = loadFromLocalStorage();
        const map = new Map();
        // Prima aggiungi i dati locali
        existing.forEach(it => map.set(it.id, it));
        // Poi sovrascrivi con i dati di Firebase (prioritÃ  a Firebase)
        fbData.forEach(it => {
          map.set(it.id, it);
        });
        const merged = Array.from(map.values());
        localStorage.setItem('magazzino_materials', JSON.stringify(merged));
      } catch (e) {
        // fallback semplice
        localStorage.setItem('magazzino_materials', JSON.stringify(fbData));
      }
    }

    function loadFromLocalStorage(){
      const saved = localStorage.getItem('magazzino_materials');
      return saved ? JSON.parse(saved) : [];
    }

    function addToLocalStorage(item){
      const materials = loadFromLocalStorage();
      const newItem = {...item, id: item.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_local_'+Date.now())};
      // Convert dates to ISO strings for JSON serialization
      if(newItem.orderDate instanceof Date) newItem.orderDate = newItem.orderDate.toISOString();
      if(newItem.expiry instanceof Date) newItem.expiry = newItem.expiry.toISOString();
      if(newItem.createdAt instanceof Date) newItem.createdAt = newItem.createdAt.toISOString();
      
      // Create/update batch system
      if (!newItem.batches) {
        newItem.batches = [];
      }
      
      // Create new batch for this order
      const batchId = 'batch_' + newItem.id.substring(0, 8) + '_' + Date.now();
      const newBatch = {
        batchId: batchId,
        dataOrdine: newItem.orderDate,
        quantitÃ : newItem.quantity || 0,
        quantitÃ Rimanente: newItem.quantity || 0,
        prezzo: newItem.price || 0,
        scadenza: newItem.expiry
      };
      
      const idx = materials.findIndex(m => m.id === newItem.id);
      if (idx >= 0) {
        // Material already exists - add new batch
        const existing = materials[idx];
        if (!existing.batches) existing.batches = [];
        existing.batches.push(newBatch);
        // Update total quantity
        existing.quantity = existing.batches.reduce((sum, b) => sum + (b.quantitÃ Rimanente || 0), 0);
        existing.updatedAt = new Date().toISOString();
        materials[idx] = existing;
      } else {
        // New material - add batch
        newItem.batches.push(newBatch);
        materials.push(newItem);
      }
      
      localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      return newItem.id;
    }

    function deleteFromLocalStorage(id){
      const materials = loadFromLocalStorage();
      const filtered = materials.filter(m=>m.id !== id);
      localStorage.setItem('magazzino_materials', JSON.stringify(filtered));
    }

    function updateQuantityLocalStorage(id, delta){
      const materials = loadFromLocalStorage();
      const item = materials.find(m=>m.id === id);
      if(item){
        item.quantity = (item.quantity || 0) + delta;
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }
    }

    async function updateMaterialFields(id, fields){
      const updatedFields = { ...fields, updatedAt: new Date().toISOString() };
      const materials = loadFromLocalStorage();
      const item = materials.find(m => m.id === id);
      if(item){
        Object.assign(item, updatedFields);
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(id).set(updatedFields, { merge: true });
        } catch(err) {
          console.warn('Firebase update non riuscito:', err && err.message ? err.message : err);
          showAlert('Modifica salvata in locale. Firebase non raggiungibile.', 'warn');
        }
      }

      loadMaterialsFromStorage();
    }

    function promptSelectOrCustom(title, options, currentValue){
      const printable = options
        .filter(opt => opt && opt !== 'Other')
        .map(opt => '- ' + opt)
        .join('\n');
      const message = title + '\n' + printable + '\nScrivi un valore personalizzato:';
      const selected = prompt(message, currentValue || '');
      if(selected === null) return null;
      return selected.trim();
    }

    // --- IMPLANTS MANAGEMENT ---
    let currentImplantTypeFilter = 'Tutti';
    let currentImplantCompanyFilter = 'Tutte';
    let currentImplantModelFilter = 'Tutti';
    let currentImplantExpiryFilter = 'Tutte';

    function loadImplantsFromStorage(){
      const saved = localStorage.getItem('magazzino_implants');
      const implants = saved ? JSON.parse(saved) : [];
      if(!Array.isArray(implants)) return [];
      let changed = false;
      const normalized = implants.map(item => {
        if(item && item.id) return item;
        changed = true;
        return {
          ...item,
          id: (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_implant_' + Date.now() + '_' + Math.floor(Math.random() * 100000))
        };
      });
      if(changed){
        saveImplantsToStorage(normalized);
      }
      return normalized;
    }

    function saveImplantsToStorage(implants){
      localStorage.setItem('magazzino_implants', JSON.stringify(implants));
    }

    function toFirestoreImplantData(implant){
      const implantData = {...implant};
      delete implantData.id;
      if(implantData.orderDate && typeof implantData.orderDate === 'string'){
        implantData.orderDate = new Date(implantData.orderDate);
      }
      if(implantData.expiry && typeof implantData.expiry === 'string'){
        implantData.expiry = new Date(implantData.expiry);
      }
      if(implantData.createdAt && typeof implantData.createdAt === 'string'){
        implantData.createdAt = new Date(implantData.createdAt);
      }
      return implantData;
    }

    async function syncLocalImplantsToFirebase(){
      if(!firebaseReady || typeof db === 'undefined') return;
      try {
        const localImplants = loadImplantsFromStorage();
        if(!localImplants || localImplants.length === 0) return;
        await Promise.all(
          localImplants
            .filter(item => item && item.id)
            .map(item => db.collection('implants').doc(item.id).set(toFirestoreImplantData(item), { merge: true }))
        );
      } catch(err){
        console.warn('Sync locale impianti verso Firebase non riuscita:', err);
      }
    }

    // Gestione opzioni dinamiche per modelli e nomenclature
    function loadImplantModels(){
      const saved = localStorage.getItem('implant_models');
      return saved ? JSON.parse(saved) : ['BLT', 'BL', 'BLX'];
    }

    function loadImplantNomenclatures(){
      const saved = localStorage.getItem('implant_nomenclatures');
      return saved ? JSON.parse(saved) : ['RN', 'RB', 'NC', 'RC'];
    }

    function loadKitComponents(){
      const saved = localStorage.getItem('kit_components');
      return saved ? JSON.parse(saved) : ['Frese chirurgiche'];
    }

    function saveKitComponent(component){
      if(!component || component.trim() === '') return;
      const components = loadKitComponents();
      const trimmedComponent = component.trim();
      if(!components.includes(trimmedComponent)){
        components.push(trimmedComponent);
        components.sort();
        localStorage.setItem('kit_components', JSON.stringify(components));
      }
    }

    function saveImplantModel(model, type){
      if(!model || model.trim() === '') return;
      const trimmedModel = model.trim();
      
      // Determina se Ã¨ un impianto o una componente
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const storageKey = isComponent ? 'implant_nomenclatures' : 'implant_models';
      const saved = localStorage.getItem(storageKey);
      const models = saved ? JSON.parse(saved) : [];
      
      if(!models.includes(trimmedModel)){
        models.push(trimmedModel);
        models.sort();
        localStorage.setItem(storageKey, JSON.stringify(models));
      }
    }

    function populateImplantModelSelect(){
      const select = document.getElementById('implantModel');
      const type = document.getElementById('implantType').value;
      
      // Carica la lista appropriata in base al tipo
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const models = isComponent ? loadImplantNomenclatures() : loadImplantModels();
      
      // Mantieni solo l'opzione vuota
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      // Aggiungi le opzioni salvate
      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        select.appendChild(option);
      });
    }

    function populateKitComponentsSelect(){
      const select = document.getElementById('implantKitComponents');
      const components = loadKitComponents();
      
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      components.forEach(component => {
        const option = document.createElement('option');
        option.value = component;
        option.textContent = component;
        select.appendChild(option);
      });
    }

    function addImplantToStorage(implant){
      const implants = loadImplantsFromStorage();
      const newImplant = {...implant, id: implant.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_implant_'+Date.now())};
      if(newImplant.orderDate instanceof Date) newImplant.orderDate = newImplant.orderDate.toISOString();
      if(newImplant.expiry instanceof Date) newImplant.expiry = newImplant.expiry.toISOString();
      implants.push(newImplant);
      saveImplantsToStorage(implants);
      return newImplant.id;
    }

    function updateImplantQuantity(id, delta){
      const implants = loadImplantsFromStorage();
      const item = implants.find(m=>m.id === id);
      if(item){
        item.quantity = Math.max(0, (item.quantity || 0) + delta);
        saveImplantsToStorage(implants);
        
        // Sync to Firebase
        if(firebaseReady && typeof db !== 'undefined'){
          const ref = db.collection('implants').doc(id);
          db.runTransaction(async tx=>{
            const doc = await tx.get(ref);
            if(!doc.exists) return;
            const q = Math.max(0, (doc.data().quantity || 0) + delta);
            tx.update(ref, {quantity: q});
          }).catch(err => {
            console.warn('Firebase update failed for implant quantity:', err);
          });
        }
      }
      renderImplantsList();
    }

    function deleteImplant(id){
      if(!confirm('Eliminare questo impianto?')) return;
      const implants = loadImplantsFromStorage();
      const filtered = implants.filter(m=>m.id !== id);
      saveImplantsToStorage(filtered);
      
      // Sync to Firebase
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('implants').doc(id).delete().catch(err => {
          console.warn('Firebase delete failed for implant:', err);
        });
      }
      
      renderImplantsList();
    }

    function renderImplantsList(){
      const implantsList = document.getElementById('implantsList');
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => i.model === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }
      
      // Ordina alfabeticamente per tipo e azienda
      implants.sort((a, b) => {
        const typeA = (a.type || '').toLowerCase();
        const typeB = (b.type || '').toLowerCase();
        const companyA = (a.company || '').toLowerCase();
        const companyB = (b.company || '').toLowerCase();
        
        if(typeA !== typeB) return typeA.localeCompare(typeB);
        return companyA.localeCompare(companyB);
      });
      
      implantsList.innerHTML = '';
      
      implants.forEach(implant=>{
        const tr = document.createElement('tr');
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString() : '-';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        
        // Semaforo scadenza
        let statusHtml = '';
        if(!expiry){
          statusHtml = '<span title="Nessuna scadenza" style="font-size:24px;cursor:help;">âšª</span>';
        } else {
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          if(days < 0) {
            statusHtml = '<span title="Scaduto il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
          } else if(mesi < 3) {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
          } else if(mesi < 6) {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸŸ¡</span>';
          } else {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸŸ¢</span>';
          }
        }
        
        // Badge quantitÃ 
        const qtyBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+implant.quantity+'</span>';
        
        // Mostra modello o componenti kit
        let modelDisplay = '-';
        if(implant.type === 'Kit chirurgico' && implant.kitComponents){
          modelDisplay = escapeHtml(implant.kitComponents);
        } else if(implant.model) {
          modelDisplay = escapeHtml(implant.model);
        }
        
        tr.innerHTML = `
          <td data-label="Tipo">${escapeHtml(implant.type)}</td>
          <td data-label="Azienda">${escapeHtml(implant.company)}</td>
          <td data-label="Modello">${modelDisplay}</td>
          <td data-label="Ã˜">${diameter}</td>
          <td data-label="L">${length}</td>
          <td data-label="Data ordine">${orderDate}</td>
          <td data-label="Scadenza" style="text-align:center;white-space:nowrap;">${statusHtml}</td>
          <td data-label="Prezzo">â‚¬ ${Number(implant.price||0).toFixed(2)}</td>
          <td data-label="QuantitÃ " style="text-align:center">${qtyBadge}</td>
          <td data-label="Azioni" style="white-space:nowrap">
            <button class="btn-action btn-inc" onclick="updateImplantQuantity('${implant.id}', 1)" title="Aggiungi 1">+</button>
            <button class="btn-action btn-dec" onclick="updateImplantQuantity('${implant.id}', -1)" title="Rimuovi 1">âˆ’</button>
            <button class="btn-action btn-del" onclick="deleteImplant('${implant.id}')" title="Elimina">Ã—</button>
          </td>
        `;
        implantsList.appendChild(tr);
      });
    }

    function toggleActionMenu(menuId){
      const menu = document.getElementById(menuId);
      const isVisible = menu.style.display !== 'none';
      
      // Nascondi tutti i menu aperti
      document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      
      // Mostra il menu corrente se non era visibile
      if(!isVisible){
        menu.style.display = 'block';
      }
    }

    // Chiudi i menu quando clicki fuori
    document.addEventListener('click', function(event){
      if(!event.target.closest('.action-menu-btn') && !event.target.closest('.action-menu')){
        document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      }
    });

    function openImplantsModal(){
      document.getElementById('implantsModal').classList.add('active');
      populateImplantModelSelect();
      populateKitComponentsSelect();
      initImplantFilters();
      renderImplantsList();
      syncLocalImplantsToFirebase();
    }

    function closeImplantsModal(){
      document.getElementById('implantsModal').classList.remove('active');
    }

    function initImplantFilters(){
      const implants = loadImplantsFromStorage();
      
      // Popola filtro aziende
      const companies = [...new Set(implants.map(i => i.company).filter(c => c))];
      const companyFilter = document.getElementById('implantCompanyFilter');
      companyFilter.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.sort().forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companyFilter.appendChild(option);
      });
      
      // Popola filtro modelli in base al tipo
      updateImplantModelFilter();
    }

    function updateImplantModelFilter(){
      const implants = loadImplantsFromStorage();
      const selectedType = currentImplantTypeFilter;
      const modelFilter = document.getElementById('implantModelFilter');
      const modelLabel = document.getElementById('implantModelFilterLabel');
      
      // Cambia etichetta in base al tipo
      const isScrew = selectedType === 'Vite tappo' || selectedType === 'Vite di guarigione';
      const isImplant = selectedType === 'Impianto';
      
      if(isScrew) {
        modelLabel.textContent = 'Filtra per nomenclatura:';
      } else if(isImplant) {
        modelLabel.textContent = 'Filtra per modello:';
      } else {
        modelLabel.textContent = 'Filtra per modello/nomenclatura:';
      }
      
      // Filtra modelli in base al tipo selezionato
      let filteredImplants = implants;
      if(selectedType !== 'Tutti'){
        filteredImplants = implants.filter(i => i.type === selectedType);
      }
      
      const models = [...new Set(filteredImplants.map(i => i.model).filter(m => m))];
      modelFilter.innerHTML = '<option value="Tutti">Tutti</option>';
      models.sort().forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelFilter.appendChild(option);
      });
      
      // Reset selezione se il modello corrente non Ã¨ piÃ¹ nella lista
      if(currentImplantModelFilter !== 'Tutti' && !models.includes(currentImplantModelFilter)){
        currentImplantModelFilter = 'Tutti';
        modelFilter.value = 'Tutti';
      }
    }


    // Request browser notification permission (optional)
    if ('Notification' in window){
      Notification.requestPermission().catch(()=>{});
    }

    function showAlert(text, type='info'){
      const d = document.createElement('div');
      d.className = 'alert ' + (type==='warn'?'warn':'info');
      d.textContent = text;
      alertsEl.appendChild(d);
      setTimeout(()=>d.remove(), 8000);
    }

    function notify(title, body){
      // Browser notification
      if (window.Notification && Notification.permission === 'granted'){
        new Notification(title, {body});
      }
      // in-app alert
      showAlert(title + ' â€” ' + body, 'warn');
    }

    function daysBetween(a,b){
      const ms = 24*60*60*1000;
      return Math.ceil((b-a)/ms);
    }

    function initCategoryFilters(){
      categoryFiltersEl.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'category-btn' + (cat === currentFilter ? ' active' : '');
        btn.textContent = cat;
        btn.addEventListener('click', ()=>{
          currentFilter = cat;
          updateCategoryFilters();
          renderFilteredMaterials();
        });
        categoryFiltersEl.appendChild(btn);
      });
      // Filtro aziende: menu a tendina
      if (companyFilterSelect) {
        const companies = Array.from(new Set(allDocs.map(doc => (doc.data().company || '').trim()).filter(c => c))).sort();
        companyFilterSelect.innerHTML = '<option value="Tutte">Tutte</option>';
        companies.forEach(comp => {
          if(comp) {
            const opt = document.createElement('option');
            opt.value = comp;
            opt.textContent = comp;
            companyFilterSelect.appendChild(opt);
          }
        });
        companyFilterSelect.value = currentCompanyFilter;
      }
      // Filtro distributori: menu a tendina
      if (distributorFilterSelect) {
        const distributors = Array.from(new Set(allDocs.map(doc => (doc.data().distributor || '').trim()).filter(c => c))).sort();
        distributorFilterSelect.innerHTML = '<option value="Tutti">Tutti</option>';
        distributors.forEach(dist => {
          if(dist) {
            const opt = document.createElement('option');
            opt.value = dist;
            opt.textContent = dist;
            distributorFilterSelect.appendChild(opt);
          }
        });
        distributorFilterSelect.value = currentDistributorFilter;
      }
    }

    function updateCategoryFilters(){
      const btns = categoryFiltersEl.querySelectorAll('.category-btn');
      btns.forEach(btn=>{
        if(btn.textContent === currentFilter){
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    // Rimosso updateCompanyFilters: non serve piÃ¹ con il select

    function loadMaterialsFromStorage(){
      const localData = loadFromLocalStorage();
      allDocs = localData.map(d=>({id: d.id, data: ()=>d}));
      initCategoryFilters();
      renderFilteredMaterials();
      checkAndNotify(allDocs);
      updateResetButtonVisibility();
    }

    function renderFilteredMaterials(){
      listEl.innerHTML = '';
      let filtered = currentFilter === 'Tutti' 
        ? allDocs 
        : allDocs.filter(doc=>doc.data().category === currentFilter);
      if(currentCompanyFilter !== 'Tutte'){
        filtered = filtered.filter(doc => (doc.data().company || '') === currentCompanyFilter);
      }
      if(currentDistributorFilter !== 'Tutti'){
        filtered = filtered.filter(doc => (doc.data().distributor || '') === currentDistributorFilter);
      }
      // Filtro scadenza semaforo
      if(currentExpiryFilter !== 'Tutte'){
        const now = new Date();
        filtered = filtered.filter(doc => {
          const data = doc.data();
          if(!data.expiry) return false;
          const expiry = data.expiry && data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry);
          const days = Math.ceil((expiry - now) / (1000*60*60*24));
          const mesi = days / 30.44;
          if(days < 0) return currentExpiryFilter === 'Rosso';
          if(mesi < 3) return currentExpiryFilter === 'Rosso';
          if(mesi < 6) return currentExpiryFilter === 'Giallo';
          return currentExpiryFilter === 'Verde';
        });
      }
      // Filtro quantitÃ  semaforo
      if(currentQuantityFilter !== 'Tutte'){
        filtered = filtered.filter(doc => {
          const data = doc.data();
          const soglia = data.lowStockThreshold || 2;
          if(currentQuantityFilter === 'Rosso') return (data.quantity||0) < soglia;
          if(currentQuantityFilter === 'Giallo') return (data.quantity||0) == soglia;
          if(currentQuantityFilter === 'Verde') return (data.quantity||0) > soglia;
          return true;
        });
      }
      
      // Ordina alfabeticamente per nome
      filtered.sort((a, b) => {
        const nameA = (a.data().name || '').toLowerCase();
        const nameB = (b.data().name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      filtered.forEach(doc=>{
        const tr = renderItem(doc);
        listEl.appendChild(tr);
      });
            // Gestione filtro quantitÃ  da select
            const quantityFilterSelect = document.getElementById('quantityFilterSelect');
            if (quantityFilterSelect) {
              quantityFilterSelect.addEventListener('change', function() {
                currentQuantityFilter = this.value;
                renderFilteredMaterials();
                updateResetButtonVisibility();
              });
            }
        // Gestione filtro scadenza da select
        const expiryFilterSelect = document.getElementById('expiryFilterSelect');
        if (expiryFilterSelect) {
          expiryFilterSelect.addEventListener('change', function() {
            currentExpiryFilter = this.value;
            renderFilteredMaterials();
            updateResetButtonVisibility();
          });
        }
    }

    // Funzione per convertire in Title Case (iniziali maiuscole)
    function toTitleCase(str) {
      return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    // Auto-fill categoria e azienda quando si completa il nome materiale
    let autoFillTimeout;
    document.getElementById('name').addEventListener('input', function() {
      clearTimeout(autoFillTimeout);
      const materialName = this.value.trim();
      
      autoFillTimeout = setTimeout(() => {
        if(materialName.length < 3) return;
        
        const materials = loadFromLocalStorage();
        const lowerName = materialName.toLowerCase();
        
        // Prima cerca match esatto
        let match = materials.find(m => m.name && m.name.toLowerCase() === lowerName);
        
        // Se non trova match esatto, cerca match parziale/simile
        if(!match) {
          match = materials.find(m => {
            if(!m.name) return false;
            const existingName = m.name.toLowerCase();
            // Match se uno contiene l'altro (errori di digitazione parziali)
            return existingName.includes(lowerName) || lowerName.includes(existingName);
          });
        }
        
        if(match) {
          // Correggi il nome con la versione corretta in Title Case
          const correctedName = toTitleCase(match.name);
          document.getElementById('name').value = correctedName;
          
          // Auto-fill categoria
          if(match.category) {
            document.getElementById('category').value = match.category;
          }
          
          // Auto-fill azienda
          if(match.company) {
            const companySelect = document.getElementById('companySelect');
            const companyInput = document.getElementById('company');
            
            const option = Array.from(companySelect.options).find(opt => opt.value === match.company);
            if(option) {
              companySelect.value = match.company;
              companyInput.style.display = 'none';
            } else {
              companySelect.value = 'Other';
              companyInput.value = match.company;
              companyInput.style.display = '';
            }
          }
        }
      }, 600); // Attiva dopo 600ms dalla fine della digitazione
    });

    addForm.addEventListener('submit', async e=>{
      e.preventDefault();
      console.log('Form submitted');
      
      const name = toTitleCase(document.getElementById('name').value.trim());
      const orderDate = document.getElementById('orderDate').value;
      const expiry = document.getElementById('expiry').value;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const quantity = parseInt(document.getElementById('quantity').value,10) || 0;
      const category = document.getElementById('category').value.trim();
        let distributor = document.getElementById('distributorSelect').value;
        if(distributor === 'Other') {
          distributor = document.getElementById('distributor').value.trim();
        }
        let company = document.getElementById('companySelect').value;
        if(company === 'Other') {
          company = document.getElementById('company').value.trim();
        }
      const notifyDays = 30;
      let lowStockThreshold = document.getElementById('lowStockThreshold').value;
      if(lowStockThreshold === 'Other') {
        lowStockThreshold = parseInt(document.getElementById('lowStockThresholdCustom').value,10) || 2;
      } else {
        lowStockThreshold = parseInt(lowStockThreshold,10) || 2;
      }
          // Gestione visibilitÃ  input soglia personalizzata
          document.getElementById('lowStockThreshold').addEventListener('change', function() {
            if(this.value === 'Other') {
              document.getElementById('lowStockThresholdCustom').style.display = '';
            } else {
              document.getElementById('lowStockThresholdCustom').style.display = 'none';
            }
          });
      
      if(!name || !orderDate || !expiry || !category) {
        console.log('Missing fields:', {name, orderDate, expiry, category});
        return;
      }
      
      const newData = {
        name, 
        orderDate: new Date(orderDate), 
        expiry: new Date(expiry), 
        price, 
        quantity, 
        category, 
          distributor, 
          company,
        notifyDays, 
        lowStockThreshold,
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      console.log('Saving material:', name);
      
      // ID unico condiviso tra locale e Firebase
      const materialId = window.crypto && window.crypto.randomUUID
        ? window.crypto.randomUUID()
        : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000));

      // Save to local storage
      const itemId = addToLocalStorage({id: materialId, ...newData});
      console.log('Saved with ID:', itemId);
      
      // Try Firebase sync (optional)
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(materialId).set(newData);
        } catch(err) {
          console.warn('Firebase unavailable:', err.message);
          showAlert('Materiale salvato in locale. Firebase non raggiungibile.', 'warn');
        }
      }
      
      // Reset and reload
      addForm.reset();
      document.getElementById('quantity').value = 1;
      showAlert('âœ“ ' + name + ' aggiunto', 'info');
      
      // Reload immediately
      setTimeout(loadMaterialsFromStorage, 100);
    });

    // Material Modal Form Handler
    document.getElementById('materialForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name = toTitleCase(document.getElementById('matName').value.trim());
      const orderDate = document.getElementById('matOrderDate').value;
      const expiry = document.getElementById('matExpiry').value;
      const price = parseFloat(document.getElementById('matPrice').value) || 0;
      const quantity = parseInt(document.getElementById('matQuantity').value,10) || 0;
      const category = document.getElementById('matCategory').value.trim();
      const distributor = document.getElementById('matDistributor').value.trim();
      const company = document.getElementById('matCompany').value.trim();
      const lowStockThreshold = parseInt(document.getElementById('matLowStock').value,10) || 2;
      const notifyDays = 30;
      
      if(!name || !orderDate || !expiry || !category) {
        showAlert('Compila tutti i campi richiesti', 'warn');
        return;
      }
      
      const newData = {
        name, 
        orderDate: new Date(orderDate), 
        expiry: new Date(expiry), 
        price, 
        quantity, 
        category, 
        distributor, 
        company,
        notifyDays, 
        lowStockThreshold,
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      const materialId = window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000));
      
      addToLocalStorage({id: materialId, ...newData});
      
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(materialId).set(newData);
        } catch(err) {
          console.warn('Firebase unavailable:', err.message);
        }
      }
      
      closeMaterialModal();
      showAlert('âœ“ ' + name + ' aggiunto', 'info');
      setTimeout(loadMaterialsFromStorage, 100);
    });

    function renderItem(doc){
      const data = doc.data();
      const tr = document.createElement('tr');
      const now = new Date();
      const orderDate = data.orderDate ? (data.orderDate.toDate ? data.orderDate.toDate() : new Date(data.orderDate)) : null;
      const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
      let statusHtml = '';
      if(!expiry){
        statusHtml = '<span title="Nessuna scadenza" style="font-size:24px;cursor:help;">âšª</span>';
      } else {
        const days = daysBetween(now, expiry);
        const mesi = days / 30.44;
        if(days < 0) {
          statusHtml = '<span title="Scaduto il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
        } else if(days <= 30) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸŸ¡</span>';
        } else if(mesi < 3) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
        } else if(mesi < 6) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸŸ¡</span>';
        } else {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">ğŸŸ¢</span>';
        }
      }
      // Badge semaforo quantitÃ 
      let lowBadge = '';
      const soglia = data.lowStockThreshold || 2;
      if (data.quantity < soglia) {
        lowBadge = '<span class="badge low" style="background:#d32f2f;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else if (data.quantity == soglia) {
        lowBadge = '<span class="badge soon" style="background:#fbc02d;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else {
        lowBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      }
      
      const expandBtnId = 'expand_' + doc.id;
      const batchDetailId = 'batch_' + doc.id;
      
      tr.innerHTML = `
        <td data-label="Nome"><button class="batch-expand-btn" id="${expandBtnId}" style="margin-right:8px">â–¶</button><span class="editable-name" style="cursor:pointer;text-decoration:underline;">${escapeHtml(data.name)}</span></td>
        <td data-label="Data ordine">${orderDate ? orderDate.toLocaleDateString() : '-'}</td>
        <td data-label="Scadenza" style="text-align:center;white-space:nowrap;">${statusHtml}</td>
        <td data-label="Prezzo">â‚¬ ${Number(data.price).toFixed(2)}</td>
        <td data-label="Distributore">${escapeHtml(data.distributor||'-')}</td>
        <td data-label="Azienda">${escapeHtml(data.company||'-')}</td>
        <td data-label="QuantitÃ " style="text-align:center;">${lowBadge}</td>
        <td data-label="Azioni" style="white-space:nowrap;padding:8px;">
          <button data-id="${doc.id}" class="btn-action btn-inc" title="Aggiungi 1">+</button>
          <button data-id="${doc.id}" class="btn-action btn-dec" title="Rimuovi 1">âˆ’</button>
          <button data-id="${doc.id}" class="btn-action btn-del" title="Elimina">Ã—</button>
        </td>
      `;
      
      // attach actions
      tr.querySelector('.btn-inc').addEventListener('click', (e)=>{e.preventDefault(); changeQuantity(doc.id, 1)});
      tr.querySelector('.btn-dec').addEventListener('click', (e)=>{e.preventDefault(); changeQuantity(doc.id, -1)});
      tr.querySelector('.btn-del').addEventListener('click', (e)=>{e.preventDefault(); deleteItem(doc.id)});
      tr.querySelector('.editable-name').addEventListener('click', () => {
        const newName = prompt('Modifica nome materiale:', data.name);
        if(newName && newName.trim() && newName !== data.name) {
          const formattedName = toTitleCase(newName.trim());
          data.name = formattedName;
          updateMaterialFields(doc.id, { name: formattedName });
        }
      });
      
      // Expand button per batch
      const expandBtn = tr.querySelector('#' + expandBtnId);
      expandBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const batchDetail = document.getElementById(batchDetailId);
        if (batchDetail) {
          batchDetail.classList.toggle('show');
          expandBtn.textContent = batchDetail.classList.contains('show') ? 'â–¼' : 'â–¶';
        }
      });
      
      // Crea riga batch details (nascosta)
      const batchDetailRow = document.createElement('tr');
      batchDetailRow.id = batchDetailId;
      batchDetailRow.className = 'batch-details';
      
      const batches = data.batches || [];
      let batchesHtml = '<div class="batches-list">';
      
      if (batches.length === 0) {
        batchesHtml += '<div style="color:#666;font-size:13px">Nessun batch disponibile</div>';
      } else {
        batches.forEach(batch => {
          const batchExpiry = batch.scadenza ? new Date(batch.scadenza) : null;
          const batchDays = batchExpiry ? daysBetween(now, batchExpiry) : null;
          
          let expiryClass = 'expiry-ok';
          if (batchDays !== null && batchDays < 0) expiryClass = 'expiry-critical';
          else if (batchDays !== null && batchDays < 90) expiryClass = 'expiry-warn';
          
          batchesHtml += `
            <div class="batch-card">
              <div class="batch-card-header">
                <div><strong>${batch.batchId}</strong></div>
                <div>Ordine: ${batch.dataOrdine}</div>
                <div>Scade: ${batchExpiry ? batchExpiry.toLocaleDateString() : 'N/A'}</div>
                <div><span class="expiry-status ${expiryClass}">${batch.quantitÃ Rimanente}/${batch.quantitÃ } pz</span></div>
              </div>
              <div style="font-size:12px;color:#666;margin-top:6px">
                Prezzo: â‚¬${batch.prezzo.toFixed(2)} | Ordine ID: ${batch.ordinoId || 'N/A'}
              </div>
          `;
          
          if (batch.consumptions && batch.consumptions.length > 0) {
            batchesHtml += '<div class="consumption-history">ğŸ“‰ Consumi: ';
            batch.consumptions.forEach(c => {
              batchesHtml += `${c.quantitÃ }pz (${c.data}) `;
            });
            batchesHtml += '</div>';
          }
          
          batchesHtml += '</div>';
        });
      }
      
      batchesHtml += '</div>';
      batchDetailRow.innerHTML = `<td colspan="8">${batchesHtml}</td>`;
      
      // Insert batch row after material row
      setTimeout(() => {
        if (tr.parentNode) {
          tr.parentNode.insertBefore(batchDetailRow, tr.nextSibling);
        }
      }, 0);
      
      return tr;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function changeQuantity(id, delta){
      updateQuantityLocalStorage(id, delta);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        const ref = db.collection('materials').doc(id);
        db.runTransaction(async tx=>{
          const doc = await tx.get(ref);
          if(!doc.exists) return;
          const q = (doc.data().quantity||0) + delta;
          tx.update(ref,{quantity: q});
        }).catch(()=>{});
      }
    }

    function deleteItem(id){
      if(!confirm('Eliminare questo elemento?')) return;
      deleteFromLocalStorage(id);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('materials').doc(id).delete().catch(()=>{});
      }
    }

    function startRealtimeListeners(){
      if(realtimeListenersStarted) return;
      realtimeListenersStarted = true;

      // Listen realtime with Firebase fallback to localStorage
      try {
        db.collection('materials').orderBy('name').onSnapshot(
          snapshot => {
            saveToLocalStorage(snapshot.docs);
            allDocs = loadFromLocalStorage().map(d=>({id: d.id, data: ()=>d}));
            initCategoryFilters();
            renderFilteredMaterials();
            checkAndNotify(allDocs);
          },
          error => {
            console.warn('Firebase error, usando localStorage:', error);
            loadMaterialsFromStorage();
          }
        );
      } catch(err) {
        firebaseReady = false;
        console.warn('Firebase init error, usando localStorage:', err);
        loadMaterialsFromStorage();
      }

      // Listen realtime for implants
      try {
        db.collection('implants').onSnapshot(
          snapshot => {
            const cloudImplants = snapshot.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                type: data.type,
                company: data.company,
                model: data.model,
                kitComponents: data.kitComponents,
                diameter: data.diameter,
                length: data.length,
                orderDate: data.orderDate && data.orderDate.toDate ? data.orderDate.toDate().toISOString() : data.orderDate,
                expiry: data.expiry && data.expiry.toDate ? data.expiry.toDate().toISOString() : data.expiry,
                price: data.price,
                quantity: data.quantity,
                createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt
              };
            });

            const localImplants = loadImplantsFromStorage();
            const mergedMap = new Map();

            cloudImplants.forEach(item => {
              if(item && item.id) mergedMap.set(item.id, item);
            });

            const missingOnCloud = [];
            localImplants.forEach(item => {
              if(!item || !item.id) return;
              if(!mergedMap.has(item.id)){
                mergedMap.set(item.id, item);
                missingOnCloud.push(item);
              }
            });

            const mergedImplants = Array.from(mergedMap.values());
            saveImplantsToStorage(mergedImplants);

            if(missingOnCloud.length > 0){
              Promise.all(
                missingOnCloud.map(item =>
                  db.collection('implants').doc(item.id).set(toFirestoreImplantData(item), { merge: true })
                )
              ).catch(err => {
                console.warn('Sync local->firebase impianti non completata:', err);
              });
            }

            if(document.getElementById('implantsModal').classList.contains('active')){
              renderImplantsList();
            }
          },
          error => {
            console.warn('Firebase error for implants, usando localStorage:', error);
          }
        );
      } catch(err) {
        console.warn('Firebase init error for implants, usando localStorage:', err);
      }

      // keep allMaterials updated for exports
      try {
        db.collection('materials').orderBy('name').onSnapshot(snapshot=>{
          allMaterials = snapshot.docs.map(doc=>({id: doc.id, ...doc.data()}));
        }, ()=>{
          allMaterials = loadFromLocalStorage();
        });
      } catch(err) {
        allMaterials = loadFromLocalStorage();
      }

      syncLocalImplantsToFirebase();
    }
    
    // Gestione visibilitÃ  input azienda e distributore personalizzati
    document.getElementById('companySelect').addEventListener('change', function() {
      if(this.value === 'Other') {
        document.getElementById('company').style.display = '';
      } else {
        document.getElementById('company').style.display = 'none';
      }
    });
    document.getElementById('distributorSelect').addEventListener('change', function() {
      if(this.value === 'Other') {
        document.getElementById('distributor').style.display = '';
      } else {
        document.getElementById('distributor').style.display = 'none';
      }
    });

    // Gestione filtro azienda da select
    if (companyFilterSelect) {
      companyFilterSelect.addEventListener('change', function() {
        currentCompanyFilter = this.value;
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }
    // Gestione filtro distributore da select
    if (distributorFilterSelect) {
      distributorFilterSelect.addEventListener('change', function() {
        currentDistributorFilter = this.value;
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }

    // Funzione per controllare visualizzazione pulsante reset
    function updateResetButtonVisibility() {
      const resetBtn = document.getElementById('resetFiltersBtn');
      const hasActiveFilters = 
        currentExpiryFilter !== 'Tutte' ||
        currentQuantityFilter !== 'Tutte' ||
        currentCompanyFilter !== 'Tutte' ||
        currentDistributorFilter !== 'Tutti';
      
      if (hasActiveFilters) {
        resetBtn.classList.remove('hidden');
      } else {
        resetBtn.classList.add('hidden');
      }
    }

    // Reset filtri
    const resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        document.getElementById('expiryFilterSelect').value = 'Tutte';
        document.getElementById('quantityFilterSelect').value = 'Tutte';
        document.getElementById('companyFilterSelect').value = 'Tutte';
        document.getElementById('distributorFilterSelect').value = 'Tutti';
        
        currentExpiryFilter = 'Tutte';
        currentQuantityFilter = 'Tutte';
        currentCompanyFilter = 'Tutte';
        currentDistributorFilter = 'Tutti';
        
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }

    // Load initial data from localStorage on page load
    window.addEventListener('load', ()=>{
      loadMaterialsFromStorage();
    });

    function checkAndNotify(docs){
      const now = new Date();
      docs.forEach(doc=>{
        const data = doc.data();
        const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
        // expiry notifications
        if(expiry){
          const days = daysBetween(now, expiry);
          const key = doc.id + ':expiry';
          if(days < 0){
            if(!notified.get(key)){
              notify('Materiale scaduto: '+data.name, 'Scaduto il '+expiry.toLocaleDateString());
              notified.set(key, true);
            }
          } else if(days <= 30){
            if(!notified.get(key)){
              notify('Scadenza prossima: '+data.name, 'Scade tra '+days+' giorni ('+expiry.toLocaleDateString()+')');
              notified.set(key, true);
            }
          } else {
            notified.delete(key);
          }
        }
        // low stock notifications
        const key2 = doc.id + ':low';
        const soglia = data.lowStockThreshold || 2;
        if((data.quantity||0) < soglia){
          if(!notified.get(key2)){
            notify('QuantitÃ  bassa: '+data.name, 'QuantitÃ  = '+(data.quantity||0));
            notified.set(key2, true);
          }
        } else notified.delete(key2);
      });
    }

    // periodic check (every 5 minutes)
    setInterval(async ()=>{
      if(!firebaseReady || typeof db === 'undefined') {
        checkAndNotify(allDocs);
        return;
      }
      try {
        const snap = await db.collection('materials').get();
        checkAndNotify(snap.docs);
      } catch {
        checkAndNotify(allDocs);
      }
    }, 5*60*1000);

    let allMaterials = []; // store materials for PDF export

    // fallback iniziale in attesa dei listener realtime
    allMaterials = loadFromLocalStorage();

    function generateTablePDF(title, filename, headers, rows, summaryLines, columnWidths){
      const JsPdfCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
      if(!JsPdfCtor){
        showAlert('Libreria PDF non disponibile', 'warn');
        return;
      }

      const doc = new JsPdfCtor({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 10;
      const tableWidth = pageWidth - (margin * 2);
      const colCount = headers.length;
      const baseWidths = Array.isArray(columnWidths) && columnWidths.length === colCount
        ? columnWidths.slice()
        : new Array(colCount).fill(1);
      const baseTotal = baseWidths.reduce((sum, w) => sum + w, 0) || colCount;
      const scaledWidths = baseWidths.map(w => (w / baseTotal) * tableWidth);
      const rowHeight = 6;
      let y = margin;

      function fitText(value, maxWidth){
        const original = value === null || value === undefined ? '' : String(value);
        let text = original;
        while(text.length > 0 && doc.getTextWidth(text) > maxWidth){
          text = text.slice(0, -1);
        }
        if(text !== original){
          text = text.slice(0, Math.max(0, text.length - 1)) + 'â€¦';
        }
        return text;
      }

      function drawHeaderBlock(){
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 61, 122);
        doc.text(title, margin, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        doc.text('Esportazione del: ' + new Date().toLocaleDateString(), margin, y);
        y += 6;
      }

      function drawTableHeader(){
        const headerFill = [0, 61, 122];
        const headerText = [255, 255, 255];
        const headerBorder = [0, 61, 122];
        let xCursor = margin;
        headers.forEach((header, index) => {
          const colWidth = scaledWidths[index];
          doc.setFillColor(headerFill[0], headerFill[1], headerFill[2]);
          doc.setTextColor(headerText[0], headerText[1], headerText[2]);
          doc.setDrawColor(headerBorder[0], headerBorder[1], headerBorder[2]);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8.5);
          doc.rect(xCursor, y, colWidth, rowHeight, 'F');
          doc.rect(xCursor, y, colWidth, rowHeight);
          doc.text(fitText(header, colWidth - 2), xCursor + 1, y + 4);
          xCursor += colWidth;
        });
        y += rowHeight;
      }

      function ensureSpace(required){
        if(y + required > pageHeight - margin){
          doc.addPage();
          y = margin;
          drawHeaderBlock();
          drawTableHeader();
        }
      }

      drawHeaderBlock();
      drawTableHeader();

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8.5);
      doc.setTextColor(20, 20, 20);
      rows.forEach((row, rowIndex) => {
        ensureSpace(rowHeight);
        const fill = rowIndex % 2 === 0 ? 252 : 245;
        let xCursor = margin;
        row.forEach((cell, index) => {
          const colWidth = scaledWidths[index];
          doc.setFillColor(fill, fill, fill);
          doc.rect(xCursor, y, colWidth, rowHeight, 'F');
          doc.setDrawColor(220, 220, 220);
          doc.rect(xCursor, y, colWidth, rowHeight);
          doc.text(fitText(cell, colWidth - 2), xCursor + 1, y + 4);
          xCursor += colWidth;
        });
        y += rowHeight;
      });

      if(Array.isArray(summaryLines) && summaryLines.length){
        ensureSpace((summaryLines.length * 5) + 4);
        y += 3;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        summaryLines.forEach(line => {
          doc.text(line, margin, y);
          y += 5;
        });
      }

      doc.save(filename);
    }

    async function downloadMaterialsPDF(){
      const visibleRows = Array.from(document.querySelectorAll('#list tr'));
      const allMaterials = visibleRows.map(row => {
        const cells = row.querySelectorAll('td');
        const statusCell = cells[2];
        const statusBadge = statusCell ? statusCell.querySelector('span') : null;
        const statusTitle = statusBadge ? (statusBadge.getAttribute('title') || '').trim() : '';
        const expiryDateMatch = statusTitle.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})/);
        const expiryStatus = expiryDateMatch ? expiryDateMatch[1] : '-';
        const qtyText = (cells[6]?.textContent || '0').replace(/[^\d-]/g, '');
        const priceRaw = (cells[3]?.textContent || '0').replace(/[^\d,.-]/g, '').replace(',', '.');
        return {
          name: (cells[0]?.textContent || '-').trim(),
          orderDate: (cells[1]?.textContent || '-').trim(),
          expiryStatus: expiryStatus,
          priceText: (cells[3]?.textContent || 'â‚¬ 0.00').trim(),
          distributor: (cells[4]?.textContent || '-').trim(),
          company: (cells[5]?.textContent || '-').trim(),
          quantity: parseInt(qtyText || '0', 10) || 0,
          priceValue: parseFloat(priceRaw || '0') || 0
        };
      });

      if(allMaterials.length === 0){
        showAlert('Nessun materiale visibile da esportare', 'warn');
        return;
      }
      const headers = ['Nome', 'Data Ordine', 'Scadenza', 'Prezzo (â‚¬)', 'Distributore', 'Azienda', 'QuantitÃ '];
      const rows = allMaterials.map(item => [
        item.name || '-',
        item.orderDate || '-',
        item.expiryStatus || '-',
        item.priceText || 'â‚¬ 0.00',
        item.distributor || '-',
        item.company || '-',
        String(item.quantity || 0)
      ]);
      const summaryLines = [
        'Totale materiali: ' + allMaterials.length,
        'Valore totale: â‚¬ ' + allMaterials.reduce((sum, m)=>(sum + (m.priceValue||0) * (m.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Materiali',
        'materiali_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [18, 14, 14, 12, 18, 18, 8]
      );
      showAlert('âœ“ PDF Materiali scaricato con successo', 'info');
    }

    async function downloadImplantsPDF(){
      // Applica gli stessi filtri che sono visualizzati nella tabella impianti
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => i.model === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }

      // Se nessun filtro Ã¨ impostato, includi tutti i dati
      if(implants.length === 0){
        const hasActiveFilters = currentImplantTypeFilter !== 'Tutti' || 
                                 currentImplantCompanyFilter !== 'Tutte' || 
                                 currentImplantModelFilter !== 'Tutti' || 
                                 currentImplantExpiryFilter !== 'Tutte';
        
        if(hasActiveFilters){
          showAlert('Nessun impianto da esportare con i filtri selezionati', 'warn');
          return;
        } else {
          // Nessun filtro attivo - carica tutto da localStorage come fallback
          implants = loadImplantsFromStorage() || [];
          if(!implants || implants.length === 0){
            showAlert('Nessun impianto da esportare', 'warn');
            return;
          }
        }
      }

      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }

      const headers = ['Tipo', 'Azienda', 'Modello', 'Ã˜', 'L', 'Ordine', 'Scadenza', 'Prezzo', 'Qta'];
      const rows = implants.map(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString() : '-';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const expiryDate = expiry ? expiry.toLocaleDateString() : '-';
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        const modelValue = implant.type === 'Kit chirurgico'
          ? (implant.kitComponents ? escapeHtml(implant.kitComponents) : '-')
          : (implant.model ? escapeHtml(implant.model) : '-');
        return [
          escapeHtml(implant.type),
          escapeHtml(implant.company),
          modelValue,
          diameter,
          length,
          orderDate,
          expiryDate,
          'â‚¬ ' + Number(implant.price || 0).toFixed(2),
          String(implant.quantity || 0)
        ];
      });
      const summaryLines = [
        'Totale impianti: ' + implants.length,
        'Valore totale: â‚¬ ' + implants.reduce((sum, i)=>(sum + (parseFloat(i.price)||0) * (i.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Impianti',
        'impianti_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [18, 20, 24, 6, 6, 12, 14, 10, 6]
      );
      showAlert('âœ“ PDF Impianti scaricato con successo', 'info');
    }

    async function downloadPDF(){
      downloadMaterialsPDF();
    }

    // --- BACKUP & RESTORE ---
    function exportBackup(){
      const materials = loadFromLocalStorage();
      const implants = loadImplantsFromStorage();
      const implantModels = loadImplantModels();
      const implantNomenclatures = loadImplantNomenclatures();
      const kitComponents = loadKitComponents();
      
      const backup = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: {
          materials: materials,
          implants: implants,
          implantModels: implantModels,
          implantNomenclatures: implantNomenclatures,
          kitComponents: kitComponents
        }
      };
      
      const dataStr = JSON.stringify(backup, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'backup_magazzino_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ Backup scaricato con successo', 'info');
    }
    
    function importBackup(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e){
        try {
          const backup = JSON.parse(e.target.result);
          
          if(!backup.data){
            showAlert('File di backup non valido', 'warn');
            return;
          }
          
          if(!confirm('ATTENZIONE: Importando il backup, tutti i dati correnti verranno sostituiti. Continuare?')){
            return;
          }
          
          // Importa materiali
          if(backup.data.materials && Array.isArray(backup.data.materials)){
            localStorage.setItem('magazzino', JSON.stringify(backup.data.materials));
          }
          
          // Importa impianti
          if(backup.data.implants && Array.isArray(backup.data.implants)){
            localStorage.setItem('magazzino_implants', JSON.stringify(backup.data.implants));
          }
          
          // Importa modelli
          if(backup.data.implantModels && Array.isArray(backup.data.implantModels)){
            localStorage.setItem('implant_models', JSON.stringify(backup.data.implantModels));
          }
          
          // Importa nomenclature
          if(backup.data.implantNomenclatures && Array.isArray(backup.data.implantNomenclatures)){
            localStorage.setItem('implant_nomenclatures', JSON.stringify(backup.data.implantNomenclatures));
          }
          
          // Importa componenti kit
          if(backup.data.kitComponents && Array.isArray(backup.data.kitComponents)){
            localStorage.setItem('kit_components', JSON.stringify(backup.data.kitComponents));
          }
          
          // Sincronizza con Firebase se disponibile
          if(firebaseReady && typeof db !== 'undefined'){
            // Sincronizza materiali
            if(backup.data.materials){
              backup.data.materials.forEach(async material => {
                try {
                  const materialData = {...material};
                  delete materialData.id;
                  if(materialData.orderDate && typeof materialData.orderDate === 'string'){
                    materialData.orderDate = new Date(materialData.orderDate);
                  }
                  if(materialData.expiry && typeof materialData.expiry === 'string'){
                    materialData.expiry = new Date(materialData.expiry);
                  }
                  if(materialData.createdAt && typeof materialData.createdAt === 'string'){
                    materialData.createdAt = new Date(materialData.createdAt);
                  }
                  if(materialData.updatedAt && typeof materialData.updatedAt === 'string'){
                    materialData.updatedAt = new Date(materialData.updatedAt);
                  }
                  await db.collection('materials').doc(material.id).set(materialData);
                } catch(err){
                  console.warn('Errore sync materiale:', err);
                }
              });
            }
            
            // Sincronizza impianti
            if(backup.data.implants){
              backup.data.implants.forEach(async implant => {
                try {
                  const implantData = {...implant};
                  delete implantData.id;
                  if(implantData.orderDate && typeof implantData.orderDate === 'string'){
                    implantData.orderDate = new Date(implantData.orderDate);
                  }
                  if(implantData.expiry && typeof implantData.expiry === 'string'){
                    implantData.expiry = new Date(implantData.expiry);
                  }
                  if(implantData.createdAt && typeof implantData.createdAt === 'string'){
                    implantData.createdAt = new Date(implantData.createdAt);
                  }
                  await db.collection('implants').doc(implant.id).set(implantData);
                } catch(err){
                  console.warn('Errore sync impianto:', err);
                }
              });
            }
          }
          
          showAlert('âœ“ Backup importato con successo! Ricarica la pagina.', 'info');
          
          // Ricarica la pagina dopo 2 secondi
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          
        } catch(err) {
          console.error('Errore importazione backup:', err);
          showAlert('Errore durante l\'importazione del backup', 'warn');
        }
      };
      
      reader.readAsText(file);
      // Reset input file
      event.target.value = '';
    }

    // --- CSV EXPORTS ---
    function exportMaterialsCSV(){
      const materials = loadFromLocalStorage();
      if(!materials || materials.length === 0){
        showAlert('Nessun materiale da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Nome', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'QuantitÃ ', 'Categoria', 'Distributore', 'Azienda', 'Soglia Bassa', 'Giorni Notifica'];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      materials.forEach(material => {
        const orderDate = material.orderDate ? new Date(material.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = material.expiry ? new Date(material.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          material.id || '',
          '"' + (material.name || '').replace(/"/g, '""') + '"',
          orderDate,
          expiry,
          Number(material.price || 0).toFixed(2),
          material.quantity || 0,
          '"' + (material.category || '').replace(/"/g, '""') + '"',
          '"' + (material.distributor || '').replace(/"/g, '""') + '"',
          '"' + (material.company || '').replace(/"/g, '""') + '"',
          material.lowStockThreshold || 2,
          material.notifyDays || 30
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'materiali_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Materiali scaricato con successo', 'info');
    }
    
    function exportImplantsCSV(){
      const implants = loadImplantsFromStorage();
      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Tipo', 'Azienda', 'Modello', 'Componenti Kit', 'Diametro (mm)', 'Lunghezza (mm)', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'QuantitÃ '];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      implants.forEach(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = implant.expiry ? new Date(implant.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          implant.id || '',
          '"' + (implant.type || '').replace(/"/g, '""') + '"',
          '"' + (implant.company || '').replace(/"/g, '""') + '"',
          '"' + (implant.model || '').replace(/"/g, '""') + '"',
          '"' + (implant.kitComponents || '').replace(/"/g, '""') + '"',
          implant.diameter || '',
          implant.length || '',
          orderDate,
          expiry,
          Number(implant.price || 0).toFixed(2),
          implant.quantity || 0
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'impianti_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Impianti scaricato con successo', 'info');
    }

    // --- IMPLANTS EVENT LISTENERS ---
    document.getElementById('implantsBtn').addEventListener('click', openImplantsModal);
    
    // Gestione campi custom per impianti
    document.getElementById('implantCompany').addEventListener('change', function() {
      const custom = document.getElementById('implantCompanyCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantModel').addEventListener('change', function() {
      const customInput = document.getElementById('implantModelCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantKitComponents').addEventListener('change', function() {
      const customInput = document.getElementById('implantKitComponentsCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantDiameter').addEventListener('change', function() {
      const custom = document.getElementById('implantDiameterCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantLength').addEventListener('change', function() {
      const custom = document.getElementById('implantLengthCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    // Mostra/nascondi campi in base al tipo di impianto
    document.getElementById('implantType').addEventListener('change', function() {
      const type = this.value;
      const isImplant = type === 'Impianto';
      const isScrew = type === 'Vite tappo' || type === 'Vite di guarigione';
      const isKit = type === 'Kit chirurgico';
      
      const modelGroup = document.getElementById('implantModelGroup');
      const modelLabel = modelGroup.querySelector('label');
      
      // Cambia etichetta in base al tipo
      if(isScrew) {
        modelLabel.textContent = 'Nomenclatura';
      } else if(isImplant) {
        modelLabel.textContent = 'Modello';
      } else {
        modelLabel.textContent = 'Modello / Nomenclatura';
      }
      
      modelGroup.style.display = (isImplant || isScrew) ? '' : 'none';
      document.getElementById('implantDiameterGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantLengthGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantKitComponentsGroup').style.display = isKit ? '' : 'none';
      
      // Ricarica le opzioni appropriate
      populateImplantModelSelect();
    });

    // Event listeners per i filtri impianti
    document.getElementById('implantTypeFilter').addEventListener('change', function() {
      currentImplantTypeFilter = this.value;
      updateImplantModelFilter(); // Aggiorna il filtro modello in base al tipo
      renderImplantsList();
    });
    
    document.getElementById('implantCompanyFilter').addEventListener('change', function() {
      currentImplantCompanyFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantModelFilter').addEventListener('change', function() {
      currentImplantModelFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantExpiryFilter').addEventListener('change', function() {
      currentImplantExpiryFilter = this.value;
      renderImplantsList();
    });

    // Submit form impianti
    document.getElementById('implantForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const type = document.getElementById('implantType').value;
      let company = document.getElementById('implantCompany').value;
      if(company === 'Other') company = document.getElementById('implantCompanyCustom').value.trim();
      
      // Prendi il valore dall'input personalizzato (sempre visibile ora)
      let model = document.getElementById('implantModelCustom').value.trim();
      if(!model) {
        model = document.getElementById('implantModel').value;
      }
      
      // Salva il modello/nomenclatura nelle opzioni per usi futuri
      if(model) {
        saveImplantModel(model, type);
      }
      
      // Prendi i componenti del kit se il tipo Ã¨ Kit chirurgico
      let kitComponents = null;
      if(type === 'Kit chirurgico') {
        kitComponents = document.getElementById('implantKitComponentsCustom').value.trim();
        if(!kitComponents) {
          kitComponents = document.getElementById('implantKitComponents').value;
        }
        // Salva i componenti nelle opzioni per usi futuri
        if(kitComponents) {
          saveKitComponent(kitComponents);
        }
      }
      
      let diameter = document.getElementById('implantDiameter').value;
      if(diameter === 'Other') diameter = document.getElementById('implantDiameterCustom').value;
      
      let length = document.getElementById('implantLength').value;
      if(length === 'Other') length = document.getElementById('implantLengthCustom').value;
      
      const orderDate = document.getElementById('implantOrderDate').value;
      const expiry = document.getElementById('implantExpiry').value;
      const price = parseFloat(document.getElementById('implantPrice').value) || 0;
      const quantity = parseInt(document.getElementById('implantQuantity').value, 10) || 0;

      const newImplant = {
        type,
        company,
        model: model || null,
        kitComponents: kitComponents || null,
        diameter: diameter || null,
        length: length || null,
        orderDate: new Date(orderDate),
        expiry: expiry ? new Date(expiry) : null,
        price,
        quantity,
        createdAt: new Date()
      };

      const implantId = addImplantToStorage(newImplant);
      
      // Sync to Firebase (optional)
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('implants').doc(implantId).set(newImplant);
        } catch(err) {
          console.warn('Firebase sync failed for implant:', err.message);
        }
      }

      document.getElementById('implantForm').reset();
      document.getElementById('implantQuantity').value = 1;
      showAlert('âœ“ Impianto aggiunto', 'info');
      initImplantFilters(); // Aggiorna i filtri
      renderImplantsList();
    });

    // ===== ANALISI SPESE FUNCTIONS =====
    let reportCharts = { trend: null, distribution: null };

    function openReportModal() {
      const modal = document.getElementById('reportModal');
      modal.classList.add('active');
      setTimeout(() => initReportFilters(), 100);
    }

    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      modal.classList.remove('active');
      if (reportCharts.trend) reportCharts.trend.destroy();
      if (reportCharts.distribution) reportCharts.distribution.destroy();
    }

    function initReportFilters() {
      const materials = loadFromLocalStorage();
      
      // Popola categorie
      const categories = Array.from(new Set(materials.map(m => m.category).filter(c => c))).sort();
      const categorySelect = document.getElementById('reportCategoryFilter');
      categorySelect.innerHTML = '<option value="Tutti">Tutti</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

      // Popola aziende
      const companies = Array.from(new Set(materials.map(m => m.company).filter(c => c))).sort();
      const companySelect = document.getElementById('reportCompanyFilter');
      companySelect.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp;
        opt.textContent = comp;
        companySelect.appendChild(opt);
      });

      // Popola distributori
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(d => d))).sort();
      const distributorSelect = document.getElementById('reportDistributorFilter');
      distributorSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      distributors.forEach(dist => {
        const opt = document.createElement('option');
        opt.value = dist;
        opt.textContent = dist;
        distributorSelect.appendChild(opt);
      });

      updateReportData();
    }

    function getFilteredReportData() {
      const materials = loadFromLocalStorage();
      const categoryFilter = document.getElementById('reportCategoryFilter').value;
      const companyFilter = document.getElementById('reportCompanyFilter').value;
      const distributorFilter = document.getElementById('reportDistributorFilter').value;

      return materials.filter(m => {
        if (categoryFilter !== 'Tutti' && m.category !== categoryFilter) return false;
        if (companyFilter !== 'Tutte' && m.company !== companyFilter) return false;
        if (distributorFilter !== 'Tutti' && m.distributor !== distributorFilter) return false;
        return true;
      });
    }

    function updateReportData() {
      const filtered = getFilteredReportData();
      
      // Calcola statistiche
      const totalExpense = filtered.reduce((sum, m) => sum + ((m.price || 0) * (m.quantity || 1)), 0);
      const orderCount = filtered.length;
      const avgPrice = orderCount > 0 ? totalExpense / orderCount : 0;
      
      // Top categoria
      const categoryExpense = {};
      filtered.forEach(m => {
        const cat = m.category || 'Non categorizzato';
        categoryExpense[cat] = (categoryExpense[cat] || 0) + ((m.price || 0) * (m.quantity || 1));
      });
      const topCategory = Object.entries(categoryExpense).sort((a, b) => b[1] - a[1])[0]?.[0] || '--';

      document.getElementById('reportTotalExpense').textContent = 'â‚¬ ' + totalExpense.toFixed(2);
      document.getElementById('reportOrderCount').textContent = orderCount;
      document.getElementById('reportAveragePrice').textContent = 'â‚¬ ' + avgPrice.toFixed(2);
      document.getElementById('reportTopCategory').textContent = topCategory;

      // Aggiorna grafici e tabella
      updateReportCharts(filtered);
      updateReportTable(filtered);
    }

    function updateReportCharts(filtered) {
      // Trend spese per mese
      const monthlyData = {};
      filtered.forEach(m => {
        const orderDate = m.orderDate ? (typeof m.orderDate === 'string' ? new Date(m.orderDate) : m.orderDate) : new Date();
        const monthKey = orderDate.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit' });
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + ((m.price || 0) * (m.quantity || 1));
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const monthlyExpenses = sortedMonths.map(m => monthlyData[m]);

      // Distrubuzione per categoria
      const categoryData = {};
      filtered.forEach(m => {
        const cat = m.category || 'Non categorizzato';
        categoryData[cat] = (categoryData[cat] || 0) + ((m.price || 0) * (m.quantity || 1));
      });

      // Destroy previous charts
      if (reportCharts.trend) reportCharts.trend.destroy();
      if (reportCharts.distribution) reportCharts.distribution.destroy();

      // Trend Chart
      const trendCtx = document.getElementById('reportTrendChart').getContext('2d');
      reportCharts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Spesa Mensile (â‚¬)',
            data: monthlyExpenses,
            borderColor: '#0066cc',
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#0066cc'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Spesa (â‚¬)' } }
          }
        }
      });

      // Distribution Chart
      const distCtx = document.getElementById('reportDistributionChart').getContext('2d');
      const colors = ['#0066cc', '#d32f2f', '#f57c00', '#388e3c', '#7b1fa2', '#c2185b', '#00838f', '#6d4c41'];
      reportCharts.distribution = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateReportTable(filtered) {
      const tbody = document.getElementById('reportTableBody');
      tbody.innerHTML = '';

      filtered.sort((a, b) => {
        const dateA = a.orderDate ? (typeof a.orderDate === 'string' ? new Date(a.orderDate) : a.orderDate) : new Date();
        const dateB = b.orderDate ? (typeof b.orderDate === 'string' ? new Date(b.orderDate) : b.orderDate) : new Date();
        return dateB - dateA;
      }).forEach(m => {
        const orderDate = m.orderDate ? (typeof m.orderDate === 'string' ? m.orderDate : m.orderDate.toLocaleDateString('it-IT')) : '--';
        const total = ((m.price || 0) * (m.quantity || 1)).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${m.category || '--'}</td>
          <td>${m.name || '--'}</td>
          <td>${m.company || '--'}</td>
          <td>${m.distributor || '--'}</td>
          <td>â‚¬ ${(m.price || 0).toFixed(2)}</td>
          <td>${m.quantity || 0}</td>
          <td>â‚¬ ${total}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function resetReportFilters() {
      document.getElementById('reportCategoryFilter').value = 'Tutti';
      document.getElementById('reportCompanyFilter').value = 'Tutte';
      document.getElementById('reportDistributorFilter').value = 'Tutti';
      updateReportData();
    }

    // ===== IMPLANTS REPORT FUNCTIONS =====
    let implantsReportCharts = { trend: null, distribution: null };

    function openImplantsReportModal() {
      const modal = document.getElementById('implantsReportModal');
      modal.classList.add('active');
      setTimeout(() => initImplantsReportFilters(), 100);
    }

    function closeImplantsReportModal() {
      const modal = document.getElementById('implantsReportModal');
      modal.classList.remove('active');
      if (implantsReportCharts.trend) implantsReportCharts.trend.destroy();
      if (implantsReportCharts.distribution) implantsReportCharts.distribution.destroy();
    }

    function initImplantsReportFilters() {
      const implants = loadImplantsFromStorage();
      
      // Popola tipi
      const types = Array.from(new Set(implants.map(i => i.type).filter(t => t))).sort();
      const typeSelect = document.getElementById('implantsReportTypeFilter');
      typeSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        typeSelect.appendChild(opt);
      });

      // Popola aziende
      const companies = Array.from(new Set(implants.map(i => i.company).filter(c => c))).sort();
      const companySelect = document.getElementById('implantsReportCompanyFilter');
      companySelect.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp;
        opt.textContent = comp;
        companySelect.appendChild(opt);
      });

      updateImplantsReportData();
    }

    function getFilteredImplantsReportData() {
      const implants = loadImplantsFromStorage();
      const typeFilter = document.getElementById('implantsReportTypeFilter').value;
      const companyFilter = document.getElementById('implantsReportCompanyFilter').value;

      return implants.filter(i => {
        if (typeFilter !== 'Tutti' && i.type !== typeFilter) return false;
        if (companyFilter !== 'Tutte' && i.company !== companyFilter) return false;
        return true;
      });
    }

    function updateImplantsReportData() {
      const filtered = getFilteredImplantsReportData();
      
      // Calcola statistiche
      const totalExpense = filtered.reduce((sum, i) => sum + ((i.price || 0) * (i.quantity || 1)), 0);
      const orderCount = filtered.length;
      const avgPrice = orderCount > 0 ? totalExpense / orderCount : 0;
      
      // Top tipo
      const typeExpense = {};
      filtered.forEach(i => {
        const type = i.type || 'Non categorizzato';
        typeExpense[type] = (typeExpense[type] || 0) + ((i.price || 0) * (i.quantity || 1));
      });
      const topType = Object.entries(typeExpense).sort((a, b) => b[1] - a[1])[0]?.[0] || '--';

      document.getElementById('implantsReportTotalExpense').textContent = 'â‚¬ ' + totalExpense.toFixed(2);
      document.getElementById('implantsReportOrderCount').textContent = orderCount;
      document.getElementById('implantsReportAveragePrice').textContent = 'â‚¬ ' + avgPrice.toFixed(2);
      document.getElementById('implantsReportTopType').textContent = topType;

      // Aggiorna grafici e tabella
      updateImplantsReportCharts(filtered);
      updateImplantsReportTable(filtered);
    }

    function updateImplantsReportCharts(filtered) {
      // Trend spese per mese
      const monthlyData = {};
      filtered.forEach(i => {
        const orderDate = i.orderDate ? (typeof i.orderDate === 'string' ? new Date(i.orderDate) : i.orderDate) : new Date();
        const monthKey = orderDate.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit' });
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + ((i.price || 0) * (i.quantity || 1));
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const monthlyExpenses = sortedMonths.map(m => monthlyData[m]);

      // Distribuzione per tipo
      const typeData = {};
      filtered.forEach(i => {
        const type = i.type || 'Non categorizzato';
        typeData[type] = (typeData[type] || 0) + ((i.price || 0) * (i.quantity || 1));
      });

      // Destroy previous charts
      if (implantsReportCharts.trend) implantsReportCharts.trend.destroy();
      if (implantsReportCharts.distribution) implantsReportCharts.distribution.destroy();

      // Trend Chart
      const trendCtx = document.getElementById('implantsReportTrendChart').getContext('2d');
      implantsReportCharts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Spesa Mensile (â‚¬)',
            data: monthlyExpenses,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#1976d2'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Spesa (â‚¬)' } }
          }
        }
      });

      // Distribution Chart
      const distCtx = document.getElementById('implantsReportDistributionChart').getContext('2d');
      const colors = ['#1976d2', '#d32f2f', '#f57c00', '#388e3c', '#7b1fa2', '#c2185b', '#00838f', '#6d4c41'];
      implantsReportCharts.distribution = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeData),
          datasets: [{
            data: Object.values(typeData),
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateImplantsReportTable(filtered) {
      const tbody = document.getElementById('implantsReportTableBody');
      tbody.innerHTML = '';

      filtered.sort((a, b) => {
        const dateA = a.orderDate ? (typeof a.orderDate === 'string' ? new Date(a.orderDate) : a.orderDate) : new Date();
        const dateB = b.orderDate ? (typeof b.orderDate === 'string' ? new Date(b.orderDate) : b.orderDate) : new Date();
        return dateB - dateA;
      }).forEach(i => {
        const orderDate = i.orderDate ? (typeof i.orderDate === 'string' ? i.orderDate : i.orderDate.toLocaleDateString('it-IT')) : '--';
        const total = ((i.price || 0) * (i.quantity || 1)).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${i.type || '--'}</td>
          <td>${i.company || '--'}</td>
          <td>${i.model || '--'}</td>
          <td>â‚¬ ${(i.price || 0).toFixed(2)}</td>
          <td>${i.quantity || 0}</td>
          <td>â‚¬ ${total}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function resetImplantsReportFilters() {
      document.getElementById('implantsReportTypeFilter').value = 'Tutti';
      document.getElementById('implantsReportCompanyFilter').value = 'Tutte';
      updateImplantsReportData();
    }

    // ===== NUOVO ORDINE FUNCTIONS =====
    let orderArticles = [];

    function openAddSelectionModal() {
      const modal = document.getElementById('addSelectionModal');
      modal.classList.add('active');
    }
    
    function closeAddSelectionModal() {
      const modal = document.getElementById('addSelectionModal');
      modal.classList.remove('active');
    }
    
    function continueWithOrder() {
      closeAddSelectionModal();
      setTimeout(() => {
        const modal = document.getElementById('orderModal');
        modal.classList.add('active');
        setTimeout(() => initOrderModal(), 100);
      }, 200);
    }
    
    function continueWithMaterial() {
      closeAddSelectionModal();
      setTimeout(() => {
        const modal = document.getElementById('materialModal');
        modal.classList.add('active');
      }, 200);
    }

    function openMaterialModal() {
      const modal = document.getElementById('materialModal');
      modal.classList.add('active');
    }

    function closeMaterialModal() {
      const modal = document.getElementById('materialModal');
      modal.classList.remove('active');
      document.getElementById('materialForm').reset();
    }

    function openOrderModal() {
      const modal = document.getElementById('orderModal');
      modal.classList.add('active');
      setTimeout(() => initOrderModal(), 100);
    }

    function closeOrderModal() {
      const modal = document.getElementById('orderModal');
      modal.classList.remove('active');
      document.getElementById('orderForm').reset();
      orderArticles = [];
      document.getElementById('articlesContainer').innerHTML = '';
    }

    function initOrderModal() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('orderDate').value = today;

      const materials = loadFromLocalStorage();
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(d => d))).sort();
      
      const distSelect = document.getElementById('orderDistributor');
      distSelect.innerHTML = '<option value="">-- Seleziona --</option>';
      distributors.forEach(dist => {
        const opt = document.createElement('option');
        opt.value = dist;
        opt.textContent = dist;
        distSelect.appendChild(opt);
      });

      orderArticles = [];
      addArticleRow();
    }

    function addArticleRow() {
      const materials = loadFromLocalStorage();
      const rowId = 'article_' + Date.now() + '_' + Math.random();
      
      const row = document.createElement('div');
      row.className = 'article-row';
      row.id = rowId;
      
      const materialSelect = document.createElement('select');
      materialSelect.className = 'article-field';
      materialSelect.innerHTML = '<option value="">-- Seleziona materiale --</option>';
      materials.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name + ' (' + m.category + ')';
        materialSelect.appendChild(opt);
      });

      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.min = '1';
      quantityInput.step = '1';
      quantityInput.placeholder = 'QuantitÃ ';
      quantityInput.className = 'article-field';

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = '0';
      priceInput.step = '0.01';
      priceInput.placeholder = 'â‚¬ Prezzo';
      priceInput.className = 'article-field';

      const expiryInput = document.createElement('input');
      expiryInput.type = 'date';
      expiryInput.className = 'article-field';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'article-remove';
      removeBtn.textContent = 'âŒ Rimuovi';
      removeBtn.onclick = () => row.remove();

      // Crea wrapper per ogni campo
      const matFieldWrapper = document.createElement('div');
      matFieldWrapper.className = 'article-field';
      matFieldWrapper.innerHTML = '<label>Materiale</label>';
      matFieldWrapper.appendChild(materialSelect);

      const qtyFieldWrapper = document.createElement('div');
      qtyFieldWrapper.className = 'article-field';
      qtyFieldWrapper.innerHTML = '<label>QuantitÃ  (pz)</label>';
      qtyFieldWrapper.appendChild(quantityInput);

      const priceFieldWrapper = document.createElement('div');
      priceFieldWrapper.className = 'article-field';
      priceFieldWrapper.innerHTML = '<label>Prezzo (â‚¬)</label>';
      priceFieldWrapper.appendChild(priceInput);

      const expiryFieldWrapper = document.createElement('div');
      expiryFieldWrapper.className = 'article-field';
      expiryFieldWrapper.innerHTML = '<label>ğŸ“… Scadenza</label>';
      expiryFieldWrapper.appendChild(expiryInput);

      row.appendChild(matFieldWrapper);
      row.appendChild(qtyFieldWrapper);
      row.appendChild(priceFieldWrapper);
      row.appendChild(expiryFieldWrapper);
      row.appendChild(removeBtn);

      document.getElementById('articlesContainer').appendChild(row);
    }

    document.getElementById('orderForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();

      const orderDate = document.getElementById('orderDate').value;
      const distributor = document.getElementById('orderDistributor').value;

      if (!orderDate || !distributor) {
        alert('Compila data ordine e distributore');
        return;
      }

      const articles = [];
      document.querySelectorAll('#articlesContainer .article-row').forEach(row => {
        const selects = row.querySelectorAll('select');
        const inputs = row.querySelectorAll('input');
        
        const materialId = selects[0]?.value;
        const quantity = parseInt(inputs[0]?.value) || 0;
        const price = parseFloat(inputs[1]?.value) || 0;
        const expiry = inputs[2]?.value;

        if (materialId && quantity > 0) {
          articles.push({ materialId, quantity, price, expiry });
        }
      });

      if (articles.length === 0) {
        alert('Aggiungi almeno un articolo');
        return;
      }

      // Salva ordine e crea batch
      const materials = loadFromLocalStorage();
      const orderId = 'ord_' + Date.now();

      articles.forEach(article => {
        const matIdx = materials.findIndex(m => m.id === article.materialId);
        if (matIdx >= 0) {
          const material = materials[matIdx];
          if (!material.batches) material.batches = [];

          // Crea nuovo batch
          const batchId = 'batch_' + orderId.substring(0, 8) + '_' + article.materialId.substring(0, 8);
          const newBatch = {
            batchId: batchId,
            ordinoId: orderId,
            dataOrdine: orderDate,
            quantitÃ : article.quantity,
            quantitÃ Rimanente: article.quantity,
            prezzo: article.price,
            scadenza: article.expiry
          };

          material.batches.push(newBatch);
          material.quantity = material.batches.reduce((sum, b) => sum + (b.quantitÃ Rimanente || 0), 0);
          material.updatedAt = new Date().toISOString();
          materials[matIdx] = material;
        }
      });

      saveToLocalStorage(materials);
      showAlert(`âœ… Ordine ${orderId} salvato con ${articles.length} articoli`, 'info');
      closeOrderModal();
      loadMaterialsFromStorage();
    });

    // ===== CONSUMO MATERIALE FUNCTIONS (FIFO SYSTEM) =====
    
    function openConsumptionModal() {
      const modal = document.getElementById('consumptionModal');
      modal.classList.add('active');
      setTimeout(() => initConsumptionModal(), 100);
    }

    function closeConsumptionModal() {
      const modal = document.getElementById('consumptionModal');
      modal.classList.remove('active');
      document.getElementById('consumptionForm').reset();
      document.getElementById('consumptionMaterial').value = '';
    }

    function initConsumptionModal() {
      const materials = loadFromLocalStorage();
      const select = document.getElementById('consumptionMaterial');
      select.innerHTML = '<option value="">-- Seleziona materiale --</option>';
      
      materials.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name + ' (' + (m.quantity || 0) + ' pz disponibili)';
        select.appendChild(opt);
      });

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('consumptionDate').value = today;
    }

    function updateConsumptionPreview() {
      const materialId = document.getElementById('consumptionMaterial').value;
      const quantity = parseInt(document.getElementById('consumptionQuantity').value) || 0;
      const previewDiv = document.getElementById('consumptionPreviewContent');

      if (!materialId || quantity <= 0) {
        previewDiv.innerHTML = 'Seleziona materiale e quantitÃ  per visualizzare anteprima...';
        return;
      }

      const materials = loadFromLocalStorage();
      const material = materials.find(m => m.id === materialId);
      if (!material) {
        previewDiv.innerHTML = 'Materiale non trovato';
        return;
      }

      // Ottieni batch del materiale (ordina per data ordine, piÃ¹ vecchi prima)
      const batches = (material.batches || []).sort((a, b) => new Date(a.datiOrdine) - new Date(b.dataOrdine));
      
      if (batches.length === 0) {
        previewDiv.innerHTML = 'âš ï¸ Nessun batch disponibile per questo materiale';
        return;
      }

      // Simula riduzione FIFO
      let remainingQty = quantity;
      let previewHtml = '';
      let found = false;

      for (let i = 0; i < batches.length && remainingQty > 0; i++) {
        const batch = batches[i];
        const batchRemaining = batch.quantitÃ Rimanente || batch.quantitÃ  || 0;
        
        if (batchRemaining > 0) {
          found = true;
          const qtyFromBatch = Math.min(remainingQty, batchRemaining);
          const qtyAfter = batchRemaining - qtyFromBatch;
          
          previewHtml += `
            <div class="consumption-preview-line">
              <span>ğŸ“¦ <strong>${batch.batchId}</strong> (Ordine: ${batch.dataOrdine})</span>
            </div>
            <div class="consumption-preview-line">
              <span style="margin-left:20px">Scadenza: ${batch.scadenza}</span>
            </div>
            <div class="consumption-preview-line">
              <span style="margin-left:20px">Riducibile: <strong>${qtyFromBatch} pz</strong></span>
              <strong style="color:#d32f2f">${batchRemaining} â†’ ${qtyAfter} pz</strong>
            </div>
          `;
          
          remainingQty -= qtyFromBatch;
        }
      }

      if (!found) {
        previewHtml = 'âš ï¸ Materiale esaurito';
      } else if (remainingQty > 0) {
        previewHtml += `<div class="consumption-preview-line" style="color:#d32f2f"><strong>âš ï¸ QuantitÃ  insufficiente: mancano ${remainingQty} pz</strong></div>`;
      }

      previewDiv.innerHTML = previewHtml;
    }

    document.getElementById('consumptionForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const materialId = document.getElementById('consumptionMaterial').value;
      const quantity = parseInt(document.getElementById('consumptionQuantity').value);
      const consumptionDate = document.getElementById('consumptionDate').value;

      if (!materialId || !quantity || quantity <= 0) {
        alert('Compila tutti i campi correttamente');
        return;
      }

      const materials = loadFromLocalStorage();
      const materialIdx = materials.findIndex(m => m.id === materialId);
      if (materialIdx < 0) {
        alert('Materiale non trovato');
        return;
      }

      const material = materials[materialIdx];
      let batches = (material.batches || []).sort((a, b) => new Date(a.dataOrdine) - new Date(b.dataOrdine));
      
      // Sistema FIFO: riduce dai batch piÃ¹ vecchi
      let remainingQty = quantity;
      let consumed = [];
      let totalQtyBefore = 0;
      let totalQtyAfter = 0;

      for (let i = 0; i < batches.length && remainingQty > 0; i++) {
        const batchRemaining = batches[i].quantitÃ Rimanente || batches[i].quantitÃ  || 0;
        if (batchRemaining > 0) {
          totalQtyBefore += batchRemaining;
          const qtyFromBatch = Math.min(remainingQty, batchRemaining);
          batches[i].quantitÃ Rimanente = batchRemaining - qtyFromBatch;
          totalQtyAfter += batches[i].quantitÃ Rimanente;
          consumed.push({batchId: batches[i].batchId, quantitÃ : qtyFromBatch});
          remainingQty -= qtyFromBatch;
        }
      }

      if (remainingQty > 0) {
        alert('QuantitÃ  insufficiente nel magazzino');
        return;
      }

      // Aggiorna batch e storico consumi
      material.batches = batches;
      material.quantity = (material.quantity || 0) - quantity;
      material.consumptionHistory = material.consumptionHistory || [];
      material.consumptionHistory.push({
        data: consumptionDate,
        quantitÃ : quantity,
        batchesConsumed: consumed,
        timestamp: new Date().toISOString()
      });

      materials[materialIdx] = material;
      saveToLocalStorage(materials);

      // Mostra notifica di conferma
      const batchInfo = consumed.map(c => `${c.quantitÃ } pz da ${c.batchId}`).join(', ');
      showAlert(`âœ… Consumati ${quantity} pz da: ${batchInfo}`, 'info');
      
      closeConsumptionModal();
      loadMaterialsFromStorage(); // Ricarica tabella
    });

    // Mostra/nascondi pulsante Gestione Impianti in base alla categoria
    function updateImplantsButtonVisibility() {
      const btn = document.getElementById('implantsBtn');
      btn.style.display = (currentFilter === 'Chirurgia') ? '' : 'none';
    }

    // Chiama questa funzione quando cambia il filtro categoria
    const originalUpdateCategoryFilters = updateCategoryFilters;
    updateCategoryFilters = function() {
      originalUpdateCategoryFilters();
      updateImplantsButtonVisibility();
    };
  </script>
</body>
</html>
