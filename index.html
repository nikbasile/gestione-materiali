<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Odontoiatrico Basile Ciccarone - Magazzino Materiali</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f8fb;color:#2c3e50;line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    h1{color:#003d7a;margin-bottom:8px;font-size:28px;font-weight:600}
    .subtitle{color:#7f8c8d;margin-bottom:24px;font-size:14px}
    #alerts{margin-bottom:20px}
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:8px;font-size:14px;border-left:4px solid}
    .alert.info{background:#e6f0ff;border-color:#0066cc;color:#003d7a}
    .alert.warn{background:#fff3e6;border-color:#ff9800;color:#e65100}
    
    form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-size:12px;font-weight:600;color:#003d7a;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
    input,select{padding:10px 12px;font-size:14px;border:1px solid #d0dce6;border-radius:6px;background:#fff;color:#2c3e50;transition:border-color 0.2s}
    input:focus,select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s}
    form button{background:#0066cc;color:#fff}
    form button:hover{background:#0052a3}
    
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    thead{background:#003d7a;color:#fff}
    th{padding:14px 12px;text-align:left;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-bottom:1px solid #e8ecf1;font-size:14px;vertical-align:middle}
    tbody tr:hover{background:#f9fbfd}
    
    .badge{display:inline-block;padding:6px 10px;border-radius:6px;color:#fff;font-weight:600;font-size:12px}
    .expired{background:#d32f2f}
    .soon{background:#f57c00}
    .ok{background:#388e3c}
    .low{background:#d32f2f}
    
    .btn-action{width:32px;height:32px;padding:0;font-size:18px;font-weight:bold;border:2px solid;border-radius:6px;cursor:pointer;transition:all 0.15s;margin:0 2px;display:inline-flex;align-items:center;justify-content:center;}
    .btn-inc{background:#e8f5e9;color:#2e7d32;border-color:#2e7d32;}
    .btn-inc:hover{background:#2e7d32;color:#fff;}
    .btn-dec{background:#fff3e0;color:#ef6c00;border-color:#ef6c00;}
    .btn-dec:hover{background:#ef6c00;color:#fff;}
    .btn-del{background:#ffebee;color:#c62828;border-color:#c62828;}
    .btn-del:hover{background:#c62828;color:#fff;}
    
    .action-buttons{display:flex;gap:10px;margin-bottom:20px;justify-content:flex-end}
    .action-buttons button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff}
    .action-buttons button:hover{background:#0052a3}
    .action-buttons button.export{background:#388e3c}
    .action-buttons button.export:hover{background:#2e7d32}
    
    .action-menu-btn{height:44px;box-sizing:border-box;padding:0 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff;display:flex;align-items:center;gap:6px}
    .action-menu-btn:hover{background:#0052a3}
    .action-menu{position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;min-width:250px}
    .action-menu button.menu-item{width:100%;padding:12px 16px;border:none;background:none;color:#2c3e50;text-align:left;cursor:pointer;font-size:14px;transition:background 0.2s;display:flex;align-items:center;gap:8px;font-family:inherit}
    .action-menu button.menu-item:hover{background:#f5f5f5}
    
    #loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    #loginScreen.hidden{display:none}
    .login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);text-align:center;max-width:320px}
    .login-box h2{color:#003d7a;margin-bottom:24px;font-size:24px}
    .login-box input{width:100%;padding:12px;margin-bottom:16px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .login-box input:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    .login-box button{width:100%;padding:12px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s}
    .login-box button:hover{background:#0052a3}
    .login-error{color:#d32f2f;font-size:13px;margin-bottom:12px}
    
    .category-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .category-btn{padding:12px 16px;border:2px solid #d0dce6;border-radius:8px;background:#fff;color:#2c3e50;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s;text-align:center}
    .category-btn:hover{border-color:#0066cc;color:#0066cc}
    .category-btn.active{background:#0066cc;color:#fff;border-color:#0066cc}
    
    .header-wrapper{display:flex;align-items:center;gap:16px;margin-bottom:24px}
    .logo-circle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,61,122,0.25)}
    .header-content h1{margin:0;padding:0;font-size:32px}
    .header-content .studio-name{font-size:14px;color:#7f8c8d;font-weight:400}
    .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .filters-row{margin-bottom:20px;display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;background:linear-gradient(135deg,#f0f4f8 0%,#fff 100%);padding:18px 20px;border-radius:10px;border:1px solid #e0e8f0;box-shadow:0 2px 6px rgba(0,61,122,0.05)}
    .filter-label{font-weight:700;color:#003d7a;font-size:12px;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.6px;display:flex;align-items:center;gap:6px}
    .filter-label::before{display:inline-block;width:6px;height:6px;border-radius:50%;background:#0066cc}
    .filter-select{padding:9px 14px;font-size:14px;border-radius:8px;border:1.5px solid #d0dce6;min-width:190px;background:#fff;color:#2c3e50;font-weight:500;transition:all 0.2s;box-shadow:0 1px 2px rgba(0,0,0,0.04);cursor:pointer}
    .filter-select:hover{border-color:#0066cc;box-shadow:0 2px 8px rgba(0,102,204,0.12)}
    .filter-select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.15)}
    
    .filters-reset-btn{padding:9px 18px;font-size:13px;font-weight:600;background:#fff;color:#d32f2f;border:1.5px solid #d32f2f;border-radius:8px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
    .filters-reset-btn:hover{background:#d32f2f;color:#fff}
    .filters-reset-btn.hidden{display:none}

    /* Report Modal Styles */
    #reportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #reportModal.active{display:flex;align-items:flex-start;justify-content:center}
    #implantsReportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #implantsReportModal.active{display:flex;align-items:flex-start;justify-content:center}
    #incomingRegisterModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #incomingRegisterModal.active{display:flex;align-items:flex-start;justify-content:center}
    #implantsIncomingRegisterModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #implantsIncomingRegisterModal.active{display:flex;align-items:flex-start;justify-content:center}
    #alertsReportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #alertsReportModal.active{display:flex;align-items:flex-start;justify-content:center}
    .report-modal-content{background:#fff;border-radius:12px;max-width:1400px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .report-header{background:linear-gradient(135deg,#0066cc 0%,#003d7a 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .report-header h2{margin:0;font-size:22px}
    .report-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .report-close:hover{background:#fff;color:#0066cc}
    .report-body{padding:24px}
    .report-filters{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;padding:16px;background:#f0f4f8;border-radius:8px}
    .report-filter-group{display:flex;flex-direction:column;gap:6px}
    .report-filter-group label{font-weight:600;color:#003d7a;font-size:12px}
    .report-filter-group select{padding:8px 12px;border-radius:6px;border:1px solid #d0dce6;font-size:14px}
    .report-content{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:20px}
    .report-chart-container{background:#f9fbfd;padding:16px;border-radius:8px;position:relative;height:400px}
    .report-table-container{overflow-x:auto;margin-top:20px}
    .report-table{width:100%;border-collapse:collapse;background:#fff}
    .report-table thead{background:#003d7a;color:#fff}
    .report-table th{padding:12px;text-align:left;font-weight:600;font-size:13px}
    .report-table td{padding:12px;border-bottom:1px solid #e8ecf1;font-size:14px}
    .report-table tbody tr:hover{background:#f9fbfd}
    .report-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
    .report-stat{background:linear-gradient(135deg,#e3f2fd 0%,#f3f8ff 100%);padding:16px;border-radius:8px;border-left:4px solid #0066cc}
    .report-stat-label{font-size:12px;color:#003d7a;font-weight:600}
    .report-stat-value{font-size:24px;font-weight:700;color:#0066cc;margin-top:8px}
    .alerts-report-empty{padding:14px 16px;border-radius:8px;background:#e8f5e9;color:#1b5e20;font-weight:600;margin-bottom:14px}
    .alerts-report-empty.warn{background:#fff3e0;color:#e65100}
    .alerts-report-badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;padding:0 7px;background:#d32f2f;color:#fff;border-radius:999px;font-size:12px;font-weight:700}
    .severity-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .severity-badge.critical{background:#ffebee;color:#c62828}
    .severity-badge.warning{background:#fff3e0;color:#e65100}
    .alerts-criteria{background:#f5f8fb;border:1px solid #e0e8f0;border-radius:8px;padding:14px 16px;margin-bottom:14px;color:#2c3e50;font-size:13px}
    .alerts-criteria strong{color:#003d7a}
    .alerts-criteria ul{margin:6px 0 0 18px}
    .alerts-criteria li{margin:4px 0}
    .alerts-settings{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;background:#f0f4f8;border:1px solid #e0e8f0;border-radius:8px;padding:14px 16px;margin-bottom:14px}
    .alerts-settings-group{display:flex;flex-direction:column;gap:6px;min-width:220px}
    .alerts-settings-group label{font-size:12px;font-weight:700;color:#003d7a;text-transform:uppercase;letter-spacing:0.4px}
    .alerts-settings-group input{padding:9px 12px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .alerts-settings-btn{padding:10px 14px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    .alerts-settings-btn:hover{background:#0052a3}
    .main-dashboard-row{display:flex;gap:12px;align-items:stretch;justify-content:space-between;flex-wrap:wrap}
    .main-dashboard-group{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap}
    .main-dashboard-btn{width:230px !important;height:88px !important;padding:12px 16px !important;border-radius:8px !important;box-sizing:border-box;font-size:15px !important;font-weight:600 !important;display:flex !important;align-items:center !important;justify-content:center !important;gap:6px;line-height:1.15;text-align:center;white-space:normal}
    .main-dashboard-btn .alerts-report-badge{margin-left:8px}
    .active-status-icon{display:inline-block;font-size:20px;line-height:1;vertical-align:middle;margin-right:2px}
    .main-dashboard-row.top-row{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));align-items:stretch}
    .main-dashboard-row.top-row > .main-dashboard-group{display:contents}
    .main-dashboard-row.top-row .main-dashboard-btn{width:100% !important;min-width:0}

    @media (max-width:1200px){
      .report-content{grid-template-columns:1fr}
      .report-chart-container{height:350px}
      .main-dashboard-btn{width:210px !important}
      .main-dashboard-row.top-row{grid-template-columns:repeat(4,minmax(0,1fr))}
    }

    @media (max-width:900px){
      .main-dashboard-row,.main-dashboard-group{justify-content:center}
      .main-dashboard-btn{width:100% !important;max-width:320px;height:72px !important}
      .main-dashboard-row.top-row{display:flex}
      .main-dashboard-row.top-row > .main-dashboard-group{display:flex}
    }

    /* Consumption Modal Styles */
    #consumptionModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #consumptionModal.active{display:flex;align-items:flex-start;justify-content:center}
    .consumption-modal-content{background:#fff;border-radius:12px;max-width:700px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .consumption-header{background:linear-gradient(135deg,#f57c00 0%,#e65100 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .consumption-header h2{margin:0;font-size:22px}
    .consumption-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .consumption-close:hover{background:#fff;color:#f57c00}
    .consumption-body{padding:24px}
    .consumption-form{display:flex;flex-direction:column;gap:16px}
    .consumption-group{display:flex;flex-direction:column;gap:8px}
    .consumption-group label{font-weight:600;color:#003d7a;font-size:13px;text-transform:uppercase}
    .consumption-group select,.consumption-group input{padding:10px 12px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .consumption-preview{background:#f0f4f8;padding:16px;border-radius:8px;border-left:4px solid #f57c00;margin-top:12px}
    .consumption-preview-title{font-weight:600;color:#003d7a;margin-bottom:8px}
    .consumption-preview-line{display:flex;justify-content:space-between;padding:6px 0;font-size:14px}
    .consumption-preview-line strong{color:#f57c00}
    .consumption-buttons{display:flex;gap:12px;margin-top:20px}
    .consumption-btn{flex:1;padding:12px;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .consumption-btn.cancel{background:#e0e0e0;color:#333}
    .consumption-btn.cancel:hover{background:#bdbdbd}
    .consumption-btn.confirm{background:#f57c00;color:#fff}
    .consumption-btn.confirm:hover{background:#e65100}
    .batch-info{background:#fff3e0;padding:12px;border-radius:6px;margin-top:12px;border-left:3px solid #f57c00}

    /* Add Selection Modal Styles */
    #addSelectionModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;overflow-y:auto;padding:20px}
    #addSelectionModal.active{display:flex;align-items:center;justify-content:center}
    .selection-modal-content{background:#fff;border-radius:12px;max-width:600px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:slideDown 0.3s ease}
    .selection-header{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:28px;border-radius:12px 12px 0 0;text-align:center}
    .selection-header h2{margin:0;font-size:26px;font-weight:700}
    .selection-header p{margin:8px 0 0 0;font-size:15px;opacity:0.95}
    .selection-body{padding:40px;display:flex;flex-direction:column;gap:20px;align-items:center}
    .selection-btn{width:100%;max-width:320px;padding:18px 24px;font-size:16px;font-weight:600;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .selection-btn.order{background:linear-gradient(135deg,#388e3c 0%,#1b5e20 100%);color:#fff}
    .selection-btn.order:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(56,142,60,0.3)}
    .selection-btn.material{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff}
    .selection-btn.material:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(25,118,210,0.3)}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}

    /* Material Modal Styles */
    #materialModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px}
    #materialModal.active{display:flex;align-items:flex-start;justify-content:center}
    .material-modal-content{background:#fff;border-radius:12px;max-width:700px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .material-header{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:24px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .material-header h2{margin:0;font-size:22px;font-weight:700}
    .material-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .material-close:hover{background:#fff;color:#1976d2}
    .material-body{padding:32px}
    .material-form{display:grid;grid-template-columns:1fr 1fr;gap:20px;grid-auto-flow:dense}
    .material-form-group{display:flex;flex-direction:column;gap:8px}
    .material-form-group.full{grid-column:1/-1}
    .material-form-group label{font-weight:600;color:#003d7a;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
    .material-form-group input,.material-form-group select{padding:12px;border:1.5px solid #d0dce6;border-radius:8px;font-size:14px;transition:all 0.2s;background:#fff}
    .material-form-group input:focus,.material-form-group select:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1);background:#f8f9fa}
    .material-form-group .custom-input{display:none;margin-top:6px}
    .material-form-group.custom-open .custom-input{display:block}
    .material-buttons{display:flex;gap:12px;margin-top:32px;grid-column:1/-1}
    .material-btn{flex:1;padding:12px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;font-size:15px;text-transform:uppercase;letter-spacing:0.5px}
    .material-btn.cancel{background:#e0e0e0;color:#333}
    .material-btn.cancel:hover{background:#bdbdbd;transform:translateY(-1px)}
    .material-btn.submit{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;box-shadow:0 4px 12px rgba(25,118,210,0.25)}
    .material-btn.submit:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(25,118,210,0.35)}

    /* Order Modal Styles */
    #orderModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow:hidden;padding:20px}
    #orderModal.active{display:flex;align-items:flex-start;justify-content:center;padding:40px 20px}
    .order-modal-content{background:#fff;border-radius:12px;max-width:1400px;width:100%;max-height:90vh;display:flex;flex-direction:column;margin:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .order-header{background:linear-gradient(135deg,#388e3c 0%,#1b5e20 100%);color:#fff;padding:24px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .order-header h2{margin:0;font-size:22px}
    .order-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .order-close:hover{background:#fff;color:#388e3c}
    .order-body{padding:32px 40px 0 40px;flex:1;overflow-y:auto;display:flex;flex-direction:column}
    #orderForm{display:flex;flex-direction:column;gap:0;background:transparent;padding:0;margin:0;box-shadow:none}
    .order-info{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:40px;padding:24px;background:#f0f4f8;border-radius:10px;border-left:4px solid #388e3c}
    .order-info-group{display:flex;flex-direction:column;gap:10px}
    .order-info-group label{font-weight:700;color:#003d7a;font-size:11px;text-transform:uppercase;letter-spacing:0.6px}
    .order-info-group input,.order-info-group select{padding:13px 14px;border:1.5px solid #d0dce6;border-radius:8px;font-size:14px;transition:all 0.3s;background:#fff}
    .order-info-group input:focus,.order-info-group select:focus{outline:none;border-color:#388e3c;box-shadow:0 0 0 3px rgba(56,142,60,0.12);background:#fafbfc}
    .articles-container{margin:32px 0;border:none;border-radius:0;padding:0;background:transparent;flex:1;overflow-y:auto;overflow-x:hidden;padding-right:8px}
    .articles-title{font-weight:700;color:#003d7a;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;font-size:15px;padding-bottom:14px;border-bottom:2px solid #e0e0e0;gap:12px;flex-wrap:wrap}
    .order-articles-actions{display:flex;gap:10px;flex-wrap:wrap}
    #articlesContainer table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:980px}
    #articlesContainer th,#articlesContainer td{padding:6px 8px;border:1px solid #d0dce6;font-size:12px;vertical-align:middle}
    #articlesContainer td input,#articlesContainer td select{width:100%;min-width:0}
    #articlesContainer th:nth-child(1),#articlesContainer td:nth-child(1){width:44%}
    #articlesContainer th:nth-child(2),#articlesContainer td:nth-child(2){width:7%}
    #articlesContainer th:nth-child(3),#articlesContainer td:nth-child(3){width:10%}
    #articlesContainer th:nth-child(4),#articlesContainer td:nth-child(4){width:10%}
    #articlesContainer th:nth-child(5),#articlesContainer td:nth-child(5){width:12%}
    #articlesContainer th:nth-child(6),#articlesContainer td:nth-child(6){width:8%}
    #articlesContainer th:nth-child(7),#articlesContainer td:nth-child(7){width:9%}
    #articlesContainer th:nth-child(8),#articlesContainer td:nth-child(8){width:6%}
    .article-row{transition:background-color 0.2s}
    .article-row > *{min-width:0}
    .article-row:hover{background:#f9fbfd}
    .article-field{display:flex;flex-direction:column;gap:7px}
    .article-field label{font-weight:700;color:#003d7a;font-size:11px;text-transform:uppercase;letter-spacing:0.4px}
    .article-field input,.article-field select{padding:11px 13px;border:1.5px solid #d0dce6;border-radius:7px;font-size:13px;transition:all 0.2s;width:100%;background:#fff}
    .article-field input:focus,.article-field select:focus{outline:none;border-color:#388e3c;box-shadow:0 0 0 3px rgba(56,142,60,0.12);background:#fafbfc}
    .article-remove{background:#c62828;color:#fff;border:none;border-radius:7px;padding:10px 12px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:13px;display:flex;align-items:center;justify-content:center;gap:4px;height:44px}
    .article-remove:hover{background:#b71c1c;transform:translateY(-2px);box-shadow:0 4px 10px rgba(198,40,40,0.35)}
    .add-article-btn{padding:12px 20px;background:linear-gradient(135deg,#388e3c 0%,#2e7d32 100%);color:#fff;border:none;border-radius:7px;cursor:pointer;font-weight:600;transition:all 0.3s;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 3px 10px rgba(56,142,60,0.3);text-transform:uppercase;letter-spacing:0.4px}
    .add-article-btn:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(56,142,60,0.4)}
    .import-article-btn{padding:12px 18px;background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;border:none;border-radius:7px;cursor:pointer;font-weight:600;transition:all 0.3s;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 3px 10px rgba(25,118,210,0.25);text-transform:uppercase;letter-spacing:0.4px}
    .import-article-btn:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(25,118,210,0.35)}
    .order-buttons{display:flex;gap:14px;margin-top:20px;padding:20px 40px;border-top:2px solid #e0e0e0;background:#fff;position:sticky;bottom:0;left:0;right:0;z-index:100;width:100%}
    .order-btn{flex:1;padding:14px 20px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:all 0.3s;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    .order-btn.cancel{background:#e0e0e0;color:#333}
    .order-btn.cancel:hover{background:#bdbdbd;transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15)}
    .order-btn.submit{background:linear-gradient(135deg,#388e3c 0%,#2e7d32 100%);color:#fff;box-shadow:0 3px 10px rgba(56,142,60,0.3)}
    .order-btn.submit:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(56,142,60,0.4)}

    /* PDF Import Modal Styles */
    #pdfImportModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10002;overflow-y:auto;padding:20px}
    #pdfImportModal.active{display:flex;align-items:flex-start;justify-content:center}
    .pdf-import-content{background:#fff;border-radius:12px;max-width:1100px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .pdf-import-header{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .pdf-import-header h2{margin:0;font-size:22px}
    .pdf-import-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .pdf-import-close:hover{background:#fff;color:#1976d2}
    .pdf-import-body{padding:24px}
    .pdf-import-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .pdf-upload-btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.3px;box-shadow:0 2px 8px rgba(25,118,210,0.2)}
    .pdf-upload-btn input{display:none}
    .pdf-import-addrow{background:#f0f4f8;color:#003d7a;border:1px solid #d0dce6;padding:10px 14px;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;text-transform:uppercase;letter-spacing:0.3px}
    .pdf-import-addrow:hover{background:#e6eef7}
    .pdf-import-raw{margin-bottom:16px}
    .pdf-import-raw label{display:block;font-weight:600;color:#003d7a;font-size:12px;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.4px}
    .pdf-import-raw textarea{width:100%;min-height:120px;padding:10px 12px;border:1px solid #d0dce6;border-radius:6px;font-size:13px;font-family:inherit}
    .pdf-import-table-wrap{overflow-x:auto;border:1px solid #e8ecf1;border-radius:8px}
    .pdf-import-table{width:100%;border-collapse:collapse;background:#fff}
    .pdf-import-table th{padding:12px;text-align:left;background:#f4f7fb;color:#003d7a;font-size:12px;text-transform:uppercase;letter-spacing:0.4px}
    .pdf-import-table td{padding:10px;border-bottom:1px solid #eef2f6}
    .pdf-import-table input,.pdf-import-table select{width:100%;padding:8px 10px;border:1px solid #d0dce6;border-radius:6px;font-size:13px}
    .pdf-import-table input[readonly]{background:#f4f7fb;color:#003d7a}
    .pdf-import-table th:nth-child(1),.pdf-import-table td:nth-child(1){min-width:280px}
    .pdf-import-remove{background:#c62828;color:#fff;border:none;border-radius:6px;padding:8px 10px;cursor:pointer;font-weight:600;font-size:12px}
    .pdf-import-buttons{display:flex;gap:12px;margin-top:16px}
    .pdf-import-btn{flex:1;padding:12px;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:13px;text-transform:uppercase;letter-spacing:0.4px}
    .pdf-import-btn.cancel{background:#e0e0e0;color:#333}
    .pdf-import-btn.cancel:hover{background:#bdbdbd}
    .pdf-import-btn.submit{background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;box-shadow:0 3px 10px rgba(25,118,210,0.25)}
    .pdf-import-btn.submit:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(25,118,210,0.35)}

    /* Batch Expansion Styles */
    .batch-expand-row{background:#f9fbfd;cursor:pointer;user-select:none}
    .batch-expand-btn{background:none;border:none;color:#0066cc;cursor:pointer;font-weight:600;font-size:14px;padding:0}
    .batch-expand-btn:hover{color:#0052a3}
    .batch-details{display:none;background:#f0f4f8;padding:12px 24px;border-top:1px solid #e0e0e0}
    .batch-details.show{display:block}
    .batches-list{display:flex;flex-direction:column;gap:8px}
    .batch-card{background:#fff;padding:12px;border-radius:6px;border-left:4px solid #0066cc}
    .batch-card-header{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;font-size:13px}
    .batch-card-header strong{color:#003d7a}
    .batch-card-header .expiry-status{font-weight:600;padding:2px 6px;border-radius:3px}
    .material-price-col{display:none !important}
    .expiry-ok{background:#c8e6c9;color:#2e7d32}
    .expiry-warn{background:#ffe0b2;color:#e65100}
    .expiry-critical{background:#ffcdd2;color:#c62828}
    .consumption-history{margin-top:8px;padding:8px;background:#fafafa;border-radius:4px;font-size:12px;color:#666}
    .header-content{min-width:0}
    
    .implants-btn{background:#ff6b35;margin-left:10px}
    .implants-btn:hover{background:#e55a2b}
    #implantsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto}
    #implantsModal.active{display:flex;align-items:flex-start;justify-content:center;padding:14px}
    #implantsModal .modal-content{background:#fff;border-radius:12px;max-width:1280px;width:96%;margin:10px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .implants-toolbar{margin:16px 0;display:flex;flex-direction:column;gap:10px}
    .implants-toolbar-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .implants-toolbar-row.right{justify-content:flex-end}
    .implants-toolbar .action-menu-btn{height:46px;padding:0 18px;font-size:15px;font-weight:600;justify-content:center;text-align:center;line-height:1.15}
    .modal-header{background:#003d7a;color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:22px}
    .modal-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .modal-close:hover{background:#fff;color:#003d7a}
    .modal-body{padding:24px}

    @media (max-width:900px){
      .container{padding:16px}
      .header-content h1{font-size:24px;line-height:1.2}
      .action-buttons{justify-content:stretch}
      .action-buttons button{width:100%}
      .filters-row{gap:12px;padding:14px 16px}
      .filters-row > div{flex:1 1 180px}
      .filter-select{min-width:160px}
      .order-body{padding:18px 16px 0 16px}
      .order-info{grid-template-columns:1fr;gap:14px;margin-bottom:20px;padding:14px}
      .articles-title{font-size:14px;margin-bottom:12px;padding-bottom:10px}
      #articlesContainer th,#articlesContainer td{padding:5px 6px;font-size:11px}
      #articlesContainer table{min-width:860px}
      .order-buttons{padding:14px 16px;margin-top:12px}
    }

    @media (max-width:700px){
      body{font-size:14px}
      .container{padding:12px}
      .header-wrapper{align-items:flex-start;gap:12px}
      .logo-circle{width:48px;height:48px;font-size:18px}
      .header-content h1{font-size:20px}
      .header-content .studio-name{font-size:13px}
      .subtitle{font-size:13px}
      form{grid-template-columns:1fr;padding:14px;gap:10px}
      .category-filters{grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
      .category-btn{padding:10px 8px;font-size:13px}
      .action-buttons{margin-bottom:14px}
      .action-buttons button{font-size:13px;padding:10px 12px}
      .filters-row{flex-direction:column;gap:10px;padding:12px 14px}
      .filters-row > div{width:100%}
      .filter-label{display:flex;align-items:center;margin-right:0;margin-bottom:6px;font-size:12px}
      .filter-label::before{width:5px;height:5px}
      .filter-select{display:block;width:100%;min-width:0;font-size:13px;padding:9px 10px;border-radius:6px}
      .filters-reset-btn{width:100%;padding:10px 14px;font-size:12px}

      table{border:none;box-shadow:none;background:transparent}
      thead{display:none}
      tbody{display:block}
      tbody tr{display:block;background:#fff;border:1px solid #e8ecf1;border-radius:8px;margin-bottom:10px;padding:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
      td{display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:1px solid #eef2f6;padding:9px 8px;font-size:13px;text-align:right}
      td::before{content:attr(data-label);font-weight:600;color:#003d7a;text-align:left}
      td:last-child{border-bottom:none}
      td[data-label="Azioni"]{justify-content:flex-end}
      td[data-label="Azioni"]::before{margin-right:auto}
      .btn-action{width:34px;height:34px}
    }

    @media (max-width:420px){
      .category-filters{grid-template-columns:1fr}
    }

    @media (max-width:360px){
      .container{padding:10px}
      .header-wrapper{gap:10px}
      .logo-circle{width:42px;height:42px;font-size:16px}
      .header-content h1{font-size:18px}
      .header-content .studio-name{font-size:12px}
      form{padding:12px}
      .category-btn{font-size:12px;padding:9px 8px}
      .filter-label{font-size:12px}
      .filter-select{font-size:12px;padding:8px 9px}
      .alert{padding:10px 12px;font-size:13px}
    }
  </style>
</head>
<body>
  <!-- Login disabilitato temporaneamente -->
  <div style="display:none"></div>

  <div class="container" id="mainContent" style="display:block">
    <div class="header-wrapper">
      <div class="logo-circle">BC</div>
      <div class="header-content">
        <h1>Studio Odontoiatrico Basile Ciccarone</h1>
        <p class="studio-name">Gestione Magazzino Materiali di Consumo</p>
      </div>
    </div>
    <div id="alerts"></div>
    <div class="alert info" style="margin-bottom:18px;">
      <strong>Workflow magazzino (materiali e impianti):</strong>
      <ul style="margin:8px 0 10px 18px; font-size:13px; color:#003d7a;">
        <li>Entrate: usa <strong>Nuovo Ordine</strong> o <strong>Nuovo Materiale</strong> (per impianti aggiungili direttamente dal magazzino impianti)</li>
        <li>Uscite: usa solo <strong>Registra Consumo</strong> (scarico automatico dal magazzino)</li>
        <li>Dal magazzino puoi modificare <strong>scadenza</strong> e <strong>soglia quantitÃ </strong> cliccando sul semaforo o sulla soglia</li>
      </ul>
      <strong>Nota sulle notifiche:</strong> Riceverai un avviso automatico quando:
      <ul style="margin:8px 0 0 18px; font-size:13px; color:#003d7a;">
        <li>Un materiale/impianto Ã¨ scaduto o sta per scadere tra 30 giorni</li>
        <li>La quantitÃ  del materiale raggiunge il valore soglia impostato</li>
      </ul>
      Gli avvisi sono consultabili in <strong>Report Avvisi</strong> per avere tutto in un'unica vista.

      <div style="margin-top:12px;padding:10px 12px;background:#fff;border:1px solid #d0dce6;border-radius:8px;">
        <strong>Checklist pre-produzione (sicurezza eliminazione):</strong>
        <ul style="margin:8px 0 0 18px; font-size:13px; color:#003d7a;">
          <li>Verifica gli UID autorizzati in <strong>ADMIN_DELETE_UIDS</strong></li>
          <li>Attiva il toggle <strong>ğŸ”’ Restrizioni elimina admin</strong></li>
          <li>Conferma in Firestore rules: delete solo admin</li>
          <li>Esegui deploy delle regole Firestore</li>
          <li>Testa delete con utente non admin e admin</li>
        </ul>
      </div>
    </div>

    <!-- Pulsanti Principali -->
    <div style="background:linear-gradient(135deg,#f0f4f8 0%,#fff 100%);padding:18px 20px;border-radius:10px;border:1px solid #e0e8f0;box-shadow:0 2px 6px rgba(0,61,122,0.05);margin-bottom:20px">
      <!-- Prima fila: Aggiungi a sinistra, Analisi e Consumo a destra -->
      <div class="main-dashboard-row top-row" style="margin-bottom:14px">
        <button class="main-dashboard-btn" onclick="openAddSelectionModal()" style="background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(25,118,210,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
          â• Aggiungi Nuovo Materiale/Ordine
        </button>

        <div class="main-dashboard-group">
          <button class="main-dashboard-btn" onclick="openReportModal()" style="background:linear-gradient(135deg,#1976d2 0%,#0d47a1 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(13,71,161,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ“Š Analisi Spese
          </button>

          <button class="main-dashboard-btn" onclick="openConsumptionModal()" style="background:linear-gradient(135deg,#f57c00 0%,#e65100 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(230,81,0,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ“‰ Registra Consumo
          </button>

          <button class="main-dashboard-btn" onclick="openIncomingRegisterModal()" style="background:linear-gradient(135deg,#43a047 0%,#2e7d32 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(67,160,71,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ“¥ Registro Entrate
          </button>

          <button class="main-dashboard-btn" onclick="openActiveUsageModal()" style="background:linear-gradient(135deg,#fbc02d 0%,#f9a825 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(249,168,37,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            <span class="active-status-icon">âš¡</span> Magazzino Attivo
          </button>

          <button class="main-dashboard-btn" onclick="openOutgoingRegisterModal()" style="background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(183,28,28,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ“¤ Registro Uscite
          </button>

          <button id="alertsReportBtn" class="main-dashboard-btn" onclick="openAlertsReportModal()" style="background:linear-gradient(135deg,#f57c00 0%,#e65100 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(230,81,0,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ§¾ Report Avvisi <span id="alertsReportCount" class="alerts-report-badge">0</span>
          </button>
        </div>
      </div>

      <!-- Seconda fila: Magazzini a sinistra, Scarica e Backup a destra -->
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:12px;align-items:center">
          <button id="materialsBtn" class="implants-btn-main" onclick="openMaterialsWarehouse()" style="background:linear-gradient(135deg,#0066cc 0%,#003d7a 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(0,61,122,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ“¦ Magazzino Materiali
          </button>

          <button id="implantsBtn" class="implants-btn-main" onclick="openImplantsModal()" style="background:linear-gradient(135deg,#2E7D32 0%,#1B5E20 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(27,94,32,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
            ğŸ”© Magazzino Implantare
          </button>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-left:auto;justify-content:flex-end">
          <label style="display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #d0dce6;border-radius:8px;padding:8px 12px;font-size:13px;color:#003d7a;font-weight:600;white-space:nowrap;">
            <input type="checkbox" id="deleteRestrictionsToggle" />
            ğŸ”’ Restrizioni elimina admin
          </label>

          <!-- Pulsante Scarica Dati Materiali -->
          <div style="position:relative">
            <button class="action-menu-btn" onclick="toggleActionMenu('downloadMenu')">ğŸ“¥ Scarica Dati â–¼</button>
            <div id="downloadMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;left:0">
              <button class="menu-item" onclick="downloadMaterialsPDF()">ğŸ“„ PDF Materiali</button>
              <button class="menu-item" onclick="exportMaterialsCSV()">ğŸ“Š CSV Materiali</button>
            </div>
          </div>

          <!-- Pulsante Backup -->
          <div style="position:relative">
            <button class="action-menu-btn" onclick="toggleActionMenu('backupMenu')">ğŸ’¾ Backup â–¼</button>
            <div id="backupMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;right:0;left:auto">
              <button class="menu-item" onclick="exportBackup()">ğŸ“¥ Esporta Backup Completo</button>
              <button class="menu-item" onclick="document.getElementById('importFile').click()">ğŸ“¤ Importa Backup</button>
              <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="categoryFilters" class="category-filters"></div>

    <div id="materialsFilters" class="filters-row">
      <div>
        <label for="expiryFilterSelect" class="filter-label">ğŸ“… Scadenza</label>
        <select id="expiryFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
          <option value="Rosso">ğŸ”´ Entro 3 mesi</option>
          <option value="Giallo">ğŸŸ¡ Entro 6 mesi</option>
          <option value="Verde">ğŸŸ¢ Oltre 6 mesi</option>
        </select>
      </div>
      <div>
        <label for="quantityFilterSelect" class="filter-label">ğŸ“¦ QuantitÃ </label>
        <select id="quantityFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
          <option value="Rosso">ğŸ”´ Sotto soglia</option>
          <option value="Giallo">ğŸŸ¡ Uguale soglia</option>
          <option value="Verde">ğŸŸ¢ Sopra soglia</option>
        </select>
      </div>
      <div>
        <label for="companyFilterSelect" class="filter-label">ğŸ¢ Azienda</label>
        <select id="companyFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
        </select>
      </div>
      <div>
        <label for="distributorFilterSelect" class="filter-label">ğŸšš Distributore</label>
        <select id="distributorFilterSelect" class="filter-select">
          <option value="Tutti">Tutti</option>
        </select>
      </div>
      <button id="resetFiltersBtn" class="filters-reset-btn hidden">âŸ² Azzera Filtri</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nome</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th class="material-price-col">Prezzo</th><th>Distributore</th><th>Azienda</th><th style="text-align:center;">QuantitÃ </th><th>Azioni</th></tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

  </div>

  <!-- Modal Magazzino Implantare -->
  <div id="implantsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ”© Magazzino Implantare</h2>
        <button class="modal-close" onclick="closeImplantsModal()">Ã—</button>
      </div>
      <div class="modal-body">
      
      <form id="implantForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:24px;background:#f5f5f5;border-radius:8px;margin-bottom:24px">
        <div class="form-group">
          <label>Tipo</label>
          <select id="implantType" required>
            <option value="">-- Seleziona --</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Azienda</label>
          <select id="implantCompany" required>
            <option value="">-- Seleziona --</option>
            <option value="Straumann">Straumann</option>
            <option value="Nobel Biocare">Nobel Biocare</option>
            <option value="Zimmer Biomet">Zimmer Biomet</option>
            <option value="Dentsply Sirona">Dentsply Sirona</option>
            <option value="Osstem">Osstem</option>
            <option value="Biomet 3i">Biomet 3i</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantCompanyCustom" placeholder="Azienda personalizzata" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantModelGroup">
          <label>Modello / Nomenclatura</label>
          <select id="implantModel">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantModelCustom" placeholder="Scrivi modello/nomenclatura (es. BLX, NC, RC)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantKitComponentsGroup" style="display:none">
          <label>Componenti Kit</label>
          <select id="implantKitComponents">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantKitComponentsCustom" placeholder="Scrivi componente (es. Frese chirurgiche, Maschiatore, ecc.)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantDiameterGroup">
          <label>Diametro (mm)</label>
          <select id="implantDiameter">
            <option value="">-- Seleziona --</option>
            <option value="2.9">2.9 mm</option>
            <option value="3.3">3.3 mm</option>
            <option value="3.5">3.5 mm</option>
            <option value="4.0">4.0 mm</option>
            <option value="4.1">4.1 mm</option>
            <option value="4.5">4.5 mm</option>
            <option value="4.8">4.8 mm</option>
            <option value="5.0">5.0 mm</option>
            <option value="6.0">6.0 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantDiameterCustom" type="number" step="0.1" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantLengthGroup">
          <label>Lunghezza (mm)</label>
          <select id="implantLength">
            <option value="">-- Seleziona --</option>
            <option value="6">6 mm</option>
            <option value="8">8 mm</option>
            <option value="10">10 mm</option>
            <option value="12">12 mm</option>
            <option value="14">14 mm</option>
            <option value="16">16 mm</option>
            <option value="18">18 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantLengthCustom" type="number" step="0.5" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group">
          <label>ğŸ“… Data Ordine</label>
          <input id="implantOrderDate" type="date" required />
        </div>
        <div class="form-group">
          <label>â° Data Scadenza (gestita dal magazzino)</label>
          <input id="implantExpiry" type="date" />
        </div>
        <div class="form-group">
          <label>Prezzo (â‚¬)</label>
          <input id="implantPrice" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div class="form-group">
          <label>QuantitÃ </label>
          <input id="implantQuantity" type="number" min="0" value="1" required />
        </div>
        <button type="submit" style="grid-column:span 1;align-self:flex-end">Aggiungi impianto</button>
      </form>

      <h3 style="margin:24px 0 12px;color:#003d7a;font-size:18px">ğŸ“‹ Inventario Impianti</h3>
      
      <!-- Dropdown Scarica Dati Impianti -->
      <div class="implants-toolbar">
        <div class="implants-toolbar-row">
        <button class="action-menu-btn" onclick="openImplantsIncomingRegisterModal()" style="background-color:#43a047">ğŸ“¥ Registro Entrate Impianti</button>
        <button class="action-menu-btn" onclick="openImplantConsumptionModal()" style="background-color:#f57c00">ğŸ“‰ Registra Consumo Impianti</button>
        <button class="action-menu-btn" onclick="openActiveImplantsUsageModal()" style="background-color:#fbc02d;color:#fff;font-weight:700"><span class="active-status-icon">âš¡</span> Magazzino Attivo Impianti</button>
        <button class="action-menu-btn" onclick="openImplantsOutgoingRegisterModal()" style="background-color:#e53935">ğŸ“¤ Registro Uscite Impianti</button>
        </div>
        <div class="implants-toolbar-row right">
          <button class="action-menu-btn" onclick="openImplantsReportModal()" style="background-color:#1976d2">ğŸ“Š Analisi Spese Impianti</button>
          <div style="position:relative">
            <button class="action-menu-btn" onclick="toggleActionMenu('implantsMenu')">ğŸ“¥ Scarica Dati â–¼</button>
            <div id="implantsMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:48px;right:0;left:auto">
          <button class="menu-item" onclick="downloadImplantsPDF()">ğŸ“„ Scarica PDF Impianti</button>
          <button class="menu-item" onclick="exportImplantsCSV()">ğŸ“Š Scarica CSV Impianti</button>
          <button class="menu-item" onclick="downloadImplantsIncomingLotsPDF()">ğŸ“„ PDF Entrate Lotti (data) Impianti</button>
          <button class="menu-item" onclick="exportImplantsIncomingLotsCSV()">ğŸ“Š CSV Entrate Lotti (data) Impianti</button>
          <button class="menu-item" onclick="downloadImplantsOutgoingPDF()">ğŸ“„ PDF Uscite Lotti (data) Impianti</button>
          <button class="menu-item" onclick="exportImplantsOutgoingCSV()">ğŸ“Š CSV Uscite Lotti (data) Impianti</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filtri Impianti -->
      <div class="filters-row" style="margin-bottom:16px;display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <label for="implantTypeFilter" class="filter-label">Filtra per tipo:</label>
          <select id="implantTypeFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div>
          <label for="implantCompanyFilter" class="filter-label">Filtra per azienda:</label>
          <select id="implantCompanyFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
          </select>
        </div>
        <div>
          <label for="implantModelFilter" id="implantModelFilterLabel" class="filter-label">Filtra per modello:</label>
          <select id="implantModelFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
          </select>
        </div>
        <div>
          <label for="implantExpiryFilter" class="filter-label">Filtra per scadenza:</label>
          <select id="implantExpiryFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
            <option value="Scaduti">Scaduti</option>
            <option value="< 3 mesi">< 3 mesi</option>
            <option value="< 6 mesi">< 6 mesi</option>
            <option value="> 6 mesi">> 6 mesi</option>
          </select>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Tipo</th><th>Azienda</th><th>Modello</th><th>Ã˜</th><th>L</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th>Prezzo</th><th style="text-align:center;">QuantitÃ </th><th>Azioni</th></tr>
          </thead>
          <tbody id="implantsList"></tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <!-- Analisi Spese Modal -->
  <div id="reportModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“Š Analisi Spese Materiali</h2>
        <button class="report-close" onclick="closeReportModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri Report -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Categoria / Macroarea</label>
            <select id="reportCategoryFilter" onchange="updateReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Azienda</label>
            <select id="reportCompanyFilter" onchange="updateReportData()">
              <option value="Tutte">Tutte</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Distributore</label>
            <select id="reportDistributorFilter" onchange="updateReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Stato Movimento</label>
            <select id="reportStatusFilter" onchange="updateReportData()">
              <option value="Tutti" selected>Tutti</option>
              <option value="in_uso">In uso</option>
              <option value="consumato">Consumato</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetReportFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche Riassuntive -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Spesa Totale</div>
            <div class="report-stat-value" id="reportTotalExpense">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Numero Ordini</div>
            <div class="report-stat-value" id="reportOrderCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Prezzo Medio</div>
            <div class="report-stat-value" id="reportAveragePrice">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Top Categoria</div>
            <div class="report-stat-value" id="reportTopCategory" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Grafici -->
        <div class="report-content">
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“ˆ Trend Spese (Mese)</h3>
            <div class="report-chart-container">
              <canvas id="reportTrendChart"></canvas>
            </div>
          </div>
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“Š Distribuzione Spese</h3>
            <div class="report-chart-container">
              <canvas id="reportDistributionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tabella Analitica -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Analisi Dettagliata</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Categoria</th>
                <th>Nome Materiale</th>
                <th>Azienda</th>
                <th>Distributore</th>
                <th>Prezzo (â‚¬)</th>
                <th>QuantitÃ </th>
                <th>Totale (â‚¬)</th>
              </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Registro Entrate Modal -->
  <div id="incomingRegisterModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“¥ Registro Entrate Magazzino</h2>
        <button class="report-close" onclick="closeIncomingRegisterModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Categoria</label>
            <select id="incomingCategoryFilter" onchange="updateIncomingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Distributore</label>
            <select id="incomingDistributorFilter" onchange="updateIncomingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Periodo</label>
            <select id="incomingPeriodFilter" onchange="updateIncomingRegisterData()">
              <option value="7">Ultimi 7 giorni</option>
              <option value="30">Ultimi 30 giorni</option>
              <option value="90">Ultimi 90 giorni</option>
              <option value="365">Ultimo anno</option>
              <option value="all" selected>Tutto</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetIncomingFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Totale Entrate</div>
            <div class="report-stat-value" id="incomingTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  Totale</div>
            <div class="report-stat-value" id="incomingTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Carico</div>
            <div class="report-stat-value" id="incomingLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Tabella Entrate -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Storico Carichi</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Categoria</th>
                <th>Nome Materiale</th>
                <th>Distributore</th>
                <th>QuantitÃ </th>
                <th>Lotto (data)</th>
                <th>Tipo</th>
              </tr>
            </thead>
            <tbody id="incomingRegisterTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Registro Uscite Modal -->
  <div id="outgoingRegisterModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px">
    <div class="report-modal-content">
      <div class="report-header" style="background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%)">
        <h2>ğŸ“¤ Registro Uscite Magazzino</h2>
        <button class="report-close" onclick="closeOutgoingRegisterModal()">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Categoria</label>
            <select id="outgoingCategoryFilter" onchange="updateOutgoingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Operatore</label>
            <select id="outgoingOperatorFilter" onchange="updateOutgoingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Periodo</label>
            <select id="outgoingPeriodFilter" onchange="updateOutgoingRegisterData()">
              <option value="7">Ultimi 7 giorni</option>
              <option value="30">Ultimi 30 giorni</option>
              <option value="90">Ultimi 90 giorni</option>
              <option value="365">Ultimo anno</option>
              <option value="all" selected>Tutto</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Stato</label>
            <select id="outgoingStatusFilter" onchange="updateOutgoingRegisterData()">
              <option value="Tutti" selected>Tutti</option>
              <option value="in_uso">In uso</option>
              <option value="consumato">Consumato</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetOutgoingFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Totale Uscite</div>
            <div class="report-stat-value" id="outgoingTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  Totale Scaricata</div>
            <div class="report-stat-value" id="outgoingTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Scarico</div>
            <div class="report-stat-value" id="outgoingLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Storico Uscite</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Nome Materiale</th>
                <th>Operatore</th>
                <th>QuantitÃ </th>
                <th>Stato</th>
                <th>Lotti (data)</th>
              </tr>
            </thead>
            <tbody id="outgoingRegisterTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Magazzino Attivo (In Uso) Modal -->
  <div id="activeUsageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px">
    <div class="report-modal-content">
      <div class="report-header" style="background:linear-gradient(135deg,#fbc02d 0%,#f9a825 100%);color:#3e2723">
        <h2><span class="active-status-icon">âš¡</span> Magazzino Attivo (Materiali in uso)</h2>
        <button class="report-close" onclick="closeActiveUsageModal()" style="border-color:#3e2723;color:#3e2723">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Voci In Uso</div>
            <div class="report-stat-value" id="activeUsageTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  In Uso</div>
            <div class="report-stat-value" id="activeUsageTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Prelievo</div>
            <div class="report-stat-value" id="activeUsageLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Materiali Attualmente in Uso</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Materiale</th>
                <th>Operatore</th>
                <th>QuantitÃ </th>
                <th>Lotti (data)</th>
                <th>Stato</th>
                <th>Azione</th>
              </tr>
            </thead>
            <tbody id="activeUsageTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Selection Modal -->
  <div id="addSelectionModal">
    <div class="selection-modal-content">
      <div class="selection-header">
        <h2>Cosa vuoi aggiungere?</h2>
        <p>Scegli un'opzione per iniziare</p>
      </div>
      <div class="selection-body">
        <button type="button" class="selection-btn order" onclick="continueWithOrder()">
          <span>ğŸ“¦</span>
          <span>Nuovo Ordine</span>
        </button>
        <button type="button" class="selection-btn material" onclick="continueWithMaterial()">
          <span>ğŸ“</span>
          <span>Nuovo Materiale</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Nuovo Materiale Modal -->
  <div id="materialModal">
    <div class="material-modal-content">
      <div class="material-header">
        <h2>ğŸ“ Nuovo Materiale</h2>
        <button class="material-close" onclick="closeMaterialModal()">Ã—</button>
      </div>
      <div class="material-body">
        <form id="materialForm" class="material-form">
          <div class="material-form-group"><label for="matName">Nome materiale</label><input id="matName" list="matNameSuggestions" placeholder="Es. Cemento composito" required autocomplete="off" /><datalist id="matNameSuggestions"></datalist></div>
          <div class="material-form-group"><label for="matOrderDate">ğŸ“… Data Ordine</label><input id="matOrderDate" type="date" required /></div>
          <div class="material-form-group"><label for="matExpiry">â° Data Scadenza (gestita dal magazzino)</label><input id="matExpiry" type="date" /></div>
          <div class="material-form-group"><label for="matPrice">Prezzo (â‚¬)</label><input id="matPrice" type="number" step="0.01" placeholder="0.00" /></div>
          <div class="material-form-group"><label for="matPriceType">Tipo Prezzo</label><select id="matPriceType"><option value="unitario" selected>ğŸ’° Unitario</option><option value="totale">ğŸ“¦ Totale</option></select></div>
          <div class="material-form-group"><label for="matQuantity">QuantitÃ </label><input id="matQuantity" type="number" min="0" value="1" required /></div>
          <div class="material-form-group"><label for="matVatRate">IVA (%)</label><select id="matVatRate"><option value="22" selected>22%</option><option value="10">10%</option><option value="4">4%</option></select></div>
          <div class="material-form-group"><label for="matCategory">ğŸ—‚ï¸ Categoria</label><select id="matCategory" required><option value="">-- Seleziona --</option><option value="Strumentario">Strumentario</option><option value="Consumabili Generici">Consumabili Generici</option><option value="Monouso">Monouso</option><option value="Disinfezione e Sterilizzazione">Disinfezione e Sterilizzazione</option><option value="Chirurgia">Chirurgia</option><option value="Endodonzia">Endodonzia</option><option value="Conservativa e Protesi">Conservativa e Protesi</option><option value="Frese e Lucidatura">Frese e Lucidatura</option><option value="Anestesia e Farmaci">Anestesia e Farmaci</option><option value="Impronte e Laboratorio">Impronte e Laboratorio</option><option value="Radiografia e Fotografia">Radiografia e Fotografia</option><option value="Profilassi e Igiene Orale">Profilassi e Igiene Orale</option><option value="Ortodonzia">Ortodonzia</option></select></div>
          <div class="material-form-group"><label for="matDistributor">ğŸšš Distributore</label><select id="matDistributor" required><option value="">-- Seleziona --</option><option value="Dental Leader">Dental Leader</option><option value="GherÃ²">GherÃ²</option><option value="Revello">Revello</option><option value="Dentitalia">Dentitalia</option><option value="Dental Trey">Dental Trey</option><option value="Umbra">Umbra</option><option value="Eli Dent">Eli Dent</option><option value="Non disponibile">Non disponibile</option><option value="Other">Altro...</option></select><input id="matDistributorCustom" class="custom-input" placeholder="Distributore personalizzato" /></div>
          <div class="material-form-group"><label for="matCompany">ğŸ¢ Azienda</label><select id="matCompany"><option value="">-- Seleziona --</option><option value="3M">3M</option><option value="Ivoclar">Ivoclar</option><option value="GC">GC</option><option value="Dentsply Sirona">Dentsply Sirona</option><option value="Coltene">Coltene</option><option value="Kerr">Kerr</option><option value="Voco">Voco</option><option value="Septodont">Septodont</option><option value="Zhermack">Zhermack</option><option value="DMG">DMG</option><option value="VOCO">VOCO</option><option value="Other">Altro...</option></select><input id="matCompanyCustom" class="custom-input" placeholder="Azienda personalizzata" /></div>
          <div class="material-buttons"><button type="button" class="material-btn cancel" onclick="closeMaterialModal()">Annulla</button><button type="submit" class="material-btn submit">âœ“ Aggiungi</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Nuovo Ordine Modal -->
  <div id="orderModal">
    <div class="order-modal-content">
      <div class="order-header">
        <h2>ğŸ“¦ Nuovo Ordine</h2>
        <button class="order-close" onclick="closeOrderModal()">Ã—</button>
      </div>
      <div class="order-body">
        <form id="orderForm">
          <!-- Info Ordine -->
          <div class="order-info">
            <div class="order-info-group">
              <label for="orderDate">Data Ordine</label>
              <input id="orderDate" type="date" required />
            </div>
            <div class="order-info-group">
              <label for="orderDistributor">Distributore</label>
              <select id="orderDistributor" required>
                <option value="">-- Seleziona --</option>
              </select>
              <input id="orderDistributorCustom" placeholder="Distributore personalizzato" style="display:none;margin-top:6px" />
            </div>
          </div>

          <!-- Articoli -->
          <div class="articles-container">
            <div class="articles-title">
              <div>ğŸ“‹ Articoli dell'Ordine</div>
              <div class="order-articles-actions">
                <button type="button" class="add-article-btn" onclick="addArticleRow()">â• Aggiungi Articolo</button>
                <button type="button" class="import-article-btn" onclick="openPdfImportModal()">ğŸ“„ Importa PDF</button>
              </div>
            </div>
            <div id="articlesContainer" style="border:1px solid #d0dce6;border-radius:8px;max-height:700px;background:#fff;overflow:auto">
              <table>
                <thead style="position:sticky;top:0;background:#f0f4f8;z-index:10">
                  <tr style="background:#f0f4f8;border-bottom:2px solid #d0dce6">
                    <th style="text-align:left;font-weight:600;color:#003d7a;white-space:nowrap">Materiale</th>
                    <th style="text-align:center;font-weight:600;color:#003d7a;white-space:nowrap">QtÃ </th>
                    <th style="text-align:center;font-weight:600;color:#003d7a;white-space:nowrap">Prezzo</th>
                    <th style="text-align:center;font-weight:600;color:#003d7a;white-space:nowrap">Tipo</th>
                    <th style="text-align:left;font-weight:600;color:#003d7a;white-space:nowrap">Azienda</th>
                    <th style="text-align:center;font-weight:600;color:#003d7a;white-space:nowrap">IVA %</th>
                    <th style="text-align:left;font-weight:600;color:#003d7a;white-space:nowrap">Categoria</th>
                    <th style="text-align:center;font-weight:600;color:#003d7a;white-space:nowrap">Azioni</th>
                  </tr>
                </thead>
                <tbody id="articlesContainerBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Pulsanti -->
          <div class="order-buttons">
            <button type="button" class="order-btn cancel" onclick="closeOrderModal()">â† Annulla</button>
            <button type="submit" class="order-btn submit">âœ“ Salva Ordine</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- PDF Import Modal -->
  <div id="pdfImportModal">
    <div class="pdf-import-content">
      <div class="pdf-import-header">
        <h2>ğŸ“„ Importa Fattura PDF</h2>
        <button class="pdf-import-close" onclick="closePdfImportModal()">Ã—</button>
      </div>
      <div class="pdf-import-body">
        <div class="pdf-import-actions">
          <label class="pdf-upload-btn">
            ğŸ“¥ Carica PDF
            <input type="file" id="pdfImportFile" accept="application/pdf" onchange="handlePdfImportFile(event)" />
          </label>
          <button type="button" class="pdf-import-addrow" onclick="addImportRow()">â• Riga manuale</button>
          <div style="display:flex;flex-direction:column;gap:6px;min-width:220px">
            <label for="pdfImportDistributor" style="font-weight:600;color:#003d7a;font-size:12px;text-transform:uppercase;letter-spacing:0.4px">Distributore (import)</label>
            <input id="pdfImportDistributor" type="text" placeholder="Es. Dental Leader" list="distributorNameList" />
          </div>
        </div>
        <div class="pdf-import-raw">
          <label for="pdfImportRaw">Testo estratto (facoltativo)</label>
          <textarea id="pdfImportRaw" placeholder="Testo estratto dal PDF..."></textarea>
        </div>
        <div class="pdf-import-table-wrap">
          <table class="pdf-import-table">
            <thead>
              <tr>
                <th>Nome e descrizione materiale</th>
                <th>QuantitÃ </th>
                <th>Prezzo (â‚¬)</th>
                <th>Totale netto (â‚¬)</th>
                <th>IVA %</th>
                <th>IVA (â‚¬)</th>
                <th>Azienda</th>
                <th>Categoria</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="pdfImportTableBody"></tbody>
          </table>
        </div>
        <datalist id="materialNameList"></datalist>
        <datalist id="distributorNameList"></datalist>
        <div class="pdf-import-buttons">
          <button type="button" class="pdf-import-btn cancel" onclick="closePdfImportModal()">Annulla</button>
          <button type="button" class="pdf-import-btn submit" onclick="applyPdfImportRows()">Importa nell'ordine</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Consumo Materiale Modal -->
  <div id="consumptionModal">
    <div class="consumption-modal-content">
      <div class="consumption-header">
        <h2>ğŸ“‰ Registra Consumo Materiale</h2>
        <button class="consumption-close" onclick="closeConsumptionModal()">Ã—</button>
      </div>
      <div class="consumption-body">
        <form class="consumption-form" id="consumptionForm">
          <div class="consumption-group">
            <label for="consumptionMaterialSearch">Materiale</label>
            <input id="consumptionMaterialSearch" type="text" list="consumptionMaterialList" placeholder="Scrivi il nome materiale..." autocomplete="off" required oninput="updateConsumptionPreview()" onchange="updateConsumptionPreview()" />
            <datalist id="consumptionMaterialList"></datalist>
            <input id="consumptionMaterial" type="hidden" />
          </div>

          <div class="consumption-group">
            <label for="consumptionQuantity">QuantitÃ  da consumare (pz)</label>
            <input id="consumptionQuantity" type="number" min="1" step="1" required onchange="updateConsumptionPreview()" />
          </div>

          <div class="consumption-group">
            <label for="consumptionDate">Data consumo</label>
            <input id="consumptionDate" type="date" required onchange="updateConsumptionPreview()" />
          </div>

          <div class="consumption-group">
            <label for="consumptionOperator">Operatore</label>
            <input id="consumptionOperator" type="text" list="consumptionOperatorList" placeholder="Es. Maria" required autocomplete="off" />
            <datalist id="consumptionOperatorList"></datalist>
          </div>

          <div class="consumption-group">
            <label for="consumptionStatus">Stato</label>
            <select id="consumptionStatus" onchange="updateConsumptionPreview()">
              <option value="in_uso" selected>ğŸŸ¡ In uso</option>
              <option value="consumato">ğŸ”´ Consumato</option>
            </select>
          </div>

          <!-- Preview FEFO -->
          <div class="consumption-preview">
            <div class="consumption-preview-title">ğŸ“‹ Preview Riduzione FEFO</div>
            <div id="consumptionPreviewContent" style="color:#666;font-size:13px;padding:8px">
              Seleziona un materiale per visualizzare anteprima...
            </div>
          </div>

          <div class="consumption-buttons">
            <button type="button" class="consumption-btn cancel" onclick="closeConsumptionModal()">Annulla</button>
            <button type="submit" class="consumption-btn confirm">âœ“ Conferma Movimento</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Implants Report Modal -->
  <div id="implantsReportModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“Š Analisi Spese Impianti</h2>
        <button class="report-close" onclick="closeImplantsReportModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri Report -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Tipo Impianto</label>
            <select id="implantsReportTypeFilter" onchange="updateImplantsReportData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Azienda</label>
            <select id="implantsReportCompanyFilter" onchange="updateImplantsReportData()">
              <option value="Tutte">Tutte</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Stato Movimento</label>
            <select id="implantsReportStatusFilter" onchange="updateImplantsReportData()">
              <option value="Tutti" selected>Tutti</option>
              <option value="in_uso">In uso</option>
              <option value="consumato">Consumato</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetImplantsReportFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche Riassuntive -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Spesa Totale</div>
            <div class="report-stat-value" id="implantsReportTotalExpense">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Numero Ordini</div>
            <div class="report-stat-value" id="implantsReportOrderCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Prezzo Medio</div>
            <div class="report-stat-value" id="implantsReportAveragePrice">â‚¬ 0.00</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Top Tipo</div>
            <div class="report-stat-value" id="implantsReportTopType" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Grafici -->
        <div class="report-content">
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“ˆ Trend Spese (Mese)</h3>
            <div class="report-chart-container">
              <canvas id="implantsReportTrendChart"></canvas>
            </div>
          </div>
          <div>
            <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“Š Distribuzione per Tipo</h3>
            <div class="report-chart-container">
              <canvas id="implantsReportDistributionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tabella Analitica -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Analisi Dettagliata</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Tipo</th>
                <th>Azienda</th>
                <th>Modello</th>
                <th>Prezzo (â‚¬)</th>
                <th>QuantitÃ </th>
                <th>Totale (â‚¬)</th>
              </tr>
            </thead>
            <tbody id="implantsReportTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Registro Entrate Impianti Modal -->
  <div id="implantsIncomingRegisterModal">
    <div class="report-modal-content">
      <div class="report-header">
        <h2>ğŸ“¥ Registro Entrate Impianti</h2>
        <button class="report-close" onclick="closeImplantsIncomingRegisterModal()">Ã—</button>
      </div>
      <div class="report-body">
        
        <!-- Filtri -->
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Tipo</label>
            <select id="implantsIncomingTypeFilter" onchange="updateImplantsIncomingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Azienda</label>
            <select id="implantsIncomingCompanyFilter" onchange="updateImplantsIncomingRegisterData()">
              <option value="Tutte">Tutte</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Periodo</label>
            <select id="implantsIncomingPeriodFilter" onchange="updateImplantsIncomingRegisterData()">
              <option value="7">Ultimi 7 giorni</option>
              <option value="30" selected>Ultimi 30 giorni</option>
              <option value="90">Ultimi 90 giorni</option>
              <option value="365">Ultimo anno</option>
              <option value="all">Tutto</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetImplantsIncomingFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <!-- Statistiche -->
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Totale Entrate</div>
            <div class="report-stat-value" id="implantsIncomingTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  Totale</div>
            <div class="report-stat-value" id="implantsIncomingTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Carico</div>
            <div class="report-stat-value" id="implantsIncomingLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <!-- Tabella Entrate -->
        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Storico Carichi Impianti</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data Ordine</th>
                <th>Tipo</th>
                <th>Azienda</th>
                <th>Modello</th>
                <th>QuantitÃ </th>
                <th>Lotto (data)</th>
              </tr>
            </thead>
            <tbody id="implantsIncomingRegisterTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Consumo Impianti Modal -->
  <div id="implantConsumptionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px">
    <div class="consumption-modal-content">
      <div class="consumption-header">
        <h2>ğŸ“‰ Registra Consumo Impianti</h2>
        <button class="consumption-close" onclick="closeImplantConsumptionModal()">Ã—</button>
      </div>
      <div class="consumption-body">
        <form class="consumption-form" id="implantConsumptionForm">
          <div class="consumption-group">
            <label for="implantConsumptionSearch">Impianto</label>
            <input id="implantConsumptionSearch" type="text" list="implantConsumptionList" placeholder="Scrivi tipo/modello impianto..." autocomplete="off" required oninput="updateImplantConsumptionPreview()" onchange="updateImplantConsumptionPreview()" />
            <datalist id="implantConsumptionList"></datalist>
            <input id="implantConsumptionId" type="hidden" />
          </div>

          <div class="consumption-group">
            <label for="implantConsumptionQuantity">QuantitÃ  da consumare (pz)</label>
            <input id="implantConsumptionQuantity" type="number" min="1" step="1" required onchange="updateImplantConsumptionPreview()" />
          </div>

          <div class="consumption-group">
            <label for="implantConsumptionDate">Data consumo</label>
            <input id="implantConsumptionDate" type="date" required onchange="updateImplantConsumptionPreview()" />
          </div>

          <div class="consumption-group">
            <label for="implantConsumptionOperator">Operatore</label>
            <input id="implantConsumptionOperator" type="text" list="consumptionOperatorList" placeholder="Es. Maria" required autocomplete="off" />
          </div>

          <div class="consumption-group">
            <label for="implantConsumptionStatus">Stato</label>
            <select id="implantConsumptionStatus" onchange="updateImplantConsumptionPreview()">
              <option value="in_uso" selected>ğŸŸ¡ In uso</option>
              <option value="consumato">ğŸ”´ Consumato</option>
            </select>
          </div>

          <div class="consumption-preview">
            <div class="consumption-preview-title">ğŸ“‹ Preview Riduzione FEFO</div>
            <div id="implantConsumptionPreviewContent" style="color:#666;font-size:13px;padding:8px">
              Seleziona un impianto per visualizzare anteprima...
            </div>
          </div>

          <div class="consumption-buttons">
            <button type="button" class="consumption-btn cancel" onclick="closeImplantConsumptionModal()">Annulla</button>
            <button type="submit" class="consumption-btn confirm">âœ“ Conferma Movimento</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Registro Uscite Impianti Modal -->
  <div id="implantsOutgoingRegisterModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px">
    <div class="report-modal-content">
      <div class="report-header" style="background:linear-gradient(135deg,#e53935 0%,#b71c1c 100%)">
        <h2>ğŸ“¤ Registro Uscite Impianti</h2>
        <button class="report-close" onclick="closeImplantsOutgoingRegisterModal()">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-filters">
          <div class="report-filter-group">
            <label>Tipo</label>
            <select id="implantsOutgoingTypeFilter" onchange="updateImplantsOutgoingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Operatore</label>
            <select id="implantsOutgoingOperatorFilter" onchange="updateImplantsOutgoingRegisterData()">
              <option value="Tutti">Tutti</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Periodo</label>
            <select id="implantsOutgoingPeriodFilter" onchange="updateImplantsOutgoingRegisterData()">
              <option value="7">Ultimi 7 giorni</option>
              <option value="30" selected>Ultimi 30 giorni</option>
              <option value="90">Ultimi 90 giorni</option>
              <option value="365">Ultimo anno</option>
              <option value="all">Tutto</option>
            </select>
          </div>
          <div class="report-filter-group">
            <label>Stato</label>
            <select id="implantsOutgoingStatusFilter" onchange="updateImplantsOutgoingRegisterData()">
              <option value="Tutti" selected>Tutti</option>
              <option value="in_uso">In uso</option>
              <option value="consumato">Consumato</option>
            </select>
          </div>
          <div class="report-filter-group" style="margin-top:24px">
            <button onclick="resetImplantsOutgoingFilters()" style="padding:8px 16px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">Azzera Filtri</button>
          </div>
        </div>

        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Totale Uscite</div>
            <div class="report-stat-value" id="implantsOutgoingTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  Totale Scaricata</div>
            <div class="report-stat-value" id="implantsOutgoingTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Scarico</div>
            <div class="report-stat-value" id="implantsOutgoingLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Storico Uscite Impianti</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Azienda</th>
                <th>Modello</th>
                <th>Operatore</th>
                <th>QuantitÃ </th>
                <th>Stato</th>
                <th>Lotti (data)</th>
              </tr>
            </thead>
            <tbody id="implantsOutgoingRegisterTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Magazzino Attivo Impianti Modal -->
  <div id="activeImplantsUsageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto;padding:20px">
    <div class="report-modal-content">
      <div class="report-header" style="background:linear-gradient(135deg,#fbc02d 0%,#f9a825 100%);color:#3e2723">
        <h2><span class="active-status-icon">âš¡</span> Magazzino Attivo Impianti</h2>
        <button class="report-close" onclick="closeActiveImplantsUsageModal()" style="border-color:#3e2723;color:#3e2723">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-stats">
          <div class="report-stat">
            <div class="report-stat-label">Voci In Uso</div>
            <div class="report-stat-value" id="activeImplantsUsageTotalCount">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">QuantitÃ  In Uso</div>
            <div class="report-stat-value" id="activeImplantsUsageTotalQuantity">0</div>
          </div>
          <div class="report-stat">
            <div class="report-stat-label">Ultimo Prelievo</div>
            <div class="report-stat-value" id="activeImplantsUsageLastDate" style="font-size:16px">--</div>
          </div>
        </div>

        <h3 style="color:#003d7a;margin-bottom:12px">ğŸ“‹ Impianti Attualmente in Uso</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Azienda</th>
                <th>Modello</th>
                <th>Operatore</th>
                <th>QuantitÃ </th>
                <th>Lotti (data)</th>
                <th>Stato</th>
                <th>Azione</th>
              </tr>
            </thead>
            <tbody id="activeImplantsUsageTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Avvisi Modal -->
  <div id="alertsReportModal">
    <div class="report-modal-content" style="max-width:1100px">
      <div class="report-header" style="background:linear-gradient(135deg,#f57c00 0%,#e65100 100%)">
        <h2>ğŸ§¾ Report Avvisi</h2>
        <button class="report-close" onclick="closeAlertsReportModal()">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-stats">
          <div class="report-stat" style="border-left-color:#d32f2f">
            <div class="report-stat-label">Totale Avvisi</div>
            <div class="report-stat-value" id="alertsReportTotal">0</div>
          </div>
          <div class="report-stat" style="border-left-color:#0066cc">
            <div class="report-stat-label">Avvisi Materiali</div>
            <div class="report-stat-value" id="alertsReportMaterials">0</div>
          </div>
          <div class="report-stat" style="border-left-color:#2e7d32">
            <div class="report-stat-label">Avvisi Implantare</div>
            <div class="report-stat-value" id="alertsReportImplants">0</div>
          </div>
          <div class="report-stat" style="border-left-color:#c62828">
            <div class="report-stat-label">Critici</div>
            <div class="report-stat-value" id="alertsReportCritical">0</div>
          </div>
        </div>

        <div class="alerts-settings">
          <div class="alerts-settings-group">
            <label for="alertsExpiryDaysInput">Giorni avviso scadenza</label>
            <input id="alertsExpiryDaysInput" type="number" min="1" max="365" value="30" />
          </div>
          <div class="alerts-settings-group">
            <label for="alertsImplantLowQtyInput">Soglia quantitÃ  bassa implantare</label>
            <input id="alertsImplantLowQtyInput" type="number" min="1" max="99" value="2" />
          </div>
          <button class="alerts-settings-btn" onclick="saveAlertsSettings()">Salva soglie avvisi</button>
        </div>

        <div class="alerts-criteria">
          <strong>Definizione livelli avviso</strong>
          <ul>
            <li><strong>Critico (Materiali):</strong> scadenza giÃ  passata oppure quantitÃ  sotto la soglia impostata.</li>
            <li><strong>Attenzione (Materiali):</strong> scadenza entro <span id="alertsCriteriaDays">30</span> giorni oppure quantitÃ  uguale alla soglia.</li>
            <li><strong>Critico (Implantare):</strong> scadenza giÃ  passata oppure quantitÃ  esaurita (0).</li>
            <li><strong>Attenzione (Implantare):</strong> scadenza entro <span id="alertsCriteriaDaysImplants">30</span> giorni oppure quantitÃ  bassa (1-<span id="alertsCriteriaImplantQty">2</span>).</li>
          </ul>
        </div>

        <div id="alertsReportEmpty" class="alerts-report-empty">âœ… Nessun avviso attivo al momento.</div>

        <h3 style="color:#003d7a;margin-bottom:10px">ğŸ“¦ Avvisi Magazzino Materiali</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Livello</th>
                <th>Elemento</th>
                <th>Tipo Avviso</th>
                <th>Dettaglio</th>
              </tr>
            </thead>
            <tbody id="alertsReportMaterialsTableBody"></tbody>
          </table>
        </div>

        <h3 style="color:#003d7a;margin:20px 0 10px">ğŸ”© Avvisi Magazzino Implantare</h3>
        <div class="report-table-container">
          <table class="report-table">
            <thead>
              <tr>
                <th>Livello</th>
                <th>Elemento</th>
                <th>Tipo Avviso</th>
                <th>Dettaglio</th>
              </tr>
            </thead>
            <tbody id="alertsReportImplantsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZeB8P2osUIN2YHa5qg4eAZdRH8js2cW0",
      authDomain: "gestione-materiali-di-consumo.firebaseapp.com",
      projectId: "gestione-materiali-di-consumo",
      storageBucket: "gestione-materiali-di-consumo.firebasestorage.app",
      messagingSenderId: "831456435798",
      appId: "1:831456435798:web:af967c6986c06dde8d65f7",
      measurementId: "G-CEGE8B5LGZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const DELETE_RESTRICTIONS_KEY = 'magazzino_delete_restrictions_active_v1';
    const ADMIN_DELETE_UIDS = [
      'INSERISCI_UID_ADMIN'
    ];
    let currentUserUid = null;
    let deleteRestrictionsActive = loadDeleteRestrictionsFlag();
    let isDeleteAdmin = false;
    const APP_VERSION = '2026-02-20-fix-local-first-3';
    console.log('App version:', APP_VERSION);
    let firebaseReady = true;
    let realtimeListenersStarted = false;
    if (db && typeof db.enablePersistence === 'function') {
      db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        console.warn('Persistenza offline Firebase non attiva:', err && err.message ? err.message : err);
      });
    }

    // Login anonimo automatico
    auth.onAuthStateChanged(user => {
      if (!user) {
        currentUserUid = null;
        isDeleteAdmin = false;
        auth.signInAnonymously().catch(err => {
          console.warn('Errore login anonimo:', err.message);
        });
      } else {
        console.log('Login anonimo riuscito:', user.uid);
        currentUserUid = user.uid;
        refreshDeletePermissions();
        startRealtimeListeners();
      }
    });

    function loadDeleteRestrictionsFlag(){
      try {
        return localStorage.getItem(DELETE_RESTRICTIONS_KEY) === 'true';
      } catch(_err) {
        return false;
      }
    }

    function saveDeleteRestrictionsFlag(value){
      try {
        localStorage.setItem(DELETE_RESTRICTIONS_KEY, value ? 'true' : 'false');
      } catch(_err) {}
    }

    function refreshDeletePermissions(){
      isDeleteAdmin = !deleteRestrictionsActive || ADMIN_DELETE_UIDS.includes(String(currentUserUid || ''));
      const toggle = document.getElementById('deleteRestrictionsToggle');
      if (toggle) toggle.checked = !!deleteRestrictionsActive;
      if (Array.isArray(allDocs) && allDocs.length >= 0) renderFilteredMaterials();
      if (typeof renderImplantsList === 'function') renderImplantsList();
    }

    function initDeleteRestrictionsToggle(){
      const toggle = document.getElementById('deleteRestrictionsToggle');
      if (!toggle) return;
      toggle.checked = !!deleteRestrictionsActive;
      toggle.addEventListener('change', function(){
        deleteRestrictionsActive = !!this.checked;
        saveDeleteRestrictionsFlag(deleteRestrictionsActive);
        refreshDeletePermissions();
        showAlert(
          deleteRestrictionsActive
            ? 'ğŸ”’ Restrizioni eliminazione attive (solo admin)'
            : 'ğŸ”“ Restrizioni eliminazione disattive (modalitÃ  test)',
          'info'
        );
      });
    }

    function ensureDeleteAdmin(){
      if(!deleteRestrictionsActive) return true;
      if(isDeleteAdmin) return true;
      showAlert('Azione consentita solo all\'amministratore', 'warn');
      return false;
    }

    const listEl = document.getElementById('list');
    const alertsEl = document.getElementById('alerts');
    const categoryFiltersEl = document.getElementById('categoryFilters');
    const companyFilterSelect = document.getElementById('companyFilterSelect');
    const distributorFilterSelect = document.getElementById('distributorFilterSelect');

    const CATEGORIES = ['Tutti', 'Strumentario', 'Consumabili Generici', 'Monouso', 'Disinfezione e Sterilizzazione', 'Chirurgia', 'Endodonzia', 'Conservativa e Protesi', 'Frese e Lucidatura', 'Anestesia e Farmaci', 'Impronte e Laboratorio', 'Radiografia e Fotografia', 'Profilassi e Igiene Orale', 'Ortodonzia'];
    const COMPANY_OPTIONS = ['3M', 'Ivoclar', 'GC', 'Dentsply Sirona', 'Coltene', 'Kerr', 'Voco', 'Septodont', 'Zhermack', 'DMG', 'VOCO', 'Other'];
    const DISTRIBUTOR_OPTIONS = ['Dental Leader', 'GherÃ²', 'Revello', 'Dentitalia', 'Dental Trey', 'Umbra', 'Eli Dent', 'Non disponibile', 'Other'];
    let currentFilter = 'Tutti';
    let currentCompanyFilter = 'Tutte';
    let currentDistributorFilter = 'Tutti';
    let currentExpiryFilter = 'Tutte';
    let currentQuantityFilter = 'Tutte';
    let allDocs = []; // store all docs for filtering
    let alertsReportData = { materials: [], implants: [] };
    const ALERTS_SETTINGS_KEY = 'magazzino_alert_settings_v1';
    const DEFAULT_ALERTS_SETTINGS = { expiryWarningDays: 30, implantLowQtyWarning: 2 };
    let alertsSettings = loadAlertsSettings();

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveToLocalStorage(docs){
      // Se docs non Ã¨ un array o vuoto, niente da salvare
      if (!Array.isArray(docs) || docs.length === 0) return;
      // Estrai dati dai doc Firestore
      const fbData = docs[0] && typeof docs[0].data === 'function'
        ? docs.map(doc=>{
            const d = doc.data();
            const order = d.orderDate && d.orderDate.toDate ? d.orderDate.toDate().toISOString() : (d.orderDate ? new Date(d.orderDate).toISOString() : null);
            const exp = d.expiry && d.expiry.toDate ? d.expiry.toDate().toISOString() : (d.expiry ? new Date(d.expiry).toISOString() : null);
            const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt ? new Date(d.createdAt).toISOString() : null);
            return {id: doc.id, ...d, orderDate: order, expiry: exp, createdAt: created};
          })
        : docs;
      // Carica materiali esistenti in localStorage e unisci (Firebase ha prioritÃ , localStorage Ã¨ solo backup offline)
      try {
        const existing = loadFromLocalStorage();
        const map = new Map();
        // Prima aggiungi i dati locali
        existing.forEach(it => map.set(it.id, it));
        // Poi sovrascrivi con i dati di Firebase (prioritÃ  a Firebase)
        fbData.forEach(it => {
          const prev = map.get(it.id) || {};
          const mergedItem = { ...prev, ...it };
          if ((!Array.isArray(it.batches) || it.batches.length === 0) && Array.isArray(prev.batches) && prev.batches.length > 0) {
            mergedItem.batches = prev.batches;
            if (!Number.isFinite(Number(mergedItem.quantity))) {
              mergedItem.quantity = prev.quantity || 0;
            }
          }
          map.set(it.id, mergedItem);
        });
        const merged = Array.from(map.values());
        localStorage.setItem('magazzino_materials', JSON.stringify(merged));
      } catch (e) {
        // fallback semplice
        localStorage.setItem('magazzino_materials', JSON.stringify(fbData));
      }
    }

    function normalizeBatchRecord(batch, material){
      if(!batch || typeof batch !== 'object') return null;
      const qty = Number(batch.quantitÃ  ?? batch.quantita ?? batch.originalQuantita ?? batch.quantity ?? 0) || 0;
      const qtyRemaining = Number(
        batch.quantitÃ Rimanente ?? batch.quantitaRimanente ?? batch.remainingQuantity ?? batch.quantityRemaining ?? qty
      ) || 0;

      return {
        ...batch,
        batchId: batch.batchId || batch.id || ('batch_legacy_' + String(material.id || 'mat') + '_' + Date.now()),
        dataOrdine: batch.dataOrdine || batch.orderDate || batch.data || material.orderDate || material.createdAt || new Date().toISOString(),
        quantitÃ : qty,
        quantitÃ Rimanente: qtyRemaining,
        prezzo: Number(batch.prezzo ?? batch.price ?? material.price ?? 0) || 0,
        scadenza: batch.scadenza ?? batch.expiry ?? material.expiry ?? null,
        distributore: batch.distributore || batch.distributor || material.distributor || '',
        azienda: batch.azienda || batch.company || material.company || '',
        ordinoId: batch.ordinoId || batch.orderId || null
      };
    }

    function loadFromLocalStorage(){
      const saved = localStorage.getItem('magazzino_materials');
      const legacy = localStorage.getItem('magazzino');
      const parsed = saved ? JSON.parse(saved) : (legacy ? JSON.parse(legacy) : []);
      if(!Array.isArray(parsed)) return [];

      if(!saved && legacy && Array.isArray(parsed) && parsed.length > 0){
        try {
          localStorage.setItem('magazzino_materials', JSON.stringify(parsed));
        } catch(_err) {}
      }

      let changed = false;
      const normalized = parsed.map(material => {
        if(!material || typeof material !== 'object') return material;
        const next = { ...material };

        if(!Array.isArray(next.batches)) {
          next.batches = [];
          changed = true;
        }

        const normalizedBatches = next.batches
          .map(batch => normalizeBatchRecord(batch, next))
          .filter(Boolean);

        if(normalizedBatches.length !== next.batches.length) changed = true;
        if(normalizedBatches.length > 0) {
          const totalQty = normalizedBatches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
          if(Number(next.quantity || 0) !== totalQty) {
            next.quantity = totalQty;
            changed = true;
          }
        }

        if(normalizedBatches.length === 0 && Number(next.quantity || 0) > 0) {
          normalizedBatches.push(normalizeBatchRecord({
            batchId: 'batch_restore_' + String(next.id || 'mat') + '_' + Date.now(),
            dataOrdine: next.orderDate || next.createdAt || new Date().toISOString(),
            quantitÃ : Number(next.quantity || 0),
            quantitÃ Rimanente: Number(next.quantity || 0),
            prezzo: Number(next.price || 0),
            scadenza: next.expiry || null,
            distributore: next.distributor || '',
            azienda: next.company || ''
          }, next));
          changed = true;
        }

        next.batches = normalizedBatches;

        const computedSummaryExpiry = recomputeMaterialExpiryFromBatches(normalizedBatches);
        const currentSummaryExpiry = parseFlexibleDate(next.expiry);
        const currentSummaryExpiryIso = currentSummaryExpiry ? currentSummaryExpiry.toISOString() : null;
        if ((computedSummaryExpiry || null) !== (currentSummaryExpiryIso || null)) {
          next.expiry = computedSummaryExpiry;
          changed = true;
        }

        return next;
      });

      if(changed) {
        localStorage.setItem('magazzino_materials', JSON.stringify(normalized));
      }

      return normalized;
    }

    function addToLocalStorage(item){
      const materials = loadFromLocalStorage();
      const newItem = {...item, id: item.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_local_'+Date.now())};
      // Convert dates to ISO strings for JSON serialization
      if(newItem.orderDate instanceof Date) newItem.orderDate = newItem.orderDate.toISOString();
      if(newItem.expiry instanceof Date) newItem.expiry = newItem.expiry.toISOString();
      if(newItem.createdAt instanceof Date) newItem.createdAt = newItem.createdAt.toISOString();
      
      // Create/update batch system
      if (!newItem.batches) {
        newItem.batches = [];
      }
      
      // Create new batch for this order
      const batchId = 'batch_' + newItem.id.substring(0, 8) + '_' + Date.now();
      const newBatch = {
        batchId: batchId,
        dataOrdine: newItem.orderDate,
        quantitÃ : newItem.quantity || 0,
        quantitÃ Rimanente: newItem.quantity || 0,
        prezzo: newItem.price || 0,
        scadenza: newItem.expiry,
        distributore: newItem.distributor || '',
        azienda: newItem.company || ''
      };
      
      const idx = materials.findIndex(m => m.id === newItem.id);
      if (idx >= 0) {
        // Material already exists - add new batch
        const existing = materials[idx];
        if (!existing.batches) existing.batches = [];
        existing.batches.push(newBatch);
        // Update total quantity
        existing.quantity = existing.batches.reduce((sum, b) => sum + (b.quantitÃ Rimanente || 0), 0);
        existing.expiry = recomputeMaterialExpiryFromBatches(existing.batches);
        existing.updatedAt = new Date().toISOString();
        materials[idx] = existing;
      } else {
        // New material - add batch
        newItem.batches.push(newBatch);
        newItem.expiry = recomputeMaterialExpiryFromBatches(newItem.batches);
        materials.push(newItem);
      }
      
      localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      return newItem.id;
    }

    function deleteFromLocalStorage(id){
      const materials = loadFromLocalStorage();
      const filtered = materials.filter(m=>m.id !== id);
      localStorage.setItem('magazzino_materials', JSON.stringify(filtered));
    }

    function updateQuantityLocalStorage(id, delta){
      const materials = loadFromLocalStorage();
      const item = materials.find(m=>m.id === id);
      if(item){
        const nextQuantity = (item.quantity || 0) + delta;
        item.quantity = Math.max(0, nextQuantity);
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }
    }

    async function updateMaterialFields(id, fields){
      const updatedFields = { ...fields, updatedAt: new Date().toISOString() };
      const materials = loadFromLocalStorage();
      const item = materials.find(m => m.id === id);
      if(item){
        Object.assign(item, updatedFields);
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(id).set(updatedFields, { merge: true });
        } catch(err) {
          console.warn('Firebase update non riuscito:', err && err.message ? err.message : err);
          showAlert('Modifica salvata in locale. Firebase non raggiungibile.', 'warn');
        }
      }

      loadMaterialsFromStorage();
    }

    function recomputeMaterialExpiryFromBatches(batches){
      if(!Array.isArray(batches) || batches.length === 0) return null;
      const dated = batches
        .filter(b => Number(b.quantitÃ Rimanente || 0) > 0)
        .map(b => parseFlexibleDate(b.scadenza))
        .filter(Boolean)
        .sort((a, b) => b.getTime() - a.getTime());

      if(dated.length === 0) return null;
      return dated[0].toISOString();
    }

    async function editBatchExpiry(materialId, batchId){
      const materials = loadFromLocalStorage();
      const materialIdx = materials.findIndex(m => String(m.id) === String(materialId));
      if(materialIdx < 0){
        showAlert('Materiale non trovato', 'warn');
        return;
      }

      const material = materials[materialIdx];
      if(!Array.isArray(material.batches) || material.batches.length === 0){
        showAlert('Nessun lotto disponibile', 'warn');
        return;
      }

      const batch = material.batches.find(b => String(b.batchId || b.id) === String(batchId));
      if(!batch){
        showAlert('Lotto non trovato', 'warn');
        return;
      }

      const current = parseFlexibleDate(batch.scadenza);
      const currentInput = current ? current.toISOString().split('T')[0] : '';
      const newExpiry = prompt('Inserisci data scadenza lotto (YYYY-MM-DD). Lascia vuoto per rimuovere:', currentInput);
      if(newExpiry === null) return;

      const value = String(newExpiry || '').trim();
      if(!value){
        batch.scadenza = null;
      } else {
        const parsed = parseFlexibleDate(value);
        if(!parsed){
          showAlert('Data scadenza lotto non valida. Usa formato YYYY-MM-DD.', 'warn');
          return;
        }
        batch.scadenza = parsed.toISOString();
      }

      material.updatedAt = new Date().toISOString();
      material.expiry = recomputeMaterialExpiryFromBatches(material.batches);
      materials[materialIdx] = material;
      localStorage.setItem('magazzino_materials', JSON.stringify(materials));

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(material.id).set({
            batches: material.batches,
            expiry: material.expiry,
            updatedAt: material.updatedAt
          }, { merge: true });
        } catch(err){
          console.warn('Firebase update batch scadenza non riuscito:', err && err.message ? err.message : err);
        }
      }

      loadMaterialsFromStorage();
      showAlert('âœ“ Scadenza lotto aggiornata', 'info');
    }

    function promptSelectOrCustom(title, options, currentValue){
      const printable = options
        .filter(opt => opt && opt !== 'Other')
        .map(opt => '- ' + opt)
        .join('\n');
      const message = title + '\n' + printable + '\nScrivi un valore personalizzato:';
      const selected = prompt(message, currentValue || '');
      if(selected === null) return null;
      return selected.trim();
    }

    // --- IMPLANTS MANAGEMENT ---
    let currentImplantTypeFilter = 'Tutti';
    let currentImplantCompanyFilter = 'Tutte';
    let currentImplantModelFilter = 'Tutti';
    let currentImplantExpiryFilter = 'Tutte';

    function getImplantDisplayModel(implant){
      return implant && (implant.model || implant.kitComponents) ? (implant.model || implant.kitComponents) : null;
    }

    function getImplantIdentityKey(implant){
      const parts = [
        String(implant && implant.type ? implant.type : '').trim().toLowerCase(),
        String(implant && implant.company ? implant.company : '').trim().toLowerCase(),
        String(getImplantDisplayModel(implant) || '').trim().toLowerCase(),
        String(implant && implant.diameter ? implant.diameter : '').trim().toLowerCase(),
        String(implant && implant.length ? implant.length : '').trim().toLowerCase()
      ];
      return parts.join('|');
    }

    function normalizeImplantBatchRecord(batch, implant){
      if(!batch || typeof batch !== 'object') return null;
      const qty = Number(batch.quantitÃ  ?? batch.quantita ?? batch.originalQuantita ?? batch.quantity ?? 0) || 0;
      const qtyRemaining = Number(
        batch.quantitÃ Rimanente ?? batch.quantitaRimanente ?? batch.remainingQuantity ?? batch.quantityRemaining ?? qty
      ) || 0;

      return {
        ...batch,
        batchId: batch.batchId || batch.id || ('lotto_implant_' + String(implant.id || 'imp') + '_' + Date.now()),
        dataOrdine: batch.dataOrdine || batch.orderDate || batch.data || implant.orderDate || implant.createdAt || new Date().toISOString(),
        quantitÃ : qty,
        quantitÃ Rimanente: qtyRemaining,
        prezzo: Number(batch.prezzo ?? batch.price ?? implant.price ?? 0) || 0,
        scadenza: batch.scadenza ?? batch.expiry ?? implant.expiry ?? null,
        azienda: batch.azienda || batch.company || implant.company || ''
      };
    }

    function recomputeImplantExpiryFromBatches(batches){
      if(!Array.isArray(batches) || batches.length === 0) return null;
      const dated = batches
        .filter(b => Number(b.quantitÃ Rimanente || 0) > 0)
        .map(b => parseFlexibleDate(b.scadenza))
        .filter(Boolean)
        .sort((a, b) => b.getTime() - a.getTime());
      if(dated.length === 0) return null;
      return dated[0].toISOString();
    }

    function loadImplantsFromStorage(){
      const saved = localStorage.getItem('magazzino_implants');
      const implants = saved ? JSON.parse(saved) : [];
      if(!Array.isArray(implants)) return [];
      let changed = false;
      const normalized = implants.map(item => {
        if(!item || typeof item !== 'object') return item;
        const next = { ...item };
        if(!next.id){
          next.id = (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_implant_' + Date.now() + '_' + Math.floor(Math.random() * 100000));
          changed = true;
        }

        if(!Array.isArray(next.batches)) {
          next.batches = [];
          changed = true;
        }

        if(!Array.isArray(next.consumptionHistory)) {
          next.consumptionHistory = [];
          changed = true;
        }

        const normalizedBatches = next.batches
          .map(batch => normalizeImplantBatchRecord(batch, next))
          .filter(Boolean);
        if(normalizedBatches.length !== next.batches.length) changed = true;

        const currentQty = Number(next.quantity || 0) || 0;
        if(normalizedBatches.length === 0 && currentQty > 0){
          normalizedBatches.push(normalizeImplantBatchRecord({
            batchId: 'lotto_restore_' + String(next.id || 'imp') + '_' + Date.now(),
            dataOrdine: next.orderDate || next.createdAt || new Date().toISOString(),
            quantitÃ : currentQty,
            quantitÃ Rimanente: currentQty,
            prezzo: Number(next.price || 0),
            scadenza: next.expiry || null,
            azienda: next.company || ''
          }, next));
          changed = true;
        }

        next.batches = normalizedBatches;
        const computedQty = normalizedBatches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
        if(currentQty !== computedQty) {
          next.quantity = computedQty;
          changed = true;
        }

        const computedExpiry = recomputeImplantExpiryFromBatches(normalizedBatches);
        const currentExpiry = parseFlexibleDate(next.expiry);
        const currentExpiryIso = currentExpiry ? currentExpiry.toISOString() : null;
        if((computedExpiry || null) !== (currentExpiryIso || null)) {
          next.expiry = computedExpiry;
          changed = true;
        }

        return next;
      });
      if(changed){
        saveImplantsToStorage(normalized);
      }
      return normalized;
    }

    function saveImplantsToStorage(implants){
      localStorage.setItem('magazzino_implants', JSON.stringify(implants));
      checkAndNotify(allDocs);
    }

    function toFirestoreImplantData(implant){
      const implantData = {...implant};
      delete implantData.id;
      if(implantData.orderDate && typeof implantData.orderDate === 'string'){
        implantData.orderDate = new Date(implantData.orderDate);
      }
      if(implantData.expiry && typeof implantData.expiry === 'string'){
        implantData.expiry = new Date(implantData.expiry);
      }
      if(implantData.createdAt && typeof implantData.createdAt === 'string'){
        implantData.createdAt = new Date(implantData.createdAt);
      }
      return implantData;
    }

    async function syncLocalImplantsToFirebase(){
      if(!firebaseReady || typeof db === 'undefined') return;
      try {
        const localImplants = loadImplantsFromStorage();
        if(!localImplants || localImplants.length === 0) return;
        await Promise.all(
          localImplants
            .filter(item => item && item.id)
            .map(item => db.collection('implants').doc(item.id).set(toFirestoreImplantData(item), { merge: true }))
        );
      } catch(err){
        console.warn('Sync locale impianti verso Firebase non riuscita:', err);
      }
    }

    // Gestione opzioni dinamiche per modelli e nomenclature
    function loadImplantModels(){
      const saved = localStorage.getItem('implant_models');
      return saved ? JSON.parse(saved) : ['BLT', 'BL', 'BLX'];
    }

    function loadImplantNomenclatures(){
      const saved = localStorage.getItem('implant_nomenclatures');
      return saved ? JSON.parse(saved) : ['RN', 'RB', 'NC', 'RC'];
    }

    function loadKitComponents(){
      const saved = localStorage.getItem('kit_components');
      return saved ? JSON.parse(saved) : ['Frese chirurgiche'];
    }

    function saveKitComponent(component){
      if(!component || component.trim() === '') return;
      const components = loadKitComponents();
      const trimmedComponent = component.trim();
      if(!components.includes(trimmedComponent)){
        components.push(trimmedComponent);
        components.sort();
        localStorage.setItem('kit_components', JSON.stringify(components));
      }
    }

    function saveImplantModel(model, type){
      if(!model || model.trim() === '') return;
      const trimmedModel = model.trim();
      
      // Determina se Ã¨ un impianto o una componente
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const storageKey = isComponent ? 'implant_nomenclatures' : 'implant_models';
      const saved = localStorage.getItem(storageKey);
      const models = saved ? JSON.parse(saved) : [];
      
      if(!models.includes(trimmedModel)){
        models.push(trimmedModel);
        models.sort();
        localStorage.setItem(storageKey, JSON.stringify(models));
      }
    }

    function populateImplantModelSelect(){
      const select = document.getElementById('implantModel');
      const type = document.getElementById('implantType').value;
      
      // Carica la lista appropriata in base al tipo
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const models = isComponent ? loadImplantNomenclatures() : loadImplantModels();
      
      // Mantieni solo l'opzione vuota
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      // Aggiungi le opzioni salvate
      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        select.appendChild(option);
      });
    }

    function populateKitComponentsSelect(){
      const select = document.getElementById('implantKitComponents');
      const components = loadKitComponents();
      
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      components.forEach(component => {
        const option = document.createElement('option');
        option.value = component;
        option.textContent = component;
        select.appendChild(option);
      });
    }

    function addImplantToStorage(implant){
      const implants = loadImplantsFromStorage();
      const newImplant = {...implant, id: implant.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_implant_'+Date.now())};
      if(newImplant.orderDate instanceof Date) newImplant.orderDate = newImplant.orderDate.toISOString();
      if(newImplant.expiry instanceof Date) newImplant.expiry = newImplant.expiry.toISOString();
      if(newImplant.createdAt instanceof Date) newImplant.createdAt = newImplant.createdAt.toISOString();

      const batchId = 'lotto_impl_' + String(newImplant.id).substring(0, 8) + '_' + Date.now();
      const newBatch = normalizeImplantBatchRecord({
        batchId,
        dataOrdine: newImplant.orderDate,
        quantitÃ : Number(newImplant.quantity || 0),
        quantitÃ Rimanente: Number(newImplant.quantity || 0),
        prezzo: Number(newImplant.price || 0),
        scadenza: newImplant.expiry || null,
        azienda: newImplant.company || ''
      }, newImplant);

      const identityKey = getImplantIdentityKey(newImplant);
      const existingIdx = implants.findIndex(item => getImplantIdentityKey(item) === identityKey);

      if(existingIdx >= 0){
        const existing = implants[existingIdx];
        if(!Array.isArray(existing.batches)) existing.batches = [];
        if(newBatch) existing.batches.push(newBatch);
        existing.quantity = existing.batches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
        existing.expiry = recomputeImplantExpiryFromBatches(existing.batches);
        existing.updatedAt = new Date().toISOString();
        implants[existingIdx] = existing;
        saveImplantsToStorage(implants);
        return existing.id;
      }

      newImplant.batches = newBatch ? [newBatch] : [];
      newImplant.consumptionHistory = Array.isArray(newImplant.consumptionHistory) ? newImplant.consumptionHistory : [];
      newImplant.quantity = newImplant.batches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
      newImplant.expiry = recomputeImplantExpiryFromBatches(newImplant.batches);
      implants.push(newImplant);
      saveImplantsToStorage(implants);
      return newImplant.id;
    }

    function updateImplantQuantity(id, delta){
      if(delta < 0){
        showAlert('âš ï¸ Per ridurre la quantitÃ  degli impianti, usa il "Registro Uscite Impianti"', 'warn');
        return;
      }
      const implants = loadImplantsFromStorage();
      const item = implants.find(m=>m.id === id);
      if(item){
        item.quantity = Math.max(0, (item.quantity || 0) + delta);
        saveImplantsToStorage(implants);
        
        // Sync to Firebase
        if(firebaseReady && typeof db !== 'undefined'){
          const ref = db.collection('implants').doc(id);
          db.runTransaction(async tx=>{
            const doc = await tx.get(ref);
            if(!doc.exists) return;
            const q = Math.max(0, (doc.data().quantity || 0) + delta);
            tx.update(ref, {quantity: q});
          }).catch(err => {
            console.warn('Firebase update failed for implant quantity:', err);
          });
        }
      }
      renderImplantsList();
    }

    function deleteImplant(id){
      if(!ensureDeleteAdmin()) return;
      if(!confirm('Eliminare questo impianto?')) return;
      const implants = loadImplantsFromStorage();
      const filtered = implants.filter(m=>m.id !== id);
      saveImplantsToStorage(filtered);
      
      // Sync to Firebase
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('implants').doc(id).delete().catch(err => {
          console.warn('Firebase delete failed for implant:', err);
        });
      }
      
      renderImplantsList();
    }

    function editImplantExpiry(id){
      const implants = loadImplantsFromStorage();
      const implant = implants.find(i => i.id === id);
      if(!implant) return;
      
      const currentExpiry = implant.expiry ? new Date(implant.expiry).toISOString().split('T')[0] : '';
      const newExpiry = prompt('Inserisci data scadenza (YYYY-MM-DD). Lascia vuoto per rimuovere:', currentExpiry);
      
      if(newExpiry === null) return; // Annullato
      
      const expiryValue = (newExpiry || '').trim();
      if(!expiryValue){
        // Rimuovi scadenza
        implant.expiry = null;
      } else {
        const parsed = new Date(expiryValue);
        if(isNaN(parsed.getTime())){
          showAlert('Data scadenza non valida. Usa formato YYYY-MM-DD.', 'warn');
          return;
        }
        implant.expiry = parsed;
      }
      
      saveImplantsToStorage(implants);
      
      // Sync to Firebase
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('implants').doc(id).update({ expiry: implant.expiry }).catch(err => {
          console.warn('Firebase update failed for implant expiry:', err);
        });
      }
      
      renderImplantsList();
    }

    async function editImplantBatchExpiry(implantId, batchId){
      const implants = loadImplantsFromStorage();
      const implantIdx = implants.findIndex(i => String(i.id) === String(implantId));
      if(implantIdx < 0){
        showAlert('Impianto non trovato', 'warn');
        return;
      }

      const implant = implants[implantIdx];
      if(!Array.isArray(implant.batches) || implant.batches.length === 0){
        showAlert('Nessun lotto disponibile', 'warn');
        return;
      }

      const batch = implant.batches.find(b => String(b.batchId || b.id) === String(batchId));
      if(!batch){
        showAlert('Lotto non trovato', 'warn');
        return;
      }

      const current = parseFlexibleDate(batch.scadenza);
      const currentInput = current ? current.toISOString().split('T')[0] : '';
      const newExpiry = prompt('Inserisci data scadenza lotto impianto (YYYY-MM-DD). Lascia vuoto per rimuovere:', currentInput);
      if(newExpiry === null) return;

      const value = String(newExpiry || '').trim();
      if(!value){
        batch.scadenza = null;
      } else {
        const parsed = parseFlexibleDate(value);
        if(!parsed){
          showAlert('Data scadenza lotto non valida. Usa formato YYYY-MM-DD.', 'warn');
          return;
        }
        batch.scadenza = parsed.toISOString();
      }

      implant.updatedAt = new Date().toISOString();
      implant.expiry = recomputeImplantExpiryFromBatches(implant.batches);
      implants[implantIdx] = implant;
      saveImplantsToStorage(implants);

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('implants').doc(implant.id).set({
            batches: implant.batches,
            expiry: implant.expiry,
            updatedAt: implant.updatedAt
          }, { merge: true });
        } catch(err){
          console.warn('Firebase update lotto impianto non riuscito:', err && err.message ? err.message : err);
        }
      }

      renderImplantsList();
      showAlert('âœ“ Scadenza lotto impianto aggiornata', 'info');
    }

    function renderImplantsList(){
      const implantsList = document.getElementById('implantsList');
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => (getImplantDisplayModel(i) || '') === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }
      
      // Ordina per data ordine (piÃ¹ recente -> meno recente)
      implants.sort((a, b) => {
        const dateA = parseFlexibleDate(a.orderDate || a.createdAt);
        const dateB = parseFlexibleDate(b.orderDate || b.createdAt);
        const timeA = dateA ? dateA.getTime() : 0;
        const timeB = dateB ? dateB.getTime() : 0;
        if(timeA !== timeB) return timeB - timeA;
        return String(a.type || '').localeCompare(String(b.type || ''), 'it-IT');
      });
      
      implantsList.innerHTML = '';
      
      implants.forEach(implant=>{
        const tr = document.createElement('tr');
        const orderDate = parseFlexibleDate(implant.orderDate);
        const expiry = parseFlexibleDate(implant.expiry);
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        const displayModel = getImplantDisplayModel(implant);
        const expandBtnId = 'expand_impl_' + implant.id;
        const lotDetailId = 'lot_impl_' + implant.id;
        
        // Semaforo scadenza (editabile)
        let statusHtml = '';
        if(!expiry){
          statusHtml = '<span onclick="editImplantExpiry(\''+implant.id+'\')" title="Clicca per impostare scadenza" style="font-size:24px;cursor:pointer;">âšª</span>';
        } else {
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          if(days < 0) {
            statusHtml = '<span onclick="editImplantExpiry(\''+implant.id+'\')" title="Scaduto il ' + formatDate(expiry) + ' - Clicca per modificare" style="font-size:24px;cursor:pointer;">ğŸ”´</span>';
          } else if(mesi < 3) {
            statusHtml = '<span onclick="editImplantExpiry(\''+implant.id+'\')" title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + ' - Clicca per modificare" style="font-size:24px;cursor:pointer;">ğŸ”´</span>';
          } else if(mesi < 6) {
            statusHtml = '<span onclick="editImplantExpiry(\''+implant.id+'\')" title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + ' - Clicca per modificare" style="font-size:24px;cursor:pointer;">ğŸŸ¡</span>';
          } else {
            statusHtml = '<span onclick="editImplantExpiry(\''+implant.id+'\')" title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + ' - Clicca per modificare" style="font-size:24px;cursor:pointer;">ğŸŸ¢</span>';
          }
        }
        
        // Badge quantitÃ 
        const qtyBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+implant.quantity+'</span>';
        
        tr.innerHTML = `
          <td data-label="Tipo"><button class="batch-expand-btn" id="${expandBtnId}" style="margin-right:8px">â–¶</button>${escapeHtml(implant.type)}</td>
          <td data-label="Azienda">${escapeHtml(implant.company)}</td>
          <td data-label="Modello">${escapeHtml(displayModel || '-')}</td>
          <td data-label="Ã˜">${diameter}</td>
          <td data-label="L">${length}</td>
          <td data-label="Data ordine">${formatDate(orderDate)}</td>
          <td data-label="Scadenza" style="text-align:center;white-space:nowrap;">${statusHtml}</td>
          <td data-label="Prezzo">â‚¬ ${Number(implant.price||0).toFixed(2)}</td>
          <td data-label="QuantitÃ " style="text-align:center">${qtyBadge}</td>
          <td data-label="Azioni" style="white-space:nowrap">
            ${(!deleteRestrictionsActive || isDeleteAdmin)
              ? `<button class="btn-action btn-del" onclick="deleteImplant('${implant.id}')" title="Elimina">Ã—</button>`
              : '<span title="Solo amministratore" style="font-size:16px;opacity:0.7">ğŸ”’</span>'}
          </td>
        `;
        implantsList.appendChild(tr);

        const lotDetailRow = document.createElement('tr');
        lotDetailRow.id = lotDetailId;
        lotDetailRow.className = 'batch-details';

        const lots = Array.isArray(implant.batches) ? implant.batches : [];
        let lotsHtml = '<div class="batches-list">';
        if(lots.length === 0) {
          lotsHtml += '<div style="color:#666;font-size:13px">Nessun lotto disponibile</div>';
        } else {
          const sortedLotsForDisplay = [...lots].sort((a, b) => new Date(b.dataOrdine || 0) - new Date(a.dataOrdine || 0));
          sortedLotsForDisplay.forEach((lot, lotIndex) => {
            const lotExpiry = parseFlexibleDate(lot.scadenza);
            const lotDays = lotExpiry ? daysBetween(now, lotExpiry) : null;
            const encodedImplantId = encodeURIComponent(String(implant.id));
            const encodedLotId = encodeURIComponent(String(lot.batchId || lot.id || ''));
            const lotExpiryLabel = lotExpiry ? formatDate(lotExpiry) : 'N/A';
            const lotLabel = getLotDisplayLabel(lot, lotIndex);
            let expiryClass = 'expiry-ok';
            if (lotDays !== null && lotDays < 0) expiryClass = 'expiry-critical';
            else if (lotDays !== null && lotDays < 90) expiryClass = 'expiry-warn';

            lotsHtml += `
              <div class="batch-card">
                <div class="batch-card-header">
                  <div><strong>${lotLabel}</strong></div>
                  <div>Data ordine: ${formatDate(lot.dataOrdine)}</div>
                  <div>Scade: <span class="editable-implant-lot-expiry" data-implant-id="${encodedImplantId}" data-lot-id="${encodedLotId}" title="Clicca per modificare scadenza lotto" style="cursor:pointer;text-decoration:underline;color:#003d7a">${lotExpiryLabel}</span></div>
                  <div><span class="expiry-status ${expiryClass}">${lot.quantitÃ Rimanente}/${lot.quantitÃ } pz</span></div>
                </div>
                <div style="font-size:12px;color:#666;margin-top:6px">
                  Azienda: ${escapeHtml(lot.azienda || implant.company || 'N/A')} | Prezzo: â‚¬${Number(lot.prezzo || implant.price || 0).toFixed(2)}
                </div>
            `;

            if (Array.isArray(lot.consumptions) && lot.consumptions.length > 0) {
              lotsHtml += '<div class="consumption-history">ğŸ“‰ Consumi: ';
              lot.consumptions.forEach(c => {
                lotsHtml += `${c.quantitÃ  || 0}pz (${formatDate(c.data)}) `;
              });
              lotsHtml += '</div>';
            }

            lotsHtml += '</div>';
          });
        }
        lotsHtml += '</div>';
        lotDetailRow.innerHTML = `<td colspan="10">${lotsHtml}</td>`;

        lotDetailRow.querySelectorAll('.editable-implant-lot-expiry').forEach(el => {
          el.addEventListener('click', () => {
            const implantId = decodeURIComponent(el.getAttribute('data-implant-id') || '');
            const lotId = decodeURIComponent(el.getAttribute('data-lot-id') || '');
            if(implantId && lotId) editImplantBatchExpiry(implantId, lotId);
          });
        });

        setTimeout(() => {
          if (tr.parentNode) {
            tr.parentNode.insertBefore(lotDetailRow, tr.nextSibling);
          }
        }, 0);

        const expandBtn = tr.querySelector('#' + expandBtnId);
        if(expandBtn){
          expandBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const detail = document.getElementById(lotDetailId);
            if(detail){
              detail.classList.toggle('show');
              expandBtn.textContent = detail.classList.contains('show') ? 'â–¼' : 'â–¶';
            }
          });
        }
      });
    }

    function toggleActionMenu(menuId){
      const menu = document.getElementById(menuId);
      const isVisible = menu.style.display !== 'none';
      
      // Nascondi tutti i menu aperti
      document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      
      // Mostra il menu corrente se non era visibile
      if(!isVisible){
        menu.style.display = 'block';
      }
    }

    // Chiudi i menu quando clicki fuori
    document.addEventListener('click', function(event){
      if(!event.target.closest('.action-menu-btn') && !event.target.closest('.action-menu')){
        document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      }
    });

    function openImplantsModal(){
      document.getElementById('implantsModal').classList.add('active');
      populateImplantModelSelect();
      populateKitComponentsSelect();
      initImplantFilters();
      renderImplantsList();
      syncLocalImplantsToFirebase();
    }

    function closeImplantsModal(){
      document.getElementById('implantsModal').classList.remove('active');
    }

    function initImplantFilters(){
      const implants = loadImplantsFromStorage();
      
      // Popola filtro aziende
      const companies = [...new Set(implants.map(i => i.company).filter(c => c))];
      const companyFilter = document.getElementById('implantCompanyFilter');
      companyFilter.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.sort().forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companyFilter.appendChild(option);
      });
      
      // Popola filtro modelli in base al tipo
      updateImplantModelFilter();
    }

    function updateImplantModelFilter(){
      const implants = loadImplantsFromStorage();
      const selectedType = currentImplantTypeFilter;
      const modelFilter = document.getElementById('implantModelFilter');
      const modelLabel = document.getElementById('implantModelFilterLabel');
      
      // Cambia etichetta in base al tipo
      const isScrew = selectedType === 'Vite tappo' || selectedType === 'Vite di guarigione';
      const isImplant = selectedType === 'Impianto';
      
      if(isScrew) {
        modelLabel.textContent = 'Filtra per nomenclatura:';
      } else if(isImplant) {
        modelLabel.textContent = 'Filtra per modello:';
      } else {
        modelLabel.textContent = 'Filtra per modello/nomenclatura:';
      }
      
      // Filtra modelli in base al tipo selezionato
      let filteredImplants = implants;
      if(selectedType !== 'Tutti'){
        filteredImplants = implants.filter(i => i.type === selectedType);
      }
      
      const models = [...new Set(filteredImplants.map(i => i.model).filter(m => m))];
      modelFilter.innerHTML = '<option value="Tutti">Tutti</option>';
      models.sort().forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelFilter.appendChild(option);
      });
      
      // Reset selezione se il modello corrente non Ã¨ piÃ¹ nella lista
      if(currentImplantModelFilter !== 'Tutti' && !models.includes(currentImplantModelFilter)){
        currentImplantModelFilter = 'Tutti';
        modelFilter.value = 'Tutti';
      }
    }

    function showAlert(text, type='info'){
      const d = document.createElement('div');
      d.className = 'alert ' + (type==='warn'?'warn':'info');
      d.textContent = text;
      alertsEl.appendChild(d);
      setTimeout(()=>d.remove(), 8000);
    }

    function daysBetween(a,b){
      const ms = 24*60*60*1000;
      return Math.ceil((b-a)/ms);
    }

    function parseFlexibleDate(value){
      if(!value) return null;
      if(value instanceof Date) return isNaN(value.getTime()) ? null : value;
      if(typeof value === 'number') {
        const fromNumber = new Date(value);
        return isNaN(fromNumber.getTime()) ? null : fromNumber;
      }

      const raw = String(value).trim();
      if(!raw) return null;

      const direct = new Date(raw);
      if(!isNaN(direct.getTime())) return direct;

      const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(m){
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        const yy = parseInt(m[3], 10);
        const fullYear = yy < 100 ? 2000 + yy : yy;
        const parsed = new Date(fullYear, mm - 1, dd);
        if(!isNaN(parsed.getTime())) return parsed;
      }

      return null;
    }

    function formatDate(value){
      const d = parseFlexibleDate(value);
      return d
        ? new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(d)
        : '--';
    }

    function getLotDisplayLabel(lot, index){
      const lotDate = formatDate(
        lot && typeof lot === 'object'
          ? (lot.dataOrdine || lot.orderDate || lot.createdAt)
          : null
      );
      const base = lotDate !== '--' ? `Lotto del ${lotDate}` : 'Lotto senza data';
      return Number.isInteger(index) ? `${base} Â· n.${index + 1}` : base;
    }

    function getConsumptionStatusLabel(status){
      return status === 'in_uso' ? 'In uso' : 'Consumato';
    }

    function getConsumptionStatusBadge(status){
      const label = getConsumptionStatusLabel(status);
      const style = status === 'in_uso'
        ? 'background:#fff8e1;color:#8a6d00;border:1px solid #f9a825;'
        : 'background:#ffebee;color:#b71c1c;border:1px solid #e53935;';
      return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;${style}">${label}</span>`;
    }

    function clampNumber(value, min, max, fallback){
      const n = Number(value);
      if(!Number.isFinite(n)) return fallback;
      return Math.min(max, Math.max(min, Math.round(n)));
    }

    function loadAlertsSettings(){
      try {
        const raw = localStorage.getItem(ALERTS_SETTINGS_KEY);
        if(!raw) return { ...DEFAULT_ALERTS_SETTINGS };
        const parsed = JSON.parse(raw);
        return {
          expiryWarningDays: clampNumber(parsed.expiryWarningDays, 1, 365, DEFAULT_ALERTS_SETTINGS.expiryWarningDays),
          implantLowQtyWarning: clampNumber(parsed.implantLowQtyWarning, 1, 99, DEFAULT_ALERTS_SETTINGS.implantLowQtyWarning)
        };
      } catch {
        return { ...DEFAULT_ALERTS_SETTINGS };
      }
    }

    function applyAlertsSettingsToUI(){
      const expiryInput = document.getElementById('alertsExpiryDaysInput');
      const implantQtyInput = document.getElementById('alertsImplantLowQtyInput');
      const criteriaDays = document.getElementById('alertsCriteriaDays');
      const criteriaDaysImplants = document.getElementById('alertsCriteriaDaysImplants');
      const criteriaImplantQty = document.getElementById('alertsCriteriaImplantQty');

      if(expiryInput) expiryInput.value = alertsSettings.expiryWarningDays;
      if(implantQtyInput) implantQtyInput.value = alertsSettings.implantLowQtyWarning;
      if(criteriaDays) criteriaDays.textContent = alertsSettings.expiryWarningDays;
      if(criteriaDaysImplants) criteriaDaysImplants.textContent = alertsSettings.expiryWarningDays;
      if(criteriaImplantQty) criteriaImplantQty.textContent = alertsSettings.implantLowQtyWarning;
    }

    function saveAlertsSettings(){
      const expiryInput = document.getElementById('alertsExpiryDaysInput');
      const implantQtyInput = document.getElementById('alertsImplantLowQtyInput');

      alertsSettings = {
        expiryWarningDays: clampNumber(expiryInput ? expiryInput.value : DEFAULT_ALERTS_SETTINGS.expiryWarningDays, 1, 365, DEFAULT_ALERTS_SETTINGS.expiryWarningDays),
        implantLowQtyWarning: clampNumber(implantQtyInput ? implantQtyInput.value : DEFAULT_ALERTS_SETTINGS.implantLowQtyWarning, 1, 99, DEFAULT_ALERTS_SETTINGS.implantLowQtyWarning)
      };

      localStorage.setItem(ALERTS_SETTINGS_KEY, JSON.stringify(alertsSettings));
      applyAlertsSettingsToUI();
      checkAndNotify(allDocs);
      showAlert('âœ“ Soglie avvisi aggiornate', 'info');
    }

    function buildMaterialAlerts(docs){
      const now = new Date();
      const alerts = [];

      docs.forEach(doc => {
        const data = doc.data();
        const name = data.name || 'Materiale senza nome';
        const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
        const qty = Number(data.quantity || 0);
        const threshold = Number(data.lowStockThreshold || 2);

        if (expiry && !isNaN(expiry.getTime())) {
          const days = daysBetween(now, expiry);
          if (days < 0) {
            alerts.push({
              level: 'critical',
              source: 'materials',
              item: name,
              type: 'Scadenza',
              detail: 'Scaduto il ' + expiry.toLocaleDateString('it-IT')
            });
          } else if (days <= alertsSettings.expiryWarningDays) {
            alerts.push({
              level: 'warning',
              source: 'materials',
              item: name,
              type: 'Scadenza',
              detail: 'Scade tra ' + days + ' giorni (' + expiry.toLocaleDateString('it-IT') + ')'
            });
          }
        }

        if (qty < threshold) {
          alerts.push({
            level: 'critical',
            source: 'materials',
            item: name,
            type: 'QuantitÃ ',
            detail: 'QuantitÃ  ' + qty + ' sotto soglia ' + threshold
          });
        } else if (qty === threshold) {
          alerts.push({
            level: 'warning',
            source: 'materials',
            item: name,
            type: 'QuantitÃ ',
            detail: 'QuantitÃ  pari alla soglia (' + threshold + ')'
          });
        }
      });

      return alerts;
    }

    function buildImplantAlerts(){
      const now = new Date();
      const implants = loadImplantsFromStorage();
      const alerts = [];

      implants.forEach(implant => {
        const itemName = [implant.type, implant.model].filter(Boolean).join(' - ') || implant.type || implant.model || 'Impianto';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const qty = Number(implant.quantity || 0);

        if (expiry && !isNaN(expiry.getTime())) {
          const days = daysBetween(now, expiry);
          if (days < 0) {
            alerts.push({
              level: 'critical',
              source: 'implants',
              item: itemName,
              type: 'Scadenza',
              detail: 'Scaduto il ' + expiry.toLocaleDateString('it-IT')
            });
          } else if (days <= alertsSettings.expiryWarningDays) {
            alerts.push({
              level: 'warning',
              source: 'implants',
              item: itemName,
              type: 'Scadenza',
              detail: 'Scade tra ' + days + ' giorni (' + expiry.toLocaleDateString('it-IT') + ')'
            });
          }
        }

        if (qty <= 0) {
          alerts.push({
            level: 'critical',
            source: 'implants',
            item: itemName,
            type: 'QuantitÃ ',
            detail: 'QuantitÃ  esaurita (0)'
          });
        } else if (qty <= alertsSettings.implantLowQtyWarning) {
          alerts.push({
            level: 'warning',
            source: 'implants',
            item: itemName,
            type: 'QuantitÃ ',
            detail: 'QuantitÃ  bassa: ' + qty + ' (soglia ' + alertsSettings.implantLowQtyWarning + ')'
          });
        }
      });

      return alerts;
    }

    function updateAlertsReportBadge(){
      const badgeEl = document.getElementById('alertsReportCount');
      if (!badgeEl) return;
      const total = alertsReportData.materials.length + alertsReportData.implants.length;
      badgeEl.textContent = total;
      badgeEl.style.background = total > 0 ? '#d32f2f' : '#2e7d32';
    }

    function updateAlertsReportSection(tbodyId, alerts, emptyMessage){
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!alerts.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="4" style="text-align:center;color:#666;padding:16px">' + emptyMessage + '</td>';
        tbody.appendChild(tr);
        return;
      }

      alerts.forEach(alert => {
        const tr = document.createElement('tr');
        const levelLabel = alert.level === 'critical' ? 'Critico' : 'Attenzione';
        tr.innerHTML = `
          <td><span class="severity-badge ${alert.level}">${levelLabel}</span></td>
          <td>${alert.item}</td>
          <td>${alert.type}</td>
          <td>${alert.detail}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAlertsReport(){
      const materialAlerts = alertsReportData.materials;
      const implantAlerts = alertsReportData.implants;
      const allAlerts = [...materialAlerts, ...implantAlerts];
      const criticalCount = allAlerts.filter(a => a.level === 'critical').length;

      const totalEl = document.getElementById('alertsReportTotal');
      const materialsEl = document.getElementById('alertsReportMaterials');
      const implantsEl = document.getElementById('alertsReportImplants');
      const criticalEl = document.getElementById('alertsReportCritical');
      const emptyEl = document.getElementById('alertsReportEmpty');

      if (totalEl) totalEl.textContent = allAlerts.length;
      if (materialsEl) materialsEl.textContent = materialAlerts.length;
      if (implantsEl) implantsEl.textContent = implantAlerts.length;
      if (criticalEl) criticalEl.textContent = criticalCount;

      if (emptyEl) {
        if (allAlerts.length === 0) {
          emptyEl.textContent = 'âœ… Nessun avviso attivo al momento.';
          emptyEl.classList.remove('warn');
        } else {
          emptyEl.textContent = 'âš ï¸ Avvisi attivi rilevati. Materiali e Implantare sono separati nelle tabelle seguenti.';
          emptyEl.classList.add('warn');
        }
      }

      updateAlertsReportSection('alertsReportMaterialsTableBody', materialAlerts, 'Nessun avviso attivo per il magazzino materiali');
      updateAlertsReportSection('alertsReportImplantsTableBody', implantAlerts, 'Nessun avviso attivo per il magazzino implantare');
      updateAlertsReportBadge();
    }

    function openAlertsReportModal() {
      const modal = document.getElementById('alertsReportModal');
      if (!modal) return;
      applyAlertsSettingsToUI();
      renderAlertsReport();
      modal.classList.add('active');
    }

    function closeAlertsReportModal() {
      const modal = document.getElementById('alertsReportModal');
      if (!modal) return;
      modal.classList.remove('active');
    }

    function initCategoryFilters(){
      categoryFiltersEl.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'category-btn' + (cat === currentFilter ? ' active' : '');
        btn.textContent = cat;
        btn.addEventListener('click', ()=>{
          currentFilter = cat;
          updateCategoryFilters();
          renderFilteredMaterials();
        });
        categoryFiltersEl.appendChild(btn);
      });
      // Filtro aziende: menu a tendina
      if (companyFilterSelect) {
        const companies = Array.from(new Set(allDocs.map(doc => (doc.data().company || '').trim()).filter(c => c))).sort();
        companyFilterSelect.innerHTML = '<option value="Tutte">Tutte</option>';
        companies.forEach(comp => {
          if(comp) {
            const opt = document.createElement('option');
            opt.value = comp;
            opt.textContent = comp;
            companyFilterSelect.appendChild(opt);
          }
        });
        companyFilterSelect.value = currentCompanyFilter;
      }
      // Filtro distributori: menu a tendina
      if (distributorFilterSelect) {
        const distributors = Array.from(new Set(allDocs.map(doc => (doc.data().distributor || '').trim()).filter(c => c))).sort();
        distributorFilterSelect.innerHTML = '<option value="Tutti">Tutti</option>';
        distributors.forEach(dist => {
          if(dist) {
            const opt = document.createElement('option');
            opt.value = dist;
            opt.textContent = dist;
            distributorFilterSelect.appendChild(opt);
          }
        });
        distributorFilterSelect.value = currentDistributorFilter;
      }
    }

    function updateCategoryFilters(){
      const btns = categoryFiltersEl.querySelectorAll('.category-btn');
      btns.forEach(btn=>{
        if(btn.textContent === currentFilter){
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    // Rimosso updateCompanyFilters: non serve piÃ¹ con il select

    function loadMaterialsFromStorage(){
      const localData = loadFromLocalStorage();
      allDocs = localData.map(d=>({id: d.id, data: ()=>d}));
      initCategoryFilters();
      renderFilteredMaterials();
      checkAndNotify(allDocs);
      updateResetButtonVisibility();
    }

    function renderFilteredMaterials(){
      listEl.innerHTML = '';
      let filtered = currentFilter === 'Tutti' 
        ? allDocs 
        : allDocs.filter(doc=>doc.data().category === currentFilter);
      if(currentCompanyFilter !== 'Tutte'){
        filtered = filtered.filter(doc => (doc.data().company || '') === currentCompanyFilter);
      }
      if(currentDistributorFilter !== 'Tutti'){
        filtered = filtered.filter(doc => (doc.data().distributor || '') === currentDistributorFilter);
      }
      // Filtro scadenza semaforo
      if(currentExpiryFilter !== 'Tutte'){
        const now = new Date();
        filtered = filtered.filter(doc => {
          const data = doc.data();
          if(!data.expiry) return false;
          const expiry = data.expiry && data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry);
          const days = Math.ceil((expiry - now) / (1000*60*60*24));
          const mesi = days / 30.44;
          if(days < 0) return currentExpiryFilter === 'Rosso';
          if(mesi < 3) return currentExpiryFilter === 'Rosso';
          if(mesi < 6) return currentExpiryFilter === 'Giallo';
          return currentExpiryFilter === 'Verde';
        });
      }
      // Filtro quantitÃ  semaforo
      if(currentQuantityFilter !== 'Tutte'){
        filtered = filtered.filter(doc => {
          const data = doc.data();
          const soglia = data.lowStockThreshold || 2;
          if(currentQuantityFilter === 'Rosso') return (data.quantity||0) < soglia;
          if(currentQuantityFilter === 'Giallo') return (data.quantity||0) == soglia;
          if(currentQuantityFilter === 'Verde') return (data.quantity||0) > soglia;
          return true;
        });
      }
      
      // Ordina per data ordine (piÃ¹ recente -> meno recente)
      filtered.sort((a, b) => {
        const dateA = parseFlexibleDate(a.data().orderDate || a.data().createdAt);
        const dateB = parseFlexibleDate(b.data().orderDate || b.data().createdAt);
        const timeA = dateA ? dateA.getTime() : 0;
        const timeB = dateB ? dateB.getTime() : 0;
        if(timeA !== timeB) return timeB - timeA;
        const nameA = (a.data().name || '').toLowerCase();
        const nameB = (b.data().name || '').toLowerCase();
        return nameA.localeCompare(nameB, 'it-IT');
      });
      
      filtered.forEach(doc=>{
        const tr = renderItem(doc);
        listEl.appendChild(tr);
      });
            // Gestione filtro quantitÃ  da select
            const quantityFilterSelect = document.getElementById('quantityFilterSelect');
            if (quantityFilterSelect) {
              quantityFilterSelect.addEventListener('change', function() {
                currentQuantityFilter = this.value;
                renderFilteredMaterials();
                updateResetButtonVisibility();
              });
            }
        // Gestione filtro scadenza da select
        const expiryFilterSelect = document.getElementById('expiryFilterSelect');
        if (expiryFilterSelect) {
          expiryFilterSelect.addEventListener('change', function() {
            currentExpiryFilter = this.value;
            renderFilteredMaterials();
            updateResetButtonVisibility();
          });
        }
    }

    // Funzione per convertire in Title Case (iniziali maiuscole)
    function toTitleCase(str) {
      return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function refreshMatNameSuggestions(filterText = '') {
      const datalist = document.getElementById('matNameSuggestions');
      if (!datalist) return;

      const normalizedFilter = (filterText || '').toLowerCase().trim();
      const materials = loadFromLocalStorage();
      const uniqueNames = Array.from(new Set(
        materials
          .map(m => (m && m.name ? String(m.name).trim() : ''))
          .filter(Boolean)
      ));

      const filteredNames = uniqueNames
        .filter(name => {
          if (!normalizedFilter) return true;
          return name.toLowerCase().includes(normalizedFilter);
        })
        .sort((a, b) => a.localeCompare(b, 'it-IT'))
        .slice(0, 40);

      datalist.innerHTML = '';
      filteredNames.forEach(name => {
        const option = document.createElement('option');
        option.value = toTitleCase(name);
        datalist.appendChild(option);
      });
    }

    let modalAutoFillTimeout;
    document.getElementById('matName').addEventListener('input', function() {
      clearTimeout(modalAutoFillTimeout);
      const materialName = this.value.trim();
      refreshMatNameSuggestions(materialName);

      modalAutoFillTimeout = setTimeout(() => {
        const materials = loadFromLocalStorage();
        const lowerName = materialName.toLowerCase();

        const match = materials.find(m => m.name && m.name.toLowerCase() === lowerName);

        if(!match && materialName.length < 3) return;

        if(match) {
          document.getElementById('matName').value = toTitleCase(match.name);

          if(match.category) {
            document.getElementById('matCategory').value = match.category;
          }

          if(match.company) {
            const companySelect = document.getElementById('matCompany');
            const companyInput = document.getElementById('matCompanyCustom');
            const option = Array.from(companySelect.options).find(opt => opt.value === match.company);
            if(option) {
              companySelect.value = match.company;
              companyInput.style.display = 'none';
            } else {
              companySelect.value = 'Other';
              companyInput.value = match.company;
              companyInput.style.display = '';
            }
          }

          if(match.distributor) {
            const distSelect = document.getElementById('matDistributor');
            const distInput = document.getElementById('matDistributorCustom');
            const option = Array.from(distSelect.options).find(opt => opt.value === match.distributor);
            if(option) {
              distSelect.value = match.distributor;
              distInput.style.display = 'none';
            } else {
              distSelect.value = 'Other';
              distInput.value = match.distributor;
              distInput.style.display = '';
            }
          }
          setupMaterialCustomFields();
        }
      }, 600);
    });

    // Material Modal Form Handler
    document.getElementById('materialForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name = toTitleCase(document.getElementById('matName').value.trim());
      const orderDate = document.getElementById('matOrderDate').value;
      let price = parseFloat(document.getElementById('matPrice').value) || 0;
      const priceType = document.getElementById('matPriceType').value;
      const quantity = parseInt(document.getElementById('matQuantity').value,10) || 0;
      const vatRate = parseInt(document.getElementById('matVatRate').value, 10) || 22;
      
      // Se il prezzo Ã¨ totale, calcola il prezzo unitario
      if (priceType === 'totale' && quantity > 0) {
        price = price / quantity;
      }
      const category = document.getElementById('matCategory').value.trim();
      let distributor = document.getElementById('matDistributor').value.trim();
      if (distributor === 'Other') {
        distributor = document.getElementById('matDistributorCustom').value.trim();
      }
      let company = document.getElementById('matCompany').value.trim();
      if (company === 'Other') {
        company = document.getElementById('matCompanyCustom').value.trim();
      }
      const notifyDays = 30;
      const lowStockThreshold = 2;
      
      if(!name || !orderDate || !category || !distributor) {
        showAlert('Compila tutti i campi richiesti', 'warn');
        return;
      }
      
      const newData = {
        name, 
        orderDate: new Date(orderDate), 
        expiry: null,
        price, 
        vatRate,
        quantity, 
        category, 
        distributor, 
        company,
        notifyDays, 
        lowStockThreshold,
        createdAt: new Date(),
        updatedAt: new Date()
      };

      const existingByName = loadFromLocalStorage().find(m => (m.name || '').trim().toLowerCase() === name.toLowerCase());
      const materialId = existingByName
        ? existingByName.id
        : (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000)));
      
      addToLocalStorage({id: materialId, ...newData});
      
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          const localSaved = loadFromLocalStorage().find(m => m.id === materialId) || { id: materialId, ...newData };
          const cloudPayload = { ...localSaved };
          delete cloudPayload.id;
          await db.collection('materials').doc(materialId).set(cloudPayload, { merge: true });
        } catch(err) {
          console.warn('Firebase unavailable:', err.message);
        }
      }
      
      closeMaterialModal();
      showAlert(existingByName ? ('âœ“ ' + name + ' aggiornato con nuovo carico') : ('âœ“ ' + name + ' aggiunto'), 'info');
      setTimeout(loadMaterialsFromStorage, 100);
    });

    function renderItem(doc){
      const data = doc.data();
      const tr = document.createElement('tr');
      const now = new Date();
      const orderDate = data.orderDate ? (data.orderDate.toDate ? data.orderDate.toDate() : new Date(data.orderDate)) : null;
      const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
      let statusHtml = '';
      if(!expiry){
        statusHtml = '<span title="Nessuna scadenza" style="font-size:24px;cursor:help;">âšª</span>';
      } else {
        const days = daysBetween(now, expiry);
        const mesi = days / 30.44;
        if(days < 0) {
          statusHtml = '<span title="Scaduto il ' + formatDate(expiry) + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
        } else if(days <= 30) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + '" style="font-size:24px;cursor:help;">ğŸŸ¡</span>';
        } else if(mesi < 3) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + '" style="font-size:24px;cursor:help;">ğŸ”´</span>';
        } else if(mesi < 6) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + '" style="font-size:24px;cursor:help;">ğŸŸ¡</span>';
        } else {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + formatDate(expiry) + '" style="font-size:24px;cursor:help;">ğŸŸ¢</span>';
        }
      }
      // Badge semaforo quantitÃ 
      let lowBadge = '';
      const soglia = data.lowStockThreshold || 2;
      if (data.quantity < soglia) {
        lowBadge = '<span class="badge low" style="background:#d32f2f;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else if (data.quantity == soglia) {
        lowBadge = '<span class="badge soon" style="background:#fbc02d;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else {
        lowBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      }
      
      const expandBtnId = 'expand_' + doc.id;
      const batchDetailId = 'batch_' + doc.id;
      
      tr.innerHTML = `
        <td data-label="Nome"><button class="batch-expand-btn" id="${expandBtnId}" style="margin-right:8px">â–¶</button><span class="editable-name" style="cursor:pointer;text-decoration:underline;">${escapeHtml(data.name)}</span></td>
        <td data-label="Data ordine">${formatDate(orderDate)}</td>
        <td data-label="Scadenza" style="text-align:center;white-space:nowrap;"><span class="readonly-expiry" title="Scadenza riassuntiva automatica (modifica i singoli batch)">${statusHtml}</span></td>
        <td data-label="Prezzo" class="material-price-col">â‚¬ ${Number(data.price).toFixed(2)}</td>
        <td data-label="Distributore">${escapeHtml(data.distributor||'-')}</td>
        <td data-label="Azienda">${escapeHtml(data.company||'-')}</td>
        <td data-label="QuantitÃ " style="text-align:center;">${lowBadge}<div><span class="editable-threshold" title="Modifica soglia quantitÃ " style="font-size:11px;color:#003d7a;cursor:pointer;text-decoration:underline;">Soglia: ${soglia}</span></div></td>
        <td data-label="Azioni" style="white-space:nowrap;padding:8px;">
          ${(!deleteRestrictionsActive || isDeleteAdmin)
            ? `<button data-id="${doc.id}" class="btn-action btn-del" title="Elimina">Ã—</button>`
            : '<span title="Solo amministratore" style="font-size:16px;opacity:0.7">ğŸ”’</span>'}
        </td>
      `;
      
      // attach actions
      const deleteBtn = tr.querySelector('.btn-del');
      if(deleteBtn){
        deleteBtn.addEventListener('click', (e)=>{e.preventDefault(); deleteItem(doc.id)});
      }
      tr.querySelector('.editable-name').addEventListener('click', () => {
        const newName = prompt('Modifica nome materiale:', data.name);
        if(newName && newName.trim() && newName !== data.name) {
          const formattedName = toTitleCase(newName.trim());
          data.name = formattedName;
          updateMaterialFields(doc.id, { name: formattedName });
        }
      });
      tr.querySelector('.editable-threshold').addEventListener('click', () => {
        const newThresholdRaw = prompt('Inserisci soglia quantitÃ  minima (numero intero >= 1):', String(soglia));
        if (newThresholdRaw === null) return;
        const parsedThreshold = parseInt(newThresholdRaw, 10);
        if (!Number.isInteger(parsedThreshold) || parsedThreshold < 1) {
          showAlert('Soglia non valida. Inserisci un numero intero maggiore o uguale a 1.', 'warn');
          return;
        }
        updateMaterialFields(doc.id, { lowStockThreshold: parsedThreshold });
      });
      
      // Expand button per batch
      const expandBtn = tr.querySelector('#' + expandBtnId);
      expandBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const batchDetail = document.getElementById(batchDetailId);
        if (batchDetail) {
          batchDetail.classList.toggle('show');
          expandBtn.textContent = batchDetail.classList.contains('show') ? 'â–¼' : 'â–¶';
        }
      });
      
      // Crea riga batch details (nascosta)
      const batchDetailRow = document.createElement('tr');
      batchDetailRow.id = batchDetailId;
      batchDetailRow.className = 'batch-details';
      
      const batches = data.batches || [];
      let batchesHtml = '<div class="batches-list">';
      
      if (batches.length === 0) {
        batchesHtml += '<div style="color:#666;font-size:13px">Nessun lotto disponibile</div>';
      } else {
        const sortedBatchesForDisplay = [...batches].sort((a, b) => new Date(b.dataOrdine || 0) - new Date(a.dataOrdine || 0));
        sortedBatchesForDisplay.forEach((batch, batchIndex) => {
          const batchExpiry = batch.scadenza ? new Date(batch.scadenza) : null;
          const batchDays = batchExpiry ? daysBetween(now, batchExpiry) : null;
          const encodedMaterialId = encodeURIComponent(String(doc.id));
          const encodedBatchId = encodeURIComponent(String(batch.batchId || batch.id || ''));
          const batchExpiryLabel = batchExpiry ? formatDate(batchExpiry) : 'N/A';
          const batchLabel = getLotDisplayLabel(batch, batchIndex);
          
          let expiryClass = 'expiry-ok';
          if (batchDays !== null && batchDays < 0) expiryClass = 'expiry-critical';
          else if (batchDays !== null && batchDays < 90) expiryClass = 'expiry-warn';
          
          batchesHtml += `
            <div class="batch-card">
              <div class="batch-card-header">
                <div><strong>${batchLabel}</strong></div>
                <div>Data ordine: ${formatDate(batch.dataOrdine)}</div>
                <div>Scade: <span class="editable-batch-expiry" data-material-id="${encodedMaterialId}" data-batch-id="${encodedBatchId}" title="Clicca per modificare scadenza lotto" style="cursor:pointer;text-decoration:underline;color:#003d7a">${batchExpiryLabel}</span></div>
                <div><span class="expiry-status ${expiryClass}">${batch.quantitÃ Rimanente}/${batch.quantitÃ } pz</span></div>
              </div>
              <div style="font-size:12px;color:#666;margin-top:6px">
                Fornitore: ${escapeHtml(batch.distributore || data.distributor || 'N/A')} | Azienda: ${escapeHtml(batch.azienda || data.company || 'N/A')} | Prezzo: â‚¬${Number(batch.prezzo || 0).toFixed(2)} | Ordine ID: ${batch.ordinoId || 'N/A'}
              </div>
          `;
          
          if (batch.consumptions && batch.consumptions.length > 0) {
            batchesHtml += '<div class="consumption-history">ğŸ“‰ Consumi: ';
            batch.consumptions.forEach(c => {
              batchesHtml += `${c.quantitÃ }pz (${formatDate(c.data)}) `;
            });
            batchesHtml += '</div>';
          }
          
          batchesHtml += '</div>';
        });
      }
      
      batchesHtml += '</div>';
      batchDetailRow.innerHTML = `<td colspan="8">${batchesHtml}</td>`;

      batchDetailRow.querySelectorAll('.editable-batch-expiry').forEach(el => {
        el.addEventListener('click', () => {
          const materialId = decodeURIComponent(el.getAttribute('data-material-id') || '');
          const batchId = decodeURIComponent(el.getAttribute('data-batch-id') || '');
          if(materialId && batchId) editBatchExpiry(materialId, batchId);
        });
      });
      
      // Insert batch row after material row
      setTimeout(() => {
        if (tr.parentNode) {
          tr.parentNode.insertBefore(batchDetailRow, tr.nextSibling);
        }
      }, 0);
      
      return tr;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function changeQuantity(id, delta){
      if(delta < 0){
        showAlert('Le uscite sono gestite solo dal Registro Consumi.', 'warn');
        return;
      }
      updateQuantityLocalStorage(id, delta);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        const ref = db.collection('materials').doc(id);
        db.runTransaction(async tx=>{
          const doc = await tx.get(ref);
          if(!doc.exists) return;
          const q = (doc.data().quantity||0) + delta;
          tx.update(ref,{quantity: q});
        }).catch(()=>{});
      }
    }

    function deleteItem(id){
      if(!ensureDeleteAdmin()) return;
      if(!confirm('Eliminare questo elemento?')) return;
      deleteFromLocalStorage(id);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('materials').doc(id).delete().catch(()=>{});
      }
    }

    function startRealtimeListeners(){
      if(realtimeListenersStarted) return;
      realtimeListenersStarted = true;

      // Listen realtime with Firebase fallback to localStorage
      try {
        db.collection('materials').orderBy('name').onSnapshot(
          snapshot => {
            saveToLocalStorage(snapshot.docs);
            allDocs = loadFromLocalStorage().map(d=>({id: d.id, data: ()=>d}));
            initCategoryFilters();
            renderFilteredMaterials();
            checkAndNotify(allDocs);
          },
          error => {
            console.warn('Firebase error, usando localStorage:', error);
            loadMaterialsFromStorage();
          }
        );
      } catch(err) {
        firebaseReady = false;
        console.warn('Firebase init error, usando localStorage:', err);
        loadMaterialsFromStorage();
      }

      // Listen realtime for implants
      try {
        db.collection('implants').onSnapshot(
          snapshot => {
            const cloudImplants = snapshot.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                type: data.type,
                company: data.company,
                model: data.model,
                kitComponents: data.kitComponents,
                diameter: data.diameter,
                length: data.length,
                orderDate: data.orderDate && data.orderDate.toDate ? data.orderDate.toDate().toISOString() : data.orderDate,
                expiry: data.expiry && data.expiry.toDate ? data.expiry.toDate().toISOString() : data.expiry,
                price: data.price,
                quantity: data.quantity,
                createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt,
                updatedAt: data.updatedAt && data.updatedAt.toDate ? data.updatedAt.toDate().toISOString() : data.updatedAt,
                batches: Array.isArray(data.batches) ? data.batches : [],
                consumptionHistory: Array.isArray(data.consumptionHistory) ? data.consumptionHistory : []
              };
            });

            const localImplants = loadImplantsFromStorage();
            const mergedMap = new Map();

            cloudImplants.forEach(item => {
              if(item && item.id) mergedMap.set(item.id, item);
            });

            const missingOnCloud = [];
            localImplants.forEach(item => {
              if(!item || !item.id) return;
              if(!mergedMap.has(item.id)){
                mergedMap.set(item.id, item);
                missingOnCloud.push(item);
              }
            });

            const mergedImplants = Array.from(mergedMap.values());
            saveImplantsToStorage(mergedImplants);

            if(missingOnCloud.length > 0){
              Promise.all(
                missingOnCloud.map(item =>
                  db.collection('implants').doc(item.id).set(toFirestoreImplantData(item), { merge: true })
                )
              ).catch(err => {
                console.warn('Sync local->firebase impianti non completata:', err);
              });
            }

            if(document.getElementById('implantsModal').classList.contains('active')){
              renderImplantsList();
            }
          },
          error => {
            console.warn('Firebase error for implants, usando localStorage:', error);
          }
        );
      } catch(err) {
        console.warn('Firebase init error for implants, usando localStorage:', err);
      }

      // keep allMaterials updated for exports
      try {
        db.collection('materials').orderBy('name').onSnapshot(snapshot=>{
          allMaterials = snapshot.docs.map(doc=>({id: doc.id, ...doc.data()}));
        }, ()=>{
          allMaterials = loadFromLocalStorage();
        });
      } catch(err) {
        allMaterials = loadFromLocalStorage();
      }

      syncLocalImplantsToFirebase();
    }
    
    // Gestione filtro azienda da select
    if (companyFilterSelect) {
      companyFilterSelect.addEventListener('change', function() {
        currentCompanyFilter = this.value;
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }
    // Gestione filtro distributore da select
    if (distributorFilterSelect) {
      distributorFilterSelect.addEventListener('change', function() {
        currentDistributorFilter = this.value;
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }

    // Funzione per controllare visualizzazione pulsante reset
    function updateResetButtonVisibility() {
      const resetBtn = document.getElementById('resetFiltersBtn');
      const hasActiveFilters = 
        currentExpiryFilter !== 'Tutte' ||
        currentQuantityFilter !== 'Tutte' ||
        currentCompanyFilter !== 'Tutte' ||
        currentDistributorFilter !== 'Tutti';
      
      if (hasActiveFilters) {
        resetBtn.classList.remove('hidden');
      } else {
        resetBtn.classList.add('hidden');
      }
    }

    // Reset filtri
    const resetBtn = document.getElementById('resetFiltersBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        document.getElementById('expiryFilterSelect').value = 'Tutte';
        document.getElementById('quantityFilterSelect').value = 'Tutte';
        document.getElementById('companyFilterSelect').value = 'Tutte';
        document.getElementById('distributorFilterSelect').value = 'Tutti';
        
        currentExpiryFilter = 'Tutte';
        currentQuantityFilter = 'Tutte';
        currentCompanyFilter = 'Tutte';
        currentDistributorFilter = 'Tutti';
        
        renderFilteredMaterials();
        updateResetButtonVisibility();
      });
    }

    // Load initial data from localStorage on page load
    window.addEventListener('load', ()=>{
      initDeleteRestrictionsToggle();
      refreshDeletePermissions();
      applyAlertsSettingsToUI();
      loadMaterialsFromStorage();
    });

    function checkAndNotify(docs){
      const normalizedDocs = Array.isArray(docs) ? docs : [];
      alertsReportData = {
        materials: buildMaterialAlerts(normalizedDocs),
        implants: buildImplantAlerts()
      };
      renderAlertsReport();
    }

    // periodic check (every 5 minutes)
    setInterval(async ()=>{
      if(!firebaseReady || typeof db === 'undefined') {
        checkAndNotify(allDocs);
        return;
      }
      try {
        const snap = await db.collection('materials').get();
        checkAndNotify(snap.docs);
      } catch {
        checkAndNotify(allDocs);
      }
    }, 5*60*1000);

    let allMaterials = []; // store materials for PDF export

    // fallback iniziale in attesa dei listener realtime
    allMaterials = loadFromLocalStorage();

    function generateTablePDF(title, filename, headers, rows, summaryLines, columnWidths){
      const JsPdfCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
      if(!JsPdfCtor){
        showAlert('Libreria PDF non disponibile', 'warn');
        return;
      }

      const doc = new JsPdfCtor({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 10;
      const tableWidth = pageWidth - (margin * 2);
      const colCount = headers.length;
      const baseWidths = Array.isArray(columnWidths) && columnWidths.length === colCount
        ? columnWidths.slice()
        : new Array(colCount).fill(1);
      const baseTotal = baseWidths.reduce((sum, w) => sum + w, 0) || colCount;
      const scaledWidths = baseWidths.map(w => (w / baseTotal) * tableWidth);
      const rowHeight = 6;
      let y = margin;

      function fitText(value, maxWidth){
        const original = value === null || value === undefined ? '' : String(value);
        let text = original;
        while(text.length > 0 && doc.getTextWidth(text) > maxWidth){
          text = text.slice(0, -1);
        }
        if(text !== original){
          text = text.slice(0, Math.max(0, text.length - 1)) + 'â€¦';
        }
        return text;
      }

      function drawHeaderBlock(){
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 61, 122);
        doc.text(title, margin, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        doc.text('Esportazione del: ' + new Date().toLocaleDateString(), margin, y);
        y += 6;
      }

      function drawTableHeader(){
        const headerFill = [0, 61, 122];
        const headerText = [255, 255, 255];
        const headerBorder = [0, 61, 122];
        let xCursor = margin;
        headers.forEach((header, index) => {
          const colWidth = scaledWidths[index];
          doc.setFillColor(headerFill[0], headerFill[1], headerFill[2]);
          doc.setTextColor(headerText[0], headerText[1], headerText[2]);
          doc.setDrawColor(headerBorder[0], headerBorder[1], headerBorder[2]);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8.5);
          doc.rect(xCursor, y, colWidth, rowHeight, 'F');
          doc.rect(xCursor, y, colWidth, rowHeight);
          doc.text(fitText(header, colWidth - 2), xCursor + 1, y + 4);
          xCursor += colWidth;
        });
        y += rowHeight;
      }

      function ensureSpace(required){
        if(y + required > pageHeight - margin){
          doc.addPage();
          y = margin;
          drawHeaderBlock();
          drawTableHeader();
        }
      }

      drawHeaderBlock();
      drawTableHeader();

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8.5);
      doc.setTextColor(20, 20, 20);
      rows.forEach((row, rowIndex) => {
        ensureSpace(rowHeight);
        const fill = rowIndex % 2 === 0 ? 252 : 245;
        let xCursor = margin;
        row.forEach((cell, index) => {
          const colWidth = scaledWidths[index];
          doc.setFillColor(fill, fill, fill);
          doc.rect(xCursor, y, colWidth, rowHeight, 'F');
          doc.setDrawColor(220, 220, 220);
          doc.rect(xCursor, y, colWidth, rowHeight);
          doc.text(fitText(cell, colWidth - 2), xCursor + 1, y + 4);
          xCursor += colWidth;
        });
        y += rowHeight;
      });

      if(Array.isArray(summaryLines) && summaryLines.length){
        ensureSpace((summaryLines.length * 5) + 4);
        y += 3;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        summaryLines.forEach(line => {
          doc.text(line, margin, y);
          y += 5;
        });
      }

      doc.save(filename);
    }

    async function downloadMaterialsPDF(){
      const visibleRows = Array.from(document.querySelectorAll('#list tr'));
      const allMaterials = visibleRows.map(row => {
        const cells = row.querySelectorAll('td');
        const statusCell = cells[2];
        const statusBadge = statusCell ? statusCell.querySelector('span') : null;
        const statusTitle = statusBadge ? (statusBadge.getAttribute('title') || '').trim() : '';
        const expiryDateMatch = statusTitle.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})/);
        const expiryStatus = expiryDateMatch ? expiryDateMatch[1] : '-';
        const qtyText = (cells[6]?.textContent || '0').replace(/[^\d-]/g, '');
        const priceRaw = (cells[3]?.textContent || '0').replace(/[^\d,.-]/g, '').replace(',', '.');
        return {
          name: (cells[0]?.textContent || '-').trim(),
          orderDate: (cells[1]?.textContent || '-').trim(),
          expiryStatus: expiryStatus,
          priceText: (cells[3]?.textContent || 'â‚¬ 0.00').trim(),
          distributor: (cells[4]?.textContent || '-').trim(),
          company: (cells[5]?.textContent || '-').trim(),
          quantity: parseInt(qtyText || '0', 10) || 0,
          priceValue: parseFloat(priceRaw || '0') || 0
        };
      });

      if(allMaterials.length === 0){
        showAlert('Nessun materiale visibile da esportare', 'warn');
        return;
      }
      const headers = ['Nome', 'Data Ordine', 'Scadenza', 'Prezzo (â‚¬)', 'Distributore', 'Azienda', 'QuantitÃ '];
      const rows = allMaterials.map(item => [
        item.name || '-',
        item.orderDate || '-',
        item.expiryStatus || '-',
        item.priceText || 'â‚¬ 0.00',
        item.distributor || '-',
        item.company || '-',
        String(item.quantity || 0)
      ]);
      const summaryLines = [
        'Totale materiali: ' + allMaterials.length,
        'Valore totale: â‚¬ ' + allMaterials.reduce((sum, m)=>(sum + (m.priceValue||0) * (m.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Materiali',
        'materiali_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [18, 14, 14, 12, 18, 18, 8]
      );
      showAlert('âœ“ PDF Materiali scaricato con successo', 'info');
    }

    async function downloadImplantsPDF(){
      // Applica gli stessi filtri che sono visualizzati nella tabella impianti
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => i.model === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }

      // Se nessun filtro Ã¨ impostato, includi tutti i dati
      if(implants.length === 0){
        const hasActiveFilters = currentImplantTypeFilter !== 'Tutti' || 
                                 currentImplantCompanyFilter !== 'Tutte' || 
                                 currentImplantModelFilter !== 'Tutti' || 
                                 currentImplantExpiryFilter !== 'Tutte';
        
        if(hasActiveFilters){
          showAlert('Nessun impianto da esportare con i filtri selezionati', 'warn');
          return;
        } else {
          // Nessun filtro attivo - carica tutto da localStorage come fallback
          implants = loadImplantsFromStorage() || [];
          if(!implants || implants.length === 0){
            showAlert('Nessun impianto da esportare', 'warn');
            return;
          }
        }
      }

      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }

      const headers = ['Tipo', 'Azienda', 'Modello', 'Ã˜', 'L', 'Ordine', 'Scadenza', 'Prezzo', 'Qta'];
      const rows = implants.map(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString() : '-';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const expiryDate = expiry ? expiry.toLocaleDateString() : '-';
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        const modelValue = implant.type === 'Kit chirurgico'
          ? (implant.kitComponents ? escapeHtml(implant.kitComponents) : '-')
          : (implant.model ? escapeHtml(implant.model) : '-');
        return [
          escapeHtml(implant.type),
          escapeHtml(implant.company),
          modelValue,
          diameter,
          length,
          orderDate,
          expiryDate,
          'â‚¬ ' + Number(implant.price || 0).toFixed(2),
          String(implant.quantity || 0)
        ];
      });
      const summaryLines = [
        'Totale impianti: ' + implants.length,
        'Valore totale: â‚¬ ' + implants.reduce((sum, i)=>(sum + (parseFloat(i.price)||0) * (i.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Impianti',
        'impianti_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [18, 20, 24, 6, 6, 12, 14, 10, 6]
      );
      showAlert('âœ“ PDF Impianti scaricato con successo', 'info');
    }

    async function downloadPDF(){
      downloadMaterialsPDF();
    }

    // --- BACKUP & RESTORE ---
    function exportBackup(){
      const materials = loadFromLocalStorage();
      const implants = loadImplantsFromStorage();
      const implantModels = loadImplantModels();
      const implantNomenclatures = loadImplantNomenclatures();
      const kitComponents = loadKitComponents();
      
      const backup = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: {
          materials: materials,
          implants: implants,
          implantModels: implantModels,
          implantNomenclatures: implantNomenclatures,
          kitComponents: kitComponents
        }
      };
      
      const dataStr = JSON.stringify(backup, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'backup_magazzino_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ Backup scaricato con successo', 'info');
    }
    
    function importBackup(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e){
        try {
          const backup = JSON.parse(e.target.result);
          
          if(!backup.data){
            showAlert('File di backup non valido', 'warn');
            return;
          }
          
          if(!confirm('ATTENZIONE: Importando il backup, tutti i dati correnti verranno sostituiti. Continuare?')){
            return;
          }
          
          // Importa materiali
          if(backup.data.materials && Array.isArray(backup.data.materials)){
            localStorage.setItem('magazzino', JSON.stringify(backup.data.materials));
          }
          
          // Importa impianti
          if(backup.data.implants && Array.isArray(backup.data.implants)){
            localStorage.setItem('magazzino_implants', JSON.stringify(backup.data.implants));
          }
          
          // Importa modelli
          if(backup.data.implantModels && Array.isArray(backup.data.implantModels)){
            localStorage.setItem('implant_models', JSON.stringify(backup.data.implantModels));
          }
          
          // Importa nomenclature
          if(backup.data.implantNomenclatures && Array.isArray(backup.data.implantNomenclatures)){
            localStorage.setItem('implant_nomenclatures', JSON.stringify(backup.data.implantNomenclatures));
          }
          
          // Importa componenti kit
          if(backup.data.kitComponents && Array.isArray(backup.data.kitComponents)){
            localStorage.setItem('kit_components', JSON.stringify(backup.data.kitComponents));
          }
          
          // Sincronizza con Firebase se disponibile
          if(firebaseReady && typeof db !== 'undefined'){
            // Sincronizza materiali
            if(backup.data.materials){
              backup.data.materials.forEach(async material => {
                try {
                  const materialData = {...material};
                  delete materialData.id;
                  if(materialData.orderDate && typeof materialData.orderDate === 'string'){
                    materialData.orderDate = new Date(materialData.orderDate);
                  }
                  if(materialData.expiry && typeof materialData.expiry === 'string'){
                    materialData.expiry = new Date(materialData.expiry);
                  }
                  if(materialData.createdAt && typeof materialData.createdAt === 'string'){
                    materialData.createdAt = new Date(materialData.createdAt);
                  }
                  if(materialData.updatedAt && typeof materialData.updatedAt === 'string'){
                    materialData.updatedAt = new Date(materialData.updatedAt);
                  }
                  await db.collection('materials').doc(material.id).set(materialData);
                } catch(err){
                  console.warn('Errore sync materiale:', err);
                }
              });
            }
            
            // Sincronizza impianti
            if(backup.data.implants){
              backup.data.implants.forEach(async implant => {
                try {
                  const implantData = {...implant};
                  delete implantData.id;
                  if(implantData.orderDate && typeof implantData.orderDate === 'string'){
                    implantData.orderDate = new Date(implantData.orderDate);
                  }
                  if(implantData.expiry && typeof implantData.expiry === 'string'){
                    implantData.expiry = new Date(implantData.expiry);
                  }
                  if(implantData.createdAt && typeof implantData.createdAt === 'string'){
                    implantData.createdAt = new Date(implantData.createdAt);
                  }
                  await db.collection('implants').doc(implant.id).set(implantData);
                } catch(err){
                  console.warn('Errore sync impianto:', err);
                }
              });
            }
          }
          
          showAlert('âœ“ Backup importato con successo! Ricarica la pagina.', 'info');
          
          // Ricarica la pagina dopo 2 secondi
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          
        } catch(err) {
          console.error('Errore importazione backup:', err);
          showAlert('Errore durante l\'importazione del backup', 'warn');
        }
      };
      
      reader.readAsText(file);
      // Reset input file
      event.target.value = '';
    }

    // --- CSV EXPORTS ---
    function exportMaterialsCSV(){
      const materials = loadFromLocalStorage();
      if(!materials || materials.length === 0){
        showAlert('Nessun materiale da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Nome', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'QuantitÃ ', 'Categoria', 'Distributore', 'Azienda', 'Soglia Bassa', 'Giorni Notifica'];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      materials.forEach(material => {
        const orderDate = material.orderDate ? new Date(material.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = material.expiry ? new Date(material.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          material.id || '',
          '"' + (material.name || '').replace(/"/g, '""') + '"',
          orderDate,
          expiry,
          Number(material.price || 0).toFixed(2),
          material.quantity || 0,
          '"' + (material.category || '').replace(/"/g, '""') + '"',
          '"' + (material.distributor || '').replace(/"/g, '""') + '"',
          '"' + (material.company || '').replace(/"/g, '""') + '"',
          material.lowStockThreshold || 2,
          material.notifyDays || 30
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'materiali_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Materiali scaricato con successo', 'info');
    }
    
    function exportImplantsCSV(){
      const implants = loadImplantsFromStorage();
      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Tipo', 'Azienda', 'Modello', 'Componenti Kit', 'Diametro (mm)', 'Lunghezza (mm)', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'QuantitÃ '];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      implants.forEach(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = implant.expiry ? new Date(implant.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          implant.id || '',
          '"' + (implant.type || '').replace(/"/g, '""') + '"',
          '"' + (implant.company || '').replace(/"/g, '""') + '"',
          '"' + (implant.model || '').replace(/"/g, '""') + '"',
          '"' + (implant.kitComponents || '').replace(/"/g, '""') + '"',
          implant.diameter || '',
          implant.length || '',
          orderDate,
          expiry,
          Number(implant.price || 0).toFixed(2),
          implant.quantity || 0
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'impianti_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Impianti scaricato con successo', 'info');
    }

    function csvEscape(value){
      return '"' + String(value === null || value === undefined ? '' : value).replace(/"/g, '""') + '"';
    }

    function exportImplantsIncomingLotsCSV(){
      const rowsData = getFilteredImplantsIncomingData();
      if(!rowsData || rowsData.length === 0){
        showAlert('Nessuna entrata lotti impianti da esportare', 'warn');
        return;
      }

      const headers = ['Data Ordine', 'Tipo', 'Azienda', 'Modello', 'QuantitÃ ', 'Lotto (data)'];
      let csvContent = headers.join(',') + '\n';

      rowsData.forEach(row => {
        const values = [
          formatDate(row.orderDate || row.createdAt),
          row.type || '--',
          row.company || '--',
          row.model || '--',
          Number(row.quantity || 0),
          getLotDisplayLabel({ dataOrdine: row.orderDate || row.createdAt })
        ];
        csvContent += values.map(csvEscape).join(',') + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'impianti_entrate_lotti_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Entrate Lotti Impianti scaricato con successo', 'info');
    }

    function exportImplantsOutgoingCSV(){
      const rowsData = getFilteredImplantsOutgoingData();
      if(!rowsData || rowsData.length === 0){
        showAlert('Nessuna uscita impianti da esportare', 'warn');
        return;
      }

      const headers = ['Data', 'Tipo', 'Azienda', 'Modello', 'Operatore', 'QuantitÃ ', 'Stato', 'Lotti (data)'];
      let csvContent = headers.join(',') + '\n';

      rowsData.forEach(row => {
        const values = [
          formatDate(row.date),
          row.type || '--',
          row.company || '--',
          row.model || '--',
          row.operator || '--',
          Number(row.quantity || 0),
          getConsumptionStatusLabel(row.status),
          row.batches || '--'
        ];
        csvContent += values.map(csvEscape).join(',') + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'impianti_uscite_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('âœ“ CSV Uscite Impianti scaricato con successo', 'info');
    }

    function downloadImplantsIncomingLotsPDF(){
      const rowsData = getFilteredImplantsIncomingData();
      if(!rowsData || rowsData.length === 0){
        showAlert('Nessuna entrata lotti impianti da esportare', 'warn');
        return;
      }

      const headers = ['Data Ordine', 'Tipo', 'Azienda', 'Modello', 'Qta', 'Lotto (data)'];
      const rows = rowsData.map(row => [
        formatDate(row.orderDate || row.createdAt),
        row.type || '--',
        row.company || '--',
        row.model || '--',
        String(Number(row.quantity || 0)),
        String(getLotDisplayLabel({ dataOrdine: row.orderDate || row.createdAt }))
      ]);
      const totalQty = rowsData.reduce((sum, row) => sum + (Number(row.quantity || 0) || 0), 0);
      const summaryLines = [
        'Totale lotti in entrata: ' + rowsData.length,
        'QuantitÃ  totale in entrata: ' + totalQty
      ];

      generateTablePDF(
        'Studio Dentistico - Registro Entrate Lotti Impianti',
        'impianti_entrate_lotti_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [14, 16, 18, 18, 8, 18]
      );
      showAlert('âœ“ PDF Entrate Lotti Impianti scaricato con successo', 'info');
    }

    function downloadImplantsOutgoingPDF(){
      const rowsData = getFilteredImplantsOutgoingData();
      if(!rowsData || rowsData.length === 0){
        showAlert('Nessuna uscita impianti da esportare', 'warn');
        return;
      }

      const headers = ['Data', 'Tipo', 'Azienda', 'Modello', 'Operatore', 'Qta', 'Stato', 'Lotti (data)'];
      const rows = rowsData.map(row => [
        formatDate(row.date),
        row.type || '--',
        row.company || '--',
        row.model || '--',
        row.operator || '--',
        String(Number(row.quantity || 0)),
        getConsumptionStatusLabel(row.status),
        row.batches || '--'
      ]);
      const totalQty = rowsData.reduce((sum, row) => sum + (Number(row.quantity || 0) || 0), 0);
      const summaryLines = [
        'Totale movimenti uscita impianti: ' + rowsData.length,
        'QuantitÃ  totale scaricata: ' + totalQty
      ];

      generateTablePDF(
        'Studio Dentistico - Registro Uscite Impianti',
        'impianti_uscite_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines,
        [10, 12, 12, 12, 11, 7, 9, 23]
      );
      showAlert('âœ“ PDF Uscite Impianti scaricato con successo', 'info');
    }

    // --- IMPLANTS EVENT LISTENERS ---
    document.getElementById('implantsBtn').addEventListener('click', openImplantsModal);
    
    // Gestione campi custom per impianti
    document.getElementById('implantCompany').addEventListener('change', function() {
      const custom = document.getElementById('implantCompanyCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantModel').addEventListener('change', function() {
      const customInput = document.getElementById('implantModelCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantKitComponents').addEventListener('change', function() {
      const customInput = document.getElementById('implantKitComponentsCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantDiameter').addEventListener('change', function() {
      const custom = document.getElementById('implantDiameterCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantLength').addEventListener('change', function() {
      const custom = document.getElementById('implantLengthCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    // Mostra/nascondi campi in base al tipo di impianto
    document.getElementById('implantType').addEventListener('change', function() {
      const type = this.value;
      const isImplant = type === 'Impianto';
      const isScrew = type === 'Vite tappo' || type === 'Vite di guarigione';
      const isKit = type === 'Kit chirurgico';
      
      const modelGroup = document.getElementById('implantModelGroup');
      const modelLabel = modelGroup.querySelector('label');
      
      // Cambia etichetta in base al tipo
      if(isScrew) {
        modelLabel.textContent = 'Nomenclatura';
      } else if(isImplant) {
        modelLabel.textContent = 'Modello';
      } else {
        modelLabel.textContent = 'Modello / Nomenclatura';
      }
      
      modelGroup.style.display = (isImplant || isScrew) ? '' : 'none';
      document.getElementById('implantDiameterGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantLengthGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantKitComponentsGroup').style.display = isKit ? '' : 'none';
      
      // Ricarica le opzioni appropriate
      populateImplantModelSelect();
    });

    // Event listeners per i filtri impianti
    document.getElementById('implantTypeFilter').addEventListener('change', function() {
      currentImplantTypeFilter = this.value;
      updateImplantModelFilter(); // Aggiorna il filtro modello in base al tipo
      renderImplantsList();
    });
    
    document.getElementById('implantCompanyFilter').addEventListener('change', function() {
      currentImplantCompanyFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantModelFilter').addEventListener('change', function() {
      currentImplantModelFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantExpiryFilter').addEventListener('change', function() {
      currentImplantExpiryFilter = this.value;
      renderImplantsList();
    });

    // Submit form impianti
    document.getElementById('implantForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const type = document.getElementById('implantType').value;
      let company = document.getElementById('implantCompany').value;
      if(company === 'Other') company = document.getElementById('implantCompanyCustom').value.trim();
      
      // Prendi il valore dall'input personalizzato (sempre visibile ora)
      let model = document.getElementById('implantModelCustom').value.trim();
      if(!model) {
        model = document.getElementById('implantModel').value;
      }
      
      // Salva il modello/nomenclatura nelle opzioni per usi futuri
      if(model) {
        saveImplantModel(model, type);
      }
      
      // Prendi i componenti del kit se il tipo Ã¨ Kit chirurgico
      let kitComponents = null;
      if(type === 'Kit chirurgico') {
        kitComponents = document.getElementById('implantKitComponentsCustom').value.trim();
        if(!kitComponents) {
          kitComponents = document.getElementById('implantKitComponents').value;
        }
        // Salva i componenti nelle opzioni per usi futuri
        if(kitComponents) {
          saveKitComponent(kitComponents);
        }
      }
      
      let diameter = document.getElementById('implantDiameter').value;
      if(diameter === 'Other') diameter = document.getElementById('implantDiameterCustom').value;
      
      let length = document.getElementById('implantLength').value;
      if(length === 'Other') length = document.getElementById('implantLengthCustom').value;
      
      const orderDate = document.getElementById('implantOrderDate').value;
      const expiryInput = document.getElementById('implantExpiry').value;
      const price = parseFloat(document.getElementById('implantPrice').value) || 0;
      const quantity = parseInt(document.getElementById('implantQuantity').value, 10) || 0;

      const newImplant = {
        type,
        company,
        model: model || null,
        kitComponents: kitComponents || null,
        diameter: diameter || null,
        length: length || null,
        orderDate: new Date(orderDate),
        expiry: expiryInput ? new Date(expiryInput) : null,
        price,
        quantity,
        createdAt: new Date()
      };

      const implantId = addImplantToStorage(newImplant);
      const storedImplant = loadImplantsFromStorage().find(i => i.id === implantId);
      
      // Sync to Firebase (optional)
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          if(storedImplant){
            await db.collection('implants').doc(implantId).set(toFirestoreImplantData(storedImplant), { merge: true });
          }
        } catch(err) {
          console.warn('Firebase sync failed for implant:', err.message);
        }
      }

      document.getElementById('implantForm').reset();
      document.getElementById('implantQuantity').value = 1;
      showAlert('âœ“ Carico impianto registrato', 'info');
      initImplantFilters(); // Aggiorna i filtri
      renderImplantsList();
    });

    // ===== ANALISI SPESE FUNCTIONS =====
    let reportCharts = { trend: null, distribution: null };

    function openReportModal() {
      const modal = document.getElementById('reportModal');
      modal.classList.add('active');
      setTimeout(() => initReportFilters(), 100);
    }

    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      modal.classList.remove('active');
      if (reportCharts.trend) reportCharts.trend.destroy();
      if (reportCharts.distribution) reportCharts.distribution.destroy();
    }

    function initReportFilters() {
      const materials = loadFromLocalStorage();
      
      // Popola categorie
      const categories = Array.from(new Set(materials.map(m => m.category).filter(c => c))).sort();
      const categorySelect = document.getElementById('reportCategoryFilter');
      categorySelect.innerHTML = '<option value="Tutti">Tutti</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

      // Popola aziende
      const companies = Array.from(new Set(materials.map(m => m.company).filter(c => c))).sort();
      const companySelect = document.getElementById('reportCompanyFilter');
      companySelect.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp;
        opt.textContent = comp;
        companySelect.appendChild(opt);
      });

      // Popola distributori
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(d => d))).sort();
      const distributorSelect = document.getElementById('reportDistributorFilter');
      distributorSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      distributors.forEach(dist => {
        const opt = document.createElement('option');
        opt.value = dist;
        opt.textContent = dist;
        distributorSelect.appendChild(opt);
      });

      updateReportData();
    }

    function getFilteredReportData() {
      const materials = loadFromLocalStorage();
      const categoryFilter = document.getElementById('reportCategoryFilter').value;
      const companyFilter = document.getElementById('reportCompanyFilter').value;
      const distributorFilter = document.getElementById('reportDistributorFilter').value;
      const statusFilter = (document.getElementById('reportStatusFilter') || {}).value || 'Tutti';

      return materials.filter(m => {
        if (categoryFilter !== 'Tutti' && m.category !== categoryFilter) return false;
        if (companyFilter !== 'Tutte' && m.company !== companyFilter) return false;
        if (distributorFilter !== 'Tutti' && m.distributor !== distributorFilter) return false;
        if (statusFilter !== 'Tutti') {
          const history = Array.isArray(m.consumptionHistory) ? m.consumptionHistory : [];
          const hasStatus = history.some(entry => {
            const entryStatus = entry && entry.status === 'in_uso' ? 'in_uso' : 'consumato';
            return entryStatus === statusFilter;
          });
          if (!hasStatus) return false;
        }
        return true;
      });
    }

    function updateReportData() {
      const filtered = getFilteredReportData();
      
      // Calcola statistiche
      const totalExpense = filtered.reduce((sum, m) => sum + ((m.price || 0) * (m.quantity || 1)), 0);
      const orderCount = filtered.length;
      const avgPrice = orderCount > 0 ? totalExpense / orderCount : 0;
      
      // Top categoria
      const categoryExpense = {};
      filtered.forEach(m => {
        const cat = m.category || 'Non categorizzato';
        categoryExpense[cat] = (categoryExpense[cat] || 0) + ((m.price || 0) * (m.quantity || 1));
      });
      const topCategory = Object.entries(categoryExpense).sort((a, b) => b[1] - a[1])[0]?.[0] || '--';

      document.getElementById('reportTotalExpense').textContent = 'â‚¬ ' + totalExpense.toFixed(2);
      document.getElementById('reportOrderCount').textContent = orderCount;
      document.getElementById('reportAveragePrice').textContent = 'â‚¬ ' + avgPrice.toFixed(2);
      document.getElementById('reportTopCategory').textContent = topCategory;

      // Aggiorna grafici e tabella
      updateReportCharts(filtered);
      updateReportTable(filtered);
    }

    function updateReportCharts(filtered) {
      // Trend spese per mese
      const monthlyData = {};
      filtered.forEach(m => {
        const orderDate = m.orderDate ? (typeof m.orderDate === 'string' ? new Date(m.orderDate) : m.orderDate) : new Date();
        const monthKey = orderDate.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit' });
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + ((m.price || 0) * (m.quantity || 1));
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const monthlyExpenses = sortedMonths.map(m => monthlyData[m]);

      // Distrubuzione per categoria
      const categoryData = {};
      filtered.forEach(m => {
        const cat = m.category || 'Non categorizzato';
        categoryData[cat] = (categoryData[cat] || 0) + ((m.price || 0) * (m.quantity || 1));
      });

      // Destroy previous charts
      if (reportCharts.trend) reportCharts.trend.destroy();
      if (reportCharts.distribution) reportCharts.distribution.destroy();

      // Trend Chart
      const trendCtx = document.getElementById('reportTrendChart').getContext('2d');
      reportCharts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Spesa Mensile (â‚¬)',
            data: monthlyExpenses,
            borderColor: '#0066cc',
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#0066cc'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Spesa (â‚¬)' } }
          }
        }
      });

      // Distribution Chart
      const distCtx = document.getElementById('reportDistributionChart').getContext('2d');
      const colors = ['#0066cc', '#d32f2f', '#f57c00', '#388e3c', '#7b1fa2', '#c2185b', '#00838f', '#6d4c41'];
      reportCharts.distribution = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateReportTable(filtered) {
      const tbody = document.getElementById('reportTableBody');
      tbody.innerHTML = '';

      filtered.sort((a, b) => {
        const dateA = a.orderDate ? (typeof a.orderDate === 'string' ? new Date(a.orderDate) : a.orderDate) : new Date();
        const dateB = b.orderDate ? (typeof b.orderDate === 'string' ? new Date(b.orderDate) : b.orderDate) : new Date();
        return dateB - dateA;
      }).forEach(m => {
        const orderDate = m.orderDate ? (typeof m.orderDate === 'string' ? m.orderDate : m.orderDate.toLocaleDateString('it-IT')) : '--';
        const total = ((m.price || 0) * (m.quantity || 1)).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${m.category || '--'}</td>
          <td>${m.name || '--'}</td>
          <td>${m.company || '--'}</td>
          <td>${m.distributor || '--'}</td>
          <td>â‚¬ ${(m.price || 0).toFixed(2)}</td>
          <td>${m.quantity || 0}</td>
          <td>â‚¬ ${total}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function resetReportFilters() {
      document.getElementById('reportCategoryFilter').value = 'Tutti';
      document.getElementById('reportCompanyFilter').value = 'Tutte';
      document.getElementById('reportDistributorFilter').value = 'Tutti';
      const statusFilter = document.getElementById('reportStatusFilter');
      if(statusFilter) statusFilter.value = 'Tutti';
      updateReportData();
    }

    // ===== INCOMING REGISTER FUNCTIONS =====
    function openIncomingRegisterModal() {
      const modal = document.getElementById('incomingRegisterModal');
      modal.classList.add('active');
      setTimeout(() => initIncomingRegisterFilters(), 100);
    }

    function closeIncomingRegisterModal() {
      const modal = document.getElementById('incomingRegisterModal');
      modal.classList.remove('active');
    }

    function initIncomingRegisterFilters() {
      const materials = loadFromLocalStorage();
      
      // Popola categorie
      const categories = Array.from(new Set(materials.map(m => m.category).filter(c => c))).sort();
      const categorySelect = document.getElementById('incomingCategoryFilter');
      categorySelect.innerHTML = '<option value="Tutti">Tutti</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

      // Popola distributori
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(d => d))).sort();
      const distributorSelect = document.getElementById('incomingDistributorFilter');
      distributorSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      distributors.forEach(dist => {
        const opt = document.createElement('option');
        opt.value = dist;
        opt.textContent = dist;
        distributorSelect.appendChild(opt);
      });

      updateIncomingRegisterData();
    }

    function getFilteredIncomingData() {
      const materials = loadFromLocalStorage();
      const categoryFilter = document.getElementById('incomingCategoryFilter').value;
      const distributorFilter = document.getElementById('incomingDistributorFilter').value;
      const periodFilterValue = document.getElementById('incomingPeriodFilter').value;

      // Estrai tutti i batch da tutti i materiali
      let allBatches = [];
      materials.forEach(m => {
        if (m.batches && Array.isArray(m.batches)) {
          m.batches.forEach(batch => {
            const batchOrderDate = batch.dataOrdine || batch.orderDate || m.orderDate || m.createdAt;
            const batchQuantity = Number(
              batch.quantitÃ  ?? batch.quantita ?? batch.originalQuantita ?? batch.quantity ?? 0
            ) || 0;
            const batchIdentifier = batch.batchId || batch.id || '';
            const entryType = batch.ordinoId ? 'Ordine' : 'Materiale';

            allBatches.push({
              materialName: m.name,
              category: m.category,
              distributor: m.distributor,
              orderDate: batchOrderDate,
              quantity: batchQuantity,
              batchId: batchIdentifier,
              type: entryType
            });
          });
        }
      });

      // Filtra per categoria e distributore
      allBatches = allBatches.filter(b => {
        if (categoryFilter !== 'Tutti' && b.category !== categoryFilter) return false;
        if (distributorFilter !== 'Tutti' && b.distributor !== distributorFilter) return false;
        return true;
      });

      // Filtra per periodo
      if (periodFilterValue !== 'all') {
        const periodDays = parseInt(periodFilterValue, 10);
        if (Number.isInteger(periodDays) && periodDays > 0) {
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - periodDays);
          allBatches = allBatches.filter(b => {
            const batchDate = parseFlexibleDate(b.orderDate);
            return batchDate && batchDate >= cutoffDate;
          });
        }
      }

      // Ordina per data (piÃ¹ recenti prima)
      allBatches.sort((a, b) => {
        const dA = parseFlexibleDate(a.orderDate);
        const dB = parseFlexibleDate(b.orderDate);
        const tA = dA ? dA.getTime() : 0;
        const tB = dB ? dB.getTime() : 0;
        return tB - tA;
      });

      return allBatches;
    }

    function updateIncomingRegisterData() {
      const filtered = getFilteredIncomingData();
      
      // Calcola statistiche
      const totalCount = filtered.length;
      const totalQuantity = filtered.reduce((sum, b) => sum + (b.quantity || 0), 0);
      const lastDate = filtered.length > 0 ? formatDate(filtered[0].orderDate) : '--';

      document.getElementById('incomingTotalCount').textContent = totalCount;
      document.getElementById('incomingTotalQuantity').textContent = totalQuantity;
      document.getElementById('incomingLastDate').textContent = lastDate;

      // Aggiorna tabella
      updateIncomingRegisterTable(filtered);
    }

    function updateIncomingRegisterTable(filtered) {
      const tbody = document.getElementById('incomingRegisterTableBody');
      tbody.innerHTML = '';

      filtered.forEach(b => {
        const orderDate = formatDate(b.orderDate);
        const lotLabel = getLotDisplayLabel({ dataOrdine: b.orderDate });
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${b.category || '--'}</td>
          <td>${b.materialName || '--'}</td>
          <td>${b.distributor || '--'}</td>
          <td>${b.quantity || 0}</td>
          <td>${lotLabel}</td>
          <td>${b.type || '--'}</td>
        `;
        tbody.appendChild(tr);
      });

      // Se nessun risultato
      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" style="text-align:center;color:#999;padding:20px">Nessuna entrata trovata</td>';
        tbody.appendChild(tr);
      }
    }

    function resetIncomingFilters() {
      document.getElementById('incomingCategoryFilter').value = 'Tutti';
      document.getElementById('incomingDistributorFilter').value = 'Tutti';
      document.getElementById('incomingPeriodFilter').value = 'all';
      updateIncomingRegisterData();
    }

    // ===== OUTGOING REGISTER FUNCTIONS =====
    const OPERATORS_KEY = 'magazzino_operators';
    const LAST_OPERATOR_KEY = 'magazzino_last_operator';

    function loadOperators(){
      try {
        const raw = localStorage.getItem(OPERATORS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
      } catch {
        return [];
      }
    }

    function saveOperator(name){
      const op = String(name || '').trim();
      if(!op) return;
      const operators = loadOperators();
      if(!operators.some(o => String(o).toLowerCase() === op.toLowerCase())) {
        operators.push(op);
        operators.sort((a,b)=>String(a).localeCompare(String(b), 'it-IT'));
        localStorage.setItem(OPERATORS_KEY, JSON.stringify(operators));
      }
      localStorage.setItem(LAST_OPERATOR_KEY, op);
    }

    function initConsumptionOperator(){
      const listEl = document.getElementById('consumptionOperatorList');
      const inputEl = document.getElementById('consumptionOperator');
      if(!listEl || !inputEl) return;
      const operators = loadOperators();
      listEl.innerHTML = '';
      operators.forEach(op => {
        const opt = document.createElement('option');
        opt.value = op;
        listEl.appendChild(opt);
      });
      const last = localStorage.getItem(LAST_OPERATOR_KEY) || '';
      if(last) inputEl.value = last;
    }

    function openOutgoingRegisterModal() {
      const modal = document.getElementById('outgoingRegisterModal');
      if (!modal) return;
      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.justifyContent = 'center';
      setTimeout(() => initOutgoingRegisterFilters(), 100);
    }

    function closeOutgoingRegisterModal() {
      const modal = document.getElementById('outgoingRegisterModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function initOutgoingRegisterFilters() {
      const materials = loadFromLocalStorage();
      const categories = Array.from(new Set(materials.map(m => m.category).filter(Boolean))).sort();
      const categorySelect = document.getElementById('outgoingCategoryFilter');
      categorySelect.innerHTML = '<option value="Tutti">Tutti</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

      const operators = loadOperators();
      const operatorSelect = document.getElementById('outgoingOperatorFilter');
      operatorSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      operators.forEach(op => {
        const opt = document.createElement('option');
        opt.value = op;
        opt.textContent = op;
        operatorSelect.appendChild(opt);
      });

      updateOutgoingRegisterData();
    }

    function getFilteredOutgoingData() {
      const materials = loadFromLocalStorage();
      const categoryFilter = document.getElementById('outgoingCategoryFilter').value;
      const operatorFilter = document.getElementById('outgoingOperatorFilter').value;
      const periodFilterValue = document.getElementById('outgoingPeriodFilter').value;
      const statusFilterValue = (document.getElementById('outgoingStatusFilter') || {}).value || 'Tutti';

      let allConsumptions = [];
      materials.forEach(m => {
        const history = Array.isArray(m.consumptionHistory) ? m.consumptionHistory : [];
        history.forEach(entry => {
          const qty = Number(entry.quantitÃ  || 0) || 0;
          const operator = String(entry.operatore || entry.operator || '').trim() || '--';
          const dateValue = entry.data || entry.timestamp;
          const status = entry.status === 'in_uso' ? 'in_uso' : 'consumato';
          const batchInfo = Array.isArray(entry.batchesConsumed)
            ? entry.batchesConsumed.map((b, idx) => `${b.quantitÃ  || 0}pz da ${getLotDisplayLabel(b, idx)}`).join(', ')
            : '--';

          allConsumptions.push({
            date: dateValue,
            category: m.category || '--',
            materialName: m.name || '--',
            operator,
            quantity: qty,
            status,
            batches: batchInfo
          });
        });
      });

      allConsumptions = allConsumptions.filter(c => {
        if (categoryFilter !== 'Tutti' && c.category !== categoryFilter) return false;
        if (operatorFilter !== 'Tutti' && c.operator !== operatorFilter) return false;
        if (statusFilterValue !== 'Tutti' && c.status !== statusFilterValue) return false;
        return true;
      });

      if (periodFilterValue !== 'all') {
        const periodDays = parseInt(periodFilterValue, 10);
        if (Number.isInteger(periodDays) && periodDays > 0) {
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - periodDays);
          allConsumptions = allConsumptions.filter(c => {
            const d = parseFlexibleDate(c.date);
            return d && d >= cutoffDate;
          });
        }
      }

      allConsumptions.sort((a, b) => {
        const da = parseFlexibleDate(a.date);
        const db = parseFlexibleDate(b.date);
        return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
      });

      return allConsumptions;
    }

    function updateOutgoingRegisterData() {
      const filtered = getFilteredOutgoingData();
      const totalCount = filtered.length;
      const totalQuantity = filtered.reduce((sum, c) => sum + (Number(c.quantity || 0) || 0), 0);
      const lastDate = filtered.length > 0 ? formatDate(filtered[0].date) : '--';

      document.getElementById('outgoingTotalCount').textContent = totalCount;
      document.getElementById('outgoingTotalQuantity').textContent = totalQuantity;
      document.getElementById('outgoingLastDate').textContent = lastDate;

      const tbody = document.getElementById('outgoingRegisterTableBody');
      tbody.innerHTML = '';
      filtered.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(c.date)}</td>
          <td>${c.category || '--'}</td>
          <td>${c.materialName || '--'}</td>
          <td>${c.operator || '--'}</td>
          <td>${c.quantity || 0}</td>
          <td>${getConsumptionStatusBadge(c.status)}</td>
          <td>${c.batches || '--'}</td>
        `;
        tbody.appendChild(tr);
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" style="text-align:center;color:#999;padding:20px">Nessuna uscita trovata</td>';
        tbody.appendChild(tr);
      }
    }

    function resetOutgoingFilters() {
      document.getElementById('outgoingCategoryFilter').value = 'Tutti';
      document.getElementById('outgoingOperatorFilter').value = 'Tutti';
      document.getElementById('outgoingPeriodFilter').value = 'all';
      const statusFilter = document.getElementById('outgoingStatusFilter');
      if (statusFilter) statusFilter.value = 'Tutti';
      updateOutgoingRegisterData();
    }

    function getActiveUsageData(){
      const materials = loadFromLocalStorage();
      const rows = [];
      materials.forEach(material => {
        const history = Array.isArray(material.consumptionHistory) ? material.consumptionHistory : [];
        history.forEach((entry, index) => {
          const status = entry.status === 'in_uso' ? 'in_uso' : 'consumato';
          if(status !== 'in_uso' || entry.closedAt) return;
          rows.push({
            materialId: material.id,
            usageId: String(entry.usageId || `${material.id}_${index}`),
            date: entry.data || entry.timestamp,
            category: material.category || '--',
            materialName: material.name || '--',
            operator: String(entry.operatore || entry.operator || '').trim() || '--',
            quantity: Number(entry.quantitÃ  || 0) || 0,
            batches: Array.isArray(entry.batchesConsumed)
              ? entry.batchesConsumed.map((b, idx) => `${b.quantitÃ  || 0}pz da ${getLotDisplayLabel(b, idx)}`).join(', ')
              : '--',
            status
          });
        });
      });

      rows.sort((a, b) => {
        const da = parseFlexibleDate(a.date);
        const db = parseFlexibleDate(b.date);
        return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
      });
      return rows;
    }

    function openActiveUsageModal(){
      const modal = document.getElementById('activeUsageModal');
      if(!modal) return;
      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.justifyContent = 'center';
      updateActiveUsageData();
    }

    function closeActiveUsageModal(){
      const modal = document.getElementById('activeUsageModal');
      if(!modal) return;
      modal.style.display = 'none';
    }

    async function markUsageAsConsumed(materialId, usageId){
      const materials = loadFromLocalStorage();
      const materialIdx = materials.findIndex(m => m.id === materialId);
      if(materialIdx < 0){
        showAlert('Materiale non trovato', 'warn');
        return;
      }

      const material = materials[materialIdx];
      material.consumptionHistory = Array.isArray(material.consumptionHistory) ? material.consumptionHistory : [];
      const entry = material.consumptionHistory.find((h, idx) => String(h.usageId || `${material.id}_${idx}`) === String(usageId));
      if(!entry){
        showAlert('Voce in uso non trovata', 'warn');
        return;
      }
      if(entry.closedAt || entry.status === 'consumato'){
        showAlert('Voce giÃ  chiusa come consumata', 'warn');
        return;
      }

      const suggestedOperator = String(localStorage.getItem(LAST_OPERATOR_KEY) || entry.operatore || '').trim();
      const closingOperator = prompt('Operatore che chiude il consumo:', suggestedOperator);
      if(closingOperator === null) return;
      const operator = String(closingOperator || '').trim() || String(entry.operatore || '--').trim();

      entry.status = 'consumato';
      entry.closedAt = new Date().toISOString();
      entry.closedBy = operator;
      entry.updatedAt = new Date().toISOString();

      materials[materialIdx] = material;
      saveToLocalStorage(materials);
      saveOperator(operator);

      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('materials').doc(material.id).set({
          consumptionHistory: material.consumptionHistory,
          updatedAt: new Date().toISOString()
        }, { merge: true }).catch(err => {
          console.warn('Firebase sync chiusura in uso non riuscita:', err && err.message ? err.message : err);
        });
      }

      showAlert(`âœ… ${operator} ha chiuso come consumato il materiale in uso`, 'info');
      updateActiveUsageData();
      updateOutgoingRegisterData();
    }

    function updateActiveUsageData(){
      const rows = getActiveUsageData();
      const totalCount = rows.length;
      const totalQuantity = rows.reduce((sum, row) => sum + (Number(row.quantity || 0) || 0), 0);
      const lastDate = rows.length > 0 ? formatDate(rows[0].date) : '--';

      const totalCountEl = document.getElementById('activeUsageTotalCount');
      const totalQtyEl = document.getElementById('activeUsageTotalQuantity');
      const lastDateEl = document.getElementById('activeUsageLastDate');
      if(totalCountEl) totalCountEl.textContent = String(totalCount);
      if(totalQtyEl) totalQtyEl.textContent = String(totalQuantity);
      if(lastDateEl) lastDateEl.textContent = lastDate;

      const tbody = document.getElementById('activeUsageTableBody');
      if(!tbody) return;
      tbody.innerHTML = '';

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(row.date)}</td>
          <td>${row.category || '--'}</td>
          <td>${row.materialName || '--'}</td>
          <td>${row.operator || '--'}</td>
          <td>${row.quantity || 0}</td>
          <td>${row.batches || '--'}</td>
          <td>${getConsumptionStatusBadge(row.status)}</td>
          <td><button style="padding:6px 10px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600" onclick="markUsageAsConsumed('${row.materialId}','${row.usageId}')">Segna consumato</button></td>
        `;
        tbody.appendChild(tr);
      });

      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" style="text-align:center;color:#999;padding:20px">Nessun materiale attualmente in uso</td>';
        tbody.appendChild(tr);
      }
    }

    // ===== IMPLANTS REPORT FUNCTIONS =====
    let implantsReportCharts = { trend: null, distribution: null };

    function openImplantsReportModal() {
      const modal = document.getElementById('implantsReportModal');
      modal.classList.add('active');
      setTimeout(() => initImplantsReportFilters(), 100);
    }

    function closeImplantsReportModal() {
      const modal = document.getElementById('implantsReportModal');
      modal.classList.remove('active');
      if (implantsReportCharts.trend) implantsReportCharts.trend.destroy();
      if (implantsReportCharts.distribution) implantsReportCharts.distribution.destroy();
    }

    function initImplantsReportFilters() {
      const implants = loadImplantsFromStorage();
      
      // Popola tipi
      const types = Array.from(new Set(implants.map(i => i.type).filter(t => t))).sort();
      const typeSelect = document.getElementById('implantsReportTypeFilter');
      typeSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        typeSelect.appendChild(opt);
      });

      // Popola aziende
      const companies = Array.from(new Set(implants.map(i => i.company).filter(c => c))).sort();
      const companySelect = document.getElementById('implantsReportCompanyFilter');
      companySelect.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp;
        opt.textContent = comp;
        companySelect.appendChild(opt);
      });

      updateImplantsReportData();
    }

    function getFilteredImplantsReportData() {
      const implants = loadImplantsFromStorage();
      const typeFilter = document.getElementById('implantsReportTypeFilter').value;
      const companyFilter = document.getElementById('implantsReportCompanyFilter').value;
      const statusFilter = (document.getElementById('implantsReportStatusFilter') || {}).value || 'Tutti';

      return implants.filter(i => {
        if (typeFilter !== 'Tutti' && i.type !== typeFilter) return false;
        if (companyFilter !== 'Tutte' && i.company !== companyFilter) return false;
        if (statusFilter !== 'Tutti') {
          const history = Array.isArray(i.consumptionHistory) ? i.consumptionHistory : [];
          const hasStatus = history.some(entry => {
            const entryStatus = entry && entry.status === 'in_uso' ? 'in_uso' : 'consumato';
            return entryStatus === statusFilter;
          });
          if (!hasStatus) return false;
        }
        return true;
      });
    }

    function updateImplantsReportData() {
      const filtered = getFilteredImplantsReportData();
      
      // Calcola statistiche
      const totalExpense = filtered.reduce((sum, i) => sum + ((i.price || 0) * (i.quantity || 1)), 0);
      const orderCount = filtered.length;
      const avgPrice = orderCount > 0 ? totalExpense / orderCount : 0;
      
      // Top tipo
      const typeExpense = {};
      filtered.forEach(i => {
        const type = i.type || 'Non categorizzato';
        typeExpense[type] = (typeExpense[type] || 0) + ((i.price || 0) * (i.quantity || 1));
      });
      const topType = Object.entries(typeExpense).sort((a, b) => b[1] - a[1])[0]?.[0] || '--';

      document.getElementById('implantsReportTotalExpense').textContent = 'â‚¬ ' + totalExpense.toFixed(2);
      document.getElementById('implantsReportOrderCount').textContent = orderCount;
      document.getElementById('implantsReportAveragePrice').textContent = 'â‚¬ ' + avgPrice.toFixed(2);
      document.getElementById('implantsReportTopType').textContent = topType;

      // Aggiorna grafici e tabella
      updateImplantsReportCharts(filtered);
      updateImplantsReportTable(filtered);
    }

    function updateImplantsReportCharts(filtered) {
      // Trend spese per mese
      const monthlyData = {};
      filtered.forEach(i => {
        const orderDate = i.orderDate ? (typeof i.orderDate === 'string' ? new Date(i.orderDate) : i.orderDate) : new Date();
        const monthKey = orderDate.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit' });
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + ((i.price || 0) * (i.quantity || 1));
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const monthlyExpenses = sortedMonths.map(m => monthlyData[m]);

      // Distribuzione per tipo
      const typeData = {};
      filtered.forEach(i => {
        const type = i.type || 'Non categorizzato';
        typeData[type] = (typeData[type] || 0) + ((i.price || 0) * (i.quantity || 1));
      });

      // Destroy previous charts
      if (implantsReportCharts.trend) implantsReportCharts.trend.destroy();
      if (implantsReportCharts.distribution) implantsReportCharts.distribution.destroy();

      // Trend Chart
      const trendCtx = document.getElementById('implantsReportTrendChart').getContext('2d');
      implantsReportCharts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Spesa Mensile (â‚¬)',
            data: monthlyExpenses,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#1976d2'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Spesa (â‚¬)' } }
          }
        }
      });

      // Distribution Chart
      const distCtx = document.getElementById('implantsReportDistributionChart').getContext('2d');
      const colors = ['#1976d2', '#d32f2f', '#f57c00', '#388e3c', '#7b1fa2', '#c2185b', '#00838f', '#6d4c41'];
      implantsReportCharts.distribution = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeData),
          datasets: [{
            data: Object.values(typeData),
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateImplantsReportTable(filtered) {
      const tbody = document.getElementById('implantsReportTableBody');
      tbody.innerHTML = '';

      filtered.sort((a, b) => {
        const dateA = a.orderDate ? (typeof a.orderDate === 'string' ? new Date(a.orderDate) : a.orderDate) : new Date();
        const dateB = b.orderDate ? (typeof b.orderDate === 'string' ? new Date(b.orderDate) : b.orderDate) : new Date();
        return dateB - dateA;
      }).forEach(i => {
        const orderDate = formatDate(i.orderDate);
        const total = ((i.price || 0) * (i.quantity || 1)).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${i.type || '--'}</td>
          <td>${i.company || '--'}</td>
          <td>${i.model || '--'}</td>
          <td>â‚¬ ${(i.price || 0).toFixed(2)}</td>
          <td>${i.quantity || 0}</td>
          <td>â‚¬ ${total}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function resetImplantsReportFilters() {
      document.getElementById('implantsReportTypeFilter').value = 'Tutti';
      document.getElementById('implantsReportCompanyFilter').value = 'Tutte';
      const statusFilter = document.getElementById('implantsReportStatusFilter');
      if(statusFilter) statusFilter.value = 'Tutti';
      updateImplantsReportData();
    }

    // ===== IMPLANTS INCOMING REGISTER FUNCTIONS =====
    function openImplantsIncomingRegisterModal() {
      const modal = document.getElementById('implantsIncomingRegisterModal');
      modal.classList.add('active');
      setTimeout(() => initImplantsIncomingRegisterFilters(), 100);
    }

    function closeImplantsIncomingRegisterModal() {
      const modal = document.getElementById('implantsIncomingRegisterModal');
      modal.classList.remove('active');
    }

    function initImplantsIncomingRegisterFilters() {
      const implants = loadImplantsFromStorage();
      
      // Popola tipi
      const types = Array.from(new Set(implants.map(i => i.type).filter(t => t))).sort();
      const typeSelect = document.getElementById('implantsIncomingTypeFilter');
      typeSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        typeSelect.appendChild(opt);
      });

      // Popola aziende
      const companies = Array.from(new Set(implants.map(i => i.company).filter(c => c))).sort();
      const companySelect = document.getElementById('implantsIncomingCompanyFilter');
      companySelect.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp;
        opt.textContent = comp;
        companySelect.appendChild(opt);
      });

      updateImplantsIncomingRegisterData();
    }

    function getFilteredImplantsIncomingData() {
      const implants = loadImplantsFromStorage();
      const typeFilter = document.getElementById('implantsIncomingTypeFilter').value;
      const companyFilter = document.getElementById('implantsIncomingCompanyFilter').value;
      const periodFilter = document.getElementById('implantsIncomingPeriodFilter').value;

      // Estrai tutti i lotti impianti (come entrate)
      let allEntries = [];
      implants.forEach(i => {
        const lots = Array.isArray(i.batches) ? i.batches : [];
        if(lots.length === 0){
          allEntries.push({
            implantId: i.id,
            lotId: i.id,
            type: i.type,
            company: i.company,
            model: i.model || i.kitComponents || '--',
            orderDate: i.orderDate,
            quantity: i.quantity,
            createdAt: i.createdAt || i.orderDate
          });
          return;
        }

        lots.forEach(lot => {
          const lotQty = Number(lot.quantitÃ  ?? lot.quantita ?? lot.originalQuantita ?? lot.quantity ?? 0) || 0;
          allEntries.push({
            implantId: i.id,
            lotId: lot.batchId || lot.id || i.id,
            type: i.type,
            company: i.company,
            model: i.model || i.kitComponents || '--',
            orderDate: lot.dataOrdine || lot.orderDate || i.orderDate,
            quantity: lotQty,
            createdAt: i.createdAt || i.orderDate
          });
        });
      });

      // Filtra per tipo e azienda
      allEntries = allEntries.filter(e => {
        if (typeFilter !== 'Tutti' && e.type !== typeFilter) return false;
        if (companyFilter !== 'Tutte' && e.company !== companyFilter) return false;
        return true;
      });

      // Filtra per periodo
      if (periodFilter !== 'all') {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(periodFilter));
        allEntries = allEntries.filter(e => {
          const entryDate = e.orderDate ? new Date(e.orderDate) : new Date(e.createdAt);
          return entryDate >= cutoffDate;
        });
      }

      // Ordina per data (piÃ¹ recenti prima)
      allEntries.sort((a, b) => {
        const dateA = a.orderDate ? new Date(a.orderDate) : new Date(a.createdAt);
        const dateB = b.orderDate ? new Date(b.orderDate) : new Date(b.createdAt);
        return dateB - dateA;
      });

      return allEntries;
    }

    function updateImplantsIncomingRegisterData() {
      const filtered = getFilteredImplantsIncomingData();
      
      // Calcola statistiche
      const totalCount = filtered.length;
      const totalQuantity = filtered.reduce((sum, e) => sum + (e.quantity || 0), 0);
      const lastDate = filtered.length > 0 ? formatDate(filtered[0].orderDate || filtered[0].createdAt) : '--';

      document.getElementById('implantsIncomingTotalCount').textContent = totalCount;
      document.getElementById('implantsIncomingTotalQuantity').textContent = totalQuantity;
      document.getElementById('implantsIncomingLastDate').textContent = lastDate;

      // Aggiorna tabella
      updateImplantsIncomingRegisterTable(filtered);
    }

    function updateImplantsIncomingRegisterTable(filtered) {
      const tbody = document.getElementById('implantsIncomingRegisterTableBody');
      tbody.innerHTML = '';

      filtered.forEach(e => {
        const orderDate = formatDate(e.orderDate || e.createdAt);
        const lotLabel = getLotDisplayLabel({ dataOrdine: e.orderDate || e.createdAt });
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${e.type || '--'}</td>
          <td>${e.company || '--'}</td>
          <td>${e.model}</td>
          <td>${e.quantity || 0}</td>
          <td>${lotLabel}</td>
        `;
        tbody.appendChild(tr);
      });

      // Se nessun risultato
      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center;color:#999;padding:20px">Nessuna entrata trovata</td>';
        tbody.appendChild(tr);
      }
    }

    function resetImplantsIncomingFilters() {
      document.getElementById('implantsIncomingTypeFilter').value = 'Tutti';
      document.getElementById('implantsIncomingCompanyFilter').value = 'Tutte';
      document.getElementById('implantsIncomingPeriodFilter').value = '30';
      updateImplantsIncomingRegisterData();
    }

    // ===== IMPLANTS FEFO CONSUMPTION =====
    let implantConsumptionLookup = [];

    function syncImplantConsumptionSelection(){
      const searchInput = document.getElementById('implantConsumptionSearch');
      const hiddenInput = document.getElementById('implantConsumptionId');
      if(!searchInput || !hiddenInput) return '';

      const typed = normalizeConsumptionText(searchInput.value);
      if(!typed){
        hiddenInput.value = '';
        return '';
      }

      const exact = implantConsumptionLookup.find(item => item.normalizedName === typed || item.normalizedDisplay === typed);
      hiddenInput.value = exact ? exact.id : '';
      return hiddenInput.value;
    }

    function openImplantConsumptionModal(){
      const modal = document.getElementById('implantConsumptionModal');
      if(!modal) return;
      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.justifyContent = 'center';
      setTimeout(() => initImplantConsumptionModal(), 100);
    }

    function closeImplantConsumptionModal(){
      const modal = document.getElementById('implantConsumptionModal');
      if(!modal) return;
      modal.style.display = 'none';
      const form = document.getElementById('implantConsumptionForm');
      if(form) form.reset();
      const searchInput = document.getElementById('implantConsumptionSearch');
      const hiddenInput = document.getElementById('implantConsumptionId');
      if(searchInput) searchInput.value = '';
      if(hiddenInput) hiddenInput.value = '';
      const statusEl = document.getElementById('implantConsumptionStatus');
      if(statusEl) statusEl.value = 'in_uso';
    }

    function initImplantConsumptionModal(){
      const implants = loadImplantsFromStorage();
      const datalist = document.getElementById('implantConsumptionList');
      const searchInput = document.getElementById('implantConsumptionSearch');
      const hiddenInput = document.getElementById('implantConsumptionId');
      if(!datalist || !searchInput || !hiddenInput) return;
      initConsumptionOperator();

      datalist.innerHTML = '';
      searchInput.value = '';
      hiddenInput.value = '';
      implantConsumptionLookup = [];

      implants
        .filter(i => Number(i.quantity || 0) > 0)
        .sort((a,b) => {
          const da = parseFlexibleDate(a.orderDate || a.createdAt);
          const db = parseFlexibleDate(b.orderDate || b.createdAt);
          return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
        })
        .forEach(i => {
          const model = getImplantDisplayModel(i) || '--';
          const lots = Array.isArray(i.batches) ? i.batches.length : 0;
          const baseName = [i.type || 'Impianto', model, i.company || '--'].join(' | ');
          const displayName = `${baseName} (${i.quantity || 0} pz, ${lots} lotti)`;
          implantConsumptionLookup.push({
            id: i.id,
            name: baseName,
            display: displayName,
            normalizedName: normalizeConsumptionText(baseName),
            normalizedDisplay: normalizeConsumptionText(displayName)
          });

          const opt = document.createElement('option');
          opt.value = displayName;
          datalist.appendChild(opt);
        });

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('implantConsumptionDate').value = today;
      const statusEl = document.getElementById('implantConsumptionStatus');
      if(statusEl) statusEl.value = 'in_uso';

      const lastOp = localStorage.getItem(LAST_OPERATOR_KEY) || '';
      const opInput = document.getElementById('implantConsumptionOperator');
      if(opInput && lastOp) opInput.value = lastOp;
    }

    function updateImplantConsumptionPreview(){
      const implantId = syncImplantConsumptionSelection();
      const quantity = parseInt(document.getElementById('implantConsumptionQuantity').value, 10) || 0;
      const searchValue = (document.getElementById('implantConsumptionSearch').value || '').trim();
      const previewDiv = document.getElementById('implantConsumptionPreviewContent');
      if(!previewDiv) return;

      if(!implantId || quantity <= 0){
        if(searchValue && !implantId) {
          previewDiv.innerHTML = 'Seleziona un impianto valido dai suggerimenti automatici.';
        } else {
          previewDiv.innerHTML = 'Inserisci impianto e quantitÃ  per visualizzare anteprima...';
        }
        return;
      }

      const implants = loadImplantsFromStorage();
      const implant = implants.find(i => i.id === implantId);
      if(!implant){
        previewDiv.innerHTML = 'Impianto non trovato';
        return;
      }

      const lots = [...(implant.batches || [])].sort((a,b) => {
        const aExpiry = a.scadenza ? new Date(a.scadenza).getTime() : Number.POSITIVE_INFINITY;
        const bExpiry = b.scadenza ? new Date(b.scadenza).getTime() : Number.POSITIVE_INFINITY;
        if(aExpiry !== bExpiry) return aExpiry - bExpiry;
        return new Date(a.dataOrdine || 0).getTime() - new Date(b.dataOrdine || 0).getTime();
      });

      if(lots.length === 0){
        previewDiv.innerHTML = 'âš ï¸ Nessun lotto disponibile per questo impianto';
        return;
      }

      let remainingQty = quantity;
      let previewHtml = '';
      let found = false;

      for(let i = 0; i < lots.length && remainingQty > 0; i++){
        const lot = lots[i];
        const lotRemaining = Number(lot.quantitÃ Rimanente ?? lot.quantitÃ  ?? 0) || 0;
        if(lotRemaining <= 0) continue;
        found = true;
        const qtyFromLot = Math.min(remainingQty, lotRemaining);
        const qtyAfter = lotRemaining - qtyFromLot;
        const lotLabel = getLotDisplayLabel(lot, i);

        previewHtml += `
          <div class="consumption-preview-line">
            <span>ğŸ“¦ <strong>${lotLabel}</strong> (Ordine: ${formatDate(lot.dataOrdine)})</span>
          </div>
          <div class="consumption-preview-line">
            <span style="margin-left:20px">Scadenza: ${formatDate(lot.scadenza)}</span>
          </div>
          <div class="consumption-preview-line">
            <span style="margin-left:20px">Riducibile: <strong>${qtyFromLot} pz</strong></span>
            <strong style="color:#d32f2f">${lotRemaining} â†’ ${qtyAfter} pz</strong>
          </div>
        `;

        remainingQty -= qtyFromLot;
      }

      if(!found){
        previewHtml = 'âš ï¸ Impianto esaurito';
      } else if(remainingQty > 0){
        previewHtml += `<div class="consumption-preview-line" style="color:#d32f2f"><strong>âš ï¸ QuantitÃ  insufficiente: mancano ${remainingQty} pz</strong></div>`;
      }

      previewDiv.innerHTML = previewHtml;
    }

    document.getElementById('implantConsumptionForm')?.addEventListener('submit', async function(e){
      e.preventDefault();

      const implantId = syncImplantConsumptionSelection();
      const quantity = parseInt(document.getElementById('implantConsumptionQuantity').value, 10) || 0;
      const consumptionDate = document.getElementById('implantConsumptionDate').value;
      const operator = String(document.getElementById('implantConsumptionOperator').value || '').trim();
      const movementStatus = (document.getElementById('implantConsumptionStatus') || {}).value === 'consumato' ? 'consumato' : 'in_uso';

      if(!implantId || quantity <= 0 || !consumptionDate || !operator){
        alert('Compila tutti i campi e seleziona un impianto valido');
        return;
      }

      const implants = loadImplantsFromStorage();
      const implantIdx = implants.findIndex(i => i.id === implantId);
      if(implantIdx < 0){
        alert('Impianto non trovato');
        return;
      }

      const implant = implants[implantIdx];
      let lots = [...(implant.batches || [])].sort((a,b) => {
        const aExpiry = a.scadenza ? new Date(a.scadenza).getTime() : Number.POSITIVE_INFINITY;
        const bExpiry = b.scadenza ? new Date(b.scadenza).getTime() : Number.POSITIVE_INFINITY;
        if(aExpiry !== bExpiry) return aExpiry - bExpiry;
        return new Date(a.dataOrdine || 0).getTime() - new Date(b.dataOrdine || 0).getTime();
      });

      let remainingQty = quantity;
      const consumed = [];

      for(let i = 0; i < lots.length && remainingQty > 0; i++){
        const lotRemaining = Number(lots[i].quantitÃ Rimanente ?? lots[i].quantitÃ  ?? 0) || 0;
        if(lotRemaining <= 0) continue;
        const qtyFromLot = Math.min(remainingQty, lotRemaining);
        lots[i].quantitÃ Rimanente = lotRemaining - qtyFromLot;
        consumed.push({ batchId: lots[i].batchId, dataOrdine: lots[i].dataOrdine, quantitÃ : qtyFromLot });
        lots[i].consumptions = Array.isArray(lots[i].consumptions) ? lots[i].consumptions : [];
        lots[i].consumptions.push({
          data: consumptionDate,
          quantitÃ : qtyFromLot,
          operatore: operator,
          timestamp: new Date().toISOString()
        });
        remainingQty -= qtyFromLot;
      }

      if(remainingQty > 0){
        alert('QuantitÃ  insufficiente nel magazzino implantare');
        return;
      }

      implant.batches = lots;
      implant.quantity = implant.batches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
      implant.expiry = recomputeImplantExpiryFromBatches(implant.batches);
      implant.updatedAt = new Date().toISOString();
      implant.consumptionHistory = Array.isArray(implant.consumptionHistory) ? implant.consumptionHistory : [];
      const usageId = 'use_impl_' + String(implant.id || 'imp') + '_' + Date.now();
      implant.consumptionHistory.push({
        usageId,
        data: consumptionDate,
        quantitÃ : quantity,
        operatore: operator,
        status: movementStatus,
        type: implant.type || '--',
        company: implant.company || '--',
        model: getImplantDisplayModel(implant) || '--',
        batchesConsumed: consumed,
        timestamp: new Date().toISOString()
      });

      implants[implantIdx] = implant;
      saveImplantsToStorage(implants);
      saveOperator(operator);

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('implants').doc(implant.id).set({
            batches: implant.batches,
            quantity: implant.quantity,
            expiry: implant.expiry,
            consumptionHistory: implant.consumptionHistory,
            updatedAt: implant.updatedAt
          }, { merge: true });
        } catch(err){
          console.warn('Firebase sync consumo impianti non riuscita:', err && err.message ? err.message : err);
        }
      }

      const lotInfo = consumed.map((c, idx) => `${c.quantitÃ } pz da ${getLotDisplayLabel(c, idx)}`).join(', ');
      const statusLabel = getConsumptionStatusLabel(movementStatus);
      showAlert(`âœ… ${operator} ha registrato "${statusLabel}" impianti (${quantity} pz) da: ${lotInfo}`, 'info');

      closeImplantConsumptionModal();
      initImplantFilters();
      renderImplantsList();
      updateImplantsOutgoingRegisterData();
      updateActiveImplantsUsageData();
    });

    // ===== IMPLANTS OUTGOING REGISTER =====
    function openImplantsOutgoingRegisterModal(){
      const modal = document.getElementById('implantsOutgoingRegisterModal');
      if(!modal) return;
      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.justifyContent = 'center';
      setTimeout(() => initImplantsOutgoingRegisterFilters(), 100);
    }

    function closeImplantsOutgoingRegisterModal(){
      const modal = document.getElementById('implantsOutgoingRegisterModal');
      if(!modal) return;
      modal.style.display = 'none';
    }

    function initImplantsOutgoingRegisterFilters(){
      const implants = loadImplantsFromStorage();
      const types = Array.from(new Set(implants.map(i => i.type).filter(Boolean))).sort();
      const typeSelect = document.getElementById('implantsOutgoingTypeFilter');
      typeSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        typeSelect.appendChild(opt);
      });

      const operators = loadOperators();
      const operatorSelect = document.getElementById('implantsOutgoingOperatorFilter');
      operatorSelect.innerHTML = '<option value="Tutti">Tutti</option>';
      operators.forEach(op => {
        const opt = document.createElement('option');
        opt.value = op;
        opt.textContent = op;
        operatorSelect.appendChild(opt);
      });

      updateImplantsOutgoingRegisterData();
    }

    function getFilteredImplantsOutgoingData(){
      const implants = loadImplantsFromStorage();
      const typeFilter = document.getElementById('implantsOutgoingTypeFilter').value;
      const operatorFilter = document.getElementById('implantsOutgoingOperatorFilter').value;
      const periodFilter = document.getElementById('implantsOutgoingPeriodFilter').value;
      const statusFilter = (document.getElementById('implantsOutgoingStatusFilter') || {}).value || 'Tutti';

      let allConsumptions = [];
      implants.forEach(i => {
        const history = Array.isArray(i.consumptionHistory) ? i.consumptionHistory : [];
        history.forEach(entry => {
          const operator = String(entry.operatore || entry.operator || '').trim() || '--';
          const status = entry.status === 'in_uso' ? 'in_uso' : 'consumato';
          const batches = Array.isArray(entry.batchesConsumed)
            ? entry.batchesConsumed.map((b, idx) => `${b.quantitÃ  || 0}pz da ${getLotDisplayLabel(b, idx)}`).join(', ')
            : '--';
          allConsumptions.push({
            date: entry.data || entry.timestamp,
            type: i.type || '--',
            company: i.company || '--',
            model: getImplantDisplayModel(i) || '--',
            operator,
            quantity: Number(entry.quantitÃ  || 0) || 0,
            status,
            batches
          });
        });
      });

      allConsumptions = allConsumptions.filter(c => {
        if(typeFilter !== 'Tutti' && c.type !== typeFilter) return false;
        if(operatorFilter !== 'Tutti' && c.operator !== operatorFilter) return false;
        if(statusFilter !== 'Tutti' && c.status !== statusFilter) return false;
        return true;
      });

      if(periodFilter !== 'all'){
        const days = parseInt(periodFilter, 10);
        if(Number.isInteger(days) && days > 0){
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - days);
          allConsumptions = allConsumptions.filter(c => {
            const d = parseFlexibleDate(c.date);
            return d && d >= cutoffDate;
          });
        }
      }

      allConsumptions.sort((a,b) => {
        const da = parseFlexibleDate(a.date);
        const db = parseFlexibleDate(b.date);
        return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
      });

      return allConsumptions;
    }

    function updateImplantsOutgoingRegisterData(){
      const filtered = getFilteredImplantsOutgoingData();
      const totalCount = filtered.length;
      const totalQuantity = filtered.reduce((sum, c) => sum + (Number(c.quantity || 0) || 0), 0);
      const lastDate = filtered.length > 0 ? formatDate(filtered[0].date) : '--';

      document.getElementById('implantsOutgoingTotalCount').textContent = totalCount;
      document.getElementById('implantsOutgoingTotalQuantity').textContent = totalQuantity;
      document.getElementById('implantsOutgoingLastDate').textContent = lastDate;

      const tbody = document.getElementById('implantsOutgoingRegisterTableBody');
      tbody.innerHTML = '';
      filtered.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(c.date)}</td>
          <td>${c.type || '--'}</td>
          <td>${c.company || '--'}</td>
          <td>${c.model || '--'}</td>
          <td>${c.operator || '--'}</td>
          <td>${c.quantity || 0}</td>
          <td>${getConsumptionStatusBadge(c.status)}</td>
          <td>${c.batches || '--'}</td>
        `;
        tbody.appendChild(tr);
      });

      if(filtered.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" style="text-align:center;color:#999;padding:20px">Nessuna uscita impianti trovata</td>';
        tbody.appendChild(tr);
      }
    }

    function resetImplantsOutgoingFilters(){
      document.getElementById('implantsOutgoingTypeFilter').value = 'Tutti';
      document.getElementById('implantsOutgoingOperatorFilter').value = 'Tutti';
      document.getElementById('implantsOutgoingPeriodFilter').value = '30';
      const statusFilter = document.getElementById('implantsOutgoingStatusFilter');
      if(statusFilter) statusFilter.value = 'Tutti';
      updateImplantsOutgoingRegisterData();
    }

    function getActiveImplantsUsageData(){
      const implants = loadImplantsFromStorage();
      const rows = [];
      implants.forEach(implant => {
        const history = Array.isArray(implant.consumptionHistory) ? implant.consumptionHistory : [];
        history.forEach((entry, index) => {
          const status = entry.status === 'in_uso' ? 'in_uso' : 'consumato';
          if(status !== 'in_uso' || entry.closedAt) return;
          rows.push({
            implantId: implant.id,
            usageId: String(entry.usageId || `${implant.id}_${index}`),
            date: entry.data || entry.timestamp,
            type: implant.type || '--',
            company: implant.company || '--',
            model: getImplantDisplayModel(implant) || '--',
            operator: String(entry.operatore || entry.operator || '').trim() || '--',
            quantity: Number(entry.quantitÃ  || 0) || 0,
            batches: Array.isArray(entry.batchesConsumed)
              ? entry.batchesConsumed.map((b, idx) => `${b.quantitÃ  || 0}pz da ${getLotDisplayLabel(b, idx)}`).join(', ')
              : '--',
            status
          });
        });
      });

      rows.sort((a,b) => {
        const da = parseFlexibleDate(a.date);
        const db = parseFlexibleDate(b.date);
        return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
      });
      return rows;
    }

    function openActiveImplantsUsageModal(){
      const modal = document.getElementById('activeImplantsUsageModal');
      if(!modal) return;
      modal.style.display = 'flex';
      modal.style.alignItems = 'flex-start';
      modal.style.justifyContent = 'center';
      updateActiveImplantsUsageData();
    }

    function closeActiveImplantsUsageModal(){
      const modal = document.getElementById('activeImplantsUsageModal');
      if(!modal) return;
      modal.style.display = 'none';
    }

    async function markImplantUsageAsConsumed(implantId, usageId){
      const implants = loadImplantsFromStorage();
      const implantIdx = implants.findIndex(i => i.id === implantId);
      if(implantIdx < 0){
        showAlert('Impianto non trovato', 'warn');
        return;
      }

      const implant = implants[implantIdx];
      implant.consumptionHistory = Array.isArray(implant.consumptionHistory) ? implant.consumptionHistory : [];
      const entry = implant.consumptionHistory.find((h, idx) => String(h.usageId || `${implant.id}_${idx}`) === String(usageId));
      if(!entry){
        showAlert('Voce in uso impianto non trovata', 'warn');
        return;
      }
      if(entry.closedAt || entry.status === 'consumato'){
        showAlert('Voce impianto giÃ  chiusa come consumata', 'warn');
        return;
      }

      const suggestedOperator = String(localStorage.getItem(LAST_OPERATOR_KEY) || entry.operatore || '').trim();
      const closingOperator = prompt('Operatore che chiude il consumo impianto:', suggestedOperator);
      if(closingOperator === null) return;
      const operator = String(closingOperator || '').trim() || String(entry.operatore || '--').trim();

      entry.status = 'consumato';
      entry.closedAt = new Date().toISOString();
      entry.closedBy = operator;
      entry.updatedAt = new Date().toISOString();

      implants[implantIdx] = implant;
      saveImplantsToStorage(implants);
      saveOperator(operator);

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('implants').doc(implant.id).set({
            consumptionHistory: implant.consumptionHistory,
            updatedAt: new Date().toISOString()
          }, { merge: true });
        } catch(err){
          console.warn('Firebase sync chiusura in uso impianti non riuscita:', err && err.message ? err.message : err);
        }
      }

      showAlert(`âœ… ${operator} ha chiuso come consumato l'impianto in uso`, 'info');
      updateActiveImplantsUsageData();
      updateImplantsOutgoingRegisterData();
    }

    function updateActiveImplantsUsageData(){
      const rows = getActiveImplantsUsageData();
      const totalCount = rows.length;
      const totalQuantity = rows.reduce((sum, row) => sum + (Number(row.quantity || 0) || 0), 0);
      const lastDate = rows.length > 0 ? formatDate(rows[0].date) : '--';

      const totalCountEl = document.getElementById('activeImplantsUsageTotalCount');
      const totalQtyEl = document.getElementById('activeImplantsUsageTotalQuantity');
      const lastDateEl = document.getElementById('activeImplantsUsageLastDate');
      if(totalCountEl) totalCountEl.textContent = String(totalCount);
      if(totalQtyEl) totalQtyEl.textContent = String(totalQuantity);
      if(lastDateEl) lastDateEl.textContent = lastDate;

      const tbody = document.getElementById('activeImplantsUsageTableBody');
      if(!tbody) return;
      tbody.innerHTML = '';

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(row.date)}</td>
          <td>${row.type || '--'}</td>
          <td>${row.company || '--'}</td>
          <td>${row.model || '--'}</td>
          <td>${row.operator || '--'}</td>
          <td>${row.quantity || 0}</td>
          <td>${row.batches || '--'}</td>
          <td>${getConsumptionStatusBadge(row.status)}</td>
          <td><button style="padding:6px 10px;background:#d32f2f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600" onclick="markImplantUsageAsConsumed('${row.implantId}','${row.usageId}')">Segna consumato</button></td>
        `;
        tbody.appendChild(tr);
      });

      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="9" style="text-align:center;color:#999;padding:20px">Nessun impianto attualmente in uso</td>';
        tbody.appendChild(tr);
      }
    }

    // ===== NUOVO ORDINE FUNCTIONS =====
    let orderArticles = [];

    function openAddSelectionModal() {
      const modal = document.getElementById('addSelectionModal');
      modal.classList.add('active');
    }
    
    function closeAddSelectionModal() {
      const modal = document.getElementById('addSelectionModal');
      modal.classList.remove('active');
    }
    
    function continueWithOrder() {
      closeAddSelectionModal();
      setTimeout(() => {
        const modal = document.getElementById('orderModal');
        modal.classList.add('active');
        setTimeout(() => initOrderModal(), 100);
      }, 200);
    }
    
    function continueWithMaterial() {
      closeAddSelectionModal();
      setTimeout(() => {
        const modal = document.getElementById('materialModal');
        modal.classList.add('active');
        setupMaterialCustomFields();
      }, 200);
    }

    function openMaterialsWarehouse() {
      currentFilter = 'Tutti';
      currentCompanyFilter = 'Tutte';
      currentDistributorFilter = 'Tutti';
      currentExpiryFilter = 'Tutte';
      currentQuantityFilter = 'Tutte';

      const expiryFilterSelect = document.getElementById('expiryFilterSelect');
      const quantityFilterSelect = document.getElementById('quantityFilterSelect');
      const companyFilterSelectEl = document.getElementById('companyFilterSelect');
      const distributorFilterSelectEl = document.getElementById('distributorFilterSelect');

      if (expiryFilterSelect) expiryFilterSelect.value = 'Tutte';
      if (quantityFilterSelect) quantityFilterSelect.value = 'Tutte';
      if (companyFilterSelectEl) companyFilterSelectEl.value = 'Tutte';
      if (distributorFilterSelectEl) distributorFilterSelectEl.value = 'Tutti';

      updateCategoryFilters();
      renderFilteredMaterials();
      updateResetButtonVisibility();

      const target = document.getElementById('materialsFilters') || document.querySelector('.table-wrapper');
      if (target && typeof target.scrollIntoView === 'function') {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function openMaterialModal() {
      const modal = document.getElementById('materialModal');
      modal.classList.add('active');
      setupMaterialCustomFields();
      refreshMatNameSuggestions('');
    }

    function closeMaterialModal() {
      const modal = document.getElementById('materialModal');
      modal.classList.remove('active');
      document.getElementById('materialForm').reset();
    }

    function setupMaterialCustomFields() {
      const distSelect = document.getElementById('matDistributor');
      const distInput = document.getElementById('matDistributorCustom');
      const companySelect = document.getElementById('matCompany');
      const companyInput = document.getElementById('matCompanyCustom');
      if (!distSelect || !distInput || !companySelect || !companyInput) return;

      const distGroup = distSelect.closest('.material-form-group');
      const companyGroup = companySelect.closest('.material-form-group');

      distSelect.onchange = () => {
        if (distSelect.value === 'Other') {
          if (distGroup) distGroup.classList.add('custom-open');
          distInput.required = true;
        } else {
          if (distGroup) distGroup.classList.remove('custom-open');
          distInput.required = false;
          distInput.value = '';
        }
      };

      companySelect.onchange = () => {
        if (companySelect.value === 'Other') {
          if (companyGroup) companyGroup.classList.add('custom-open');
        } else {
          if (companyGroup) companyGroup.classList.remove('custom-open');
          companyInput.value = '';
        }
      };

      distSelect.onchange();
      companySelect.onchange();
    }

    function openOrderModal() {
      const modal = document.getElementById('orderModal');
      modal.classList.add('active');
      setTimeout(() => initOrderModal(), 100);
    }

    function closeOrderModal() {
      const modal = document.getElementById('orderModal');
      modal.classList.remove('active');
      document.getElementById('orderForm').reset();
      orderArticles = [];
      document.getElementById('articlesContainerBody').innerHTML = '';
    }

    function initOrderModal() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('orderDate').value = today;

      const materials = loadFromLocalStorage();
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(d => d))).sort();
      
      const distSelect = document.getElementById('orderDistributor');
      distSelect.innerHTML = '<option value="">-- Seleziona --</option>';
      distributors.forEach(dist => {
        const opt = document.createElement('option');
        opt.value = dist;
        opt.textContent = dist;
        distSelect.appendChild(opt);
      });

      if (!Array.from(distSelect.options).some(o => o.value === 'Other')) {
        const otherOpt = document.createElement('option');
        otherOpt.value = 'Other';
        otherOpt.textContent = 'Altro...';
        distSelect.appendChild(otherOpt);
      }

      setupOrderDistributorCustom();

      orderArticles = [];
      addArticleRow();
    }

    function setupOrderDistributorCustom() {
      const distSelect = document.getElementById('orderDistributor');
      const distInput = document.getElementById('orderDistributorCustom');
      if (!distSelect || !distInput) return;
      distSelect.onchange = () => {
        if (distSelect.value === 'Other') {
          distInput.style.display = '';
          distInput.required = true;
        } else {
          distInput.style.display = 'none';
          distInput.required = false;
          distInput.value = '';
        }
      };
      distSelect.onchange();
    }

    function addArticleRow() {
      const materials = loadFromLocalStorage();
      const rowId = 'article_' + Date.now() + '_' + Math.random();
      const datalistId = 'datalist_' + rowId;
      
      const tr = document.createElement('tr');
      tr.className = 'article-row';
      tr.id = rowId;
      
      // Cambiato da select a input con datalist per permettere editing libero
      const materialInput = document.createElement('input');
      materialInput.type = 'text';
      materialInput.className = 'article-material';
      materialInput.placeholder = 'Nome materiale...';
      materialInput.setAttribute('list', datalistId);
      materialInput.setAttribute('data-material-id', '');
      materialInput.style.width = '100%';
      materialInput.style.padding = '4px 5px';
      materialInput.style.border = '1px solid #d0dce6';
      materialInput.style.borderRadius = '3px';
      
      // Crea datalist con materiali esistenti
      const datalist = document.createElement('datalist');
      datalist.id = datalistId;
      materials.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.name + ' (' + m.category + ')';
        opt.setAttribute('data-id', m.id);
        datalist.appendChild(opt);
      });
      
      // Quando seleziona da datalist, salva l'ID
      materialInput.addEventListener('input', function() {
        const selectedOption = Array.from(datalist.options).find(opt => opt.value === this.value);
        if (selectedOption) {
          this.setAttribute('data-material-id', selectedOption.getAttribute('data-id'));
        } else {
          this.setAttribute('data-material-id', '');
        }
      });

      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.min = '1';
      quantityInput.step = '1';
      quantityInput.placeholder = 'QtÃ ';
      quantityInput.className = 'article-qty';
      quantityInput.style.width = '100%';
      quantityInput.style.padding = '4px 5px';
      quantityInput.style.border = '1px solid #d0dce6';
      quantityInput.style.borderRadius = '3px';
      quantityInput.style.textAlign = 'center';

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = '0';
      priceInput.step = '0.01';
      priceInput.placeholder = 'â‚¬';
      priceInput.className = 'article-price';
      priceInput.style.width = '100%';
      priceInput.style.padding = '4px 5px';
      priceInput.style.border = '1px solid #d0dce6';
      priceInput.style.borderRadius = '3px';
      priceInput.style.textAlign = 'center';

      const priceTypeSelect = document.createElement('select');
      priceTypeSelect.className = 'article-pricetype';
      priceTypeSelect.innerHTML = '<option value="totale" selected>Totale</option><option value="unitario">Unitario</option>';
      priceTypeSelect.style.width = '100%';
      priceTypeSelect.style.padding = '4px 5px';
      priceTypeSelect.style.border = '1px solid #d0dce6';
      priceTypeSelect.style.borderRadius = '3px';
      
      // Calcola il prezzo quando cambia il tipo
      const updatePriceTypeDisplay = () => {
        if (quantityInput.value && priceInput.value) {
          if (priceTypeSelect.value === 'unitario') {
            priceInput.value = (parseFloat(priceInput.value) * parseFloat(quantityInput.value)).toFixed(2);
          } else {
            priceInput.value = (parseFloat(priceInput.value) / parseFloat(quantityInput.value)).toFixed(2);
          }
        }
      };
      priceTypeSelect.addEventListener('change', updatePriceTypeDisplay);
      quantityInput.addEventListener('change', updatePriceTypeDisplay);

      const companyInput = document.createElement('input');
      companyInput.type = 'text';
      companyInput.placeholder = 'Azienda';
      companyInput.className = 'article-company';
      companyInput.style.width = '100%';
      companyInput.style.padding = '4px 5px';
      companyInput.style.border = '1px solid #d0dce6';
      companyInput.style.borderRadius = '3px';

      const vatRateSelect = document.createElement('select');
      vatRateSelect.className = 'article-vat';
      vatRateSelect.innerHTML = '<option value="22" selected>22%</option><option value="10">10%</option><option value="4">4%</option>';
      vatRateSelect.style.width = '100%';
      vatRateSelect.style.padding = '4px 5px';
      vatRateSelect.style.border = '1px solid #d0dce6';
      vatRateSelect.style.borderRadius = '3px';

      const categorySelect = document.createElement('select');
      categorySelect.className = 'article-category';
      categorySelect.innerHTML = '<option value="Consumabili Generici" selected>Consumabili Generici</option>';
      const CATEGORIES = ['Strumentario','Consumabili Generici','Monouso','Disinfezione e Sterilizzazione','Chirurgia','Endodonzia','Conservativa e Protesi','Frese e Lucidatura','Anestesia e Farmaci','Impronte e Laboratorio','Radiografia e Fotografia','Profilassi e Igiene Orale','Ortodonzia'];
      CATEGORIES.forEach(cat => {
        if (cat !== 'Consumabili Generici') {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          categorySelect.appendChild(opt);
        }
      });
      categorySelect.style.width = '100%';
      categorySelect.style.padding = '4px 5px';
      categorySelect.style.border = '1px solid #d0dce6';
      categorySelect.style.borderRadius = '3px';

      const descriptionInput = document.createElement('input');
      descriptionInput.type = 'text';
      descriptionInput.className = 'article-desc';
      descriptionInput.value = '';
      descriptionInput.style.display = 'none';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'article-remove';
      removeBtn.textContent = 'âŒ';
      removeBtn.style.padding = '4px 8px';
      removeBtn.style.background = '#d32f2f';
      removeBtn.style.color = '#fff';
      removeBtn.style.border = 'none';
      removeBtn.style.borderRadius = '4px';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.fontSize = '11px';
      removeBtn.onclick = () => tr.remove();

      // Crea celle di tabella
      const tdMat = document.createElement('td');
      tdMat.style.padding = '4px 5px';
      tdMat.style.border = '1px solid #d0dce6';
      tdMat.appendChild(materialInput);
      tdMat.appendChild(datalist);
      tdMat.appendChild(descriptionInput);

      const tdQty = document.createElement('td');
      tdQty.style.padding = '4px 5px';
      tdQty.style.border = '1px solid #d0dce6';
      tdQty.style.width = '40px';
      tdQty.appendChild(quantityInput);

      const tdPrice = document.createElement('td');
      tdPrice.style.padding = '4px 5px';
      tdPrice.style.border = '1px solid #d0dce6';
      tdPrice.style.width = '60px';
      tdPrice.style.textAlign = 'center';
      tdPrice.appendChild(priceInput);

      const tdPriceType = document.createElement('td');
      tdPriceType.style.padding = '4px 5px';
      tdPriceType.style.border = '1px solid #d0dce6';
      tdPriceType.style.width = '70px';
      tdPriceType.style.textAlign = 'center';
      tdPriceType.appendChild(priceTypeSelect);

      const tdCompany = document.createElement('td');
      tdCompany.style.padding = '4px 5px';
      tdCompany.style.border = '1px solid #d0dce6';
      tdCompany.style.width = '80px';
      tdCompany.appendChild(companyInput);

      const tdVat = document.createElement('td');
      tdVat.style.padding = '4px 5px';
      tdVat.style.border = '1px solid #d0dce6';
      tdVat.style.width = '45px';
      tdVat.style.textAlign = 'center';
      tdVat.appendChild(vatRateSelect);

      const tdCategory = document.createElement('td');
      tdCategory.style.padding = '4px 5px';
      tdCategory.style.border = '1px solid #d0dce6';
      tdCategory.style.width = '110px';
      tdCategory.appendChild(categorySelect);

      const tdActions = document.createElement('td');
      tdActions.style.padding = '4px 5px';
      tdActions.style.border = '1px solid #d0dce6';
      tdActions.style.width = '55px';
      tdActions.style.textAlign = 'center';
      tdActions.appendChild(removeBtn);

      tr.appendChild(tdMat);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdPriceType);
      tr.appendChild(tdCompany);
      tr.appendChild(tdVat);
      tr.appendChild(tdCategory);
      tr.appendChild(tdActions);

      document.getElementById('articlesContainerBody').appendChild(tr);
      return tr;
    }

    function addArticleRowWithData(data) {
      const row = addArticleRow();
      const materialInput = row.querySelector('.article-material');
      const qtyInput = row.querySelector('.article-qty');
      const priceInput = row.querySelector('.article-price');
      const priceTypeSelect = row.querySelector('.article-pricetype');
      const companyInput = row.querySelector('.article-company');
      const vatSelect = row.querySelector('.article-vat');
      const categorySelect = row.querySelector('.article-category');
      const descInput = row.querySelector('.article-desc');
      
      if (data.materialId) {
        // Trova il materiale e imposta il nome nell'input
        const materials = loadFromLocalStorage();
        const material = materials.find(m => m.id === data.materialId);
        if (material) {
          materialInput.value = material.name + ' (' + material.category + ')';
          materialInput.setAttribute('data-material-id', data.materialId);
        }
      } else if (data.materialName) {
        materialInput.value = data.materialName;
      }
      
      if (data.quantity !== undefined) qtyInput.value = data.quantity;
      if (data.price !== undefined) priceInput.value = data.price;
      if (data.priceType) priceTypeSelect.value = data.priceType;
      if (data.company) companyInput.value = data.company;
      if (data.vatRate !== undefined) vatSelect.value = data.vatRate;
      if (data.category) categorySelect.value = data.category;
      if (data.description) descInput.value = data.description;
      return row;
    }

    // ===== PDF IMPORT FUNCTIONS =====
    const CATEGORY_OPTIONS = [
      'Strumentario','Consumabili Generici','Monouso','Disinfezione e Sterilizzazione','Chirurgia','Endodonzia',
      'Conservativa e Protesi','Frese e Lucidatura','Anestesia e Farmaci','Impronte e Laboratorio',
      'Radiografia e Fotografia','Profilassi e Igiene Orale','Ortodonzia'
    ];

    function openPdfImportModal() {
      const modal = document.getElementById('pdfImportModal');
      modal.classList.add('active');
      document.getElementById('pdfImportFile').value = '';
      document.getElementById('pdfImportRaw').value = '';
      document.getElementById('pdfImportTableBody').innerHTML = '';
      const distInput = document.getElementById('pdfImportDistributor');
      if (distInput) {
        const orderDist = document.getElementById('orderDistributor')?.value || '';
        const orderDistCustom = document.getElementById('orderDistributorCustom')?.value || '';
        distInput.value = orderDist === 'Other' ? orderDistCustom : orderDist;
      }
      renderMaterialDatalist();
      renderDistributorDatalist();
    }

    function closePdfImportModal() {
      const modal = document.getElementById('pdfImportModal');
      modal.classList.remove('active');
    }

    function getMaterialsForImport() {
      return loadFromLocalStorage();
    }

    function findMaterialMatch(name, materials) {
      const n = (name || '').toLowerCase().trim();
      let exact = materials.find(m => m.name && m.name.toLowerCase().trim() === n);
      if (exact) return exact.id;
      let partial = materials.find(m => n.includes(m.name.toLowerCase().trim()));
      return partial ? partial.id : '';
    }

    function renderMaterialDatalist() {
      const list = document.getElementById('materialNameList');
      if (!list) return;
      const materials = getMaterialsForImport();
      list.innerHTML = '';
      materials.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.name;
        list.appendChild(opt);
      });
    }

    function renderDistributorDatalist() {
      const list = document.getElementById('distributorNameList');
      if (!list) return;
      const materials = getMaterialsForImport();
      const distributors = Array.from(new Set(materials.map(m => m.distributor).filter(Boolean))).sort();
      list.innerHTML = '';
      distributors.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        list.appendChild(opt);
      });
    }

    function addImportRow(data = {}) {
      const tbody = document.getElementById('pdfImportTableBody');
      const tr = document.createElement('tr');
      const materials = getMaterialsForImport();

      const materialNameInput = document.createElement('input');
      materialNameInput.type = 'text';
      materialNameInput.className = 'pdf-import-name';
      materialNameInput.setAttribute('list', 'materialNameList');
      materialNameInput.value = data.name || '';

      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = '1';
      qtyInput.className = 'pdf-import-qty';
      qtyInput.value = data.quantity || '';

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = '0';
      priceInput.step = '0.01';
      priceInput.className = 'pdf-import-price';
      priceInput.value = data.price !== undefined ? data.price : '';

      const totalNetInput = document.createElement('input');
      totalNetInput.type = 'number';
      totalNetInput.min = '0';
      totalNetInput.step = '0.01';
      totalNetInput.className = 'pdf-import-total-net';
      totalNetInput.value = data.totalNet !== undefined ? data.totalNet : '';

      const ivaPercentInput = document.createElement('input');
      ivaPercentInput.type = 'number';
      ivaPercentInput.min = '0';
      ivaPercentInput.step = '0.01';
      ivaPercentInput.className = 'pdf-import-iva-percent';
      ivaPercentInput.value = data.ivaPercent !== undefined ? data.ivaPercent : '';

      const ivaAmountInput = document.createElement('input');
      ivaAmountInput.type = 'number';
      ivaAmountInput.step = '0.01';
      ivaAmountInput.className = 'pdf-import-iva-amount';
      ivaAmountInput.readOnly = true;

      const companyInput = document.createElement('input');
      companyInput.type = 'text';
      companyInput.className = 'pdf-import-company';
      companyInput.value = data.company || '';

      const categorySelect = document.createElement('select');
      categorySelect.innerHTML = '<option value="">-- Seleziona --</option>' + CATEGORY_OPTIONS.map(c => `<option value="${c}">${c}</option>`).join('');
      if (data.category) categorySelect.value = data.category;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'pdf-import-remove';
      removeBtn.textContent = 'Rimuovi';
      removeBtn.onclick = () => tr.remove();

      const cells = [materialNameInput, qtyInput, priceInput, totalNetInput, ivaPercentInput, ivaAmountInput, companyInput, categorySelect, removeBtn];
      cells.forEach(c => {
        const td = document.createElement('td');
        td.appendChild(c);
        tr.appendChild(td);
      });

      const updateIva = () => updateImportRowIva(tr);
      qtyInput.addEventListener('input', updateIva);
      priceInput.addEventListener('input', updateIva);
      totalNetInput.addEventListener('input', updateIva);
      ivaPercentInput.addEventListener('input', updateIva);
      updateIva();

      tbody.appendChild(tr);
    }

    async function handlePdfImportFile(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      if (!window.pdfjsLib) {
        alert('PDF.js non disponibile');
        return;
      }
      if (window.pdfjsLib.GlobalWorkerOptions && !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }

      const buffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: buffer }).promise;
      let fullText = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = await page.getTextContent();
        const pageText = text.items.map(it => it.str).join(' ');
        fullText += pageText + '\n';
      }

      document.getElementById('pdfImportRaw').value = fullText.trim();
      const items = extractPdfLineItems(fullText);
      document.getElementById('pdfImportTableBody').innerHTML = '';
      if (items.length === 0) {
        showAlert('Nessuna riga riconosciuta. Aggiungi righe manualmente.', 'warn');
        return;
      }
      renderMaterialDatalist();
      items.forEach(it => addImportRow(it));
    }

    function extractPdfLineItems(text) {
      const lower = text.toLowerCase();
      const isDentalLeader = lower.includes('dental leader') || lower.includes('codice articolo');
      if (isDentalLeader) return extractDentalLeaderItems(text);

      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const items = [];
      lines.forEach(line => {
        if (/totale|imponibile|iva|pagamento|trasporto/i.test(line)) return;
        const priceMatch = line.match(/(\d{1,6}[.,]\d{2})\s*â‚¬?/);
        const qtyMatch = line.match(/(?:^|\s)(\d{1,4})(?:\s*(?:pz|pcs|x|qt|qta|q\.t[aÃ ]))?/i);
        if (!priceMatch || !qtyMatch) return;
        const price = parseFloat(priceMatch[1].replace(',', '.'));
        const quantity = parseInt(qtyMatch[1], 10);
        let name = line.replace(priceMatch[0], ' ').replace(qtyMatch[0], ' ').replace(/â‚¬/g, ' ');
        name = name.replace(/\s{2,}/g, ' ').trim();
        if (name.length < 3) return;
        items.push({ name, quantity, price, category: '' });
      });
      return items;
    }

    function extractDentalLeaderItems(text) {
      const normalize = text.replace(/\s+/g, ' ').trim();
      const startIdx = normalize.toLowerCase().indexOf('codice articolo');
      const endIdx = normalize.toLowerCase().indexOf('totale (iva');
      const slice = normalize.slice(startIdx >= 0 ? startIdx : 0, endIdx > 0 ? endIdx : normalize.length);

      const withBreaks = slice
        .replace(/\s(Buono preparazione merce n\s*Â°\s*\d+)/gi, '\n$1')
        .replace(/\s(SDT)\s+/g, '\n$1 ')
        .replace(/(\s)([A-Z]{1,3}-\d{2,5})\s+/g, '\n$2 ')
        .replace(/(\s)(\d{1,3}-\d{3})\s+/g, '\n$2 ');

      const lines = withBreaks.split(/\n/).map(l => l.trim()).filter(Boolean);
      const items = [];

      const rowRegex = /^([A-Z]{1,3}-\d{2,5}|\d{1,3}-\d{3}|SDT)\s+(.+?)\s+(\d{1,4})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,2},\d{2})\s+(\d{1,6},\d{2})$/;
      const rowRegexNoCode = /^(.+?)\s+(\d{1,4})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,6},\d{2})\s+(\d{1,2},\d{2})\s+(\d{1,6},\d{2})$/;

      lines.forEach(line => {
        if (/buono preparazione merce|sconto merce|lotto n\.|contributo ambientale|modalit[aÃ ] di pagamento/i.test(line)) return;
        const clean = line
          .replace(/Lotto n\.[^\d]*scadenza\s*\d{2}\/\d{2}\/\d{4}/ig, '')
          .replace(/AIC\s*\d{6,}/ig, '')
          .replace(/\s{2,}/g, ' ')
          .trim();

        let match = clean.match(rowRegex);
        if (match) {
          const code = match[1];
          const description = match[2].replace(/\s{2,}/g, ' ').trim();
          const quantity = parseInt(match[3], 10);
          const unitNet = parseFloat(match[6].replace(',', '.'));
          const totalNet = parseFloat(match[7].replace(',', '.'));
          const ivaPercent = parseFloat(match[8].replace(',', '.'));
          if (!description || quantity <= 0) return;
          items.push({ name: `${code} ${description}`, quantity, price: unitNet, totalNet, ivaPercent, category: '' });
          return;
        }

        match = clean.match(rowRegexNoCode);
        if (!match) return;
        const description = match[1].replace(/\s{2,}/g, ' ').trim();
        const quantity = parseInt(match[2], 10);
        const unitNet = parseFloat(match[5].replace(',', '.'));
        const totalNet = parseFloat(match[6].replace(',', '.'));
        const ivaPercent = parseFloat(match[7].replace(',', '.'));
        if (!description || quantity <= 0) return;
        items.push({ name: description, quantity, price: unitNet, totalNet, ivaPercent, category: '' });
      });

      return items;
    }

    function applyPdfImportRows() {
      const rows = Array.from(document.querySelectorAll('#pdfImportTableBody tr'));
      if (rows.length === 0) {
        alert('Nessuna riga da importare');
        return;
      }
      let imported = 0;

      const materials = getMaterialsForImport();
      const orderDate = document.getElementById('orderDate')?.value || new Date().toISOString().split('T')[0];
      const orderDistributor = document.getElementById('orderDistributor')?.value || '';
      const orderDistributorCustom = document.getElementById('orderDistributorCustom')?.value || '';
      const importDistributor = document.getElementById('pdfImportDistributor')?.value || '';
      const finalDistributor = importDistributor || (orderDistributor === 'Other' ? orderDistributorCustom : orderDistributor);

      rows.forEach(row => {
        const materialName = row.querySelector('.pdf-import-name')?.value || '';
        const quantity = parseInt(row.querySelector('.pdf-import-qty')?.value, 10) || 0;
        const price = parseFloat(row.querySelector('.pdf-import-price')?.value) || 0;
        const category = row.querySelector('select')?.value || 'Consumabili Generici';
        const company = row.querySelector('.pdf-import-company')?.value || '';

        // Importa se c'Ã¨ almeno il nome, anche senza quantitÃ  (sarÃ  0)
        if (!materialName) {
          return;
        }

        let materialId = findMaterialMatch(materialName, materials);
        if (!materialId) {
          // Crea nuovo materiale anche senza categoria specifica
          materialId = createMaterialFromImport(materialName, category, orderDate, finalDistributor, company);
          if (materialId) {
            materials.push({ id: materialId, name: materialName, category });
            renderMaterialDatalist();
          }
        }

        // Importa sempre se c'Ã¨ un materialId (trovato o creato)
        if (materialId) {
          addArticleRowWithData({ 
            materialId, 
            materialName,
            quantity: quantity > 0 ? quantity : 1, 
            price, 
            priceType: 'totale',
            company, 
            category,
            vatRate: 22,
            description: '' 
          });
          imported += 1;
        }
      });

      if (imported === 0) {
        alert('Nessun materiale importato');
        return;
      }
      closePdfImportModal();
      showAlert(`âœ“ Importati ${imported} articoli`, 'info');
    }

    function updateImportRowIva(row) {
      const qty = parseFloat(row.querySelector('.pdf-import-qty')?.value) || 0;
      const price = parseFloat(row.querySelector('.pdf-import-price')?.value) || 0;
      const totalNet = parseFloat(row.querySelector('.pdf-import-total-net')?.value) || 0;
      const ivaPercent = parseFloat(row.querySelector('.pdf-import-iva-percent')?.value) || 0;
      const ivaAmountInput = row.querySelector('.pdf-import-iva-amount');
      const base = totalNet > 0 ? totalNet : (qty * price);
      const ivaAmount = base * (ivaPercent / 100);
      if (ivaAmountInput) ivaAmountInput.value = ivaAmount ? ivaAmount.toFixed(2) : '';
    }

    function createMaterialFromImport(name, category, orderDate, distributor, company) {
      const materials = loadFromLocalStorage();
      const materialId = window.crypto && window.crypto.randomUUID
        ? window.crypto.randomUUID()
        : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000));

      const newMaterial = {
        id: materialId,
        name: name,
        category: category,
        orderDate: new Date(orderDate).toISOString(),
        expiry: null,
        price: 0,
        quantity: 0,
        distributor: distributor,
        company: company || '',
        notifyDays: 30,
        lowStockThreshold: 2,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        batches: []
      };

      materials.push(newMaterial);
      localStorage.setItem('magazzino_materials', JSON.stringify(materials));

      if (firebaseReady && typeof db !== 'undefined') {
        db.collection('materials').doc(materialId).set(newMaterial).catch(err => {
          console.warn('Firebase unavailable:', err && err.message ? err.message : err);
        });
      }

      return materialId;
    }

    document.getElementById('orderForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();

      const orderDate = document.getElementById('orderDate').value;
      let distributor = document.getElementById('orderDistributor').value;
      if (distributor === 'Other') {
        distributor = document.getElementById('orderDistributorCustom').value.trim();
      }

      if (!orderDate || !distributor) {
        alert('Compila data ordine e distributore');
        return;
      }

      // Se il selector non trova le righe con #articlesContainer, usa #articlesContainerBody
      const articleRows = document.querySelectorAll('#articlesContainerBody .article-row');
      if (articleRows.length === 0) {
        alert('Nessun articolo da salvare');
        return;
      }
      
      const articles = [];
      articleRows.forEach(row => {
        const materialInputEl = row.querySelector('.article-material');
        const materialId = materialInputEl?.getAttribute('data-material-id') || '';
        const materialName = materialInputEl?.value || '';
        const quantity = parseInt(row.querySelector('.article-qty')?.value) || 0;
        const price = parseFloat(row.querySelector('.article-price')?.value) || 0;
        const priceType = row.querySelector('.article-pricetype')?.value || 'totale';
        const company = row.querySelector('.article-company')?.value || '';
        const vatRate = parseInt(row.querySelector('.article-vat')?.value) || 22;
        const category = row.querySelector('.article-category')?.value || 'Consumabili Generici';
        const description = row.querySelector('.article-desc')?.value || '';

        // Accetta sia materiali esistenti (con ID) che nuovi (solo nome)
        if ((materialId || materialName) && quantity > 0) {
          articles.push({ materialId, materialName, quantity, price, priceType, company, vatRate, category, description });
        }
      });

      if (articles.length === 0) {
        alert('Aggiungi almeno un articolo');
        return;
      }

      // Salva ordine e crea batch
      const materials = loadFromLocalStorage();
      const orderId = 'ord_' + Date.now();

      articles.forEach(article => {
        let materialId = article.materialId;
        
        // Se non c'Ã¨ materialId, crea un nuovo materiale
        if (!materialId && article.materialName) {
          // Estrai nome pulito (rimuovi eventuale parte " (Categoria)")
          let cleanName = article.materialName.trim();
          const matchCat = cleanName.match(/^(.+?)\s*\(([^)]+)\)$/);
          let category = article.category || 'Consumabili Generici';
          if (matchCat) {
            cleanName = matchCat[1].trim();
            category = matchCat[2].trim();
          }

          const existingByName = materials.find(m => (m.name || '').trim().toLowerCase() === cleanName.toLowerCase());
          if (existingByName) {
            materialId = existingByName.id;
          } else {
            // Crea nuovo materiale con tutti i dati dall'articolo
            materialId = window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000));
            const newMaterial = {
              id: materialId,
              name: cleanName,
              category: category,
              distributor: distributor,
              company: article.company || '',
              orderDate: new Date(orderDate),
              expiry: article.expiry ? new Date(article.expiry) : null,
              price: article.price || 0,
              vatRate: article.vatRate || 22,
              quantity: 0,
              batches: [],
              lowStockThreshold: article.lowStockThreshold || 2,
              notifyDays: 30,
              createdAt: new Date(),
              updatedAt: new Date()
            };
            materials.push(newMaterial);
          }
        }
        
        const matIdx = materials.findIndex(m => m.id === materialId);
        if (matIdx >= 0) {
          const material = materials[matIdx];
          if (!material.batches) material.batches = [];

          // Crea nuovo batch
          const batchId = 'batch_' + orderId.substring(0, 8) + '_' + materialId.substring(0, 8);
          const newBatch = {
            batchId: batchId,
            ordinoId: orderId,
            dataOrdine: orderDate,
            quantitÃ : article.quantity,
            quantitÃ Rimanente: article.quantity,
            prezzo: article.price,
            distributore: distributor,
            azienda: article.company || '',
            descrizione: article.description || '',
            scadenza: article.expiry
          };

          material.batches.push(newBatch);
          material.quantity = material.batches.reduce((sum, b) => sum + (b.quantitÃ Rimanente || 0), 0);
          material.expiry = recomputeMaterialExpiryFromBatches(material.batches);
          material.updatedAt = new Date().toISOString();
          materials[matIdx] = material;
        }
      });

      saveToLocalStorage(materials);
      showAlert(`âœ… Ordine ${orderId} salvato con ${articles.length} articoli`, 'info');
      closeOrderModal();
      loadMaterialsFromStorage();
    });

    // ===== CONSUMO MATERIALE FUNCTIONS (FEFO SYSTEM) =====
    let consumptionMaterialLookup = [];

    function normalizeConsumptionText(value){
      return String(value || '').toLowerCase().trim().replace(/\s+/g, ' ');
    }

    function syncConsumptionMaterialSelection(){
      const searchInput = document.getElementById('consumptionMaterialSearch');
      const hiddenInput = document.getElementById('consumptionMaterial');
      if (!searchInput || !hiddenInput) return '';

      const typed = normalizeConsumptionText(searchInput.value);
      if (!typed) {
        hiddenInput.value = '';
        return '';
      }

      const exact = consumptionMaterialLookup.find(item => item.normalizedName === typed || item.normalizedDisplay === typed);
      hiddenInput.value = exact ? exact.id : '';
      return hiddenInput.value;
    }

    function ensureMaterialHasBatches(material){
      if (!material || typeof material !== 'object') return false;
      let changed = false;
      if (!Array.isArray(material.batches)) {
        material.batches = [];
        changed = true;
      }
      const qty = Number(material.quantity || 0);
      if (material.batches.length === 0 && qty > 0) {
        material.batches.push({
          batchId: 'batch_restore_' + String(material.id || 'mat') + '_' + Date.now(),
          dataOrdine: material.orderDate || new Date().toISOString(),
          quantitÃ : qty,
          quantitÃ Rimanente: qty,
          prezzo: Number(material.price || 0),
          scadenza: material.expiry || null,
          distributore: material.distributor || '',
          azienda: material.company || ''
        });
        changed = true;
      }
      return changed;
    }
    
    function openConsumptionModal() {
      const modal = document.getElementById('consumptionModal');
      modal.classList.add('active');
      setTimeout(() => initConsumptionModal(), 100);
    }

    function closeConsumptionModal() {
      const modal = document.getElementById('consumptionModal');
      modal.classList.remove('active');
      document.getElementById('consumptionForm').reset();
      document.getElementById('consumptionMaterialSearch').value = '';
      document.getElementById('consumptionMaterial').value = '';
      const statusEl = document.getElementById('consumptionStatus');
      if(statusEl) statusEl.value = 'in_uso';
    }

    function initConsumptionModal() {
      const materials = loadFromLocalStorage();
      const datalist = document.getElementById('consumptionMaterialList');
      const searchInput = document.getElementById('consumptionMaterialSearch');
      const hiddenInput = document.getElementById('consumptionMaterial');
      datalist.innerHTML = '';
      searchInput.value = '';
      hiddenInput.value = '';
      consumptionMaterialLookup = [];
      let normalized = false;
      
      materials.forEach(m => {
        if (ensureMaterialHasBatches(m)) normalized = true;
      });
      if (normalized) {
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }

      materials
        .filter(m => Number(m.quantity || 0) > 0)
        .sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'it-IT'))
        .forEach(m => {
        const itemName = (m.name || '').trim();
        const batchesCount = Array.isArray(m.batches) ? m.batches.length : 0;
        const latestOrder = formatDate(m.orderDate || m.createdAt);
        const displayName = itemName + ' (' + (m.quantity || 0) + ' pz, ' + batchesCount + ' lotti, ultimo ordine ' + latestOrder + ')';
        consumptionMaterialLookup.push({
          id: m.id,
          name: itemName,
          display: displayName,
          normalizedName: normalizeConsumptionText(itemName),
          normalizedDisplay: normalizeConsumptionText(displayName)
        });

        const opt = document.createElement('option');
        opt.value = itemName;
        opt.label = (m.quantity || 0) + ' pz disponibili';
        datalist.appendChild(opt);
      });

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('consumptionDate').value = today;
      const statusEl = document.getElementById('consumptionStatus');
      if(statusEl) statusEl.value = 'in_uso';
      initConsumptionOperator();
    }

    function updateConsumptionPreview() {
      const materialId = syncConsumptionMaterialSelection();
      const quantity = parseInt(document.getElementById('consumptionQuantity').value) || 0;
      const searchValue = (document.getElementById('consumptionMaterialSearch').value || '').trim();
      const previewDiv = document.getElementById('consumptionPreviewContent');

      if (!materialId || quantity <= 0) {
        if (searchValue && !materialId) {
          previewDiv.innerHTML = 'Seleziona un materiale valido dai suggerimenti automatici.';
        } else {
          previewDiv.innerHTML = 'Inserisci materiale e quantitÃ  per visualizzare anteprima...';
        }
        return;
      }

      const materials = loadFromLocalStorage();
      const material = materials.find(m => m.id === materialId);
      if (!material) {
        previewDiv.innerHTML = 'Materiale non trovato';
        return;
      }

      // Ordina per scadenza piÃ¹ vicina (FEFO). Se manca scadenza, usa data ordine piÃ¹ vecchia.
      const batches = [...(material.batches || [])].sort((a, b) => {
        const aExpiry = a.scadenza ? new Date(a.scadenza).getTime() : Number.POSITIVE_INFINITY;
        const bExpiry = b.scadenza ? new Date(b.scadenza).getTime() : Number.POSITIVE_INFINITY;
        if (aExpiry !== bExpiry) return aExpiry - bExpiry;
        return new Date(a.dataOrdine || 0).getTime() - new Date(b.dataOrdine || 0).getTime();
      });
      
      if (batches.length === 0) {
        previewDiv.innerHTML = 'âš ï¸ Nessun lotto disponibile per questo materiale';
        return;
      }

      // Simula riduzione FEFO
      let remainingQty = quantity;
      let previewHtml = '';
      let found = false;

      for (let i = 0; i < batches.length && remainingQty > 0; i++) {
        const batch = batches[i];
        const batchRemaining = Number(batch.quantitÃ Rimanente ?? batch.quantitÃ  ?? 0) || 0;
        
        if (batchRemaining > 0) {
          found = true;
          const qtyFromBatch = Math.min(remainingQty, batchRemaining);
          const qtyAfter = batchRemaining - qtyFromBatch;
          const batchLabel = getLotDisplayLabel(batch, i);
          
          previewHtml += `
            <div class="consumption-preview-line">
              <span>ğŸ“¦ <strong>${batchLabel}</strong> (Ordine: ${formatDate(batch.dataOrdine)})</span>
            </div>
            <div class="consumption-preview-line">
              <span style="margin-left:20px">Scadenza: ${formatDate(batch.scadenza)}</span>
            </div>
            <div class="consumption-preview-line">
              <span style="margin-left:20px">Riducibile: <strong>${qtyFromBatch} pz</strong></span>
              <strong style="color:#d32f2f">${batchRemaining} â†’ ${qtyAfter} pz</strong>
            </div>
          `;
          
          remainingQty -= qtyFromBatch;
        }
      }

      if (!found) {
        previewHtml = 'âš ï¸ Materiale esaurito';
      } else if (remainingQty > 0) {
        previewHtml += `<div class="consumption-preview-line" style="color:#d32f2f"><strong>âš ï¸ QuantitÃ  insufficiente: mancano ${remainingQty} pz</strong></div>`;
      }

      previewDiv.innerHTML = previewHtml;
    }

    document.getElementById('consumptionForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const materialId = syncConsumptionMaterialSelection();
      const quantity = parseInt(document.getElementById('consumptionQuantity').value);
      const consumptionDate = document.getElementById('consumptionDate').value;
      const operator = String(document.getElementById('consumptionOperator').value || '').trim();
      const movementStatus = (document.getElementById('consumptionStatus') || {}).value === 'consumato' ? 'consumato' : 'in_uso';

      if (!materialId || !quantity || quantity <= 0 || !operator) {
        alert('Compila tutti i campi, operatore incluso, e seleziona un materiale valido');
        return;
      }

      const materials = loadFromLocalStorage();
      const materialIdx = materials.findIndex(m => m.id === materialId);
      if (materialIdx < 0) {
        alert('Materiale non trovato');
        return;
      }

      const material = materials[materialIdx];
      let batches = [...(material.batches || [])].sort((a, b) => {
        const aExpiry = a.scadenza ? new Date(a.scadenza).getTime() : Number.POSITIVE_INFINITY;
        const bExpiry = b.scadenza ? new Date(b.scadenza).getTime() : Number.POSITIVE_INFINITY;
        if (aExpiry !== bExpiry) return aExpiry - bExpiry;
        return new Date(a.dataOrdine || 0).getTime() - new Date(b.dataOrdine || 0).getTime();
      });
      
      // Sistema FEFO: riduce prima dai batch con scadenza piÃ¹ vicina
      let remainingQty = quantity;
      let consumed = [];
      let totalQtyBefore = 0;
      let totalQtyAfter = 0;

      for (let i = 0; i < batches.length && remainingQty > 0; i++) {
        const batchRemaining = Number(batches[i].quantitÃ Rimanente ?? batches[i].quantitÃ  ?? 0) || 0;
        if (batchRemaining > 0) {
          totalQtyBefore += batchRemaining;
          const qtyFromBatch = Math.min(remainingQty, batchRemaining);
          batches[i].quantitÃ Rimanente = batchRemaining - qtyFromBatch;
          totalQtyAfter += batches[i].quantitÃ Rimanente;
          consumed.push({batchId: batches[i].batchId, dataOrdine: batches[i].dataOrdine, quantitÃ : qtyFromBatch});
          batches[i].consumptions = Array.isArray(batches[i].consumptions) ? batches[i].consumptions : [];
          batches[i].consumptions.push({
            data: consumptionDate,
            quantitÃ : qtyFromBatch,
            operatore: operator,
            timestamp: new Date().toISOString()
          });
          remainingQty -= qtyFromBatch;
        }
      }

      if (remainingQty > 0) {
        alert('QuantitÃ  insufficiente nel magazzino');
        return;
      }

      // Aggiorna batch e storico consumi
      material.batches = batches;
      material.quantity = material.batches.reduce((sum, b) => sum + (Number(b.quantitÃ Rimanente || 0) || 0), 0);
      material.expiry = recomputeMaterialExpiryFromBatches(material.batches);
      material.consumptionHistory = material.consumptionHistory || [];
      const usageId = 'use_' + String(material.id || 'mat') + '_' + Date.now();
      material.consumptionHistory.push({
        usageId,
        data: consumptionDate,
        quantitÃ : quantity,
        operatore: operator,
        status: movementStatus,
        batchesConsumed: consumed,
        timestamp: new Date().toISOString()
      });

      materials[materialIdx] = material;
      saveToLocalStorage(materials);
      saveOperator(operator);

      if(firebaseReady && typeof db !== 'undefined'){
        const cloudPayload = {
          batches: material.batches,
          quantity: material.quantity,
          expiry: material.expiry,
          consumptionHistory: material.consumptionHistory,
          updatedAt: new Date().toISOString()
        };
        db.collection('materials').doc(material.id).set(cloudPayload, { merge: true }).catch(err => {
          console.warn('Firebase sync consumo non riuscita:', err && err.message ? err.message : err);
        });
      }

      // Mostra notifica di conferma
      const batchInfo = consumed.map((c, idx) => `${c.quantitÃ } pz da ${getLotDisplayLabel(c, idx)}`).join(', ');
      const statusLabel = getConsumptionStatusLabel(movementStatus);
      showAlert(`âœ… ${operator} ha registrato "${statusLabel}" (${quantity} pz) da: ${batchInfo}`, 'info');
      
      closeConsumptionModal();
      updateActiveUsageData();
      updateOutgoingRegisterData();
      loadMaterialsFromStorage(); // Ricarica tabella
    });

  </script>
</body>
</html>
