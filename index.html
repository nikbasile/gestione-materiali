<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Odontoiatrico Basile Ciccarone - Magazzino Materiali</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f5f8fb;color:#2c3e50;line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    h1{color:#003d7a;margin-bottom:8px;font-size:28px;font-weight:600}
    .subtitle{color:#7f8c8d;margin-bottom:24px;font-size:14px}
    #alerts{margin-bottom:20px}
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:8px;font-size:14px;border-left:4px solid}
    .alert.info{background:#e6f0ff;border-color:#0066cc;color:#003d7a}
    .alert.warn{background:#fff3e6;border-color:#ff9800;color:#e65100}
    
    form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-size:12px;font-weight:600;color:#003d7a;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
    input,select{padding:10px 12px;font-size:14px;border:1px solid #d0dce6;border-radius:6px;background:#fff;color:#2c3e50;transition:border-color 0.2s}
    input:focus,select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s}
    form button{background:#0066cc;color:#fff}
    form button:hover{background:#0052a3}
    
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    thead{background:#003d7a;color:#fff}
    th{padding:14px 12px;text-align:left;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-bottom:1px solid #e8ecf1;font-size:14px;vertical-align:middle}
    tbody tr:hover{background:#f9fbfd}
    
    .badge{display:inline-block;padding:6px 10px;border-radius:6px;color:#fff;font-weight:600;font-size:12px}
    .expired{background:#d32f2f}
    .soon{background:#f57c00}
    .ok{background:#388e3c}
    .low{background:#d32f2f}
    
    .btn-action{width:32px;height:32px;padding:0;font-size:18px;font-weight:bold;border:2px solid;border-radius:6px;cursor:pointer;transition:all 0.15s;margin:0 2px;display:inline-flex;align-items:center;justify-content:center;}
    .btn-inc{background:#e8f5e9;color:#2e7d32;border-color:#2e7d32;}
    .btn-inc:hover{background:#2e7d32;color:#fff;}
    .btn-dec{background:#fff3e0;color:#ef6c00;border-color:#ef6c00;}
    .btn-dec:hover{background:#ef6c00;color:#fff;}
    .btn-del{background:#ffebee;color:#c62828;border-color:#c62828;}
    .btn-del:hover{background:#c62828;color:#fff;}
    
    .action-buttons{display:flex;gap:10px;margin-bottom:20px;justify-content:flex-end}
    .action-buttons button{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff}
    .action-buttons button:hover{background:#0052a3}
    .action-buttons button.export{background:#388e3c}
    .action-buttons button.export:hover{background:#2e7d32}
    
    .action-menu-btn{padding:10px 16px;font-size:14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;background:#0066cc;color:#fff}
    .action-menu-btn:hover{background:#0052a3}
    .action-menu{position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;min-width:250px}
    .action-menu button.menu-item{width:100%;padding:12px 16px;border:none;background:none;color:#2c3e50;text-align:left;cursor:pointer;font-size:14px;transition:background 0.2s;display:flex;align-items:center;gap:8px;font-family:inherit}
    .action-menu button.menu-item:hover{background:#f5f5f5}
    
    #loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    #loginScreen.hidden{display:none}
    .login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);text-align:center;max-width:320px}
    .login-box h2{color:#003d7a;margin-bottom:24px;font-size:24px}
    .login-box input{width:100%;padding:12px;margin-bottom:16px;border:1px solid #d0dce6;border-radius:6px;font-size:14px}
    .login-box input:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,0.1)}
    .login-box button{width:100%;padding:12px;background:#0066cc;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s}
    .login-box button:hover{background:#0052a3}
    .login-error{color:#d32f2f;font-size:13px;margin-bottom:12px}
    
    .category-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .category-btn{padding:12px 16px;border:2px solid #d0dce6;border-radius:8px;background:#fff;color:#2c3e50;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s;text-align:center}
    .category-btn:hover{border-color:#0066cc;color:#0066cc}
    .category-btn.active{background:#0066cc;color:#fff;border-color:#0066cc}
    
    .header-wrapper{display:flex;align-items:center;gap:16px;margin-bottom:24px}
    .logo-circle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#003d7a 0%,#0066cc 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,61,122,0.25)}
    .header-content h1{margin:0;padding:0;font-size:32px}
    .header-content .studio-name{font-size:14px;color:#7f8c8d;font-weight:400}
    .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .filters-row{margin-bottom:12px;display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .filter-label{font-weight:600;color:#003d7a;font-size:14px;margin-right:8px}
    .filter-select{padding:8px 12px;font-size:14px;border-radius:6px;border:1px solid #d0dce6;min-width:180px}
    .header-content{min-width:0}
    
    .implants-btn{background:#ff6b35;margin-left:10px}
    .implants-btn:hover{background:#e55a2b}
    #implantsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;overflow-y:auto}
    #implantsModal.active{display:flex;align-items:flex-start;justify-content:center;padding:20px}
    .modal-content{background:#fff;border-radius:12px;max-width:900px;width:100%;margin:20px auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .modal-header{background:#003d7a;color:#fff;padding:20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:22px}
    .modal-close{background:transparent;color:#fff;border:2px solid #fff;width:36px;height:36px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .modal-close:hover{background:#fff;color:#003d7a}
    .modal-body{padding:24px}

    @media (max-width:900px){
      .container{padding:16px}
      .header-content h1{font-size:24px;line-height:1.2}
      .action-buttons{justify-content:stretch}
      .action-buttons button{width:100%}
      .filters-row{gap:12px}
      .filters-row > div{flex:1 1 220px}
    }

    @media (max-width:700px){
      body{font-size:14px}
      .container{padding:12px}
      .header-wrapper{align-items:flex-start;gap:12px}
      .logo-circle{width:48px;height:48px;font-size:18px}
      .header-content h1{font-size:20px}
      .header-content .studio-name{font-size:13px}
      .subtitle{font-size:13px}
      form{grid-template-columns:1fr;padding:14px;gap:10px}
      .category-filters{grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
      .category-btn{padding:10px 8px;font-size:13px}
      .action-buttons{margin-bottom:14px}
      .action-buttons button{font-size:13px;padding:10px 12px}
      .filters-row{display:grid;grid-template-columns:1fr;gap:10px}
      .filters-row > div{min-width:0}
      .filter-label{display:block;margin-right:0;margin-bottom:6px;font-size:13px}
      .filter-select{display:block;width:100%;min-width:0;font-size:13px;padding:9px 10px}

      table{border:none;box-shadow:none;background:transparent}
      thead{display:none}
      tbody{display:block}
      tbody tr{display:block;background:#fff;border:1px solid #e8ecf1;border-radius:8px;margin-bottom:10px;padding:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
      td{display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:1px solid #eef2f6;padding:9px 8px;font-size:13px;text-align:right}
      td::before{content:attr(data-label);font-weight:600;color:#003d7a;text-align:left}
      td:last-child{border-bottom:none}
      td[data-label="Azioni"]{justify-content:flex-end}
      td[data-label="Azioni"]::before{margin-right:auto}
      .btn-action{width:34px;height:34px}
    }

    @media (max-width:420px){
      .category-filters{grid-template-columns:1fr}
    }

    @media (max-width:360px){
      .container{padding:10px}
      .header-wrapper{gap:10px}
      .logo-circle{width:42px;height:42px;font-size:16px}
      .header-content h1{font-size:18px}
      .header-content .studio-name{font-size:12px}
      form{padding:12px}
      .category-btn{font-size:12px;padding:9px 8px}
      .filter-label{font-size:12px}
      .filter-select{font-size:12px;padding:8px 9px}
      .alert{padding:10px 12px;font-size:13px}
    }
  </style>
</head>
<body>
  <!-- Login disabilitato temporaneamente -->
  <div style="display:none"></div>

  <div class="container" id="mainContent" style="display:block">
    <div class="header-wrapper">
      <div class="logo-circle">BC</div>
      <div class="header-content">
        <h1>Studio Odontoiatrico Basile Ciccarone</h1>
        <p class="studio-name">Gestione Magazzino Materiali di Consumo</p>
      </div>
    </div>
    <div id="alerts"></div>
    <div class="alert info" style="margin-bottom:18px;">
      <strong>Nota sulle notifiche:</strong> Riceverai un avviso automatico quando:
      <ul style="margin:8px 0 0 18px; font-size:13px; color:#003d7a;">
        <li>Un materiale √® scaduto o sta per scadere tra 30 giorni</li>
        <li>La quantit√† del materiale raggiunge il valore soglia impostato</li>
      </ul>
      Le notifiche compaiono in alto nella pagina ogni volta che si verifica una di queste condizioni.
    </div>

    <form id="addForm">
      <div class="form-group"><label>Nome materiale</label><input id="name" placeholder="Es. Cemento composito" required /></div>
      <div class="form-group"><label>üìÖ Data Ordine</label><input id="orderDate" type="date" required /></div>
      <div class="form-group"><label>‚è∞ Data Scadenza</label><input id="expiry" type="date" required /></div>
      <div class="form-group"><label>Prezzo (‚Ç¨)</label><input id="price" type="number" step="0.01" placeholder="0.00" /></div>
      <div class="form-group"><label>Quantit√†</label><input id="quantity" type="number" min="0" value="1" required /></div>
      <div class="form-group"><label>üóÇÔ∏è Categoria</label><select id="category" required><option value="">-- Seleziona --</option><option value="Strumentario">Strumentario</option><option value="Consumabili Generici">Consumabili Generici</option><option value="Monouso">Monouso</option><option value="Disinfezione e Sterilizzazione">Disinfezione e Sterilizzazione</option><option value="Implantologia e Chirurgia">Implantologia e Chirurgia</option><option value="Endodonzia">Endodonzia</option><option value="Conservativa e Protesi">Conservativa e Protesi</option><option value="Frese e Lucidatura">Frese e Lucidatura</option><option value="Anestesia e Farmaci">Anestesia e Farmaci</option><option value="Impronte e Laboratorio">Impronte e Laboratorio</option><option value="Radiografia e Fotografia">Radiografia e Fotografia</option><option value="Profilassi e Igiene Orale">Profilassi e Igiene Orale</option><option value="Ortodonzia">Ortodonzia</option></select></div>

      <div class="form-group"><label>üöö Distributore</label>
        <select id="distributorSelect" required>
          <option value="">-- Seleziona --</option>
          <option value="Dental Leader">Dental Leader</option>
          <option value="Gher√≤">Gher√≤</option>
          <option value="Revello">Revello</option>
          <option value="Dentitalia">Dentitalia</option>
          <option value="Dental Trey">Dental Trey</option>
          <option value="Umbra">Umbra</option>
          <option value="Eli Dent">Eli Dent</option>
          <option value="Non disponibile">Non disponibile</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="distributor" placeholder="Distributore personalizzato" style="display:none;margin-top:6px" />
      </div>
      <div class="form-group"><label>üè¢ Azienda</label>
        <select id="companySelect">
          <option value="">-- Seleziona --</option>
          <option value="3M">3M</option>
          <option value="Ivoclar">Ivoclar</option>
          <option value="GC">GC</option>
          <option value="Dentsply Sirona">Dentsply Sirona</option>
          <option value="Coltene">Coltene</option>
          <option value="Kerr">Kerr</option>
          <option value="Voco">Voco</option>
          <option value="Septodont">Septodont</option>
          <option value="Zhermack">Zhermack</option>
          <option value="DMG">DMG</option>
          <option value="VOCO">VOCO</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="company" placeholder="Azienda personalizzata" style="display:none;margin-top:6px" />
      </div>
      <div class="form-group"><label>Soglia quantit√† bassa</label>
        <select id="lowStockThreshold">
          <option value="1">1</option>
          <option value="2">2 (default)</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="Other">Altro...</option>
        </select>
        <input id="lowStockThresholdCustom" type="number" min="1" step="1" placeholder="Personalizzato" style="display:none;margin-top:6px" />
      </div>
      <button type="submit" style="grid-column:span 1;align-self:flex-end">Aggiungi materiale</button>
    </form>
    
    <div id="categoryFilters" class="category-filters"></div>

    <!-- Pulsanti Principali -->
    <div class="action-dropdown-container" style="margin:20px 0;display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:space-between">
      <!-- Pulsante Magazzino Implantare con grafica distintiva -->
      <button id="implantsBtn" class="implants-btn-main" onclick="openImplantsModal()" style="background:linear-gradient(135deg,#2E7D32 0%,#1B5E20 100%);color:#fff;padding:12px 20px;font-size:15px;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(27,94,32,0.35);transition:all 0.2s;display:flex;align-items:center;gap:6px">
        üî© Magazzino Implantare
      </button>

      <div style="display:flex;gap:12px;align-items:center;margin-left:auto;flex-wrap:wrap">
        <!-- Pulsante Scarica Dati Materiali -->
        <div style="position:relative">
          <button class="action-menu-btn" onclick="toggleActionMenu('downloadMenu')">üì• Scarica Dati ‚ñº</button>
          <div id="downloadMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;left:0">
            <button class="menu-item" onclick="downloadMaterialsPDF()">üìÑ PDF Materiali</button>
            <button class="menu-item" onclick="exportMaterialsCSV()">üìä CSV Materiali</button>
          </div>
        </div>

        <!-- Pulsante Backup -->
        <div style="position:relative">
          <button class="action-menu-btn" onclick="toggleActionMenu('backupMenu')">üíæ Backup ‚ñº</button>
          <div id="backupMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;right:0;left:auto">
            <button class="menu-item" onclick="exportBackup()">üì• Esporta Backup Completo</button>
            <button class="menu-item" onclick="document.getElementById('importFile').click()">üì§ Importa Backup</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)" />
          </div>
        </div>
      </div>
    </div>

    <div class="filters-row">
            <div>
              <label for="expiryFilterSelect" class="filter-label">Filtra per scadenza:</label>
              <select id="expiryFilterSelect" class="filter-select">
                <option value="Tutte">Tutte</option>
                <option value="Rosso">Rosso (entro 3 mesi)</option>
                <option value="Giallo">Giallo (entro 6 mesi)</option>
                <option value="Verde">Verde (oltre 6 mesi)</option>
              </select>
            </div>
            <div>
              <label for="quantityFilterSelect" class="filter-label">Filtra per quantit√†:</label>
              <select id="quantityFilterSelect" class="filter-select">
                <option value="Tutte">Tutte</option>
                <option value="Rosso">Rosso (sotto soglia)</option>
                <option value="Giallo">Giallo (uguale soglia)</option>
                <option value="Verde">Verde (sopra soglia)</option>
              </select>
            </div>
      <div>
        <label for="companyFilterSelect" class="filter-label">Filtra per azienda:</label>
        <select id="companyFilterSelect" class="filter-select">
          <option value="Tutte">Tutte</option>
        </select>
      </div>
      <div>
        <label for="distributorFilterSelect" class="filter-label">Filtra per distributore:</label>
        <select id="distributorFilterSelect" class="filter-select">
          <option value="Tutti">Tutti</option>
        </select>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nome</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th>Prezzo</th><th>Distributore</th><th>Azienda</th><th style="text-align:center;">Quantit√†</th><th>Azioni</th></tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

  </div>

  <!-- Modal Magazzino Implantare -->
  <div id="implantsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üî© Magazzino Implantare</h2>
        <button class="modal-close" onclick="closeImplantsModal()">√ó</button>
      </div>
      <div class="modal-body">
      
      <form id="implantForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:24px;background:#f5f5f5;border-radius:8px;margin-bottom:24px">
        <div class="form-group">
          <label>Tipo</label>
          <select id="implantType" required>
            <option value="">-- Seleziona --</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Azienda</label>
          <select id="implantCompany" required>
            <option value="">-- Seleziona --</option>
            <option value="Straumann">Straumann</option>
            <option value="Nobel Biocare">Nobel Biocare</option>
            <option value="Zimmer Biomet">Zimmer Biomet</option>
            <option value="Dentsply Sirona">Dentsply Sirona</option>
            <option value="Osstem">Osstem</option>
            <option value="Biomet 3i">Biomet 3i</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantCompanyCustom" placeholder="Azienda personalizzata" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantModelGroup">
          <label>Modello / Nomenclatura</label>
          <select id="implantModel">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantModelCustom" placeholder="Scrivi modello/nomenclatura (es. BLX, NC, RC)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantKitComponentsGroup" style="display:none">
          <label>Componenti Kit</label>
          <select id="implantKitComponents">
            <option value="">-- Seleziona o scrivi sotto --</option>
          </select>
          <input id="implantKitComponentsCustom" placeholder="Scrivi componente (es. Frese chirurgiche, Maschiatore, ecc.)" style="margin-top:6px" />
        </div>
        <div class="form-group" id="implantDiameterGroup">
          <label>Diametro (mm)</label>
          <select id="implantDiameter">
            <option value="">-- Seleziona --</option>
            <option value="2.9">2.9 mm</option>
            <option value="3.3">3.3 mm</option>
            <option value="3.5">3.5 mm</option>
            <option value="4.0">4.0 mm</option>
            <option value="4.1">4.1 mm</option>
            <option value="4.5">4.5 mm</option>
            <option value="4.8">4.8 mm</option>
            <option value="5.0">5.0 mm</option>
            <option value="6.0">6.0 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantDiameterCustom" type="number" step="0.1" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group" id="implantLengthGroup">
          <label>Lunghezza (mm)</label>
          <select id="implantLength">
            <option value="">-- Seleziona --</option>
            <option value="6">6 mm</option>
            <option value="8">8 mm</option>
            <option value="10">10 mm</option>
            <option value="12">12 mm</option>
            <option value="14">14 mm</option>
            <option value="16">16 mm</option>
            <option value="18">18 mm</option>
            <option value="Other">Altro...</option>
          </select>
          <input id="implantLengthCustom" type="number" step="0.5" placeholder="Personalizzato" style="display:none;margin-top:6px" />
        </div>
        <div class="form-group">
          <label>üìÖ Data Ordine</label>
          <input id="implantOrderDate" type="date" required />
        </div>
        <div class="form-group">
          <label>‚è∞ Data Scadenza</label>
          <input id="implantExpiry" type="date" />
        </div>
        <div class="form-group">
          <label>Prezzo (‚Ç¨)</label>
          <input id="implantPrice" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div class="form-group">
          <label>Quantit√†</label>
          <input id="implantQuantity" type="number" min="0" value="1" required />
        </div>
        <button type="submit" style="grid-column:span 1;align-self:flex-end">Aggiungi impianto</button>
      </form>

      <h3 style="margin:24px 0 12px;color:#003d7a;font-size:18px">üìã Inventario Impianti</h3>
      
      <!-- Dropdown Scarica Dati Impianti -->
      <div style="margin:16px 0;display:flex;gap:10px;align-items:center;position:relative">
        <button class="action-menu-btn" onclick="toggleActionMenu('implantsMenu')">üì• Scarica Dati ‚ñº</button>
        <div id="implantsMenu" class="action-menu" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:100;min-width:250px;top:40px;left:0">
          <button class="menu-item" onclick="downloadImplantsPDF()">üìÑ Scarica PDF Impianti</button>
          <button class="menu-item" onclick="exportImplantsCSV()">üìä Scarica CSV Impianti</button>
        </div>
      </div>
      
      <!-- Filtri Impianti -->
      <div class="filters-row" style="margin-bottom:16px;display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <label for="implantTypeFilter" class="filter-label">Filtra per tipo:</label>
          <select id="implantTypeFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
            <option value="Impianto">Impianto</option>
            <option value="Vite tappo">Vite tappo</option>
            <option value="Vite di guarigione">Vite di guarigione</option>
            <option value="Kit chirurgico">Kit chirurgico</option>
            <option value="Cacciavite">Cacciavite</option>
            <option value="Cricchetto">Cricchetto</option>
            <option value="Componenti protesiche">Componenti protesiche</option>
            <option value="Altro">Altro</option>
          </select>
        </div>
        <div>
          <label for="implantCompanyFilter" class="filter-label">Filtra per azienda:</label>
          <select id="implantCompanyFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
          </select>
        </div>
        <div>
          <label for="implantModelFilter" id="implantModelFilterLabel" class="filter-label">Filtra per modello:</label>
          <select id="implantModelFilter" class="filter-select">
            <option value="Tutti">Tutti</option>
          </select>
        </div>
        <div>
          <label for="implantExpiryFilter" class="filter-label">Filtra per scadenza:</label>
          <select id="implantExpiryFilter" class="filter-select">
            <option value="Tutte">Tutte</option>
            <option value="Scaduti">Scaduti</option>
            <option value="< 3 mesi">< 3 mesi</option>
            <option value="< 6 mesi">< 6 mesi</option>
            <option value="> 6 mesi">> 6 mesi</option>
          </select>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Tipo</th><th>Azienda</th><th>Modello</th><th>√ò</th><th>L</th><th>Data ordine</th><th style="text-align:center;">Scadenza</th><th>Prezzo</th><th style="text-align:center;">Quantit√†</th><th>Azioni</th></tr>
          </thead>
          <tbody id="implantsList"></tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZeB8P2osUIN2YHa5qg4eAZdRH8js2cW0",
      authDomain: "gestione-materiali-di-consumo.firebaseapp.com",
      projectId: "gestione-materiali-di-consumo",
      storageBucket: "gestione-materiali-di-consumo.firebasestorage.app",
      messagingSenderId: "831456435798",
      appId: "1:831456435798:web:af967c6986c06dde8d65f7",
      measurementId: "G-CEGE8B5LGZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const APP_VERSION = '2026-02-20-fix-local-first-3';
    console.log('App version:', APP_VERSION);
    let firebaseReady = true;
    if (db && typeof db.enablePersistence === 'function') {
      db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        console.warn('Persistenza offline Firebase non attiva:', err && err.message ? err.message : err);
      });
    }

    // Login anonimo automatico
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously().catch(err => {
          console.warn('Errore login anonimo:', err.message);
        });
      } else {
        console.log('Login anonimo riuscito:', user.uid);
      }
    });

    const addForm = document.getElementById('addForm');
    const listEl = document.getElementById('list');
    const alertsEl = document.getElementById('alerts');
    const categoryFiltersEl = document.getElementById('categoryFilters');
    const companyFilterSelect = document.getElementById('companyFilterSelect');
    const distributorFilterSelect = document.getElementById('distributorFilterSelect');

    const CATEGORIES = ['Tutti', 'Strumentario', 'Consumabili Generici', 'Monouso', 'Disinfezione e Sterilizzazione', 'Implantologia e Chirurgia', 'Endodonzia', 'Conservativa e Protesi', 'Frese e Lucidatura', 'Anestesia e Farmaci', 'Impronte e Laboratorio', 'Radiografia e Fotografia', 'Profilassi e Igiene Orale', 'Ortodonzia'];
    const COMPANY_OPTIONS = ['3M', 'Ivoclar', 'GC', 'Dentsply Sirona', 'Coltene', 'Kerr', 'Voco', 'Septodont', 'Zhermack', 'DMG', 'VOCO', 'Other'];
    const DISTRIBUTOR_OPTIONS = ['Dental Leader', 'Gher√≤', 'Revello', 'Dentitalia', 'Dental Trey', 'Umbra', 'Eli Dent', 'Non disponibile', 'Other'];
    let currentFilter = 'Tutti';
    let currentCompanyFilter = 'Tutte';
    let currentDistributorFilter = 'Tutti';
    let currentExpiryFilter = 'Tutte';
    let currentQuantityFilter = 'Tutte';
    let allDocs = []; // store all docs for filtering

    let notified = new Map(); // track notifications per doc

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveToLocalStorage(docs){
      // Se docs non √® un array o vuoto, niente da salvare
      if (!Array.isArray(docs) || docs.length === 0) return;
      // Estrai dati dai doc Firestore
      const fbData = docs[0] && typeof docs[0].data === 'function'
        ? docs.map(doc=>{
            const d = doc.data();
            const order = d.orderDate && d.orderDate.toDate ? d.orderDate.toDate().toISOString() : (d.orderDate ? new Date(d.orderDate).toISOString() : null);
            const exp = d.expiry && d.expiry.toDate ? d.expiry.toDate().toISOString() : (d.expiry ? new Date(d.expiry).toISOString() : null);
            const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt ? new Date(d.createdAt).toISOString() : null);
            return {id: doc.id, ...d, orderDate: order, expiry: exp, createdAt: created};
          })
        : docs;
      // Carica materiali esistenti in localStorage e unisci (Firebase ha priorit√†, localStorage √® solo backup offline)
      try {
        const existing = loadFromLocalStorage();
        const map = new Map();
        // Prima aggiungi i dati locali
        existing.forEach(it => map.set(it.id, it));
        // Poi sovrascrivi con i dati di Firebase (priorit√† a Firebase)
        fbData.forEach(it => {
          map.set(it.id, it);
        });
        const merged = Array.from(map.values());
        localStorage.setItem('magazzino_materials', JSON.stringify(merged));
      } catch (e) {
        // fallback semplice
        localStorage.setItem('magazzino_materials', JSON.stringify(fbData));
      }
    }

    function loadFromLocalStorage(){
      const saved = localStorage.getItem('magazzino_materials');
      return saved ? JSON.parse(saved) : [];
    }

    function addToLocalStorage(item){
      const materials = loadFromLocalStorage();
      const newItem = {...item, id: item.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_local_'+Date.now())};
      // Convert dates to ISO strings for JSON serialization
      if(newItem.orderDate instanceof Date) newItem.orderDate = newItem.orderDate.toISOString();
      if(newItem.expiry instanceof Date) newItem.expiry = newItem.expiry.toISOString();
      if(newItem.createdAt instanceof Date) newItem.createdAt = newItem.createdAt.toISOString();
      const idx = materials.findIndex(m => m.id === newItem.id);
      if (idx >= 0) {
        materials[idx] = {...materials[idx], ...newItem};
      } else {
        materials.push(newItem);
      }
      localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      return newItem.id;
    }

    function deleteFromLocalStorage(id){
      const materials = loadFromLocalStorage();
      const filtered = materials.filter(m=>m.id !== id);
      localStorage.setItem('magazzino_materials', JSON.stringify(filtered));
    }

    function updateQuantityLocalStorage(id, delta){
      const materials = loadFromLocalStorage();
      const item = materials.find(m=>m.id === id);
      if(item){
        item.quantity = (item.quantity || 0) + delta;
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }
    }

    async function updateMaterialFields(id, fields){
      const updatedFields = { ...fields, updatedAt: new Date().toISOString() };
      const materials = loadFromLocalStorage();
      const item = materials.find(m => m.id === id);
      if(item){
        Object.assign(item, updatedFields);
        localStorage.setItem('magazzino_materials', JSON.stringify(materials));
      }

      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(id).set(updatedFields, { merge: true });
        } catch(err) {
          console.warn('Firebase update non riuscito:', err && err.message ? err.message : err);
          showAlert('Modifica salvata in locale. Firebase non raggiungibile.', 'warn');
        }
      }

      loadMaterialsFromStorage();
    }

    function promptSelectOrCustom(title, options, currentValue){
      const printable = options
        .filter(opt => opt && opt !== 'Other')
        .map(opt => '- ' + opt)
        .join('\n');
      const message = title + '\n' + printable + '\nScrivi un valore personalizzato:';
      const selected = prompt(message, currentValue || '');
      if(selected === null) return null;
      return selected.trim();
    }

    // --- IMPLANTS MANAGEMENT ---
    let currentImplantTypeFilter = 'Tutti';
    let currentImplantCompanyFilter = 'Tutte';
    let currentImplantModelFilter = 'Tutti';
    let currentImplantExpiryFilter = 'Tutte';

    function loadImplantsFromStorage(){
      const saved = localStorage.getItem('magazzino_implants');
      return saved ? JSON.parse(saved) : [];
    }

    function saveImplantsToStorage(implants){
      localStorage.setItem('magazzino_implants', JSON.stringify(implants));
    }

    // Gestione opzioni dinamiche per modelli e nomenclature
    function loadImplantModels(){
      const saved = localStorage.getItem('implant_models');
      return saved ? JSON.parse(saved) : ['BLT', 'BL', 'BLX'];
    }

    function loadImplantNomenclatures(){
      const saved = localStorage.getItem('implant_nomenclatures');
      return saved ? JSON.parse(saved) : ['RN', 'RB', 'NC', 'RC'];
    }

    function loadKitComponents(){
      const saved = localStorage.getItem('kit_components');
      return saved ? JSON.parse(saved) : ['Frese chirurgiche'];
    }

    function saveKitComponent(component){
      if(!component || component.trim() === '') return;
      const components = loadKitComponents();
      const trimmedComponent = component.trim();
      if(!components.includes(trimmedComponent)){
        components.push(trimmedComponent);
        components.sort();
        localStorage.setItem('kit_components', JSON.stringify(components));
      }
    }

    function saveImplantModel(model, type){
      if(!model || model.trim() === '') return;
      const trimmedModel = model.trim();
      
      // Determina se √® un impianto o una componente
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const storageKey = isComponent ? 'implant_nomenclatures' : 'implant_models';
      const saved = localStorage.getItem(storageKey);
      const models = saved ? JSON.parse(saved) : [];
      
      if(!models.includes(trimmedModel)){
        models.push(trimmedModel);
        models.sort();
        localStorage.setItem(storageKey, JSON.stringify(models));
      }
    }

    function populateImplantModelSelect(){
      const select = document.getElementById('implantModel');
      const type = document.getElementById('implantType').value;
      
      // Carica la lista appropriata in base al tipo
      const isComponent = type === 'Vite tappo' || type === 'Vite di guarigione';
      const models = isComponent ? loadImplantNomenclatures() : loadImplantModels();
      
      // Mantieni solo l'opzione vuota
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      // Aggiungi le opzioni salvate
      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        select.appendChild(option);
      });
    }

    function populateKitComponentsSelect(){
      const select = document.getElementById('implantKitComponents');
      const components = loadKitComponents();
      
      select.innerHTML = '<option value="">-- Seleziona o scrivi sotto --</option>';
      
      components.forEach(component => {
        const option = document.createElement('option');
        option.value = component;
        option.textContent = component;
        select.appendChild(option);
      });
    }

    function addImplantToStorage(implant){
      const implants = loadImplantsFromStorage();
      const newImplant = {...implant, id: implant.id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : '_implant_'+Date.now())};
      if(newImplant.orderDate instanceof Date) newImplant.orderDate = newImplant.orderDate.toISOString();
      if(newImplant.expiry instanceof Date) newImplant.expiry = newImplant.expiry.toISOString();
      implants.push(newImplant);
      saveImplantsToStorage(implants);
      return newImplant.id;
    }

    function updateImplantQuantity(id, delta){
      const implants = loadImplantsFromStorage();
      const item = implants.find(m=>m.id === id);
      if(item){
        item.quantity = Math.max(0, (item.quantity || 0) + delta);
        saveImplantsToStorage(implants);
        
        // Sync to Firebase
        if(firebaseReady && typeof db !== 'undefined'){
          const ref = db.collection('implants').doc(id);
          db.runTransaction(async tx=>{
            const doc = await tx.get(ref);
            if(!doc.exists) return;
            const q = Math.max(0, (doc.data().quantity || 0) + delta);
            tx.update(ref, {quantity: q});
          }).catch(err => {
            console.warn('Firebase update failed for implant quantity:', err);
          });
        }
      }
      renderImplantsList();
    }

    function deleteImplant(id){
      if(!confirm('Eliminare questo impianto?')) return;
      const implants = loadImplantsFromStorage();
      const filtered = implants.filter(m=>m.id !== id);
      saveImplantsToStorage(filtered);
      
      // Sync to Firebase
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('implants').doc(id).delete().catch(err => {
          console.warn('Firebase delete failed for implant:', err);
        });
      }
      
      renderImplantsList();
    }

    function renderImplantsList(){
      const implantsList = document.getElementById('implantsList');
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => i.model === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }
      
      // Ordina alfabeticamente per tipo e azienda
      implants.sort((a, b) => {
        const typeA = (a.type || '').toLowerCase();
        const typeB = (b.type || '').toLowerCase();
        const companyA = (a.company || '').toLowerCase();
        const companyB = (b.company || '').toLowerCase();
        
        if(typeA !== typeB) return typeA.localeCompare(typeB);
        return companyA.localeCompare(companyB);
      });
      
      implantsList.innerHTML = '';
      
      implants.forEach(implant=>{
        const tr = document.createElement('tr');
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString() : '-';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        
        // Semaforo scadenza
        let statusHtml = '';
        if(!expiry){
          statusHtml = '<span title="Nessuna scadenza" style="font-size:24px;cursor:help;">‚ö™</span>';
        } else {
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          if(days < 0) {
            statusHtml = '<span title="Scaduto il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üî¥</span>';
          } else if(mesi < 3) {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üî¥</span>';
          } else if(mesi < 6) {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üü°</span>';
          } else {
            statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üü¢</span>';
          }
        }
        
        // Badge quantit√†
        const qtyBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+implant.quantity+'</span>';
        
        // Mostra modello o componenti kit
        let modelDisplay = '-';
        if(implant.type === 'Kit chirurgico' && implant.kitComponents){
          modelDisplay = escapeHtml(implant.kitComponents);
        } else if(implant.model) {
          modelDisplay = escapeHtml(implant.model);
        }
        
        tr.innerHTML = `
          <td data-label="Tipo">${escapeHtml(implant.type)}</td>
          <td data-label="Azienda">${escapeHtml(implant.company)}</td>
          <td data-label="Modello">${modelDisplay}</td>
          <td data-label="√ò">${diameter}</td>
          <td data-label="L">${length}</td>
          <td data-label="Data ordine">${orderDate}</td>
          <td data-label="Scadenza" style="text-align:center;white-space:nowrap;">${statusHtml}</td>
          <td data-label="Prezzo">‚Ç¨ ${Number(implant.price||0).toFixed(2)}</td>
          <td data-label="Quantit√†" style="text-align:center">${qtyBadge}</td>
          <td data-label="Azioni" style="white-space:nowrap">
            <button class="btn-action btn-inc" onclick="updateImplantQuantity('${implant.id}', 1)" title="Aggiungi 1">+</button>
            <button class="btn-action btn-dec" onclick="updateImplantQuantity('${implant.id}', -1)" title="Rimuovi 1">‚àí</button>
            <button class="btn-action btn-del" onclick="deleteImplant('${implant.id}')" title="Elimina">√ó</button>
          </td>
        `;
        implantsList.appendChild(tr);
      });
    }

    function toggleActionMenu(menuId){
      const menu = document.getElementById(menuId);
      const isVisible = menu.style.display !== 'none';
      
      // Nascondi tutti i menu aperti
      document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      
      // Mostra il menu corrente se non era visibile
      if(!isVisible){
        menu.style.display = 'block';
      }
    }

    // Chiudi i menu quando clicki fuori
    document.addEventListener('click', function(event){
      if(!event.target.closest('.action-menu-btn') && !event.target.closest('.action-menu')){
        document.querySelectorAll('.action-menu').forEach(m => m.style.display = 'none');
      }
    });

    function openImplantsModal(){
      document.getElementById('implantsModal').classList.add('active');
      populateImplantModelSelect();
      populateKitComponentsSelect();
      initImplantFilters();
      renderImplantsList();
    }

    function closeImplantsModal(){
      document.getElementById('implantsModal').classList.remove('active');
    }

    function initImplantFilters(){
      const implants = loadImplantsFromStorage();
      
      // Popola filtro aziende
      const companies = [...new Set(implants.map(i => i.company).filter(c => c))];
      const companyFilter = document.getElementById('implantCompanyFilter');
      companyFilter.innerHTML = '<option value="Tutte">Tutte</option>';
      companies.sort().forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companyFilter.appendChild(option);
      });
      
      // Popola filtro modelli in base al tipo
      updateImplantModelFilter();
    }

    function updateImplantModelFilter(){
      const implants = loadImplantsFromStorage();
      const selectedType = currentImplantTypeFilter;
      const modelFilter = document.getElementById('implantModelFilter');
      const modelLabel = document.getElementById('implantModelFilterLabel');
      
      // Cambia etichetta in base al tipo
      const isScrew = selectedType === 'Vite tappo' || selectedType === 'Vite di guarigione';
      const isImplant = selectedType === 'Impianto';
      
      if(isScrew) {
        modelLabel.textContent = 'Filtra per nomenclatura:';
      } else if(isImplant) {
        modelLabel.textContent = 'Filtra per modello:';
      } else {
        modelLabel.textContent = 'Filtra per modello/nomenclatura:';
      }
      
      // Filtra modelli in base al tipo selezionato
      let filteredImplants = implants;
      if(selectedType !== 'Tutti'){
        filteredImplants = implants.filter(i => i.type === selectedType);
      }
      
      const models = [...new Set(filteredImplants.map(i => i.model).filter(m => m))];
      modelFilter.innerHTML = '<option value="Tutti">Tutti</option>';
      models.sort().forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelFilter.appendChild(option);
      });
      
      // Reset selezione se il modello corrente non √® pi√π nella lista
      if(currentImplantModelFilter !== 'Tutti' && !models.includes(currentImplantModelFilter)){
        currentImplantModelFilter = 'Tutti';
        modelFilter.value = 'Tutti';
      }
    }


    // Request browser notification permission (optional)
    if ('Notification' in window){
      Notification.requestPermission().catch(()=>{});
    }

    function showAlert(text, type='info'){
      const d = document.createElement('div');
      d.className = 'alert ' + (type==='warn'?'warn':'info');
      d.textContent = text;
      alertsEl.appendChild(d);
      setTimeout(()=>d.remove(), 8000);
    }

    function notify(title, body){
      // Browser notification
      if (window.Notification && Notification.permission === 'granted'){
        new Notification(title, {body});
      }
      // in-app alert
      showAlert(title + ' ‚Äî ' + body, 'warn');
    }

    function daysBetween(a,b){
      const ms = 24*60*60*1000;
      return Math.ceil((b-a)/ms);
    }

    function initCategoryFilters(){
      categoryFiltersEl.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'category-btn' + (cat === currentFilter ? ' active' : '');
        btn.textContent = cat;
        btn.addEventListener('click', ()=>{
          currentFilter = cat;
          updateCategoryFilters();
          renderFilteredMaterials();
        });
        categoryFiltersEl.appendChild(btn);
      });
      // Filtro aziende: menu a tendina
      if (companyFilterSelect) {
        const companies = Array.from(new Set(allDocs.map(doc => (doc.data().company || '').trim()).filter(c => c))).sort();
        companyFilterSelect.innerHTML = '<option value="Tutte">Tutte</option>';
        companies.forEach(comp => {
          if(comp) {
            const opt = document.createElement('option');
            opt.value = comp;
            opt.textContent = comp;
            companyFilterSelect.appendChild(opt);
          }
        });
        companyFilterSelect.value = currentCompanyFilter;
      }
      // Filtro distributori: menu a tendina
      if (distributorFilterSelect) {
        const distributors = Array.from(new Set(allDocs.map(doc => (doc.data().distributor || '').trim()).filter(c => c))).sort();
        distributorFilterSelect.innerHTML = '<option value="Tutti">Tutti</option>';
        distributors.forEach(dist => {
          if(dist) {
            const opt = document.createElement('option');
            opt.value = dist;
            opt.textContent = dist;
            distributorFilterSelect.appendChild(opt);
          }
        });
        distributorFilterSelect.value = currentDistributorFilter;
      }
    }

    function updateCategoryFilters(){
      const btns = categoryFiltersEl.querySelectorAll('.category-btn');
      btns.forEach(btn=>{
        if(btn.textContent === currentFilter){
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    // Rimosso updateCompanyFilters: non serve pi√π con il select

    function loadMaterialsFromStorage(){
      const localData = loadFromLocalStorage();
      allDocs = localData.map(d=>({id: d.id, data: ()=>d}));
      initCategoryFilters();
      renderFilteredMaterials();
      checkAndNotify(allDocs);
    }

    function renderFilteredMaterials(){
      listEl.innerHTML = '';
      let filtered = currentFilter === 'Tutti' 
        ? allDocs 
        : allDocs.filter(doc=>doc.data().category === currentFilter);
      if(currentCompanyFilter !== 'Tutte'){
        filtered = filtered.filter(doc => (doc.data().company || '') === currentCompanyFilter);
      }
      if(currentDistributorFilter !== 'Tutti'){
        filtered = filtered.filter(doc => (doc.data().distributor || '') === currentDistributorFilter);
      }
      // Filtro scadenza semaforo
      if(currentExpiryFilter !== 'Tutte'){
        const now = new Date();
        filtered = filtered.filter(doc => {
          const data = doc.data();
          if(!data.expiry) return false;
          const expiry = data.expiry && data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry);
          const days = Math.ceil((expiry - now) / (1000*60*60*24));
          const mesi = days / 30.44;
          if(days < 0) return currentExpiryFilter === 'Rosso';
          if(mesi < 3) return currentExpiryFilter === 'Rosso';
          if(mesi < 6) return currentExpiryFilter === 'Giallo';
          return currentExpiryFilter === 'Verde';
        });
      }
      // Filtro quantit√† semaforo
      if(currentQuantityFilter !== 'Tutte'){
        filtered = filtered.filter(doc => {
          const data = doc.data();
          const soglia = data.lowStockThreshold || 2;
          if(currentQuantityFilter === 'Rosso') return (data.quantity||0) < soglia;
          if(currentQuantityFilter === 'Giallo') return (data.quantity||0) == soglia;
          if(currentQuantityFilter === 'Verde') return (data.quantity||0) > soglia;
          return true;
        });
      }
      
      // Ordina alfabeticamente per nome
      filtered.sort((a, b) => {
        const nameA = (a.data().name || '').toLowerCase();
        const nameB = (b.data().name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      filtered.forEach(doc=>{
        const tr = renderItem(doc);
        listEl.appendChild(tr);
      });
            // Gestione filtro quantit√† da select
            const quantityFilterSelect = document.getElementById('quantityFilterSelect');
            if (quantityFilterSelect) {
              quantityFilterSelect.addEventListener('change', function() {
                currentQuantityFilter = this.value;
                renderFilteredMaterials();
              });
            }
        // Gestione filtro scadenza da select
        const expiryFilterSelect = document.getElementById('expiryFilterSelect');
        if (expiryFilterSelect) {
          expiryFilterSelect.addEventListener('change', function() {
            currentExpiryFilter = this.value;
            renderFilteredMaterials();
          });
        }
    }

    // Funzione per convertire in Title Case (iniziali maiuscole)
    function toTitleCase(str) {
      return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    // Auto-fill categoria e azienda quando si completa il nome materiale
    let autoFillTimeout;
    document.getElementById('name').addEventListener('input', function() {
      clearTimeout(autoFillTimeout);
      const materialName = this.value.trim();
      
      autoFillTimeout = setTimeout(() => {
        if(materialName.length < 3) return;
        
        const materials = loadFromLocalStorage();
        const lowerName = materialName.toLowerCase();
        
        // Prima cerca match esatto
        let match = materials.find(m => m.name && m.name.toLowerCase() === lowerName);
        
        // Se non trova match esatto, cerca match parziale/simile
        if(!match) {
          match = materials.find(m => {
            if(!m.name) return false;
            const existingName = m.name.toLowerCase();
            // Match se uno contiene l'altro (errori di digitazione parziali)
            return existingName.includes(lowerName) || lowerName.includes(existingName);
          });
        }
        
        if(match) {
          // Correggi il nome con la versione corretta in Title Case
          const correctedName = toTitleCase(match.name);
          document.getElementById('name').value = correctedName;
          
          // Auto-fill categoria
          if(match.category) {
            document.getElementById('category').value = match.category;
          }
          
          // Auto-fill azienda
          if(match.company) {
            const companySelect = document.getElementById('companySelect');
            const companyInput = document.getElementById('company');
            
            const option = Array.from(companySelect.options).find(opt => opt.value === match.company);
            if(option) {
              companySelect.value = match.company;
              companyInput.style.display = 'none';
            } else {
              companySelect.value = 'Other';
              companyInput.value = match.company;
              companyInput.style.display = '';
            }
          }
        }
      }, 600); // Attiva dopo 600ms dalla fine della digitazione
    });

    addForm.addEventListener('submit', async e=>{
      e.preventDefault();
      console.log('Form submitted');
      
      const name = toTitleCase(document.getElementById('name').value.trim());
      const orderDate = document.getElementById('orderDate').value;
      const expiry = document.getElementById('expiry').value;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const quantity = parseInt(document.getElementById('quantity').value,10) || 0;
      const category = document.getElementById('category').value.trim();
        let distributor = document.getElementById('distributorSelect').value;
        if(distributor === 'Other') {
          distributor = document.getElementById('distributor').value.trim();
        }
        let company = document.getElementById('companySelect').value;
        if(company === 'Other') {
          company = document.getElementById('company').value.trim();
        }
      const notifyDays = 30;
      let lowStockThreshold = document.getElementById('lowStockThreshold').value;
      if(lowStockThreshold === 'Other') {
        lowStockThreshold = parseInt(document.getElementById('lowStockThresholdCustom').value,10) || 2;
      } else {
        lowStockThreshold = parseInt(lowStockThreshold,10) || 2;
      }
          // Gestione visibilit√† input soglia personalizzata
          document.getElementById('lowStockThreshold').addEventListener('change', function() {
            if(this.value === 'Other') {
              document.getElementById('lowStockThresholdCustom').style.display = '';
            } else {
              document.getElementById('lowStockThresholdCustom').style.display = 'none';
            }
          });
      
      if(!name || !orderDate || !expiry || !category) {
        console.log('Missing fields:', {name, orderDate, expiry, category});
        return;
      }
      
      const newData = {
        name, 
        orderDate: new Date(orderDate), 
        expiry: new Date(expiry), 
        price, 
        quantity, 
        category, 
          distributor, 
          company,
        notifyDays, 
        lowStockThreshold,
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      console.log('Saving material:', name);
      
      // ID unico condiviso tra locale e Firebase
      const materialId = window.crypto && window.crypto.randomUUID
        ? window.crypto.randomUUID()
        : ('m_' + Date.now() + '_' + Math.floor(Math.random()*100000));

      // Save to local storage
      const itemId = addToLocalStorage({id: materialId, ...newData});
      console.log('Saved with ID:', itemId);
      
      // Try Firebase sync (optional)
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('materials').doc(materialId).set(newData);
        } catch(err) {
          console.warn('Firebase unavailable:', err.message);
          showAlert('Materiale salvato in locale. Firebase non raggiungibile.', 'warn');
        }
      }
      
      // Reset and reload
      addForm.reset();
      document.getElementById('quantity').value = 1;
      showAlert('‚úì ' + name + ' aggiunto', 'info');
      
      // Reload immediately
      setTimeout(loadMaterialsFromStorage, 100);
    });

    function renderItem(doc){
      const data = doc.data();
      const tr = document.createElement('tr');
      const now = new Date();
      const orderDate = data.orderDate ? (data.orderDate.toDate ? data.orderDate.toDate() : new Date(data.orderDate)) : null;
      const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
      let statusHtml = '';
      if(!expiry){
        statusHtml = '<span title="Nessuna scadenza" style="font-size:24px;cursor:help;">‚ö™</span>';
      } else {
        const days = daysBetween(now, expiry);
        const mesi = days / 30.44;
        if(days < 0) {
          statusHtml = '<span title="Scaduto il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üî¥</span>';
        } else if(days <= 30) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üü°</span>';
        } else if(mesi < 3) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üî¥</span>';
        } else if(mesi < 6) {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üü°</span>';
        } else {
          statusHtml = '<span title="Scade tra ' + days + ' giorni il ' + expiry.toLocaleDateString() + '" style="font-size:24px;cursor:help;">üü¢</span>';
        }
      }
      // Badge semaforo quantit√†
      let lowBadge = '';
      const soglia = data.lowStockThreshold || 2;
      if (data.quantity < soglia) {
        lowBadge = '<span class="badge low" style="background:#d32f2f;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else if (data.quantity == soglia) {
        lowBadge = '<span class="badge soon" style="background:#fbc02d;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      } else {
        lowBadge = '<span class="badge ok" style="background:#388e3c;color:#fff;font-size:14px;padding:6px 12px;border-radius:6px;font-weight:600;">'+data.quantity+'</span>';
      }
      tr.innerHTML = `
        <td data-label="Nome"><span class="editable-name" style="cursor:pointer;text-decoration:underline;">${escapeHtml(data.name)}</span></td>
        <td data-label="Data ordine">${orderDate ? orderDate.toLocaleDateString() : '-'}</td>
        <td data-label="Scadenza" style="text-align:center;white-space:nowrap;">${statusHtml}</td>
        <td data-label="Prezzo">‚Ç¨ ${Number(data.price).toFixed(2)}</td>
        <td data-label="Distributore">${escapeHtml(data.distributor||'-')}</td>
        <td data-label="Azienda">${escapeHtml(data.company||'-')}</td>
        <td data-label="Quantit√†" style="text-align:center;">${lowBadge}</td>
        <td data-label="Azioni" style="white-space:nowrap;padding:8px;">
          <button data-id="${doc.id}" class="btn-action btn-inc" title="Aggiungi 1">+</button>
          <button data-id="${doc.id}" class="btn-action btn-dec" title="Rimuovi 1">‚àí</button>
          <button data-id="${doc.id}" class="btn-action btn-del" title="Elimina">√ó</button>
        </td>
      `;
      // attach actions
      tr.querySelector('.btn-inc').addEventListener('click', (e)=>{e.preventDefault(); changeQuantity(doc.id, 1)});
      tr.querySelector('.btn-dec').addEventListener('click', (e)=>{e.preventDefault(); changeQuantity(doc.id, -1)});
      tr.querySelector('.btn-del').addEventListener('click', (e)=>{e.preventDefault(); deleteItem(doc.id)});
      tr.querySelector('.editable-name').addEventListener('click', () => {
        const newName = prompt('Modifica nome materiale:', data.name);
        if(newName && newName.trim() && newName !== data.name) {
          const formattedName = toTitleCase(newName.trim());
          data.name = formattedName;
          updateMaterialFields(doc.id, { name: formattedName });
        }
      });
      return tr;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function changeQuantity(id, delta){
      updateQuantityLocalStorage(id, delta);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        const ref = db.collection('materials').doc(id);
        db.runTransaction(async tx=>{
          const doc = await tx.get(ref);
          if(!doc.exists) return;
          const q = (doc.data().quantity||0) + delta;
          tx.update(ref,{quantity: q});
        }).catch(()=>{});
      }
    }

    function deleteItem(id){
      if(!confirm('Eliminare questo elemento?')) return;
      deleteFromLocalStorage(id);
      loadMaterialsFromStorage(); // aggiorna subito la UI
      // Prova a sincronizzare su Firebase (opzionale)
      if(firebaseReady && typeof db !== 'undefined'){
        db.collection('materials').doc(id).delete().catch(()=>{});
      }
    }

    // Listen realtime with Firebase fallback to localStorage
    try {
      db.collection('materials').orderBy('name').onSnapshot(
        snapshot => {
          saveToLocalStorage(snapshot.docs);
          allDocs = loadFromLocalStorage().map(d=>({id: d.id, data: ()=>d}));
          initCategoryFilters();
          renderFilteredMaterials();
          checkAndNotify(allDocs);
        },
        error => {
          console.warn('Firebase error, usando localStorage:', error);
          loadMaterialsFromStorage();
        }
      );
    } catch(err) {
      firebaseReady = false;
      console.warn('Firebase init error, usando localStorage:', err);
      loadMaterialsFromStorage();
    }

    // Listen realtime for implants
    try {
      db.collection('implants').onSnapshot(
        snapshot => {
          const implants = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              type: data.type,
              company: data.company,
              model: data.model,
              kitComponents: data.kitComponents,
              diameter: data.diameter,
              length: data.length,
              orderDate: data.orderDate && data.orderDate.toDate ? data.orderDate.toDate().toISOString() : data.orderDate,
              expiry: data.expiry && data.expiry.toDate ? data.expiry.toDate().toISOString() : data.expiry,
              price: data.price,
              quantity: data.quantity,
              createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt
            };
          });
          saveImplantsToStorage(implants);
          // Forza aggiornamento UI se il modale √® aperto
          if(document.getElementById('implantsModal').classList.contains('active')){
            renderImplantsList();
          }
        },
        error => {
          console.warn('Firebase error for implants, usando localStorage:', error);
        }
      );
    } catch(err) {
      console.warn('Firebase init error for implants, usando localStorage:', err);
    }
    
    // Gestione visibilit√† input azienda e distributore personalizzati
    document.getElementById('companySelect').addEventListener('change', function() {
      if(this.value === 'Other') {
        document.getElementById('company').style.display = '';
      } else {
        document.getElementById('company').style.display = 'none';
      }
    });
    document.getElementById('distributorSelect').addEventListener('change', function() {
      if(this.value === 'Other') {
        document.getElementById('distributor').style.display = '';
      } else {
        document.getElementById('distributor').style.display = 'none';
      }
    });

    // Gestione filtro azienda da select
    if (companyFilterSelect) {
      companyFilterSelect.addEventListener('change', function() {
        currentCompanyFilter = this.value;
        renderFilteredMaterials();
      });
    }
    // Gestione filtro distributore da select
    if (distributorFilterSelect) {
      distributorFilterSelect.addEventListener('change', function() {
        currentDistributorFilter = this.value;
        renderFilteredMaterials();
      });
    }

    // Load initial data from localStorage on page load
    window.addEventListener('load', ()=>{
      loadMaterialsFromStorage();
    });

    function checkAndNotify(docs){
      const now = new Date();
      docs.forEach(doc=>{
        const data = doc.data();
        const expiry = data.expiry ? (data.expiry.toDate ? data.expiry.toDate() : new Date(data.expiry)) : null;
        // expiry notifications
        if(expiry){
          const days = daysBetween(now, expiry);
          const key = doc.id + ':expiry';
          if(days < 0){
            if(!notified.get(key)){
              notify('Materiale scaduto: '+data.name, 'Scaduto il '+expiry.toLocaleDateString());
              notified.set(key, true);
            }
          } else if(days <= 30){
            if(!notified.get(key)){
              notify('Scadenza prossima: '+data.name, 'Scade tra '+days+' giorni ('+expiry.toLocaleDateString()+')');
              notified.set(key, true);
            }
          } else {
            notified.delete(key);
          }
        }
        // low stock notifications
        const key2 = doc.id + ':low';
        const soglia = data.lowStockThreshold || 2;
        if((data.quantity||0) < soglia){
          if(!notified.get(key2)){
            notify('Quantit√† bassa: '+data.name, 'Quantit√† = '+(data.quantity||0));
            notified.set(key2, true);
          }
        } else notified.delete(key2);
      });
    }

    // periodic check (every 5 minutes)
    setInterval(async ()=>{
      if(!firebaseReady || typeof db === 'undefined') {
        checkAndNotify(allDocs);
        return;
      }
      try {
        const snap = await db.collection('materials').get();
        checkAndNotify(snap.docs);
      } catch {
        checkAndNotify(allDocs);
      }
    }, 5*60*1000);

    let allMaterials = []; // store materials for PDF export

    // listen to materials and keep allMaterials updated
    if(firebaseReady && typeof db !== 'undefined') {
      db.collection('materials').orderBy('name').onSnapshot(snapshot=>{
        allMaterials = snapshot.docs.map(doc=>({id: doc.id, ...doc.data()}));
      }, ()=>{
        allMaterials = loadFromLocalStorage();
      });
    } else {
      allMaterials = loadFromLocalStorage();
    }

    function generateTablePDF(title, filename, headers, rows, summaryLines){
      const JsPdfCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
      if(!JsPdfCtor){
        showAlert('Libreria PDF non disponibile', 'warn');
        return;
      }

      const doc = new JsPdfCtor({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 10;
      const tableWidth = pageWidth - (margin * 2);
      const colCount = headers.length;
      const colWidth = tableWidth / colCount;
      const rowHeight = 6;
      let y = margin;

      function fitText(value, maxWidth){
        const original = value === null || value === undefined ? '' : String(value);
        let text = original;
        while(text.length > 0 && doc.getTextWidth(text) > maxWidth){
          text = text.slice(0, -1);
        }
        if(text !== original){
          text = text.slice(0, Math.max(0, text.length - 1)) + '‚Ä¶';
        }
        return text;
      }

      function drawHeaderBlock(){
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 61, 122);
        doc.text(title, margin, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        doc.text('Esportazione del: ' + new Date().toLocaleDateString(), margin, y);
        y += 6;
      }

      function drawTableHeader(){
        doc.setFillColor(0, 61, 122);
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        headers.forEach((header, index) => {
          const x = margin + (index * colWidth);
          doc.rect(x, y, colWidth, rowHeight, 'F');
          doc.text(fitText(header, colWidth - 2), x + 1, y + 4);
        });
        y += rowHeight;
      }

      function ensureSpace(required){
        if(y + required > pageHeight - margin){
          doc.addPage();
          y = margin;
          drawHeaderBlock();
          drawTableHeader();
        }
      }

      drawHeaderBlock();
      drawTableHeader();

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.setTextColor(20, 20, 20);
      rows.forEach((row, rowIndex) => {
        ensureSpace(rowHeight);
        const fill = rowIndex % 2 === 0 ? 252 : 245;
        row.forEach((cell, index) => {
          const x = margin + (index * colWidth);
          doc.setFillColor(fill, fill, fill);
          doc.rect(x, y, colWidth, rowHeight, 'F');
          doc.setDrawColor(220, 220, 220);
          doc.rect(x, y, colWidth, rowHeight);
          doc.text(fitText(cell, colWidth - 2), x + 1, y + 4);
        });
        y += rowHeight;
      });

      if(Array.isArray(summaryLines) && summaryLines.length){
        ensureSpace((summaryLines.length * 5) + 4);
        y += 3;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        summaryLines.forEach(line => {
          doc.text(line, margin, y);
          y += 5;
        });
      }

      doc.save(filename);
    }

    async function downloadMaterialsPDF(){
      const visibleRows = Array.from(document.querySelectorAll('#list tr'));
      const allMaterials = visibleRows.map(row => {
        const cells = row.querySelectorAll('td');
        const qtyText = (cells[6]?.textContent || '0').replace(/[^\d-]/g, '');
        const priceRaw = (cells[3]?.textContent || '0').replace(/[^\d,.-]/g, '').replace(',', '.');
        return {
          name: (cells[0]?.textContent || '-').trim(),
          orderDate: (cells[1]?.textContent || '-').trim(),
          expiryStatus: (cells[2]?.textContent || '-').trim(),
          priceText: (cells[3]?.textContent || '‚Ç¨ 0.00').trim(),
          distributor: (cells[4]?.textContent || '-').trim(),
          company: (cells[5]?.textContent || '-').trim(),
          quantity: parseInt(qtyText || '0', 10) || 0,
          priceValue: parseFloat(priceRaw || '0') || 0
        };
      });

      if(allMaterials.length === 0){
        showAlert('Nessun materiale visibile da esportare', 'warn');
        return;
      }
      const headers = ['Nome', 'Data Ordine', 'Scadenza', 'Prezzo (‚Ç¨)', 'Distributore', 'Azienda', 'Quantit√†'];
      const rows = allMaterials.map(item => [
        item.name || '-',
        item.orderDate || '-',
        item.expiryStatus || '-',
        item.priceText || '‚Ç¨ 0.00',
        item.distributor || '-',
        item.company || '-',
        String(item.quantity || 0)
      ]);
      const summaryLines = [
        'Totale materiali: ' + allMaterials.length,
        'Valore totale: ‚Ç¨ ' + allMaterials.reduce((sum, m)=>(sum + (m.priceValue||0) * (m.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Materiali',
        'materiali_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines
      );
      showAlert('‚úì PDF Materiali scaricato con successo', 'info');
    }

    async function downloadImplantsPDF(){
      // Applica gli stessi filtri che sono visualizzati nella tabella impianti
      let implants = loadImplantsFromStorage();
      const now = new Date();
      
      // Applica filtri
      if(currentImplantTypeFilter !== 'Tutti'){
        implants = implants.filter(i => i.type === currentImplantTypeFilter);
      }
      if(currentImplantCompanyFilter !== 'Tutte'){
        implants = implants.filter(i => i.company === currentImplantCompanyFilter);
      }
      if(currentImplantModelFilter !== 'Tutti'){
        implants = implants.filter(i => i.model === currentImplantModelFilter);
      }
      if(currentImplantExpiryFilter !== 'Tutte'){
        implants = implants.filter(i => {
          if(!i.expiry) return currentImplantExpiryFilter === 'Tutte';
          const expiry = new Date(i.expiry);
          const days = daysBetween(now, expiry);
          const mesi = days / 30.44;
          
          switch(currentImplantExpiryFilter){
            case 'Scaduti': return days < 0;
            case '< 3 mesi': return days >= 0 && mesi < 3;
            case '< 6 mesi': return days >= 0 && mesi < 6;
            case '> 6 mesi': return mesi >= 6;
            default: return true;
          }
        });
      }

      // Se nessun filtro √® impostato, includi tutti i dati
      if(implants.length === 0){
        const hasActiveFilters = currentImplantTypeFilter !== 'Tutti' || 
                                 currentImplantCompanyFilter !== 'Tutte' || 
                                 currentImplantModelFilter !== 'Tutti' || 
                                 currentImplantExpiryFilter !== 'Tutte';
        
        if(hasActiveFilters){
          showAlert('Nessun impianto da esportare con i filtri selezionati', 'warn');
          return;
        } else {
          // Nessun filtro attivo - carica tutto da localStorage come fallback
          implants = loadImplantsFromStorage() || [];
          if(!implants || implants.length === 0){
            showAlert('Nessun impianto da esportare', 'warn');
            return;
          }
        }
      }

      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }

      const headers = ['Tipo', 'Azienda', 'Modello', '√ò', 'L', 'Data Ordine', 'Scadenza', 'Prezzo (‚Ç¨)', 'Quantit√†'];
      const rows = implants.map(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString() : '-';
        const expiry = implant.expiry ? new Date(implant.expiry) : null;
        const expiryDate = expiry ? expiry.toLocaleDateString() : '-';
        const diameter = implant.diameter ? implant.diameter + ' mm' : '-';
        const length = implant.length ? implant.length + ' mm' : '-';
        const modelValue = implant.type === 'Kit chirurgico'
          ? (implant.kitComponents ? escapeHtml(implant.kitComponents) : '-')
          : (implant.model ? escapeHtml(implant.model) : '-');
        return [
          escapeHtml(implant.type),
          escapeHtml(implant.company),
          modelValue,
          diameter,
          length,
          orderDate,
          expiryDate,
          '‚Ç¨ ' + Number(implant.price || 0).toFixed(2),
          String(implant.quantity || 0)
        ];
      });
      const summaryLines = [
        'Totale impianti: ' + implants.length,
        'Valore totale: ‚Ç¨ ' + implants.reduce((sum, i)=>(sum + (parseFloat(i.price)||0) * (i.quantity||0)), 0).toFixed(2)
      ];
      generateTablePDF(
        'Studio Dentistico - Magazzino Impianti',
        'impianti_' + new Date().toISOString().split('T')[0] + '.pdf',
        headers,
        rows,
        summaryLines
      );
      showAlert('‚úì PDF Impianti scaricato con successo', 'info');
    }

    async function downloadPDF(){
      downloadMaterialsPDF();
    }

    // --- BACKUP & RESTORE ---
    function exportBackup(){
      const materials = loadFromLocalStorage();
      const implants = loadImplantsFromStorage();
      const implantModels = loadImplantModels();
      const implantNomenclatures = loadImplantNomenclatures();
      const kitComponents = loadKitComponents();
      
      const backup = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: {
          materials: materials,
          implants: implants,
          implantModels: implantModels,
          implantNomenclatures: implantNomenclatures,
          kitComponents: kitComponents
        }
      };
      
      const dataStr = JSON.stringify(backup, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'backup_magazzino_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('‚úì Backup scaricato con successo', 'info');
    }
    
    function importBackup(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e){
        try {
          const backup = JSON.parse(e.target.result);
          
          if(!backup.data){
            showAlert('File di backup non valido', 'warn');
            return;
          }
          
          if(!confirm('ATTENZIONE: Importando il backup, tutti i dati correnti verranno sostituiti. Continuare?')){
            return;
          }
          
          // Importa materiali
          if(backup.data.materials && Array.isArray(backup.data.materials)){
            localStorage.setItem('magazzino', JSON.stringify(backup.data.materials));
          }
          
          // Importa impianti
          if(backup.data.implants && Array.isArray(backup.data.implants)){
            localStorage.setItem('magazzino_implants', JSON.stringify(backup.data.implants));
          }
          
          // Importa modelli
          if(backup.data.implantModels && Array.isArray(backup.data.implantModels)){
            localStorage.setItem('implant_models', JSON.stringify(backup.data.implantModels));
          }
          
          // Importa nomenclature
          if(backup.data.implantNomenclatures && Array.isArray(backup.data.implantNomenclatures)){
            localStorage.setItem('implant_nomenclatures', JSON.stringify(backup.data.implantNomenclatures));
          }
          
          // Importa componenti kit
          if(backup.data.kitComponents && Array.isArray(backup.data.kitComponents)){
            localStorage.setItem('kit_components', JSON.stringify(backup.data.kitComponents));
          }
          
          // Sincronizza con Firebase se disponibile
          if(firebaseReady && typeof db !== 'undefined'){
            // Sincronizza materiali
            if(backup.data.materials){
              backup.data.materials.forEach(async material => {
                try {
                  const materialData = {...material};
                  delete materialData.id;
                  if(materialData.orderDate && typeof materialData.orderDate === 'string'){
                    materialData.orderDate = new Date(materialData.orderDate);
                  }
                  if(materialData.expiry && typeof materialData.expiry === 'string'){
                    materialData.expiry = new Date(materialData.expiry);
                  }
                  if(materialData.createdAt && typeof materialData.createdAt === 'string'){
                    materialData.createdAt = new Date(materialData.createdAt);
                  }
                  if(materialData.updatedAt && typeof materialData.updatedAt === 'string'){
                    materialData.updatedAt = new Date(materialData.updatedAt);
                  }
                  await db.collection('materials').doc(material.id).set(materialData);
                } catch(err){
                  console.warn('Errore sync materiale:', err);
                }
              });
            }
            
            // Sincronizza impianti
            if(backup.data.implants){
              backup.data.implants.forEach(async implant => {
                try {
                  const implantData = {...implant};
                  delete implantData.id;
                  if(implantData.orderDate && typeof implantData.orderDate === 'string'){
                    implantData.orderDate = new Date(implantData.orderDate);
                  }
                  if(implantData.expiry && typeof implantData.expiry === 'string'){
                    implantData.expiry = new Date(implantData.expiry);
                  }
                  if(implantData.createdAt && typeof implantData.createdAt === 'string'){
                    implantData.createdAt = new Date(implantData.createdAt);
                  }
                  await db.collection('implants').doc(implant.id).set(implantData);
                } catch(err){
                  console.warn('Errore sync impianto:', err);
                }
              });
            }
          }
          
          showAlert('‚úì Backup importato con successo! Ricarica la pagina.', 'info');
          
          // Ricarica la pagina dopo 2 secondi
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          
        } catch(err) {
          console.error('Errore importazione backup:', err);
          showAlert('Errore durante l\'importazione del backup', 'warn');
        }
      };
      
      reader.readAsText(file);
      // Reset input file
      event.target.value = '';
    }

    // --- CSV EXPORTS ---
    function exportMaterialsCSV(){
      const materials = loadFromLocalStorage();
      if(!materials || materials.length === 0){
        showAlert('Nessun materiale da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Nome', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'Quantit√†', 'Categoria', 'Distributore', 'Azienda', 'Soglia Bassa', 'Giorni Notifica'];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      materials.forEach(material => {
        const orderDate = material.orderDate ? new Date(material.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = material.expiry ? new Date(material.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          material.id || '',
          '"' + (material.name || '').replace(/"/g, '""') + '"',
          orderDate,
          expiry,
          (material.price || 0).toFixed(2),
          material.quantity || 0,
          '"' + (material.category || '').replace(/"/g, '""') + '"',
          '"' + (material.distributor || '').replace(/"/g, '""') + '"',
          '"' + (material.company || '').replace(/"/g, '""') + '"',
          material.lowStockThreshold || 2,
          material.notifyDays || 30
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'materiali_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('‚úì CSV Materiali scaricato con successo', 'info');
    }
    
    function exportImplantsCSV(){
      const implants = loadImplantsFromStorage();
      if(!implants || implants.length === 0){
        showAlert('Nessun impianto da esportare', 'warn');
        return;
      }
      
      // Header CSV
      const headers = ['ID', 'Tipo', 'Azienda', 'Modello', 'Componenti Kit', 'Diametro (mm)', 'Lunghezza (mm)', 'Data Ordine', 'Data Scadenza', 'Prezzo', 'Quantit√†'];
      let csvContent = headers.join(',') + '\n';
      
      // Rows
      implants.forEach(implant => {
        const orderDate = implant.orderDate ? new Date(implant.orderDate).toLocaleDateString('it-IT') : '';
        const expiry = implant.expiry ? new Date(implant.expiry).toLocaleDateString('it-IT') : '';
        
        const row = [
          implant.id || '',
          '"' + (implant.type || '').replace(/"/g, '""') + '"',
          '"' + (implant.company || '').replace(/"/g, '""') + '"',
          '"' + (implant.model || '').replace(/"/g, '""') + '"',
          '"' + (implant.kitComponents || '').replace(/"/g, '""') + '"',
          implant.diameter || '',
          implant.length || '',
          orderDate,
          expiry,
          (implant.price || 0).toFixed(2),
          implant.quantity || 0
        ];
        csvContent += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'impianti_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showAlert('‚úì CSV Impianti scaricato con successo', 'info');
    }

    // --- IMPLANTS EVENT LISTENERS ---
    document.getElementById('implantsBtn').addEventListener('click', openImplantsModal);
    
    // Gestione campi custom per impianti
    document.getElementById('implantCompany').addEventListener('change', function() {
      const custom = document.getElementById('implantCompanyCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantModel').addEventListener('change', function() {
      const customInput = document.getElementById('implantModelCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantKitComponents').addEventListener('change', function() {
      const customInput = document.getElementById('implantKitComponentsCustom');
      if(this.value) {
        customInput.value = this.value;
      }
    });

    document.getElementById('implantDiameter').addEventListener('change', function() {
      const custom = document.getElementById('implantDiameterCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    document.getElementById('implantLength').addEventListener('change', function() {
      const custom = document.getElementById('implantLengthCustom');
      custom.style.display = this.value === 'Other' ? '' : 'none';
    });

    // Mostra/nascondi campi in base al tipo di impianto
    document.getElementById('implantType').addEventListener('change', function() {
      const type = this.value;
      const isImplant = type === 'Impianto';
      const isScrew = type === 'Vite tappo' || type === 'Vite di guarigione';
      const isKit = type === 'Kit chirurgico';
      
      const modelGroup = document.getElementById('implantModelGroup');
      const modelLabel = modelGroup.querySelector('label');
      
      // Cambia etichetta in base al tipo
      if(isScrew) {
        modelLabel.textContent = 'Nomenclatura';
      } else if(isImplant) {
        modelLabel.textContent = 'Modello';
      } else {
        modelLabel.textContent = 'Modello / Nomenclatura';
      }
      
      modelGroup.style.display = (isImplant || isScrew) ? '' : 'none';
      document.getElementById('implantDiameterGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantLengthGroup').style.display = isImplant ? '' : 'none';
      document.getElementById('implantKitComponentsGroup').style.display = isKit ? '' : 'none';
      
      // Ricarica le opzioni appropriate
      populateImplantModelSelect();
    });

    // Event listeners per i filtri impianti
    document.getElementById('implantTypeFilter').addEventListener('change', function() {
      currentImplantTypeFilter = this.value;
      updateImplantModelFilter(); // Aggiorna il filtro modello in base al tipo
      renderImplantsList();
    });
    
    document.getElementById('implantCompanyFilter').addEventListener('change', function() {
      currentImplantCompanyFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantModelFilter').addEventListener('change', function() {
      currentImplantModelFilter = this.value;
      renderImplantsList();
    });
    
    document.getElementById('implantExpiryFilter').addEventListener('change', function() {
      currentImplantExpiryFilter = this.value;
      renderImplantsList();
    });

    // Submit form impianti
    document.getElementById('implantForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const type = document.getElementById('implantType').value;
      let company = document.getElementById('implantCompany').value;
      if(company === 'Other') company = document.getElementById('implantCompanyCustom').value.trim();
      
      // Prendi il valore dall'input personalizzato (sempre visibile ora)
      let model = document.getElementById('implantModelCustom').value.trim();
      if(!model) {
        model = document.getElementById('implantModel').value;
      }
      
      // Salva il modello/nomenclatura nelle opzioni per usi futuri
      if(model) {
        saveImplantModel(model, type);
      }
      
      // Prendi i componenti del kit se il tipo √® Kit chirurgico
      let kitComponents = null;
      if(type === 'Kit chirurgico') {
        kitComponents = document.getElementById('implantKitComponentsCustom').value.trim();
        if(!kitComponents) {
          kitComponents = document.getElementById('implantKitComponents').value;
        }
        // Salva i componenti nelle opzioni per usi futuri
        if(kitComponents) {
          saveKitComponent(kitComponents);
        }
      }
      
      let diameter = document.getElementById('implantDiameter').value;
      if(diameter === 'Other') diameter = document.getElementById('implantDiameterCustom').value;
      
      let length = document.getElementById('implantLength').value;
      if(length === 'Other') length = document.getElementById('implantLengthCustom').value;
      
      const orderDate = document.getElementById('implantOrderDate').value;
      const expiry = document.getElementById('implantExpiry').value;
      const price = parseFloat(document.getElementById('implantPrice').value) || 0;
      const quantity = parseInt(document.getElementById('implantQuantity').value, 10) || 0;

      const newImplant = {
        type,
        company,
        model: model || null,
        kitComponents: kitComponents || null,
        diameter: diameter || null,
        length: length || null,
        orderDate: new Date(orderDate),
        expiry: expiry ? new Date(expiry) : null,
        price,
        quantity,
        createdAt: new Date()
      };

      const implantId = addImplantToStorage(newImplant);
      
      // Sync to Firebase (optional)
      if(firebaseReady && typeof db !== 'undefined'){
        try {
          await db.collection('implants').doc(implantId).set(newImplant);
        } catch(err) {
          console.warn('Firebase sync failed for implant:', err.message);
        }
      }

      document.getElementById('implantForm').reset();
      document.getElementById('implantQuantity').value = 1;
      showAlert('‚úì Impianto aggiunto', 'info');
      initImplantFilters(); // Aggiorna i filtri
      renderImplantsList();
    });

    // Mostra/nascondi pulsante Gestione Impianti in base alla categoria
    function updateImplantsButtonVisibility() {
      const btn = document.getElementById('implantsBtn');
      btn.style.display = (currentFilter === 'Implantologia e Chirurgia') ? '' : 'none';
    }

    // Chiama questa funzione quando cambia il filtro categoria
    const originalUpdateCategoryFilters = updateCategoryFilters;
    updateCategoryFilters = function() {
      originalUpdateCategoryFilters();
      updateImplantsButtonVisibility();
    };
  </script>
</body>
</html>
